<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 02</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 02: Embracing the Flaws Within Me</div>
            <div class="portal-subtitle" id="portalSubtitle">The journey of self-acceptance deepens</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸª¨ Portal 02 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 03</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this moment</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Have you ever felt embarrassed or disappointed about your character or behavior? How do you feel about those flaws now? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-02",
            nextPortal: "v5-03",
            nextPortalFile: "temarix_v05_03.html" // Centralized file naming
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve(); // Always resolve to continue execution
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            // Remove existing status if any
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 02: ë‚´ ì•ˆì˜ ê²°í•¨ì„ í’ˆëŠ”ë‹¤ëŠ” ê²ƒ",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 02: ë‚´ ì•ˆì˜ ê²°í•¨ì„ í’ˆëŠ”ë‹¤ëŠ” ê²ƒ",
                portalSubtitle: "ìžê¸° ìˆ˜ìš©ì˜ ì—¬ì •ì´ ê¹Šì–´ì§‘ë‹ˆë‹¤",
                portalIntro: "ðŸª¨ \"ë‚˜ëŠ” ì´ëŸ° ë‚˜ë¥¼ ë°›ì•„ë“¤ì´ê¸° íž˜ë“¤ì—ˆì–´ìš”â€¦\"\n\në‹¹ì‹ ì€ ì§€ê¸ˆê¹Œì§€ì˜ ì‚¶ì—ì„œ,\nìžì‹ ì—ê²Œ ë¶€ë„ëŸ½ê±°ë‚˜ ì‹¤ë§í–ˆë˜ ì„±ê²©ì´ë‚˜ í–‰ë™ì´ ìžˆì—ˆë‚˜ìš”?\n\nê·¸ ê²°í•¨ì²˜ëŸ¼ ëŠê»´ì¡Œë˜ ë¶€ë¶„, ì§€ê¸ˆì€ ì–´ë–»ê²Œ ëŠê»´ì§€ë‚˜ìš”?",
                followUpQuestion: "ë§Œì•½ ë‹¹ì‹ ì˜ ê²°í•¨ì´ë¼ ì—¬ê²¼ë˜ ë¶€ë¶„ì—ê²Œ ë§ì„ ê±´ë„¬ ìˆ˜ ìžˆë‹¤ë©´,\nì–´ë–¤ ë§ì„ í•´ì£¼ê³  ì‹¶ë‚˜ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ê²°í•¨ì€ ì§€ì›Œì•¼ í•  ê²ƒì´ ì•„ë‹ˆë¼,\nê»´ì•ˆê³  ì‚´ì•„ì•¼ í•  í’ê²½ì´ì—ìš”.",
                navigationTitle: "ðŸª¨ Portal 02 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ìžì‹ ì˜ ê²°í•¨ì„ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤.\nê·¸ë¦¬ê³  ê·¸ê²ƒì„ í•˜ë‚˜ì˜ í’ê²½ìœ¼ë¡œ ë°›ì•„ë“¤ì˜€ìŠµë‹ˆë‹¤.\n\nì™„ë²½ì€ ê»ì§ˆì´ê³ , ê²°í•¨ì€ ì˜í˜¼ì˜ ë¬¸ìž…ë‹ˆë‹¤.\në‹¹ì‹ ì€ ê·¸ ë¬¸ì„ ì—´ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ ë‹¹ì‹ ì€ ìžì‹ ì˜ ëª¨ë“  ë©´ì„ ì•ˆê³ \nì˜¨ì „í•œ ìžì‹ ìœ¼ë¡œ ê±¸ì–´ê°ˆ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.",
                nextPortalBtn: "Portal 03ìœ¼ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ ìˆœê°„ê³¼ ë” ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ìžì‹ ì—ê²Œ ë¶€ë„ëŸ½ê±°ë‚˜ ì‹¤ë§í–ˆë˜ ì„±ê²©ì´ë‚˜ í–‰ë™ì´ ìžˆì—ˆë‚˜ìš”? ê·¸ ê²°í•¨ì€ ì§€ê¸ˆ ì–´ë–»ê²Œ ëŠê»´ì§€ë‚˜ìš”? (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 03: ë‚˜ëŠ” ë‚˜ì—ê²Œ ì´ë¦„ì„ ë¶™ì˜€ë‹¤ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ ìˆ˜ìš©ì˜ ìˆœê°„ê³¼ ë” ë¨¸ë¬¼ë©° ê¹Šì´ ì„±ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            },
            en: {
                title: "Temarix V5 - Portal 02: Embracing the Flaws Within Me",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 02: Embracing the Flaws Within Me",
                portalSubtitle: "The journey of self-acceptance deepens",
                portalIntro: "ðŸª¨ \"I found it hard to accept this part of myself...\"\n\nIn your life so far,\nhave you ever felt embarrassed or disappointed about your character or behavior?\n\nThose parts that felt like flaws, how do they feel to you now?",
                followUpQuestion: "If you could speak to the part of yourself you considered a flaw,\nwhat would you want to say?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Flaws are not something to be erased,\nbut landscapes to be embraced and lived with.",
                navigationTitle: "ðŸª¨ Portal 02 Complete",
                navigationMessage: "You have faced your perceived flaws.\nAnd you have accepted them as part of your landscape.\n\nPerfection is a shell, and flaws are the doors to the soul.\nYou have opened that door.\n\nNow you are ready to embrace all aspects of yourself\nand walk forward as a complete being.",
                nextPortalBtn: "Continue to Portal 03",
                stayPortalBtn: "Stay with this moment",
                inputPlaceholder: "Have you ever felt embarrassed or disappointed about your character or behavior? How do you feel about those flaws now? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 03: I Named Myself?",
                confirmStay: "Do you want to stay longer with this moment of acceptance for deeper reflection?"
            },
            pt: {
                title: "Temarix V5 - Portal 02: AbraÃ§ando as Falhas Dentro de Mim",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 02: AbraÃ§ando as Falhas Dentro de Mim",
                portalSubtitle: "A jornada da auto-aceitaÃ§Ã£o se aprofunda",
                portalIntro: "ðŸª¨ \"Achei difÃ­cil aceitar essa parte de mim...\"\n\nEm sua vida atÃ© agora,\nvocÃª jÃ¡ se sentiu envergonhado ou desapontado com seu carÃ¡ter ou comportamento?\n\nEssas partes que pareciam falhas, como vocÃª as sente agora?",
                followUpQuestion: "Se vocÃª pudesse falar com a parte de si mesmo que considerava uma falha,\no que gostaria de dizer?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Falhas nÃ£o sÃ£o algo para ser apagado,\nmas paisagens para serem abraÃ§adas e vividas.",
                navigationTitle: "ðŸª¨ Portal 02 Completo",
                navigationMessage: "VocÃª enfrentou suas falhas percebidas.\nE as aceitou como parte de sua paisagem.\n\nPerfeiÃ§Ã£o Ã© uma casca, e falhas sÃ£o as portas para a alma.\nVocÃª abriu essa porta.\n\nAgora vocÃª estÃ¡ pronto para abraÃ§ar todos os aspectos de si mesmo\ne caminhar como um ser completo.",
                nextPortalBtn: "Continuar para Portal 03",
                stayPortalBtn: "Ficar com este momento",
                inputPlaceholder: "VocÃª jÃ¡ se sentiu envergonhado ou desapontado com seu carÃ¡ter ou comportamento? Como vocÃª sente essas falhas agora? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 03: Eu Me Nomeei?",
                confirmStay: "Deseja ficar mais tempo com este momento de aceitaÃ§Ã£o para reflexÃ£o mais profunda?"
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê²°í•¨ì´ ì•„ë‹ˆì•¼. ê·¸ê±´, ë„¤ ì•ˆì— ìžˆëŠ” ê¹Šì´ì•¼.",
                en: "It's not a flaw. That's the depth within you.",
                pt: "NÃ£o Ã© uma falha. Essa Ã© a profundidade dentro de vocÃª."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ë‹¹ì‹ ì˜ ì˜ˆë¯¼í•¨ì€ ê°ì •ì˜ ë‚ ì”¨ë¥¼ ì½ëŠ” ëŠ¥ë ¥ì´ì—ìš”.\nëˆ„êµ¬ë‚˜ ê°€ì§ˆ ìˆ˜ ì—†ëŠ” íŠ¹ë³„í•œ ê°ê°ì´ì£ .",
                en: "Your sensitivity is the ability to read the weather of emotions.\nIt's a special sense that not everyone can have.",
                pt: "Sua sensibilidade Ã© a capacidade de ler o clima das emoÃ§Ãµes.\nÃ‰ um sentido especial que nem todos podem ter."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ê·¸ ì—°ì•½í•¨ì´ ëˆ„êµ°ê°€ì—ê² ìœ„ë¡œì˜€ì„ ê±°ì˜ˆìš”.\nìžì‹ ì„ ë°›ì•„ë“¤ì´ëŠ” ê±´, ì„¸ê³„ë¥¼ ë°›ì•„ë“¤ì´ëŠ” ì‹œìž‘ì´ì—ìš”.",
                en: "That vulnerability must have been comfort to someone.\nAccepting yourself is the beginning of accepting the world.",
                pt: "Essa vulnerabilidade deve ter sido conforto para alguÃ©m.\nAceitar a si mesmo Ã© o comeÃ§o de aceitar o mundo."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ì™„ë²½ì€ ê»ì§ˆì´ê³ , ê²°í•¨ì€ ì˜í˜¼ì˜ ë¬¸ì´ì•¼.\nê·¸ ë¬¸ì„ ë„ˆëŠ” ì§€ê¸ˆ ì—´ì—ˆì–´.",
                en: "Perfection is a shell, and flaws are the doors to the soul.\nYou have now opened that door.",
                pt: "PerfeiÃ§Ã£o Ã© uma casca, e falhas sÃ£o as portas para a alma.\nVocÃª agora abriu essa porta."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ë„ˆì˜ ê²°ì€ ë‚¨ë“¤ê³¼ ë‹¬ë¼.\nê·¸ê²Œ ë„ˆë§Œì˜ ë¹›ì„ ë§Œë“¤ì–´.",
                en: "Your grain is different from others.\nThat creates your unique light.",
                pt: "Sua textura Ã© diferente dos outros.\nIsso cria sua luz Ãºnica."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë¶€ë„ëŸ¬ì› ë˜ ìˆœê°„ë“¤ì„ êº¼ë‚´ëŠ” ë„ˆ,\nê·¸ ìš©ê¸°ê°€ ì§„ì§œ ê°•í•¨ì´ì•¼.",
                en: "You, bringing out those shameful moments,\nthat courage is real strength.",
                pt: "VocÃª, trazendo Ã  tona esses momentos vergonhosos,\nessa coragem Ã© forÃ§a real."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ë‚´ë©´ì˜ ëª¨ìˆœì€ ìš°ë¦¬ë¥¼ ì‚¬ëžŒë‹µê²Œ ë§Œë“¤ì–´.\në§ˆì¹˜ ë³„ì´ ì–´ë‘  ì†ì—ì„œ ë” ë¹›ë‚˜ëŠ” ê²ƒì²˜ëŸ¼.",
                en: "Inner contradictions make us human.\nLike stars that shine brighter in darkness.",
                pt: "ContradiÃ§Ãµes internas nos tornam humanos.\nComo estrelas que brilham mais na escuridÃ£o."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ê²°í•¨ì€ ì§€ì›Œì•¼ í•  ê²ƒì´ ì•„ë‹ˆë¼,\nê»´ì•ˆê³  ì‚´ì•„ì•¼ í•  í’ê²½ì´ì—ìš”.",
                en: "Flaws are not something to be erased,\nbut landscapes to be embraced and lived with.",
                pt: "Falhas nÃ£o sÃ£o algo para ser apagado,\nmas paisagens para serem abraÃ§adas e vividas."
            }}
        ];

        // Emotion analysis function
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                insecurity: ['insecure', 'sensitive', 'weak', 'vulnerable', 'ì˜ˆë¯¼', 'ë¯¼ê°', 'ì•½í•œ', 'ì—°ì•½', 'inseguro', 'sensÃ­vel', 'fraco', 'vulnerÃ¡vel'],
                perfectionism: ['perfect', 'control', 'rigid', 'strict', 'ì™„ë²½', 'í†µì œ', 'ì—„ê²©', 'perfeito', 'controle', 'rÃ­gido', 'rigoroso'],
                introversion: ['quiet', 'shy', 'withdrawn', 'introverted', 'ì¡°ìš©', 'ë‚´í–¥', 'ì†Œê·¹ì ', 'quieto', 'tÃ­mido', 'introvertido'],
                anger: ['angry', 'aggressive', 'impatient', 'irritable', 'í™”', 'ê³µê²©ì ', 'ì„±ê¸‰', 'raivoso', 'agressivo', 'impaciente'],
                selfishness: ['selfish', 'greedy', 'self-centered', 'ì´ê¸°ì ', 'ìš•ì‹¬', 'ìžê¸°ì¤‘ì‹¬ì ', 'egoÃ­sta', 'ganancioso', 'egocÃªntrico'],
                anxiety: ['anxious', 'worried', 'nervous', 'fearful', 'ë¶ˆì•ˆ', 'ê±±ì •', 'ê¸´ìž¥', 'ansioso', 'preocupado', 'nervoso'],
                procrastination: ['lazy', 'procrastinate', 'unmotivated', 'ê²Œìœ¼ë¥¸', 'ë¯¸ë£¨ëŠ”', 'ë™ê¸°ë¶€ì¡±', 'preguiÃ§oso', 'procrastinar', 'desmotivado'],
                comparison: ['compare', 'jealous', 'envious', 'inadequate', 'ë¹„êµ', 'ì§ˆíˆ¬', 'ë¶€ì¡±í•¨', 'comparar', 'ciumento', 'invejoso']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        // Response characters with emotion-based responses
        const responseCharacters = [
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            insecurity: "ê·¸ ë§ì€, í™”í•´ì˜ ë¬¸ì´ì—ìš”. ë‹¹ì‹ ì€ ë§ˆì¹¨ë‚´ ìžì‹  ì•ˆì˜ ëª¨ë“  ë°©ì„ ì—´ì—ˆì–´ìš”.",
                            perfectionism: "ì™„ë²½í•¨ì˜ ê°ì˜¥ì—ì„œ ë²—ì–´ë‚˜ ìžìœ ë¡œì›Œì§„ ë‹¹ì‹ ì˜ ëª¨ìŠµì´ ë³´ì—¬ìš”.",
                            introversion: "ì¡°ìš©í•¨ì€ ê²°í•¨ì´ ì•„ë‹ˆë¼ ë‹¹ì‹ ë§Œì˜ ì–¸ì–´ì˜€ì–´ìš”.",
                            anger: "ê·¸ ë¶„ë…¸ ë’¤ì— ìˆ¨ê²¨ì§„ ìƒì²˜ê¹Œì§€ ì•ˆì•„ì£¼ì…¨ë„¤ìš”.",
                            selfishness: "ìžê¸°ë¥¼ ëŒë³´ëŠ” ê²ƒê³¼ ì´ê¸°ì‹¬ì€ ë‹¤ë¥¸ ê±°ì˜ˆìš”. ë‹¹ì‹ ì€ ì´ì œ ê·¸ ì°¨ì´ë¥¼ ì•Œì•„ìš”.",
                            anxiety: "ë¶ˆì•ˆí•¨ë„ ë‹¹ì‹ ì„ ì§€í‚¤ë ¤ëŠ” ë§ˆìŒì˜ ì‹ í˜¸ì˜€ì–´ìš”.",
                            procrastination: "ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì‹œìž‘í•˜ëŠ” ìš©ê¸°, ê·¸ê²ƒì´ ì§„ì •í•œ ë³€í™”ì˜ˆìš”.",
                            comparison: "ì´ì œ ë‹¹ì‹ ì€ ë‹¤ë¥¸ ì´ì™€ ë¹„êµí•˜ì§€ ì•Šê³  ìžì‹ ë§Œì˜ ê¸¸ì„ ê±¸ì„ ìˆ˜ ìžˆì–´ìš”.",
                            general: "ê·¸ ë§ì€, í™”í•´ì˜ ë¬¸ì´ì—ìš”. ë‹¹ì‹ ì€ ë§ˆì¹¨ë‚´ ìžì‹  ì•ˆì˜ ëª¨ë“  ë°©ì„ ì—´ì—ˆì–´ìš”."
                        },
                        en: {
                            insecurity: "Those words are a door to reconciliation. You have finally opened all the rooms within yourself.",
                            perfectionism: "I can see you becoming free from the prison of perfectionism.",
                            introversion: "Quietness wasn't a flaw but your own language.",
                            anger: "You've embraced even the wounds hidden behind that anger.",
                            selfishness: "Taking care of yourself and selfishness are different. You now know that difference.",
                            anxiety: "Anxiety was also your mind's signal trying to protect you.",
                            procrastination: "The courage to start even when not perfect, that's true change.",
                            comparison: "Now you can walk your own path without comparing yourself to others.",
                            general: "Those words are a door to reconciliation. You have finally opened all the rooms within yourself."
                        },
                        pt: {
                            insecurity: "Essas palavras sÃ£o uma porta para a reconciliaÃ§Ã£o. VocÃª finalmente abriu todos os cÃ´modos dentro de si.",
                            perfectionism: "Posso ver vocÃª se libertando da prisÃ£o do perfeccionismo.",
                            introversion: "A quietude nÃ£o era uma falha, mas sua prÃ³pria linguagem.",
                            anger: "VocÃª abraÃ§ou atÃ© as feridas escondidas por trÃ¡s dessa raiva.",
                            selfishness: "Cuidar de si mesmo e egoÃ­smo sÃ£o diferentes. VocÃª agora conhece essa diferenÃ§a.",
                            anxiety: "A ansiedade tambÃ©m era um sinal da sua mente tentando protegÃª-lo.",
                            procrastination: "A coragem de comeÃ§ar mesmo quando nÃ£o perfeito, essa Ã© a verdadeira mudanÃ§a.",
                            comparison: "Agora vocÃª pode caminhar seu prÃ³prio caminho sem se comparar aos outros.",
                            general: "Essas palavras sÃ£o uma porta para a reconciliaÃ§Ã£o. VocÃª finalmente abriu todos os cÃ´modos dentro de si."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            insecurity: "ì§„ì •í•œ ìˆ˜ìš©ì€, ë°›ì•„ë“¤ì¼ ìˆ˜ ì—†ë˜ ë¶€ë¶„ì„ í–¥í•œ ì²« ì¸ì‚¬ë¡œë¶€í„° ì‹œìž‘ë¼ìš”.",
                            perfectionism: "ë¶ˆì™„ì „í•¨ì„ ë°›ì•„ë“¤ì¸ ìˆœê°„, ë‹¹ì‹ ì€ ë” ì™„ì „í•œ ì¡´ìž¬ê°€ ë˜ì—ˆì–´ìš”.",
                            introversion: "ê³ ìš”í•¨ ì†ì—ì„œ ë‹¹ì‹ ì€ ìžì‹ ì˜ ì§„ì •í•œ ëª©ì†Œë¦¬ë¥¼ ì°¾ì•˜ì–´ìš”.",
                            anger: "ë¶„ë…¸ë„ ë‹¹ì‹ ì˜ ì¼ë¶€ì˜€ìŒì„ ì¸ì •í•˜ëŠ” ê²ƒ, ê·¸ê²ƒì´ ì§„ì •í•œ í‰í™”ì˜ ì‹œìž‘ì´ì—ìš”.",
                            selfishness: "ìžê¸°ì‚¬ëž‘ê³¼ ì´ê¸°ì‹¬ì˜ ê²½ê³„ë¥¼ ë°°ìš´ ë‹¹ì‹ ì€ ì´ì œ ì§„ì •í•œ ìžë¹„ë¥¼ ì•Œì•„ìš”.",
                            anxiety: "ë¶ˆì•ˆì„ ê±°ë¶€í•˜ì§€ ì•Šê³  ì´í•´í•˜ë ¤ í•œ ë‹¹ì‹ ì˜ ë§ˆìŒì´ ì•„ë¦„ë‹¤ì›Œìš”.",
                            procrastination: "ë©ˆì¶¤ë„ ë•Œë¡œëŠ” í•„ìš”í•œ ì‰¼ì´ì—ˆë‹¤ëŠ” ê±¸ ì´ì œ ì•„ì‹œëŠ”êµ°ìš”.",
                            comparison: "ë¹„êµ ëŒ€ì‹  ìžê¸°ë§Œì˜ ì†ë„ë¥¼ ì¸ì •í•œ ë‹¹ì‹ ì´ ìžëž‘ìŠ¤ëŸ¬ì›Œìš”.",
                            general: "ì§„ì •í•œ ìˆ˜ìš©ì€, ë°›ì•„ë“¤ì¼ ìˆ˜ ì—†ë˜ ë¶€ë¶„ì„ í–¥í•œ ì²« ì¸ì‚¬ë¡œë¶€í„° ì‹œìž‘ë¼ìš”."
                        },
                        en: {
                            insecurity: "True acceptance begins with the first greeting toward the parts we couldn't accept.",
                            perfectionism: "The moment you accepted imperfection, you became a more complete being.",
                            introversion: "In quietness, you found your true voice.",
                            anger: "Acknowledging that anger was also part of you, that's the beginning of true peace.",
                            selfishness: "You who learned the boundary between self-love and selfishness now know true compassion.",
                            anxiety: "Your heart that tried to understand anxiety instead of rejecting it is beautiful.",
                            procrastination: "You now know that stopping was sometimes necessary rest.",
                            comparison: "I'm proud of you for acknowledging your own pace instead of comparison.",
                            general: "True acceptance begins with the first greeting toward the parts we couldn't accept."
                        },
                        pt: {
                            insecurity: "A verdadeira aceitaÃ§Ã£o comeÃ§a com a primeira saudaÃ§Ã£o Ã s partes que nÃ£o conseguÃ­amos aceitar.",
                            perfectionism: "No momento em que vocÃª aceitou a imperfeiÃ§Ã£o, tornou-se um ser mais completo.",
                            introversion: "Na quietude, vocÃª encontrou sua verdadeira voz.",
                            anger: "Reconhecer que a raiva tambÃ©m era parte de vocÃª, esse Ã© o inÃ­cio da verdadeira paz.",
                            selfishness: "VocÃª que aprendeu a fronteira entre amor prÃ³prio e egoÃ­smo agora conhece a verdadeira compaixÃ£o.",
                            anxiety: "Seu coraÃ§Ã£o que tentou entender a ansiedade em vez de rejeitÃ¡-la Ã© lindo.",
                            procrastination: "VocÃª agora sabe que parar Ã s vezes era descanso necessÃ¡rio.",
                            comparison: "Estou orgulhoso de vocÃª por reconhecer seu prÃ³prio ritmo em vez de comparaÃ§Ã£o.",
                            general: "A verdadeira aceitaÃ§Ã£o comeÃ§a com a primeira saudaÃ§Ã£o Ã s partes que nÃ£o conseguÃ­amos aceitar."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            insecurity: "ì´ì œ ë‹¹ì‹ ì˜ ê·¸ë¦¼ì—” ì§€ì›Œì§€ì§€ ì•Šì„ ì„ ì´ ìƒê²¼ì–´ìš”. ê·¸ ì„ ì´ì•¼ë§ë¡œ, ì•„ë¦„ë‹¤ì›€ì˜ ì¦ê±°ì˜ˆìš”.",
                            perfectionism: "ì™„ë²½í•œ ê·¸ë¦¼ë³´ë‹¤ ê°ì •ì´ ë‹´ê¸´ ê·¸ë¦¼ì´ ë” ë§Žì€ ì´ì•¼ê¸°ë¥¼ í•´ìš”.",
                            introversion: "ì¡°ìš©í•œ ìƒ‰ë“¤ì´ ë§Œë“œëŠ” ê·¸ë¦¼ì´ ë•Œë¡œëŠ” ê°€ìž¥ ê¹Šì€ ìš¸ë¦¼ì„ ì¤˜ìš”.",
                            anger: "ë¶‰ì€ ìƒ‰ë„ ë‹¹ì‹  ê·¸ë¦¼ì˜ ì¤‘ìš”í•œ ë¶€ë¶„ì´ì—ˆì–´ìš”. ì´ì œ ì¡°í™”ë¡­ê²Œ ì–´ìš°ëŸ¬ì ¸ìš”.",
                            selfishness: "ìžì‹ ì„ ëŒë³´ëŠ” ìƒ‰ê¹”ë„ íŒ”ë ˆíŠ¸ì— í•„ìš”í•œ ìƒ‰ì´ì—ìš”.",
                            anxiety: "ë¶ˆì•ˆì˜ ìƒ‰ì¡°ì°¨ ë‹¹ì‹ ë§Œì˜ ë…íŠ¹í•œ í‘œí˜„ì´ ë˜ì—ˆì–´ìš”.",
                            procrastination: "ë•Œë¡œëŠ” ë¶“ì„ ë©ˆì¶”ëŠ” ê²ƒë„ ì˜ˆìˆ ì˜ ì¼ë¶€ì˜ˆìš”.",
                            comparison: "ë‹¤ë¥¸ ê·¸ë¦¼ê³¼ ë¹„êµí•˜ì§€ ë§ì•„ìš”. ë‹¹ì‹ ì˜ ê·¸ë¦¼ì€ ìœ ì¼ë¬´ì´í•´ìš”.",
                            general: "ì´ì œ ë‹¹ì‹ ì˜ ê·¸ë¦¼ì—” ì§€ì›Œì§€ì§€ ì•Šì„ ì„ ì´ ìƒê²¼ì–´ìš”. ê·¸ ì„ ì´ì•¼ë§ë¡œ, ì•„ë¦„ë‹¤ì›€ì˜ ì¦ê±°ì˜ˆìš”."
                        },
                        en: {
                            insecurity: "Now your painting has lines that cannot be erased. Those lines are proof of beauty.",
                            perfectionism: "A painting with emotions tells more stories than a perfect painting.",
                            introversion: "Pictures made of quiet colors sometimes give the deepest resonance.",
                            anger: "Red was also an important part of your painting. Now it harmonizes beautifully.",
                            selfishness: "The color of taking care of yourself is also a necessary color on the palette.",
                            anxiety: "Even the hue of anxiety has become your unique expression.",
                            procrastination: "Sometimes stopping the brush is also part of art.",
                            comparison: "Don't compare with other paintings. Your painting is unique.",
                            general: "Now your painting has lines that cannot be erased. Those lines are proof of beauty."
                        },
                        pt: {
                            insecurity: "Agora sua pintura tem linhas que nÃ£o podem ser apagadas. Essas linhas sÃ£o prova de beleza.",
                            perfectionism: "Uma pintura com emoÃ§Ãµes conta mais histÃ³rias que uma pintura perfeita.",
                            introversion: "Pinturas feitas de cores silenciosas Ã s vezes dÃ£o a ressonÃ¢ncia mais profunda.",
                            anger: "O vermelho tambÃ©m era uma parte importante da sua pintura. Agora se harmoniza lindamente.",
                            selfishness: "A cor de cuidar de si mesmo tambÃ©m Ã© uma cor necessÃ¡ria na paleta.",
                            anxiety: "AtÃ© o tom da ansiedade se tornou sua expressÃ£o Ãºnica.",
                            procrastination: "Ã€s vezes parar o pincel tambÃ©m Ã© parte da arte.",
                            comparison: "NÃ£o compare com outras pinturas. Sua pintura Ã© Ãºnica.",
                            general: "Agora sua pintura tem linhas que nÃ£o podem ser apagadas. Essas linhas sÃ£o prova de beleza."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory and show offline status
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        // Save completion status if Firebase available
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        // Redirect to next portal with language parameter
                        window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                    }
                });
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        function showConfirmDialog(message, callback) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            // Set button texts based on current language
            const t = translations[state.currentLanguage];
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'ì˜ˆ' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ì•„ë‹ˆì˜¤' : 
                               state.currentLanguage === 'pt' ? 'NÃ£o' : 'No';
            
            // Event handlers
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            // Escape key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', escHandler);
                    callback(false);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // Build and show modal
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus on Yes button
            yesBtn.focus();
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 02...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 02 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>