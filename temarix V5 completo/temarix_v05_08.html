<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 08: The Night I Embraced My Broken Self</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 08: The Night I Embraced My Broken Self</div>
            <div class="portal-subtitle" id="portalSubtitle">Holding the fragments with tenderness</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸŒŒ Portal 08 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 09</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay in this embrace</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me about a night when you felt completely broken... (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: []
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-08",
            nextPortal: "v5-09",
            nextPortalFile: "temarix_v05_09.html"
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve();
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 08: ë¬´ë„ˆì¡Œë˜ ë‚˜ë¥¼ ëŒì–´ì•ˆëŠ” ë°¤",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 08: ë¬´ë„ˆì¡Œë˜ ë‚˜ë¥¼ ëŒì–´ì•ˆëŠ” ë°¤",
                portalSubtitle: "ë¶€ì„œì§„ ì¡°ê°ë“¤ì„ ë‹¤ì •í•˜ê²Œ ê°ì‹¸ë©°",
                portalIntro: "ðŸŒŒ \"ë‹¹ì‹ ì´ í•œë°¤ì¤‘ì— ë¬´ë„ˆì¡Œë˜ ê¸°ì–µì´ ìžˆë‹¤ë©´,\nê·¸ê±´ ì–´ë–¤ ìƒí™©ì´ì—ˆë‚˜ìš”?\"\n\n\"ê·¸ë•Œì˜ ë‚˜ëŠ” ì–´ë–¤ ëª¨ìŠµì´ì—ˆë‚˜ìš”?\"\n\"ì§€ê¸ˆì˜ ë‹¹ì‹ ì€ ê·¸ ëª¨ìŠµì„ ì–´ë–»ê²Œ ë°”ë¼ë³´ê³  ìžˆë‚˜ìš”?\"",
                emotionalBridge: "ë¬´ë„ˆì§ì€ ì¢…ë§ì²˜ëŸ¼ ëŠê»´ì§€ì§€ë§Œ,\nì‚¬ì‹¤ì€ ì§„ì§œ ìžì‹ ê³¼ ë§ˆì£¼í•˜ëŠ” ì‹œìž‘ì´ê¸°ë„ í•©ë‹ˆë‹¤.\n\nì§€ê¸ˆ, ê·¸ ë°¤ì˜ ë‚˜ë¥¼ ì•ˆì•„ì¤„ ìˆ˜ ìžˆë‚˜ìš”?",
                followUpQuestion: "ê·¸ ë°¤ì˜ ë‚˜ë¥¼ ì§€ê¸ˆ í’ˆì— ì•ˆê³  ìžˆë‹¤ë©´,\në‹¹ì‹ ì€ ì–´ë–¤ ë§ì„ ì†ì‚­ì´ê³  ì‹¶ë‚˜ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ì´ì œ ê·¸ ë°¤ì€ ìƒì²˜ê°€ ì•„ë‹ˆë¼,\në‹¹ì‹ ì„ ë¹›ìœ¼ë¡œ ë°ë ¤ì˜¨ í„°ë„ì´ ë˜ì—ˆì–´ìš”.",
                navigationTitle: "ðŸŒŒ Portal 08 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ë¬´ë„ˆì¡Œë˜ ë‚˜ë¥¼ ëŒì–´ì•ˆì•˜ìŠµë‹ˆë‹¤.\n\nê·¸ ì–´ë‘  ì†ì—ì„œ í™€ë¡œ ì›…í¬ë¦¬ê³  ìžˆë˜ ìžì‹ ì„ ì§€ê¸ˆì˜ ë‹¹ì‹ ì´ ì°¾ì•„ê°€ ì•ˆì•„ì£¼ì—ˆìŠµë‹ˆë‹¤.\në¬´ë„ˆì§ì€ ë” ì´ìƒ ë¶€ë„ëŸ¬ìš´ ê¸°ì–µì´ ì•„ë‹ˆë¼, ì§„ì‹¤ê³¼ ë§ˆì£¼í•œ ìš©ê¸°ì˜ ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në‹¹ì‹ ì€ ì´ì œ ì–´ë‘  ì†ì˜ ë‚˜ì™€ í•¨ê»˜ ê±¸ì„ ìˆ˜ ìžˆëŠ” ì‚¬ëžŒìž…ë‹ˆë‹¤.",
                nextPortalBtn: "Portal 09ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ ë°¤ê³¼ ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ì™„ì „ížˆ ë¬´ë„ˆì ¸ë²„ë ¸ë˜ ë°¤ì— ëŒ€í•´ ë§í•´ì£¼ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 09: ì‚¬ë¼ì§€ê³  ì‹¶ì—ˆë˜ ë‚ ì˜ ê³ ë°±ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ ë¬´ë„ˆì§ê³¼ ë” ë¨¸ë¬¼ë©° íšŒë³µì„ ê¹Šì´ ëŠë¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                transitionMessage: "ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤..."
            },
            en: {
                title: "Temarix V5 - Portal 08: The Night I Embraced My Broken Self",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 08: The Night I Embraced My Broken Self",
                portalSubtitle: "Holding the fragments with tenderness",
                portalIntro: "ðŸŒŒ \"If there was a memory of you collapsing in the middle of the night,\nwhat kind of situation was that?\"\n\n\"What did you look like then?\"\n\"How does the current you view that version of yourself?\"",
                emotionalBridge: "Collapse feels like an ending,\nbut it's actually the beginning of facing your true self.\n\nNow, can you embrace that night's version of you?",
                followUpQuestion: "If you were holding that night's version of you in your arms right now,\nwhat would you like to whisper?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Now that night is no longer a wound,\nbut a tunnel that brought you to the light.",
                navigationTitle: "ðŸŒŒ Portal 08 Complete",
                navigationMessage: "You have embraced your broken self.\n\nThe current you has found and embraced the self that was crouched alone in that darkness.\nCollapse is no longer a shameful memory, but a night of courage when you faced the truth.\n\nYou are now someone who can walk together with the you from the darkness.",
                nextPortalBtn: "Continue to Portal 09",
                stayPortalBtn: "Stay in this embrace",
                inputPlaceholder: "Tell me about a night when you felt completely broken... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 09: Confession of the Day I Wanted to Disappear?",
                confirmStay: "Do you want to stay longer with this collapse to deeply feel the recovery?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 08: A Noite em que Abracei Meu Eu Quebrado",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 08: A Noite em que Abracei Meu Eu Quebrado",
                portalSubtitle: "Segurando os fragmentos com ternura",
                portalIntro: "ðŸŒŒ \"Se houve uma memÃ³ria de vocÃª desmoronando no meio da noite,\nque tipo de situaÃ§Ã£o foi essa?\"\n\n\"Como vocÃª era naquele momento?\"\n\"Como o vocÃª atual vÃª essa versÃ£o de si mesmo?\"",
                emotionalBridge: "O colapso parece um fim,\nmas na verdade Ã© o inÃ­cio de enfrentar seu verdadeiro eu.\n\nAgora, vocÃª pode abraÃ§ar essa versÃ£o sua daquela noite?",
                followUpQuestion: "Se vocÃª estivesse segurando essa versÃ£o sua daquela noite em seus braÃ§os agora,\no que gostaria de sussurrar?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Agora aquela noite nÃ£o Ã© mais uma ferida,\nmas um tÃºnel que te trouxe Ã  luz.",
                navigationTitle: "ðŸŒŒ Portal 08 Completo",
                navigationMessage: "VocÃª abraÃ§ou seu eu quebrado.\n\nO vocÃª atual encontrou e abraÃ§ou o eu que estava agachado sozinho naquela escuridÃ£o.\nO colapso nÃ£o Ã© mais uma memÃ³ria vergonhosa, mas uma noite de coragem quando vocÃª enfrentou a verdade.\n\nVocÃª Ã© agora alguÃ©m que pode caminhar junto com o vocÃª da escuridÃ£o.",
                nextPortalBtn: "Continuar para Portal 09",
                stayPortalBtn: "Ficar neste abraÃ§o",
                inputPlaceholder: "Conte-me sobre uma noite em que se sentiu completamente quebrado... (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 09: ConfissÃ£o do Dia em que Quis Desaparecer?",
                confirmStay: "Deseja ficar mais tempo com este colapso para sentir profundamente a recuperaÃ§Ã£o?",
                transitionMessage: "Uma nova jornada comeÃ§a..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ë°¤, ë„Œ í˜¼ìžì˜€ì§€ë§Œ\nì™„ì „ížˆ ë¶€ì„œì§€ì§€ëŠ” ì•Šì•˜ì–´.\nì™œëƒë©´ ì§€ê¸ˆ ì—¬ê¸°ì— ìžˆìœ¼ë‹ˆê¹Œ.",
                en: "That night, you were alone but\nyou didn't completely break.\nBecause you're here now.",
                pt: "Naquela noite, vocÃª estava sozinho mas\nnÃ£o se quebrou completamente.\nPorque vocÃª estÃ¡ aqui agora."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ë¬´ë„ˆì§„ ë°¤ì´ì—ˆê¸°ì—,\në‹¤ì‹œ ìŒ“ì„ ìˆ˜ ìžˆëŠ” ì§€ê¸ˆì´ ìžˆëŠ” ê±°ì˜ˆìš”.",
                en: "Because it was a night of collapse,\nthere's now a present where you can rebuild.",
                pt: "Porque foi uma noite de colapso,\nhÃ¡ agora um presente onde vocÃª pode reconstruir."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ê·¸ ë°¤ì˜ ê³ ìš”í•¨ ì†ì— ìžˆë˜ ë„ˆ,\në‚˜ëŠ” ê·¸ ì•„ì´ë¥¼ ê¼­ ì•ˆì•„ì£¼ê³  ì‹¶ì–´ìš”.",
                en: "You in the silence of that night,\nI want to hold that child tight.",
                pt: "VocÃª no silÃªncio daquela noite,\neu quero abraÃ§ar forte aquela crianÃ§a."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ë°¤ì€ ì¢…ë§ì²˜ëŸ¼ ëŠê»´ì§€ì§€ë§Œ,\nê·¸ ë°¤ì´ ì—†ì—ˆë‹¤ë©´, ì§€ê¸ˆì˜ ë„ˆë„ ì—†ì—ˆì„ ê±°ì•¼.",
                en: "Night feels like an end,\nbut without that night, there wouldn't be the current you.",
                pt: "A noite parece um fim,\nmas sem aquela noite, nÃ£o haveria o vocÃª atual."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ë¬´ë„ˆì§ì€,\nì§„ì§œ ë‚˜ë¥¼ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•œ ë°°ê²½ì´ì—ˆì–´ìš”.",
                en: "That collapse was\nthe background for redrawing your true self.",
                pt: "Aquele colapso foi\no fundo para redesenhar seu verdadeiro eu."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë¬´ë„ˆì¡Œë‹¤ëŠ” ê±´,\nì§„ì‹¬ì´ ìžˆì—ˆë‹¤ëŠ” ëœ»ì´ì•¼.\ní¬ê¸°í•˜ì§€ ì•Šì•˜ë‹¤ëŠ” ì¦ê±°ì•¼.",
                en: "To have collapsed means\nthere was sincerity.\nIt's proof you didn't give up.",
                pt: "Ter desmoronado significa\nque havia sinceridade.\nÃ‰ prova de que vocÃª nÃ£o desistiu."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê·¸ ë°¤ì— ë„¤ ì•ˆì—ì„œ íƒœì–´ë‚œ ê±´\nëì´ ì•„ë‹ˆë¼, ì¹¨ë¬µ ì†ì˜ ë¶ˆì”¨ì˜€ì–´.",
                en: "What was born within you that night\nwasn't an end, but an ember in the silence.",
                pt: "O que nasceu dentro de vocÃª naquela noite\nnÃ£o foi um fim, mas uma brasa no silÃªncio."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ë§ˆì£¼í•˜ì§€ ì•Šìœ¼ë©´ íšŒë³µë„ ì—†ì–´ìš”.\nê·¸ë¦¬ê³  ë‹¹ì‹ ì€ ì§€ê¸ˆ, ë§ˆì£¼í•˜ê³  ìžˆì–´ìš”.",
                en: "Without facing it, there's no recovery.\nAnd you are facing it now.",
                pt: "Sem enfrentar, nÃ£o hÃ¡ recuperaÃ§Ã£o.\nE vocÃª estÃ¡ enfrentando agora."
            }}
        ];

        // Breakdown situation analysis function
        function analyzeBreakdownType(userInput) {
            const input = userInput.toLowerCase();
            
            const breakdownKeywords = {
                academic: ['exam', 'test', 'grade', 'university', 'college', 'school', 'study', 'ì‹œí—˜', 'ì„±ì ', 'ëŒ€í•™', 'í•™êµ', 'ê³µë¶€', 'exame', 'nota', 'universidade', 'escola', 'estudo'],
                relationship: ['breakup', 'divorce', 'fight', 'argument', 'relationship', 'love', 'ì´ë³„', 'í—¤ì–´ì ¸', 'ì‹¸ì› ', 'ì—°ì• ', 'ì‚¬ëž‘', 'tÃ©rmino', 'divÃ³rcio', 'briga', 'relacionamento', 'amor'],
                career: ['job', 'work', 'career', 'fired', 'promotion', 'interview', 'ì§ìž¥', 'ì¼', 'ì·¨ì—…', 'ë©´ì ‘', 'ìŠ¹ì§„', 'trabalho', 'carreira', 'demitido', 'promoÃ§Ã£o', 'entrevista'],
                family: ['family', 'parents', 'mother', 'father', 'sibling', 'ê°€ì¡±', 'ë¶€ëª¨', 'ì—„ë§ˆ', 'ì•„ë¹ ', 'í˜•ì œ', 'famÃ­lia', 'pais', 'mÃ£e', 'pai', 'irmÃ£o'],
                health: ['sick', 'illness', 'hospital', 'disease', 'pain', 'ì•„í”„', 'ë³‘ì›', 'ì§ˆë³‘', 'ì•„í””', 'doente', 'doenÃ§a', 'hospital', 'dor'],
                financial: ['money', 'debt', 'poor', 'financial', 'broke', 'ëˆ', 'ë¹š', 'ê°€ë‚œ', 'ê²½ì œì ', 'dinheiro', 'dÃ­vida', 'pobre', 'financeiro'],
                identity: ['identity', 'who am i', 'lost', 'confused', 'purpose', 'ì •ì²´ì„±', 'ë‚˜ëŠ” ëˆ„êµ¬', 'ê¸¸ì„ ìžƒì—ˆ', 'í˜¼ëž€', 'ëª©ì ', 'identidade', 'quem sou', 'perdido', 'confuso', 'propÃ³sito'],
                overwhelm: ['overwhelmed', 'too much', 'pressure', 'stressed', 'exhausted', 'ë²…ì°¬', 'ë„ˆë¬´ ë§Žì€', 'ì••ë°•', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'ì§€ì¹œ', 'sobrecarregado', 'muito', 'pressÃ£o', 'estressado', 'exausto'],
                loneliness: ['alone', 'lonely', 'isolated', 'nobody', 'empty', 'í˜¼ìž', 'ì™¸ë¡œìš´', 'ê³ ë¦½ëœ', 'ì•„ë¬´ë„', 'ë¹„ì–´ìžˆëŠ”', 'sozinho', 'solitÃ¡rio', 'isolado', 'ninguÃ©m', 'vazio'],
                failure: ['failed', 'failure', 'mistake', 'wrong', 'disappointed', 'ì‹¤íŒ¨', 'ìž˜ëª»', 'ì‹¤ìˆ˜', 'ì‹¤ë§', 'fracassou', 'fracasso', 'erro', 'errado', 'decepcionado']
            };
            
            let detectedTypes = [];
            for (const [type, keywords] of Object.entries(breakdownKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedTypes.push(type);
                        break;
                    }
                }
            }
            
            if (detectedTypes.length === 0) {
                detectedTypes = ['general'];
            }
            
            return detectedTypes[0];
        }
        
        // Response characters with breakdown-based responses
        const responseCharacters = [
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "ê·¸ ë°¤, ì„±ì ì´ë‚˜ ì‹œí—˜ì´ ë‹¹ì‹ ì˜ ì „ë¶€ì¸ ê²ƒì²˜ëŸ¼ ëŠê»´ì¡Œê² ì§€ë§Œ,\nì§€ê¸ˆì˜ ë‹¹ì‹ ì€ ê·¸ê²ƒë³´ë‹¤ í›¨ì”¬ í° ì¡´ìž¬ì˜ˆìš”.",
                            relationship: "ì‚¬ëž‘í•˜ëŠ” ì‚¬ëžŒì„ ìžƒì€ ë°¤ì˜ ê³µí—ˆí•¨ì´ ì–¼ë§ˆë‚˜ ê¹Šì—ˆì„ì§€...\nê·¸ ì•„í”” ì†ì—ì„œë„ ë‹¹ì‹ ì€ ì‚¬ëž‘í•  ì¤„ ì•„ëŠ” ë§ˆìŒì„ ìžƒì§€ ì•Šì•˜ì–´ìš”.",
                            career: "ê¿ˆì´ ë¬´ë„ˆì§„ ê²ƒ ê°™ì•˜ë˜ ê·¸ ë°¤,\nì‚¬ì‹¤ì€ ìƒˆë¡œìš´ ê°€ëŠ¥ì„±ì˜ ë¬¸ì´ ì—´ë¦¬ëŠ” ìˆœê°„ì´ì—ˆì„ì§€ë„ ëª°ë¼ìš”.",
                            family: "ê°€ì¡±ê³¼ì˜ ê°ˆë“±ì´ë‚˜ ìƒì‹¤ ì•žì—ì„œ ë¬´ë„ˆì§„ ê·¸ ë°¤,\në‹¹ì‹ ì€ í˜¼ìžê°€ ì•„ë‹ˆì—ˆì–´ìš”. ê·¸ ì•„í””ì´ ë‹¹ì‹ ì„ ë” ê¹Šì€ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            health: "ëª¸ì˜ ì•„í””ì´ ë§ˆìŒê¹Œì§€ ë¬´ë„ˆëœ¨ë ¸ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìƒëª…ì˜ ì†Œì¤‘í•¨ì„ ë” ê¹Šì´ ì´í•´í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            financial: "ê²½ì œì  ì–´ë ¤ì›€ ì•žì—ì„œ ì ˆë§í–ˆë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ëˆë³´ë‹¤ ì†Œì¤‘í•œ ê²ƒë“¤ì„ ë°œê²¬í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            identity: "ìžì‹ ì´ ëˆ„êµ¬ì¸ì§€ ëª¨ë¥´ê² ë˜ ê·¸ ë°¤ì˜ í˜¼ëž€ ì†ì—ì„œ,\nì§„ì§œ ë‹¹ì‹ ì„ ì°¾ì•„ê°€ëŠ” ì—¬ì •ì´ ì‹œìž‘ë˜ì—ˆì–´ìš”.",
                            overwhelm: "ëª¨ë“  ê²ƒì´ ë²„ê±°ì› ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìžì‹ ì˜ í•œê³„ë¥¼ ì¸ì •í•˜ê³  ë°›ì•„ë“¤ì´ëŠ” ë²•ì„ ë°°ì› ì–´ìš”.",
                            loneliness: "ì„¸ìƒì— í™€ë¡œ ë‚¨ê²¨ì§„ ê²ƒ ê°™ì•˜ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìžì‹ ê³¼ ì§„ì •ìœ¼ë¡œ ë§ˆì£¼í•˜ëŠ” ì‹œê°„ì„ ê°€ì¡Œì–´ìš”.",
                            failure: "ì‹¤íŒ¨ì˜ ë¬´ê²Œì— ì§“ëˆŒë ¸ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ë‹¤ì‹œ ì¼ì–´ì„¤ ìˆ˜ ìžˆëŠ” ë‚´ë©´ì˜ íž˜ì„ ë°œê²¬í–ˆì–´ìš”.",
                            general: "ë¬´ë„ˆì¡Œë˜ ê·¸ ë°¤ì´ ì§€ê¸ˆì˜ ë‹¹ì‹ ì„ ë§Œë“¤ì—ˆì–´ìš”.\nê·¸ ì–´ë‘ ì„ í†µê³¼í•œ ë‹¹ì‹ ì€ ì´ì œ ë¹›ì„ ë” ê¹Šì´ ì´í•´í•´ìš”."
                        },
                        en: {
                            academic: "That night when grades or exams felt like your everything,\nbut the current you is a much greater existence than that.",
                            relationship: "How deep the emptiness must have been on the night you lost someone you loved...\nEven in that pain, you didn't lose your heart that knows how to love.",
                            career: "That night when your dreams seemed to collapse,\nmight actually have been the moment a door to new possibilities opened.",
                            family: "That night you collapsed before family conflict or loss,\nyou weren't alone. That pain made you a deeper person.",
                            health: "That night when physical pain brought down your spirit too,\nyou came to understand the preciousness of life more deeply.",
                            financial: "That night you despaired before financial difficulties,\nyou discovered things more precious than money.",
                            identity: "In the confusion of that night when you didn't know who you were,\nthe journey to find your true self began.",
                            overwhelm: "That night when everything felt overwhelming,\nyou learned to acknowledge and accept your limits.",
                            loneliness: "That night when you felt left alone in the world,\nyou had time to truly face yourself.",
                            failure: "That night crushed by the weight of failure,\nyou discovered the inner strength to rise again.",
                            general: "That night when you collapsed created the current you.\nHaving passed through that darkness, you now understand light more deeply."
                        },
                        pt: {
                            academic: "Naquela noite quando notas ou exames pareciam ser seu tudo,\nmas o vocÃª atual Ã© uma existÃªncia muito maior que isso.",
                            relationship: "QuÃ£o profundo deve ter sido o vazio na noite em que perdeu alguÃ©m que amava...\nMesmo naquela dor, vocÃª nÃ£o perdeu seu coraÃ§Ã£o que sabe amar.",
                            career: "Naquela noite quando seus sonhos pareciam desmoronar,\ntalvez tenha sido realmente o momento em que uma porta para novas possibilidades se abriu.",
                            family: "Naquela noite que vocÃª desmoronou diante de conflito ou perda familiar,\nvocÃª nÃ£o estava sozinho. Aquela dor te tornou uma pessoa mais profunda.",
                            health: "Naquela noite quando a dor fÃ­sica derrubou seu espÃ­rito tambÃ©m,\nvocÃª passou a entender a preciosidade da vida mais profundamente.",
                            financial: "Naquela noite que vocÃª se desesperou diante das dificuldades financeiras,\nvocÃª descobriu coisas mais preciosas que dinheiro.",
                            identity: "Na confusÃ£o daquela noite quando nÃ£o sabia quem era,\na jornada para encontrar seu verdadeiro eu comeÃ§ou.",
                            overwhelm: "Naquela noite quando tudo parecia esmagador,\nvocÃª aprendeu a reconhecer e aceitar seus limites.",
                            loneliness: "Naquela noite quando se sentiu abandonado sozinho no mundo,\nvocÃª teve tempo para realmente enfrentar a si mesmo.",
                            failure: "Naquela noite esmagado pelo peso do fracasso,\nvocÃª descobriu a forÃ§a interior para se levantar novamente.",
                            general: "Aquela noite quando vocÃª desmoronou criou o vocÃª atual.\nTendo passado por aquela escuridÃ£o, vocÃª agora entende a luz mais profundamente."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "ê·¸ ë°¤ ê³µë¶€ë°©ì´ë‚˜ ë„ì„œê´€ì—ì„œ ìš¸ì—ˆë˜ ë‹¹ì‹ ,\nê·¸ ëˆˆë¬¼ì€ ë…¸ë ¥ì˜ ê²°ì •ì´ì—ˆì–´ìš”.",
                            relationship: "ì‚¬ëž‘í•˜ëŠ” ì‚¬ëžŒì„ ë³´ë‚´ì•¼ í–ˆë˜ ê·¸ ë°¤,\në‹¹ì‹ ì˜ ë§ˆìŒì€ ì§„ì§œ ì‚¬ëž‘ì´ ë¬´ì—‡ì¸ì§€ ë°°ì› ì–´ìš”.",
                            career: "ê¿ˆì´ ë¬´ë„ˆì§„ ê²ƒ ê°™ë˜ ê·¸ ë°¤,\nì‚¬ì‹¤ì€ ë” í° ê¿ˆì„ í’ˆê¸° ìœ„í•œ ê³µê°„ì´ ë§Œë“¤ì–´ì§€ê³  ìžˆì—ˆì–´ìš”.",
                            family: "ê°€ì¡±ì˜ ì•„í”” ì•žì—ì„œ ë¬´ë ¥í–ˆë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ì‚¬ëž‘ì˜ ê¹Šì´ë¥¼ ë”ìš± ì´í•´í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            health: "ëª¸ì´ ì•„íŒŒ ì ˆë§í–ˆë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ê±´ê°•í•œ í•˜ë£¨í•˜ë£¨ì˜ ì†Œì¤‘í•¨ì„ ê¹¨ë‹¬ì•˜ì–´ìš”.",
                            financial: "ëˆ ë•Œë¬¸ì— ìž  ëª» ì´ë¤˜ë˜ ê·¸ ë°¤,\nì§„ì •í•œ í’ìš”ë¡œì›€ì´ ë¬´ì—‡ì¸ì§€ ìƒê°í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            identity: "ë‚´ê°€ ëˆ„êµ¬ì¸ì§€ ëª°ë¼ ë°©í™©í–ˆë˜ ê·¸ ë°¤,\nì§„ì§œ ìžì‹ ì„ ì°¾ì•„ê°€ëŠ” ì—¬í–‰ì˜ ì‹œìž‘ì´ì—ˆì–´ìš”.",
                            overwhelm: "ëª¨ë“  ê²Œ ë„ˆë¬´ ë²…ì°¨ ì£¼ì €ì•‰ì•˜ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìžì‹ ì„ ë³´í˜¸í•˜ëŠ” ë²•ì„ ë°°ì› ì–´ìš”.",
                            loneliness: "ì„¸ìƒì— í˜¼ìž ë‚¨ê²¨ì§„ ê²ƒ ê°™ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìžì‹ ê³¼ ê°€ìž¥ ê¹Šì´ ëŒ€í™”í–ˆì–´ìš”.",
                            failure: "ì‹¤íŒ¨ë¡œ ë¬´ë„ˆì¡Œë˜ ê·¸ ë°¤,\në‹¤ì‹œ ì¼ì–´ì„¤ ìˆ˜ ìžˆëŠ” íž˜ì´ ë‹¹ì‹  ì•ˆì— ìžˆìŒì„ ì¦ëª…í–ˆì–´ìš”.",
                            general: "ê·¸ë ‡ê²Œ ë¬´ë„ˆì¡Œë˜ ë‹¹ì‹ ì„ ì§€ê¸ˆì˜ ë‹¹ì‹ ì´ ì•ˆì•˜ì„ ë•Œ,\níšŒë³µì€ ì´ë¯¸ ì‹œìž‘ë˜ì—ˆì–´ìš”."
                        },
                        en: {
                            academic: "You who cried in the study room or library that night,\nthose tears were crystals of effort.",
                            relationship: "That night you had to let go of someone you loved,\nyour heart learned what true love really is.",
                            career: "That night when your dreams seemed to collapse,\nspace was actually being created to embrace even bigger dreams.",
                            family: "That night you felt powerless before family pain,\nyou came to understand the depth of love even more.",
                            health: "That night you despaired from physical pain,\nyou realized the preciousness of each healthy day.",
                            financial: "That night you couldn't sleep because of money worries,\nyou began to think about what true abundance really is.",
                            identity: "That night you wandered not knowing who you were,\nit was the beginning of a journey to find your true self.",
                            overwhelm: "That night you collapsed because everything was too overwhelming,\nyou learned how to protect yourself.",
                            loneliness: "That night you felt left alone in the world,\nyou had the deepest conversation with yourself.",
                            failure: "That night you collapsed from failure,\nyou proved that the power to rise again exists within you.",
                            general: "When the current you embraced the you who had collapsed like that,\nrecovery had already begun."
                        },
                        pt: {
                            academic: "VocÃª que chorou na sala de estudos ou biblioteca naquela noite,\naquelas lÃ¡grimas eram cristais de esforÃ§o.",
                            relationship: "Naquela noite que teve que deixar ir alguÃ©m que amava,\nseu coraÃ§Ã£o aprendeu o que o amor verdadeiro realmente Ã©.",
                            career: "Naquela noite quando seus sonhos pareciam desmoronar,\nespaÃ§o estava sendo criado para abraÃ§ar sonhos ainda maiores.",
                            family: "Naquela noite que se sentiu impotente diante da dor familiar,\nvocÃª passou a entender a profundidade do amor ainda mais.",
                            health: "Naquela noite que se desesperou pela dor fÃ­sica,\nvocÃª percebeu a preciosidade de cada dia saudÃ¡vel.",
                            financial: "Naquela noite que nÃ£o conseguiu dormir por preocupaÃ§Ãµes com dinheiro,\nvocÃª comeÃ§ou a pensar sobre o que a verdadeira abundÃ¢ncia realmente Ã©.",
                            identity: "Naquela noite que vagou sem saber quem era,\nfoi o inÃ­cio de uma jornada para encontrar seu verdadeiro eu.",
                            overwhelm: "Naquela noite que desmoronou porque tudo era muito esmagador,\nvocÃª aprendeu como se proteger.",
                            loneliness: "Naquela noite que se sentiu abandonado sozinho no mundo,\nvocÃª teve a conversa mais profunda consigo mesmo.",
                            failure: "Naquela noite que desmoronou pelo fracasso,\nvocÃª provou que o poder de se levantar novamente existe dentro de vocÃª.",
                            general: "Quando o vocÃª atual abraÃ§ou o vocÃª que havia desmoronado assim,\na recuperaÃ§Ã£o jÃ¡ havia comeÃ§ado."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "ðŸ§™",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "ì„±ì ì´ ì¸ìƒì˜ ì „ë¶€ì¸ ì¤„ ì•Œì•˜ë˜ ê·¸ ë°¤,\në‹¹ì‹ ì€ ìžì‹ ì˜ ê°€ì¹˜ê°€ ì ìˆ˜ë³´ë‹¤ í›¨ì”¬ í¬ë‹¤ëŠ” ê±¸ ë°°ì› ì–´ìš”.",
                            relationship: "ì‚¬ëž‘ì„ ìžƒì—ˆë‹¤ê³  ìƒê°í–ˆë˜ ê·¸ ë°¤,\nì‚¬ì‹¤ì€ ë” ê¹Šì€ ì‚¬ëž‘ì„ í•  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒìœ¼ë¡œ ì„±ìž¥í•˜ê³  ìžˆì—ˆì–´ìš”.",
                            career: "ë¯¸ëž˜ê°€ ë§‰ë§‰í–ˆë˜ ê·¸ ë°¤,\nìƒˆë¡œìš´ ê¸¸ì´ ì—´ë¦¬ê¸° ìœ„í•œ ì¤€ë¹„ê°€ ë˜ê³  ìžˆì—ˆì–´ìš”.",
                            family: "ê°€ì¡±ì˜ ìƒì²˜ ì•žì—ì„œ ë¬´ë„ˆì§„ ê·¸ ë°¤,\në‹¹ì‹ ì€ ë” ë„“ì€ ì‚¬ëž‘ì„ í’ˆê²Œ ë˜ì—ˆì–´ìš”.",
                            health: "ëª¸ì˜ ê³ í†µì´ ë§ˆìŒì„ ì§“ëˆŒë €ë˜ ê·¸ ë°¤,\nìƒëª…ì˜ ì˜ë¯¸ë¥¼ ë” ê¹Šì´ ì„±ì°°í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            financial: "ê²½ì œì  ì ˆë§ ì†ì—ì„œ ë³´ë‚¸ ê·¸ ë°¤,\nì§„ì •í•œ ê°€ì¹˜ê°€ ë¬´ì—‡ì¸ì§€ ê¹¨ë‹«ê²Œ ë˜ì—ˆì–´ìš”.",
                            identity: "ì •ì²´ì„±ì˜ ìœ„ê¸°ë¥¼ ê²ªì—ˆë˜ ê·¸ ë°¤,\nì§„ì§œ ìžì‹ ì„ ë°œê²¬í•˜ëŠ” ì—¬ì •ì´ ì‹œìž‘ë˜ì—ˆì–´ìš”.",
                            overwhelm: "ëª¨ë“  ê²ƒì— ì••ë„ë˜ì—ˆë˜ ê·¸ ë°¤,\nìžì‹ ì˜ í•œê³„ë¥¼ ì¸ì •í•˜ê³  ì„±ìž¥í•˜ê²Œ ë˜ì—ˆì–´ìš”.",
                            loneliness: "ê·¹ë„ì˜ ì™¸ë¡œì›€ì„ ê²ªì—ˆë˜ ê·¸ ë°¤,\nìžì‹ ê³¼ì˜ ì§„ì •í•œ ë§Œë‚¨ì´ ì¼ì–´ë‚¬ì–´ìš”.",
                            failure: "ì‹¤íŒ¨ì˜ ë¬´ê²Œì— ì§“ëˆŒë ¸ë˜ ê·¸ ë°¤,\në‹¤ì‹œ ì¼ì–´ë‚  ìˆ˜ ìžˆëŠ” ë‚´ë©´ì˜ íž˜ì„ ë°œê²¬í–ˆì–´ìš”.",
                            general: "ë‹¹ì‹ ì€ ê·¸ ë°¤ì— ë©ˆì·„ì§€ë§Œ,\nì˜¤ëŠ˜ ë‹¤ì‹œ ê±·ê¸° ì‹œìž‘í–ˆì–´ìš”.\nê·¸ë¦¬ê³  ê·¸ê²ƒì´ ì§„ì§œ ìš©ì„œì˜ˆìš”."
                        },
                        en: {
                            academic: "That night when you thought grades were everything in life,\nyou learned that your worth is much greater than any score.",
                            relationship: "That night when you thought you lost love,\nyou were actually growing into someone who could love more deeply.",
                            career: "That night when the future seemed hopeless,\npreparation was being made for new paths to open.",
                            family: "That night you collapsed before family wounds,\nyou came to embrace a broader love.",
                            health: "That night when physical pain crushed your spirit,\nyou came to contemplate the meaning of life more deeply.",
                            financial: "That night spent in economic despair,\nyou came to realize what true value really is.",
                            identity: "That night you experienced an identity crisis,\nthe journey to discover your true self began.",
                            overwhelm: "That night you were overwhelmed by everything,\nyou came to acknowledge your limits and grow.",
                            loneliness: "That night you experienced extreme loneliness,\na true meeting with yourself took place.",
                            failure: "That night crushed by the weight of failure,\nyou discovered the inner strength to rise again.",
                            general: "You stopped that night,\nbut today you began walking again.\nAnd that is true forgiveness."
                        },
                        pt: {
                            academic: "Naquela noite quando pensou que notas eram tudo na vida,\nvocÃª aprendeu que seu valor Ã© muito maior que qualquer pontuaÃ§Ã£o.",
                            relationship: "Naquela noite quando pensou que perdeu o amor,\nvocÃª estava na verdade crescendo para se tornar alguÃ©m que poderia amar mais profundamente.",
                            career: "Naquela noite quando o futuro parecia sem esperanÃ§a,\npreparaÃ§Ã£o estava sendo feita para novos caminhos se abrirem.",
                            family: "Naquela noite que desmoronou diante de feridas familiares,\nvocÃª passou a abraÃ§ar um amor mais amplo.",
                            health: "Naquela noite quando a dor fÃ­sica esmagou seu espÃ­rito,\nvocÃª passou a contemplar o significado da vida mais profundamente.",
                            financial: "Naquela noite passada em desespero econÃ´mico,\nvocÃª passou a perceber o que o valor verdadeiro realmente Ã©.",
                            identity: "Naquela noite que experimentou uma crise de identidade,\na jornada para descobrir seu verdadeiro eu comeÃ§ou.",
                            overwhelm: "Naquela noite que foi esmagado por tudo,\nvocÃª passou a reconhecer seus limites e crescer.",
                            loneliness: "Naquela noite que experimentou solidÃ£o extrema,\num verdadeiro encontro consigo mesmo aconteceu.",
                            failure: "Naquela noite esmagado pelo peso do fracasso,\nvocÃª descobriu a forÃ§a interior para se levantar novamente.",
                            general: "VocÃª parou naquela noite,\nmas hoje comeÃ§ou a caminhar novamente.\nE isso Ã© verdadeiro perdÃ£o."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog
        function showConfirmDialog(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'ì˜ˆ' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ì•„ë‹ˆì˜¤' : 
                               state.currentLanguage === 'pt' ? 'NÃ£o' : 'No';
            
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function createPortalTransition(callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 08...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 08 DOM loaded');
            
            state.currentLanguage = getLanguageFromURL();
            
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            await initializeFirebase();
            
            initializeTemarix();
        });
    </script>
</body>
</html>
        