<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 08: The Night I Embraced My Broken Self</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 08: The Night I Embraced My Broken Self</div>
            <div class="portal-subtitle" id="portalSubtitle">Holding the fragments with tenderness</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">🌌 Portal 08 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 09</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay in this embrace</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me about a night when you felt completely broken... (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: []
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-08",
            nextPortal: "v5-09",
            nextPortalFile: "temarix_v05_09.html"
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve();
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? '오프라인 모드' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 08: 무너졌던 나를 끌어안는 밤",
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 08: 무너졌던 나를 끌어안는 밤",
                portalSubtitle: "부서진 조각들을 다정하게 감싸며",
                portalIntro: "🌌 \"당신이 한밤중에 무너졌던 기억이 있다면,\n그건 어떤 상황이었나요?\"\n\n\"그때의 나는 어떤 모습이었나요?\"\n\"지금의 당신은 그 모습을 어떻게 바라보고 있나요?\"",
                emotionalBridge: "무너짐은 종말처럼 느껴지지만,\n사실은 진짜 자신과 마주하는 시작이기도 합니다.\n\n지금, 그 밤의 나를 안아줄 수 있나요?",
                followUpQuestion: "그 밤의 나를 지금 품에 안고 있다면,\n당신은 어떤 말을 속삭이고 싶나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "이제 그 밤은 상처가 아니라,\n당신을 빛으로 데려온 터널이 되었어요.",
                navigationTitle: "🌌 Portal 08 완료",
                navigationMessage: "당신은 무너졌던 나를 끌어안았습니다.\n\n그 어둠 속에서 홀로 웅크리고 있던 자신을 지금의 당신이 찾아가 안아주었습니다.\n무너짐은 더 이상 부끄러운 기억이 아니라, 진실과 마주한 용기의 밤이 되었습니다.\n\n당신은 이제 어둠 속의 나와 함께 걸을 수 있는 사람입니다.",
                nextPortalBtn: "Portal 09로 이어가기",
                stayPortalBtn: "이 밤과 머물기",
                inputPlaceholder: "완전히 무너져버렸던 밤에 대해 말해주세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중...",
                confirmNextPortal: "Portal 09: 사라지고 싶었던 날의 고백으로 이동하시겠습니까?",
                confirmStay: "이 무너짐과 더 머물며 회복을 깊이 느끼시겠습니까?",
                transitionMessage: "새로운 여정이 시작됩니다..."
            },
            en: {
                title: "Temarix V5 - Portal 08: The Night I Embraced My Broken Self",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 08: The Night I Embraced My Broken Self",
                portalSubtitle: "Holding the fragments with tenderness",
                portalIntro: "🌌 \"If there was a memory of you collapsing in the middle of the night,\nwhat kind of situation was that?\"\n\n\"What did you look like then?\"\n\"How does the current you view that version of yourself?\"",
                emotionalBridge: "Collapse feels like an ending,\nbut it's actually the beginning of facing your true self.\n\nNow, can you embrace that night's version of you?",
                followUpQuestion: "If you were holding that night's version of you in your arms right now,\nwhat would you like to whisper?",
                lightTitle: "✨ Word of Light",
                lightMessage: "Now that night is no longer a wound,\nbut a tunnel that brought you to the light.",
                navigationTitle: "🌌 Portal 08 Complete",
                navigationMessage: "You have embraced your broken self.\n\nThe current you has found and embraced the self that was crouched alone in that darkness.\nCollapse is no longer a shameful memory, but a night of courage when you faced the truth.\n\nYou are now someone who can walk together with the you from the darkness.",
                nextPortalBtn: "Continue to Portal 09",
                stayPortalBtn: "Stay in this embrace",
                inputPlaceholder: "Tell me about a night when you felt completely broken... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 09: Confession of the Day I Wanted to Disappear?",
                confirmStay: "Do you want to stay longer with this collapse to deeply feel the recovery?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 08: A Noite em que Abracei Meu Eu Quebrado",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 08: A Noite em que Abracei Meu Eu Quebrado",
                portalSubtitle: "Segurando os fragmentos com ternura",
                portalIntro: "🌌 \"Se houve uma memória de você desmoronando no meio da noite,\nque tipo de situação foi essa?\"\n\n\"Como você era naquele momento?\"\n\"Como o você atual vê essa versão de si mesmo?\"",
                emotionalBridge: "O colapso parece um fim,\nmas na verdade é o início de enfrentar seu verdadeiro eu.\n\nAgora, você pode abraçar essa versão sua daquela noite?",
                followUpQuestion: "Se você estivesse segurando essa versão sua daquela noite em seus braços agora,\no que gostaria de sussurrar?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Agora aquela noite não é mais uma ferida,\nmas um túnel que te trouxe à luz.",
                navigationTitle: "🌌 Portal 08 Completo",
                navigationMessage: "Você abraçou seu eu quebrado.\n\nO você atual encontrou e abraçou o eu que estava agachado sozinho naquela escuridão.\nO colapso não é mais uma memória vergonhosa, mas uma noite de coragem quando você enfrentou a verdade.\n\nVocê é agora alguém que pode caminhar junto com o você da escuridão.",
                nextPortalBtn: "Continuar para Portal 09",
                stayPortalBtn: "Ficar neste abraço",
                inputPlaceholder: "Conte-me sobre uma noite em que se sentiu completamente quebrado... (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 09: Confissão do Dia em que Quis Desaparecer?",
                confirmStay: "Deseja ficar mais tempo com este colapso para sentir profundamente a recuperação?",
                transitionMessage: "Uma nova jornada começa..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그 밤, 넌 혼자였지만\n완전히 부서지지는 않았어.\n왜냐면 지금 여기에 있으니까.",
                en: "That night, you were alone but\nyou didn't completely break.\nBecause you're here now.",
                pt: "Naquela noite, você estava sozinho mas\nnão se quebrou completamente.\nPorque você está aqui agora."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "무너진 밤이었기에,\n다시 쌓을 수 있는 지금이 있는 거예요.",
                en: "Because it was a night of collapse,\nthere's now a present where you can rebuild.",
                pt: "Porque foi uma noite de colapso,\nhá agora um presente onde você pode reconstruir."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "그 밤의 고요함 속에 있던 너,\n나는 그 아이를 꼭 안아주고 싶어요.",
                en: "You in the silence of that night,\nI want to hold that child tight.",
                pt: "Você no silêncio daquela noite,\neu quero abraçar forte aquela criança."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "밤은 종말처럼 느껴지지만,\n그 밤이 없었다면, 지금의 너도 없었을 거야.",
                en: "Night feels like an end,\nbut without that night, there wouldn't be the current you.",
                pt: "A noite parece um fim,\nmas sem aquela noite, não haveria o você atual."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 무너짐은,\n진짜 나를 다시 그리기 위한 배경이었어요.",
                en: "That collapse was\nthe background for redrawing your true self.",
                pt: "Aquele colapso foi\no fundo para redesenhar seu verdadeiro eu."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "무너졌다는 건,\n진심이 있었다는 뜻이야.\n포기하지 않았다는 증거야.",
                en: "To have collapsed means\nthere was sincerity.\nIt's proof you didn't give up.",
                pt: "Ter desmoronado significa\nque havia sinceridade.\nÉ prova de que você não desistiu."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "그 밤에 네 안에서 태어난 건\n끝이 아니라, 침묵 속의 불씨였어.",
                en: "What was born within you that night\nwasn't an end, but an ember in the silence.",
                pt: "O que nasceu dentro de você naquela noite\nnão foi um fim, mas uma brasa no silêncio."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "마주하지 않으면 회복도 없어요.\n그리고 당신은 지금, 마주하고 있어요.",
                en: "Without facing it, there's no recovery.\nAnd you are facing it now.",
                pt: "Sem enfrentar, não há recuperação.\nE você está enfrentando agora."
            }}
        ];

        // Breakdown situation analysis function
        function analyzeBreakdownType(userInput) {
            const input = userInput.toLowerCase();
            
            const breakdownKeywords = {
                academic: ['exam', 'test', 'grade', 'university', 'college', 'school', 'study', '시험', '성적', '대학', '학교', '공부', 'exame', 'nota', 'universidade', 'escola', 'estudo'],
                relationship: ['breakup', 'divorce', 'fight', 'argument', 'relationship', 'love', '이별', '헤어져', '싸웠', '연애', '사랑', 'término', 'divórcio', 'briga', 'relacionamento', 'amor'],
                career: ['job', 'work', 'career', 'fired', 'promotion', 'interview', '직장', '일', '취업', '면접', '승진', 'trabalho', 'carreira', 'demitido', 'promoção', 'entrevista'],
                family: ['family', 'parents', 'mother', 'father', 'sibling', '가족', '부모', '엄마', '아빠', '형제', 'família', 'pais', 'mãe', 'pai', 'irmão'],
                health: ['sick', 'illness', 'hospital', 'disease', 'pain', '아프', '병원', '질병', '아픔', 'doente', 'doença', 'hospital', 'dor'],
                financial: ['money', 'debt', 'poor', 'financial', 'broke', '돈', '빚', '가난', '경제적', 'dinheiro', 'dívida', 'pobre', 'financeiro'],
                identity: ['identity', 'who am i', 'lost', 'confused', 'purpose', '정체성', '나는 누구', '길을 잃었', '혼란', '목적', 'identidade', 'quem sou', 'perdido', 'confuso', 'propósito'],
                overwhelm: ['overwhelmed', 'too much', 'pressure', 'stressed', 'exhausted', '벅찬', '너무 많은', '압박', '스트레스', '지친', 'sobrecarregado', 'muito', 'pressão', 'estressado', 'exausto'],
                loneliness: ['alone', 'lonely', 'isolated', 'nobody', 'empty', '혼자', '외로운', '고립된', '아무도', '비어있는', 'sozinho', 'solitário', 'isolado', 'ninguém', 'vazio'],
                failure: ['failed', 'failure', 'mistake', 'wrong', 'disappointed', '실패', '잘못', '실수', '실망', 'fracassou', 'fracasso', 'erro', 'errado', 'decepcionado']
            };
            
            let detectedTypes = [];
            for (const [type, keywords] of Object.entries(breakdownKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedTypes.push(type);
                        break;
                    }
                }
            }
            
            if (detectedTypes.length === 0) {
                detectedTypes = ['general'];
            }
            
            return detectedTypes[0];
        }
        
        // Response characters with breakdown-based responses
        const responseCharacters = [
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "그 밤, 성적이나 시험이 당신의 전부인 것처럼 느껴졌겠지만,\n지금의 당신은 그것보다 훨씬 큰 존재예요.",
                            relationship: "사랑하는 사람을 잃은 밤의 공허함이 얼마나 깊었을지...\n그 아픔 속에서도 당신은 사랑할 줄 아는 마음을 잃지 않았어요.",
                            career: "꿈이 무너진 것 같았던 그 밤,\n사실은 새로운 가능성의 문이 열리는 순간이었을지도 몰라요.",
                            family: "가족과의 갈등이나 상실 앞에서 무너진 그 밤,\n당신은 혼자가 아니었어요. 그 아픔이 당신을 더 깊은 사람으로 만들었어요.",
                            health: "몸의 아픔이 마음까지 무너뜨렸던 그 밤,\n당신은 생명의 소중함을 더 깊이 이해하게 되었어요.",
                            financial: "경제적 어려움 앞에서 절망했던 그 밤,\n당신은 돈보다 소중한 것들을 발견하게 되었어요.",
                            identity: "자신이 누구인지 모르겠던 그 밤의 혼란 속에서,\n진짜 당신을 찾아가는 여정이 시작되었어요.",
                            overwhelm: "모든 것이 버거웠던 그 밤,\n당신은 자신의 한계를 인정하고 받아들이는 법을 배웠어요.",
                            loneliness: "세상에 홀로 남겨진 것 같았던 그 밤,\n당신은 자신과 진정으로 마주하는 시간을 가졌어요.",
                            failure: "실패의 무게에 짓눌렸던 그 밤,\n당신은 다시 일어설 수 있는 내면의 힘을 발견했어요.",
                            general: "무너졌던 그 밤이 지금의 당신을 만들었어요.\n그 어둠을 통과한 당신은 이제 빛을 더 깊이 이해해요."
                        },
                        en: {
                            academic: "That night when grades or exams felt like your everything,\nbut the current you is a much greater existence than that.",
                            relationship: "How deep the emptiness must have been on the night you lost someone you loved...\nEven in that pain, you didn't lose your heart that knows how to love.",
                            career: "That night when your dreams seemed to collapse,\nmight actually have been the moment a door to new possibilities opened.",
                            family: "That night you collapsed before family conflict or loss,\nyou weren't alone. That pain made you a deeper person.",
                            health: "That night when physical pain brought down your spirit too,\nyou came to understand the preciousness of life more deeply.",
                            financial: "That night you despaired before financial difficulties,\nyou discovered things more precious than money.",
                            identity: "In the confusion of that night when you didn't know who you were,\nthe journey to find your true self began.",
                            overwhelm: "That night when everything felt overwhelming,\nyou learned to acknowledge and accept your limits.",
                            loneliness: "That night when you felt left alone in the world,\nyou had time to truly face yourself.",
                            failure: "That night crushed by the weight of failure,\nyou discovered the inner strength to rise again.",
                            general: "That night when you collapsed created the current you.\nHaving passed through that darkness, you now understand light more deeply."
                        },
                        pt: {
                            academic: "Naquela noite quando notas ou exames pareciam ser seu tudo,\nmas o você atual é uma existência muito maior que isso.",
                            relationship: "Quão profundo deve ter sido o vazio na noite em que perdeu alguém que amava...\nMesmo naquela dor, você não perdeu seu coração que sabe amar.",
                            career: "Naquela noite quando seus sonhos pareciam desmoronar,\ntalvez tenha sido realmente o momento em que uma porta para novas possibilidades se abriu.",
                            family: "Naquela noite que você desmoronou diante de conflito ou perda familiar,\nvocê não estava sozinho. Aquela dor te tornou uma pessoa mais profunda.",
                            health: "Naquela noite quando a dor física derrubou seu espírito também,\nvocê passou a entender a preciosidade da vida mais profundamente.",
                            financial: "Naquela noite que você se desesperou diante das dificuldades financeiras,\nvocê descobriu coisas mais preciosas que dinheiro.",
                            identity: "Na confusão daquela noite quando não sabia quem era,\na jornada para encontrar seu verdadeiro eu começou.",
                            overwhelm: "Naquela noite quando tudo parecia esmagador,\nvocê aprendeu a reconhecer e aceitar seus limites.",
                            loneliness: "Naquela noite quando se sentiu abandonado sozinho no mundo,\nvocê teve tempo para realmente enfrentar a si mesmo.",
                            failure: "Naquela noite esmagado pelo peso do fracasso,\nvocê descobriu a força interior para se levantar novamente.",
                            general: "Aquela noite quando você desmoronou criou o você atual.\nTendo passado por aquela escuridão, você agora entende a luz mais profundamente."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "그 밤 공부방이나 도서관에서 울었던 당신,\n그 눈물은 노력의 결정이었어요.",
                            relationship: "사랑하는 사람을 보내야 했던 그 밤,\n당신의 마음은 진짜 사랑이 무엇인지 배웠어요.",
                            career: "꿈이 무너진 것 같던 그 밤,\n사실은 더 큰 꿈을 품기 위한 공간이 만들어지고 있었어요.",
                            family: "가족의 아픔 앞에서 무력했던 그 밤,\n당신은 사랑의 깊이를 더욱 이해하게 되었어요.",
                            health: "몸이 아파 절망했던 그 밤,\n당신은 건강한 하루하루의 소중함을 깨달았어요.",
                            financial: "돈 때문에 잠 못 이뤘던 그 밤,\n진정한 풍요로움이 무엇인지 생각하게 되었어요.",
                            identity: "내가 누구인지 몰라 방황했던 그 밤,\n진짜 자신을 찾아가는 여행의 시작이었어요.",
                            overwhelm: "모든 게 너무 벅차 주저앉았던 그 밤,\n당신은 자신을 보호하는 법을 배웠어요.",
                            loneliness: "세상에 혼자 남겨진 것 같던 그 밤,\n당신은 자신과 가장 깊이 대화했어요.",
                            failure: "실패로 무너졌던 그 밤,\n다시 일어설 수 있는 힘이 당신 안에 있음을 증명했어요.",
                            general: "그렇게 무너졌던 당신을 지금의 당신이 안았을 때,\n회복은 이미 시작되었어요."
                        },
                        en: {
                            academic: "You who cried in the study room or library that night,\nthose tears were crystals of effort.",
                            relationship: "That night you had to let go of someone you loved,\nyour heart learned what true love really is.",
                            career: "That night when your dreams seemed to collapse,\nspace was actually being created to embrace even bigger dreams.",
                            family: "That night you felt powerless before family pain,\nyou came to understand the depth of love even more.",
                            health: "That night you despaired from physical pain,\nyou realized the preciousness of each healthy day.",
                            financial: "That night you couldn't sleep because of money worries,\nyou began to think about what true abundance really is.",
                            identity: "That night you wandered not knowing who you were,\nit was the beginning of a journey to find your true self.",
                            overwhelm: "That night you collapsed because everything was too overwhelming,\nyou learned how to protect yourself.",
                            loneliness: "That night you felt left alone in the world,\nyou had the deepest conversation with yourself.",
                            failure: "That night you collapsed from failure,\nyou proved that the power to rise again exists within you.",
                            general: "When the current you embraced the you who had collapsed like that,\nrecovery had already begun."
                        },
                        pt: {
                            academic: "Você que chorou na sala de estudos ou biblioteca naquela noite,\naquelas lágrimas eram cristais de esforço.",
                            relationship: "Naquela noite que teve que deixar ir alguém que amava,\nseu coração aprendeu o que o amor verdadeiro realmente é.",
                            career: "Naquela noite quando seus sonhos pareciam desmoronar,\nespaço estava sendo criado para abraçar sonhos ainda maiores.",
                            family: "Naquela noite que se sentiu impotente diante da dor familiar,\nvocê passou a entender a profundidade do amor ainda mais.",
                            health: "Naquela noite que se desesperou pela dor física,\nvocê percebeu a preciosidade de cada dia saudável.",
                            financial: "Naquela noite que não conseguiu dormir por preocupações com dinheiro,\nvocê começou a pensar sobre o que a verdadeira abundância realmente é.",
                            identity: "Naquela noite que vagou sem saber quem era,\nfoi o início de uma jornada para encontrar seu verdadeiro eu.",
                            overwhelm: "Naquela noite que desmoronou porque tudo era muito esmagador,\nvocê aprendeu como se proteger.",
                            loneliness: "Naquela noite que se sentiu abandonado sozinho no mundo,\nvocê teve a conversa mais profunda consigo mesmo.",
                            failure: "Naquela noite que desmoronou pelo fracasso,\nvocê provou que o poder de se levantar novamente existe dentro de você.",
                            general: "Quando o você atual abraçou o você que havia desmoronado assim,\na recuperação já havia começado."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const breakdownType = analyzeBreakdownType(userInput);
                    
                    const responses = {
                        ko: {
                            academic: "성적이 인생의 전부인 줄 알았던 그 밤,\n당신은 자신의 가치가 점수보다 훨씬 크다는 걸 배웠어요.",
                            relationship: "사랑을 잃었다고 생각했던 그 밤,\n사실은 더 깊은 사랑을 할 수 있는 사람으로 성장하고 있었어요.",
                            career: "미래가 막막했던 그 밤,\n새로운 길이 열리기 위한 준비가 되고 있었어요.",
                            family: "가족의 상처 앞에서 무너진 그 밤,\n당신은 더 넓은 사랑을 품게 되었어요.",
                            health: "몸의 고통이 마음을 짓눌렀던 그 밤,\n생명의 의미를 더 깊이 성찰하게 되었어요.",
                            financial: "경제적 절망 속에서 보낸 그 밤,\n진정한 가치가 무엇인지 깨닫게 되었어요.",
                            identity: "정체성의 위기를 겪었던 그 밤,\n진짜 자신을 발견하는 여정이 시작되었어요.",
                            overwhelm: "모든 것에 압도되었던 그 밤,\n자신의 한계를 인정하고 성장하게 되었어요.",
                            loneliness: "극도의 외로움을 겪었던 그 밤,\n자신과의 진정한 만남이 일어났어요.",
                            failure: "실패의 무게에 짓눌렸던 그 밤,\n다시 일어날 수 있는 내면의 힘을 발견했어요.",
                            general: "당신은 그 밤에 멈췄지만,\n오늘 다시 걷기 시작했어요.\n그리고 그것이 진짜 용서예요."
                        },
                        en: {
                            academic: "That night when you thought grades were everything in life,\nyou learned that your worth is much greater than any score.",
                            relationship: "That night when you thought you lost love,\nyou were actually growing into someone who could love more deeply.",
                            career: "That night when the future seemed hopeless,\npreparation was being made for new paths to open.",
                            family: "That night you collapsed before family wounds,\nyou came to embrace a broader love.",
                            health: "That night when physical pain crushed your spirit,\nyou came to contemplate the meaning of life more deeply.",
                            financial: "That night spent in economic despair,\nyou came to realize what true value really is.",
                            identity: "That night you experienced an identity crisis,\nthe journey to discover your true self began.",
                            overwhelm: "That night you were overwhelmed by everything,\nyou came to acknowledge your limits and grow.",
                            loneliness: "That night you experienced extreme loneliness,\na true meeting with yourself took place.",
                            failure: "That night crushed by the weight of failure,\nyou discovered the inner strength to rise again.",
                            general: "You stopped that night,\nbut today you began walking again.\nAnd that is true forgiveness."
                        },
                        pt: {
                            academic: "Naquela noite quando pensou que notas eram tudo na vida,\nvocê aprendeu que seu valor é muito maior que qualquer pontuação.",
                            relationship: "Naquela noite quando pensou que perdeu o amor,\nvocê estava na verdade crescendo para se tornar alguém que poderia amar mais profundamente.",
                            career: "Naquela noite quando o futuro parecia sem esperança,\npreparação estava sendo feita para novos caminhos se abrirem.",
                            family: "Naquela noite que desmoronou diante de feridas familiares,\nvocê passou a abraçar um amor mais amplo.",
                            health: "Naquela noite quando a dor física esmagou seu espírito,\nvocê passou a contemplar o significado da vida mais profundamente.",
                            financial: "Naquela noite passada em desespero econômico,\nvocê passou a perceber o que o valor verdadeiro realmente é.",
                            identity: "Naquela noite que experimentou uma crise de identidade,\na jornada para descobrir seu verdadeiro eu começou.",
                            overwhelm: "Naquela noite que foi esmagado por tudo,\nvocê passou a reconhecer seus limites e crescer.",
                            loneliness: "Naquela noite que experimentou solidão extrema,\num verdadeiro encontro consigo mesmo aconteceu.",
                            failure: "Naquela noite esmagado pelo peso do fracasso,\nvocê descobriu a força interior para se levantar novamente.",
                            general: "Você parou naquela noite,\nmas hoje começou a caminhar novamente.\nE isso é verdadeiro perdão."
                        }
                    };
                    
                    return responses[lang][breakdownType] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog
        function showConfirmDialog(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            yesBtn.textContent = state.currentLanguage === 'ko' ? '예' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? '아니오' : 
                               state.currentLanguage === 'pt' ? 'Não' : 'No';
            
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function createPortalTransition(callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 08...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 08 DOM loaded');
            
            state.currentLanguage = getLanguageFromURL();
            
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            await initializeFirebase();
            
            initializeTemarix();
        });
    </script>
</body>
</html>
        