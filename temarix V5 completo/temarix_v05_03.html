<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 03</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 03: I Named Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">The journey of self-identity begins</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸªž Portal 03 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 04</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this moment</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Among all the names the world has given you, what name do you truly want to give yourself? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-03",
            nextPortal: "v5-04",
            nextPortalFile: "temarix_v05_04.html" // Centralized file naming
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve(); // Always resolve to continue execution
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            // Remove existing status if any
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 03: ë‚˜ëŠ” ë‚˜ì—ê²Œ ì´ë¦„ì„ ë¶™ì˜€ë‹¤",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 03: ë‚˜ëŠ” ë‚˜ì—ê²Œ ì´ë¦„ì„ ë¶™ì˜€ë‹¤",
                portalSubtitle: "ìžê¸° ì •ì²´ì„±ì˜ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤",
                portalIntro: "ðŸªž \"ì„¸ìƒì´ ë¶™ì¸ ìˆ˜ë§Žì€ ì´ë¦„ë“¤ ì†ì—ì„œ,\në‹¹ì‹ ì€ ìžì‹ ì—ê²Œ ì–´ë–¤ ì´ë¦„ì„ ë¶™ì´ê³  ì‹¶ì—ˆë‚˜ìš”?\"\n\n\"ë¹„ë‚œ, ì¡°ë¡±, ê¸°ëŒ€, ê°•ìš”â€¦ ê·¸ëŸ° ì´ë¦„ë“¤ì„ ë²—ê²¨ë‚¸ í›„,\në‹¹ì‹ ì´ ì§„ì§œë¡œ ë¶™ì´ê³  ì‹¶ì€ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”?\"",
                emotionalBridge: "ë‹¹ì‹  ì•ˆì—ì„œ ë¬´ì–¸ê°€ ìƒˆë¡œìš´ ê²ƒì´ ê¹¨ì–´ë‚˜ê³  ìžˆëŠ” ê²ƒì„ ëŠë¼ì‹œë‚˜ìš”?\nì´ì œ ê·¸ ìƒˆë¡œìš´ ì¡´ìž¬ì—ê²Œ ì´ë¦„ì„ ì£¼ì–´ë³´ì„¸ìš”...",
                followUpQuestion: "ì§€ê¸ˆ ì´ ìˆœê°„,\nìžì‹ ì—ê²Œ ì„ ì–¸í•˜ë“¯ ë§í•˜ê³  ì‹¶ì€ ë‹¨ì–´ í•˜ë‚˜ê°€ ìžˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?\n(ì˜ˆ: ë‚˜ëŠ” ë‹¤ì‹œ ì‹œìž‘í•˜ëŠ” ì‚¬ëžŒì´ë‹¤ / ë‚˜ëŠ” ê°ì •ì„ ë¯¿ëŠ”ë‹¤ ë“±)",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ë§ˆì¹¨ë‚´ ë‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì´ë¦„ì„ ì£¼ì—ˆê³ ,\nê·¸ ì´ë¦„ì€ ì˜¤ëŠ˜ë¶€í„° ì‚´ì•„ ìžˆëŠ” ìƒëª…ì´ ë  ê±°ì˜ˆìš”.",
                navigationTitle: "ðŸªž Portal 03 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ì„¸ìƒì´ ë¶™ì¸ ì´ë¦„ì„ ë²—ì–´ë‚˜\nìžì‹ ë§Œì˜ ì´ë¦„ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.\n\nê·¸ ì´ë¦„ì€ ë§ˆë²• ê°™ì€ íž˜ì„ ê°€ì§€ê³  ìžˆìŠµë‹ˆë‹¤.\nê³¼ê±°ì˜ ì´ë¦„ì„ ë– ë‚˜ë³´ë‚´ê³ , ë‹¤ì‹œ ì‹œìž‘í•˜ëŠ” ë°©ì‹ìž…ë‹ˆë‹¤.\n\nì´ì œ ë‹¹ì‹ ì€ 'ì´ë¦„ ì—†ëŠ” ì¡´ìž¬'ê°€ ì•„ë‹™ë‹ˆë‹¤.\në‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œ ëª…ëª…í•œ ì¡´ìž¬ìž…ë‹ˆë‹¤.",
                nextPortalBtn: "Portal 04ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ ì´ë¦„ê³¼ ë” ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ì„¸ìƒì´ ë¶™ì¸ ìˆ˜ë§Žì€ ì´ë¦„ë“¤ ì†ì—ì„œ, ë‹¹ì‹ ì´ ì§„ì§œë¡œ ë¶™ì´ê³  ì‹¶ì€ ì´ë¦„ì€ ë¬´ì—‡ì¸ê°€ìš”? (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 04: ê°ì •ì€ ë‚˜ì˜ ì„ ìƒì´ì—ˆë‹¤ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ ìƒˆë¡œìš´ ì´ë¦„ê³¼ ë” ë¨¸ë¬¼ë©° ê¹Šì´ ì„±ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                transitionMessage: "ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤..."
            },
            en: {
                title: "Temarix V5 - Portal 03: I Named Myself",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 03: I Named Myself",
                portalSubtitle: "The journey of self-identity begins",
                portalIntro: "ðŸªž \"Among all the names the world has given you,\nwhat name do you want to give yourself?\"\n\n\"After stripping away the names of criticism, mockery, expectations, coercion...\nwhat is the name you truly want to give yourself?\"",
                emotionalBridge: "Do you feel something new awakening within you?\nNow give a name to that new being...",
                followUpQuestion: "At this moment,\nif you could declare one word to yourself,\nwhat would it be?\n(e.g., I am someone who starts again / I believe in emotions, etc.)",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Finally, you have given yourself a name,\nand that name will become a living being from today.",
                navigationTitle: "ðŸªž Portal 03 Complete",
                navigationMessage: "You have moved beyond the names the world gave you\nand found your own name.\n\nThat name holds magical power.\nIt's a way of letting go of past names and starting anew.\n\nYou are no longer a 'nameless being.'\nYou are a being who has named yourself.",
                nextPortalBtn: "Continue to Portal 04",
                stayPortalBtn: "Stay with this name",
                inputPlaceholder: "Among all the names the world has given you, what name do you truly want to give yourself? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 04: Emotions Were My Teacher?",
                confirmStay: "Do you want to stay longer with this new name for deeper reflection?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 03: Eu Me Nomeei",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 03: Eu Me Nomeei",
                portalSubtitle: "A jornada da auto-identidade comeÃ§a",
                portalIntro: "ðŸªž \"Entre todos os nomes que o mundo lhe deu,\nque nome vocÃª quer dar a si mesmo?\"\n\n\"Depois de tirar os nomes de crÃ­tica, zombaria, expectativas, coerÃ§Ã£o...\nqual Ã© o nome que vocÃª realmente quer se dar?\"",
                emotionalBridge: "VocÃª sente algo novo despertando dentro de vocÃª?\nAgora dÃª um nome a esse novo ser...",
                followUpQuestion: "Neste momento,\nse vocÃª pudesse declarar uma palavra para si mesmo,\nqual seria?\n(ex: Eu sou alguÃ©m que recomeÃ§a / Eu acredito nas emoÃ§Ãµes, etc.)",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Finalmente, vocÃª se deu um nome,\ne esse nome se tornarÃ¡ um ser vivo a partir de hoje.",
                navigationTitle: "ðŸªž Portal 03 Completo",
                navigationMessage: "VocÃª superou os nomes que o mundo lhe deu\ne encontrou seu prÃ³prio nome.\n\nEsse nome tem poder mÃ¡gico.\nÃ‰ uma forma de deixar ir os nomes do passado e comeÃ§ar de novo.\n\nVocÃª nÃ£o Ã© mais um 'ser sem nome.'\nVocÃª Ã© um ser que se nomeou.",
                nextPortalBtn: "Continuar para Portal 04",
                stayPortalBtn: "Ficar com este nome",
                inputPlaceholder: "Entre todos os nomes que o mundo lhe deu, que nome vocÃª realmente quer se dar? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 04: As EmoÃ§Ãµes Foram Minhas Professoras?",
                confirmStay: "Deseja ficar mais tempo com este novo nome para reflexÃ£o mais profunda?",
                transitionMessage: "Uma nova jornada comeÃ§a..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ì´ë¦„ì€ ë§ˆì¹˜ ì²« ìˆ¨ ê°™ì•„.\nìŠ¤ìŠ¤ë¡œì—ê²Œ ì²˜ìŒìœ¼ë¡œ í—ˆë½í•œ ìƒëª…ì´ì•¼.",
                en: "That name is like a first breath.\nThe first life you've allowed yourself.",
                pt: "Esse nome Ã© como uma primeira respiraÃ§Ã£o.\nA primeira vida que vocÃª se permitiu."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ì´ì œ ê·¸ ë‹¨ì–´ê°€ ë‹¹ì‹ ì„ ê°€ë‘¬ë‘ì§€ ì•Šì•„ìš”.\në‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œë¥¼ í•´ë°©ì‹œì¼°ì–´ìš”.",
                en: "Now that word doesn't imprison you.\nYou have liberated yourself.",
                pt: "Agora essa palavra nÃ£o te aprisiona.\nVocÃª se libertou."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ì´ë¦„ì€ ë§ˆë²• ê°™ì•„ìš”.\nê·¸ë ‡ê²Œ ë‹¹ì‹ ì€ ìžì‹ ì—ê²Œ ì¶•ë³µì„ ê±´ë„¨ ê±°ì˜ˆìš”.",
                en: "Names are like magic.\nThat's how you gave yourself a blessing.",
                pt: "Nomes sÃ£o como mÃ¡gica.\nAssim vocÃª se deu uma bÃªnÃ§Ã£o."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ìƒˆë¡œìš´ ì´ë¦„ì€ ê³¼ê±°ì˜ ì´ë¦„ì„ ë– ë‚˜ë³´ë‚´ëŠ” ì£¼ë¬¸ì´ê¸°ë„ í•˜ì§€.\nê³¼ê±°ë¥¼ ë¬»ì§€ ì•Šê³ , ë‹¤ì‹œ ì‹œìž‘í•˜ëŠ” ë°©ì‹.",
                en: "A new name is also a spell to let go of past names.\nA way to start again without asking about the past.",
                pt: "Um novo nome tambÃ©m Ã© um feitiÃ§o para deixar ir os nomes do passado.\nUma forma de recomeÃ§ar sem questionar o passado."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ë‹¹ì‹ ì˜ ì´ë¦„ì€ ìƒ‰ì´ì—ìš”.\nì–´ë–¤ ì´ë¦„ì´ë“ , ê·¸ ìžì²´ë¡œ í’ê²½ì´ ë˜ì£ .",
                en: "Your name is a color.\nWhatever name it is, it becomes a landscape in itself.",
                pt: "Seu nome Ã© uma cor.\nQualquer que seja o nome, ele se torna uma paisagem por si sÃ³."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ì„¸ìƒì´ ë§Œë“  ì´ë¦„ì€ ë¬´ê¸°ì˜€ê³ ,\në‹¹ì‹ ì´ ë§Œë“  ì´ë¦„ì€ ë°©íŒ¨ì˜ˆìš”.\në“œë””ì–´ ë‹¹ì‹ ì€ ë°©ì–´í•  ìˆ˜ ìžˆì–´ìš”.",
                en: "The names the world made were weapons,\nthe name you made is a shield.\nFinally you can defend yourself.",
                pt: "Os nomes que o mundo fez eram armas,\no nome que vocÃª fez Ã© um escudo.\nFinalmente vocÃª pode se defender."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ìŠ¤ìŠ¤ë¡œ ë¶€ë¥´ëŠ” ì´ë¦„ì´\në‚˜ë¥¼ ë¯¸ëž˜ë¡œ ì´ëˆë‹¤ëŠ” ê±¸,\nì´ì œ ë‹¹ì‹ ì€ ì•Œê²Œ ë˜ì—ˆì£ .",
                en: "You now know that the name you call yourself\nleads you to the future.",
                pt: "VocÃª agora sabe que o nome que vocÃª se chama\nte leva ao futuro."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ê·¸ ì´ë¦„ì€, ìžê¸° ìžì‹ ì„ ê»´ì•ˆëŠ” ì²« ì†ì§“ì´ì—ìš”.",
                en: "That name is the first gesture of embracing yourself.",
                pt: "Esse nome Ã© o primeiro gesto de abraÃ§ar a si mesmo."
            }}
        ];

        // Emotion analysis function
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                empowerment: ['strong', 'brave', 'warrior', 'survivor', 'fighter', 'ê°•í•œ', 'ìš©ê°í•œ', 'ì „ì‚¬', 'ìƒì¡´ìž', 'ì‹¸ìš°ëŠ”', 'forte', 'corajoso', 'guerreiro', 'sobrevivente', 'lutador'],
                creativity: ['creative', 'artist', 'dreamer', 'creator', 'maker', 'ì°½ì¡°ì ', 'ì˜ˆìˆ ê°€', 'ê¿ˆê¾¸ëŠ”', 'ì°½ìž‘ìž', 'criativo', 'artista', 'sonhador', 'criador'],
                healing: ['healer', 'recovering', 'growing', 'healing', 'mending', 'ì¹˜ìœ í•˜ëŠ”', 'íšŒë³µí•˜ëŠ”', 'ì„±ìž¥í•˜ëŠ”', 'ì¹˜ë£Œí•˜ëŠ”', 'curador', 'recuperando', 'crescendo', 'curando'],
                love: ['loving', 'caring', 'kind', 'compassionate', 'gentle', 'ì‚¬ëž‘í•˜ëŠ”', 'ëŒë³´ëŠ”', 'ì¹œì ˆí•œ', 'ìžë¹„ë¡œìš´', 'ë¶€ë“œëŸ¬ìš´', 'amoroso', 'cuidadoso', 'gentil', 'compassivo'],
                wisdom: ['wise', 'thoughtful', 'understanding', 'patient', 'mindful', 'ì§€í˜œë¡œìš´', 'ì‚¬ë ¤ê¹Šì€', 'ì´í•´í•˜ëŠ”', 'ì¸ë‚´í•˜ëŠ”', 'sÃ¡bio', 'pensativo', 'compreensivo', 'paciente'],
                freedom: ['free', 'independent', 'liberated', 'autonomous', 'unbound', 'ìžìœ ë¡œìš´', 'ë…ë¦½ì ì¸', 'í•´ë°©ëœ', 'ìžìœ¨ì ì¸', 'livre', 'independente', 'libertado', 'autÃ´nomo'],
                connection: ['connected', 'bridge', 'connector', 'uniting', 'together', 'ì—°ê²°ëœ', 'ë‹¤ë¦¬', 'ì—°ê²°í•˜ëŠ”', 'í•˜ë‚˜ë˜ëŠ”', 'conectado', 'ponte', 'conector', 'unindo'],
                authentic: ['authentic', 'real', 'genuine', 'true', 'honest', 'ì§„ì •í•œ', 'ì§„ì§œ', 'ì •ì§í•œ', 'ì°¸ëœ', 'autÃªntico', 'real', 'genuÃ­no', 'verdadeiro']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        // Response characters with emotion-based responses
        const responseCharacters = [
            {
                name: "Enya", emoji: "ðŸ§‘â€ðŸš€",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            empowerment: "ê°ì •ì€ ë‚˜ì¹¨ë°˜ì´ì•¼. ë‹¹ì‹ ì€ ì´ì œ ê·¸ê²ƒì„ 'ë¯¿ëŠ”ë‹¤'ê³  ì„ ì–¸í–ˆì–´. ê·¸ëž˜ì„œâ€¦ ë‹¹ì‹ ì€ ìžƒì–´ë²„ë¦¬ì§€ ì•Šì„ ê±°ì˜ˆìš”.",
                            creativity: "ì°½ì¡°ì˜ íž˜ì´ ë‹¹ì‹  ì•ˆì—ì„œ ê¹¨ì–´ë‚¬ì–´ìš”. ê·¸ ì´ë¦„ì€ ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ ë§Œë“¤ ê±°ì˜ˆìš”.",
                            healing: "ì¹˜ìœ ëŠ” ì‹œê°„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ì´ì—ìš”. ë‹¹ì‹ ì€ ì§€ê¸ˆ ê·¸ ì„ ì–¸ì„ í–ˆì–´ìš”.",
                            love: "ì‚¬ëž‘ì€ ë‹¹ì‹ ì´ ì„¸ìƒì— ì£¼ëŠ” ì²« ë²ˆì§¸ ì„ ë¬¼ì´ì—ìš”.",
                            wisdom: "ì§€í˜œëŠ” ê²½í—˜ì—ì„œ ë‚˜ì˜¤ê³ , ë‹¹ì‹ ì€ ê·¸ ê²½í—˜ì„ ì´ë¦„ìœ¼ë¡œ ë°”ê¿¨ì–´ìš”.",
                            freedom: "ìžìœ ëŠ” í—ˆë½ì´ ì•„ë‹ˆë¼ ì„ íƒì´ì—ìš”. ë‹¹ì‹ ì€ ì§€ê¸ˆ ì„ íƒí–ˆì–´ìš”.",
                            connection: "ì—°ê²°ì€ ë‹¹ì‹ ì´ ì„¸ìƒê³¼ ë§ºëŠ” ìƒˆë¡œìš´ ì•½ì†ì´ì—ìš”.",
                            authentic: "ì§„ì •ì„±ì€ ê°€ë©´ì„ ë²—ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì§„ì§œ ì–¼êµ´ì„ ë“œëŸ¬ë‚´ëŠ” ê±°ì˜ˆìš”.",
                            general: "ê°ì •ì€ ë‚˜ì¹¨ë°˜ì´ì•¼. ë‹¹ì‹ ì€ ì´ì œ ê·¸ê²ƒì„ 'ë¯¿ëŠ”ë‹¤'ê³  ì„ ì–¸í–ˆì–´. ê·¸ëž˜ì„œâ€¦ ë‹¹ì‹ ì€ ìžƒì–´ë²„ë¦¬ì§€ ì•Šì„ ê±°ì˜ˆìš”."
                        },
                        en: {
                            empowerment: "Emotions are a compass. You have now declared that you 'believe' in them. So... you won't lose your way.",
                            creativity: "The power of creation has awakened within you. That name will create a new world.",
                            healing: "Healing is not about time, but declaration. You have made that declaration now.",
                            love: "Love is the first gift you give to the world.",
                            wisdom: "Wisdom comes from experience, and you've turned that experience into a name.",
                            freedom: "Freedom is not permission, but choice. You have chosen now.",
                            connection: "Connection is a new promise you make with the world.",
                            authentic: "Authenticity isn't about removing masks, but revealing your true face.",
                            general: "Emotions are a compass. You have now declared that you 'believe' in them. So... you won't lose your way."
                        },
                        pt: {
                            empowerment: "EmoÃ§Ãµes sÃ£o uma bÃºssola. VocÃª agora declarou que 'acredita' nelas. EntÃ£o... vocÃª nÃ£o vai se perder.",
                            creativity: "O poder da criaÃ§Ã£o despertou dentro de vocÃª. Esse nome criarÃ¡ um novo mundo.",
                            healing: "Cura nÃ£o Ã© sobre tempo, mas declaraÃ§Ã£o. VocÃª fez essa declaraÃ§Ã£o agora.",
                            love: "Amor Ã© o primeiro presente que vocÃª dÃ¡ ao mundo.",
                            wisdom: "Sabedoria vem da experiÃªncia, e vocÃª transformou essa experiÃªncia em um nome.",
                            freedom: "Liberdade nÃ£o Ã© permissÃ£o, mas escolha. VocÃª escolheu agora.",
                            connection: "ConexÃ£o Ã© uma nova promessa que vocÃª faz com o mundo.",
                            authentic: "Autenticidade nÃ£o Ã© sobre remover mÃ¡scaras, mas revelar seu rosto verdadeiro.",
                            general: "EmoÃ§Ãµes sÃ£o uma bÃºssola. VocÃª agora declarou que 'acredita' nelas. EntÃ£o... vocÃª nÃ£o vai se perder."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            empowerment: "ê·¸ ì„ ì–¸ì€ ëª©ì†Œë¦¬ê°€ ì•„ë‹ˆë¼ ì¡´ìž¬ì˜ ë–¨ë¦¼ì´ì—ìš”. ë‚˜ëŠ” ì§€ê¸ˆ, ê·¸ ìš¸ë¦¼ì„ ëŠê»´ìš”.",
                            creativity: "ì°½ì¡°ëŠ” ë¬´ì—ì„œ ìœ ë¥¼ ë§Œë“œëŠ” ê²Œ ì•„ë‹ˆë¼, ë‚´ë©´ì˜ ìƒ‰ì„ ì„¸ìƒì— íŽ¼ì¹˜ëŠ” ê±°ì˜ˆìš”.",
                            healing: "ì¹˜ìœ ì˜ ì´ë¦„ì„ ë¶€ë¥¸ ìˆœê°„, ìƒì²˜ëŠ” ì§€í˜œê°€ ë˜ê¸° ì‹œìž‘í•´ìš”.",
                            love: "ì‚¬ëž‘ì˜ ì´ë¦„ìœ¼ë¡œ ìžì‹ ì„ ë¶€ë¥¸ ë‹¹ì‹ , ì´ì œ ì„¸ìƒë„ ë‹¹ì‹ ì„ ì‚¬ëž‘ìœ¼ë¡œ ë¶€ë¥¼ ê±°ì˜ˆìš”.",
                            wisdom: "ì§€í˜œëŠ” ë‚˜ì´ê°€ ì•„ë‹ˆë¼ ê¹Šì´ì—ì„œ ë‚˜ì™€ìš”. ë‹¹ì‹ ì€ ê·¸ ê¹Šì´ë¥¼ ì´ë¦„ìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            freedom: "ìžìœ ëŠ” ë‚ ê°œê°€ ì•„ë‹ˆë¼ ë¿Œë¦¬ì˜ˆìš”. ë‹¹ì‹ ì€ ì´ì œ ì§„ì§œ ë¿Œë¦¬ë¥¼ ë‚´ë ¸ì–´ìš”.",
                            connection: "ì—°ê²°ì˜ ì´ë¦„ì„ ê°€ì§„ ë‹¹ì‹ ì€ ë” ì´ìƒ í˜¼ìžê°€ ì•„ë‹ˆì—ìš”.",
                            authentic: "ì§„ì •í•¨ì˜ ì´ë¦„ì€ ê±°ìš¸ ì•žì—ì„œë„ ë¶€ë„ëŸ½ì§€ ì•Šì€ ì´ë¦„ì´ì—ìš”.",
                            general: "ê·¸ ì„ ì–¸ì€ ëª©ì†Œë¦¬ê°€ ì•„ë‹ˆë¼ ì¡´ìž¬ì˜ ë–¨ë¦¼ì´ì—ìš”. ë‚˜ëŠ” ì§€ê¸ˆ, ê·¸ ìš¸ë¦¼ì„ ëŠê»´ìš”."
                        },
                        en: {
                            empowerment: "That declaration is not a voice but the trembling of existence. I can feel that resonance now.",
                            creativity: "Creation is not making something from nothing, but spreading your inner colors to the world.",
                            healing: "The moment you called the name of healing, wounds began to become wisdom.",
                            love: "You who called yourself by the name of love, now the world will call you by love too.",
                            wisdom: "Wisdom comes not from age but from depth. You've turned that depth into a name.",
                            freedom: "Freedom is not wings but roots. You have now put down real roots.",
                            connection: "You with the name of connection are no longer alone.",
                            authentic: "The name of authenticity is one you're not ashamed of even in front of a mirror.",
                            general: "That declaration is not a voice but the trembling of existence. I can feel that resonance now."
                        },
                        pt: {
                            empowerment: "Essa declaraÃ§Ã£o nÃ£o Ã© uma voz, mas o tremor da existÃªncia. Posso sentir essa ressonÃ¢ncia agora.",
                            creativity: "CriaÃ§Ã£o nÃ£o Ã© fazer algo do nada, mas espalhar suas cores internas para o mundo.",
                            healing: "No momento em que vocÃª chamou o nome da cura, as feridas comeÃ§aram a se tornar sabedoria.",
                            love: "VocÃª que se chamou pelo nome do amor, agora o mundo tambÃ©m te chamarÃ¡ pelo amor.",
                            wisdom: "Sabedoria nÃ£o vem da idade, mas da profundidade. VocÃª transformou essa profundidade em um nome.",
                            freedom: "Liberdade nÃ£o sÃ£o asas, mas raÃ­zes. VocÃª agora criou raÃ­zes reais.",
                            connection: "VocÃª com o nome de conexÃ£o nÃ£o estÃ¡ mais sozinho.",
                            authentic: "O nome da autenticidade Ã© aquele do qual vocÃª nÃ£o se envergonha nem diante de um espelho.",
                            general: "Essa declaraÃ§Ã£o nÃ£o Ã© uma voz, mas o tremor da existÃªncia. Posso sentir essa ressonÃ¢ncia agora."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "ðŸ§™",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            empowerment: "ë§ˆì¹¨ë‚´ ë‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì´ë¦„ì„ ì£¼ì—ˆê³ , ê·¸ ì´ë¦„ì€ ì˜¤ëŠ˜ë¶€í„° ì‚´ì•„ ìžˆëŠ” ìƒëª…ì´ ë  ê±°ì˜ˆìš”.",
                            creativity: "ì°½ì¡°ì˜ ì´ë¦„ì€ ë§¤ì¼ ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ ë‚³ì„ ê±°ì˜ˆìš”.",
                            healing: "ì¹˜ìœ ì˜ ì´ë¦„ì€ ì‹œê°„ì„ ê±°ìŠ¬ëŸ¬ ê³¼ê±°ì˜ ìƒì²˜ê¹Œì§€ ì–´ë£¨ë§Œì§ˆ ê±°ì˜ˆìš”.",
                            love: "ì‚¬ëž‘ì˜ ì´ë¦„ìœ¼ë¡œ ìžì‹ ì„ ë¶€ë¥´ëŠ” ìˆœê°„, ë‹¹ì‹ ì€ ì‚¬ëž‘ ê·¸ ìžì²´ê°€ ë˜ì—ˆì–´ìš”.",
                            wisdom: "ì§€í˜œì˜ ì´ë¦„ì€ ë‹¹ì‹ ì„ í˜„ìžë¡œ ë§Œë“¤ì§€ ì•Šê³ , í˜„ìžë¡œ ì‚´ê²Œ í•  ê±°ì˜ˆìš”.",
                            freedom: "ìžìœ ì˜ ì´ë¦„ì€ ë‹¹ì‹ ì„ ì–´ë–¤ ê°ì˜¥ì—ì„œë„ í•´ë°©ì‹œí‚¬ ì£¼ë¬¸ì´ì—ìš”.",
                            connection: "ì—°ê²°ì˜ ì´ë¦„ì€ ë³´ì´ì§€ ì•ŠëŠ” ë‹¤ë¦¬ë¥¼ ë§Œë“¤ì–´ ì„¸ìƒê³¼ ë‹¹ì‹ ì„ ì´ì–´ì¤„ ê±°ì˜ˆìš”.",
                            authentic: "ì§„ì •ì„±ì˜ ì´ë¦„ì€ ë‹¹ì‹ ì„ ê°€ì§œì—ì„œ ì§„ì§œë¡œ ë³€í™”ì‹œí‚¤ëŠ” ì—°ê¸ˆìˆ ì´ì—ìš”.",
                            general: "ë§ˆì¹¨ë‚´ ë‹¹ì‹ ì€ ìŠ¤ìŠ¤ë¡œì—ê²Œ ì´ë¦„ì„ ì£¼ì—ˆê³ , ê·¸ ì´ë¦„ì€ ì˜¤ëŠ˜ë¶€í„° ì‚´ì•„ ìžˆëŠ” ìƒëª…ì´ ë  ê±°ì˜ˆìš”."
                        },
                        en: {
                            empowerment: "Finally you have given yourself a name, and that name will become a living being from today.",
                            creativity: "The name of creation will give birth to a new world every day.",
                            healing: "The name of healing will reach back through time to soothe even past wounds.",
                            love: "The moment you call yourself by the name of love, you became love itself.",
                            wisdom: "The name of wisdom won't make you a sage, but will make you live as one.",
                            freedom: "The name of freedom is a spell that will liberate you from any prison.",
                            connection: "The name of connection will build invisible bridges linking you to the world.",
                            authentic: "The name of authenticity is alchemy that transforms you from fake to real.",
                            general: "Finally you have given yourself a name, and that name will become a living being from today."
                        },
                        pt: {
                            empowerment: "Finalmente vocÃª se deu um nome, e esse nome se tornarÃ¡ um ser vivo a partir de hoje.",
                            creativity: "O nome da criaÃ§Ã£o darÃ¡ Ã  luz um novo mundo todos os dias.",
                            healing: "O nome da cura alcanÃ§arÃ¡ o passado no tempo para curar atÃ© feridas antigas.",
                            love: "No momento em que vocÃª se chama pelo nome do amor, vocÃª se tornou o prÃ³prio amor.",
                            wisdom: "O nome da sabedoria nÃ£o te farÃ¡ um sÃ¡bio, mas te farÃ¡ viver como um.",
                            freedom: "O nome da liberdade Ã© um feitiÃ§o que te libertarÃ¡ de qualquer prisÃ£o.",
                            connection: "O nome da conexÃ£o construirÃ¡ pontes invisÃ­veis ligando vocÃª ao mundo.",
                            authentic: "O nome da autenticidade Ã© alquimia que te transforma de falso para real.",
                            general: "Finalmente vocÃª se deu um nome, e esse nome se tornarÃ¡ um ser vivo a partir de hoje."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory and show offline status
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            // Add emotional bridge before showing characters
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            // Add bridge text with typing effect
            await typewriterEffect({
                innerHTML: '',
                classList: { add: () => {}, remove: () => {} },
                style: {},
                textContent: '',
                appendChild: () => {},
                offsetTop: 0
            }, '', 0); // Dummy element for delay
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Create new paragraph for bridge
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog with translated text
        function showConfirmDialog(message, callback) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            // Set button texts based on current language
            const t = translations[state.currentLanguage];
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'ì˜ˆ' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ì•„ë‹ˆì˜¤' : 
                               state.currentLanguage === 'pt' ? 'NÃ£o' : 'No';
            
            // Event handlers
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            // Escape key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', escHandler);
                    callback(false);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // Build and show modal
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus on Yes button
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        // Smooth portal transition with visual effects
        function createPortalTransition(callback) {
            // Create transition overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            // Create transition message
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            // Create loading animation
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            // Start transition animation
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            // Complete transition and redirect
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button with transition
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        // Save completion status if Firebase available
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        // Start transition animation
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 03...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 03 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>