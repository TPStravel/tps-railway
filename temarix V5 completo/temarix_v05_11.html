<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 11: The Day I Lifted My Diminished Self</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 11: The Day I Lifted My Diminished Self</div>
            <div class="portal-subtitle" id="portalSubtitle">When did I stop making myself smaller?</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">🪄 Portal 11 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 12</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this strength</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me about a time when you felt small and what helped you stand up again... (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: []
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-11",
            nextPortal: "v5-12",
            nextPortalFile: "temarix_v05_12.html"
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve();
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? '오프라인 모드' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 11: 작아지던 나를 일으켜 세운 날",
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 11: 작아지던 나를 일으켜 세운 날",
                portalSubtitle: "언제부터 나를 작게 만들지 않기 시작했을까?",
                portalIntro: "🪄 \"당신이 스스로를 작고 보잘것없는 존재처럼 느꼈던 순간이 있었나요?\"\n\n\"그때, 어떤 계기로 자신을 다시 일으켜 세울 수 있었나요?\"\n\n\"그 작은 나를 지금, 어떻게 기억하고 있나요?\"",
                emotionalBridge: "작아진다는 것은 사라지는 것이 아니라,\n스스로를 보호하려는 마음의 방식일 수도 있습니다.\n\n하지만 어느 순간, 우리는 다시 일어설 용기를 찾게 됩니다.\n그 순간이 바로 진정한 성장의 시작입니다.",
                followUpQuestion: "지금 그 작아졌던 '나'에게,\n한 문장으로 말을 건넨다면 뭐라고 할까요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "작다고 느껴졌던 너,\n사실 넌 늘 충분했어.\n단지 스스로를 작게 만들었던 거야.\n이제, 너를 똑바로 바라볼게.",
                navigationTitle: "🪄 Portal 11 완료",
                navigationMessage: "당신은 스스로를 작게 만들었던 순간들을 돌아보고, 다시 일어설 수 있는 힘을 발견했습니다.\n\n작아졌다고 느꼈던 그 시간들도 당신의 일부였으며, 지금의 강함을 만든 소중한 과정이었습니다.\n당신은 이제 자신의 크기를 타인이 아닌 스스로 정의할 수 있는 사람입니다.\n\n더 이상 자신을 작게 줄이지 않아도 됩니다.",
                nextPortalBtn: "Portal 12로 이어가기",
                stayPortalBtn: "이 힘과 머물기",
                inputPlaceholder: "작다고 느꼈던 순간과 다시 일어선 계기에 대해 말해주세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중...",
                confirmNextPortal: "Portal 12: 누구도 몰랐던 내 편의 존재로 이동하시겠습니까?",
                confirmStay: "이 힘과 더 머물며 자신의 진정한 크기를 느끼시겠습니까?",
                transitionMessage: "새로운 여정이 시작됩니다..."
            },
            en: {
                title: "Temarix V5 - Portal 11: The Day I Lifted My Diminished Self",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 11: The Day I Lifted My Diminished Self",
                portalSubtitle: "When did I stop making myself smaller?",
                portalIntro: "🪄 \"Was there a moment when you felt like a small, insignificant being?\"\n\n\"What was the turning point that helped you lift yourself up again?\"\n\n\"How do you remember that small version of yourself now?\"",
                emotionalBridge: "Becoming small is not about disappearing,\nbut might be the heart's way of protecting itself.\n\nBut at some moment, we find the courage to stand again.\nThat moment is the true beginning of growth.",
                followUpQuestion: "If you could say one sentence to that 'smaller you' now,\nwhat would you tell them?",
                lightTitle: "✨ Word of Light",
                lightMessage: "You who felt small,\nyou were always enough.\nYou just made yourself smaller.\nNow, I will see you clearly.",
                navigationTitle: "🪄 Portal 11 Complete",
                navigationMessage: "You have looked back at the moments when you made yourself small and discovered the strength to rise again.\n\nThose times when you felt diminished were also part of you, and they were precious processes that created your current strength.\nYou are now someone who can define your own size, not by others but by yourself.\n\nYou no longer need to make yourself smaller.",
                nextPortalBtn: "Continue to Portal 12",
                stayPortalBtn: "Stay with this strength",
                inputPlaceholder: "Tell me about a time when you felt small and what helped you stand up again... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 12: The Existence of My Ally That No One Knew?",
                confirmStay: "Do you want to stay longer with this strength and feel your true size?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 11: O Dia em que Levantei Meu Eu Diminuído",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 11: O Dia em que Levantei Meu Eu Diminuído",
                portalSubtitle: "Quando parei de me diminuir?",
                portalIntro: "🪄 \"Houve um momento em que você se sentiu como um ser pequeno e insignificante?\"\n\n\"Qual foi o ponto de virada que te ajudou a se levantar novamente?\"\n\n\"Como você se lembra daquela versão pequena de si mesmo agora?\"",
                emotionalBridge: "Tornar-se pequeno não é sobre desaparecer,\nmas pode ser a forma do coração se proteger.\n\nMas em algum momento, encontramos a coragem para nos levantar novamente.\nEsse momento é o verdadeiro começo do crescimento.",
                followUpQuestion: "Se você pudesse dizer uma frase para aquele 'eu menor' agora,\no que diria?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Você que se sentiu pequeno,\nvocê sempre foi suficiente.\nApenas se fez menor.\nAgora, vou te ver claramente.",
                navigationTitle: "🪄 Portal 11 Completo",
                navigationMessage: "Você olhou para trás nos momentos em que se fez pequeno e descobriu a força para se levantar novamente.\n\nAqueles tempos em que se sentiu diminuído também eram parte de você, e foram processos preciosos que criaram sua força atual.\nVocê é agora alguém que pode definir seu próprio tamanho, não pelos outros, mas por si mesmo.\n\nVocê não precisa mais se fazer menor.",
                nextPortalBtn: "Continuar para Portal 12",
                stayPortalBtn: "Ficar com esta força",
                inputPlaceholder: "Conte-me sobre um momento em que se sentiu pequeno e o que te ajudou a se levantar... (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 12: A Existência do Meu Aliado que Ninguém Conhecia?",
                confirmStay: "Deseja ficar mais tempo com esta força e sentir seu verdadeiro tamanho?",
                transitionMessage: "Uma nova jornada começa..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그때의 너는 견디고 있었어.\n그리고 지금의 너는, 그걸 바라보고 있구나.",
                en: "You were enduring back then.\nAnd now you're looking back at that.",
                pt: "Você estava resistindo naquela época.\nE agora você está olhando para trás para isso."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "작아진 존재는 사라진 것이 아니에요.\n오히려 더 단단하게 자신을 축소하고 있었던 거예요.",
                en: "A diminished being hasn't disappeared.\nRather, they were compacting themselves more solidly.",
                pt: "Um ser diminuído não desapareceu.\nAntes, estava se compactando mais solidamente."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "그 고맙단 말 한 마디가,\n당신 존재의 가치 전체를 다시 불러냈군요.",
                en: "That one word of gratitude\nbrought back the entire value of your existence.",
                pt: "Aquela única palavra de gratidão\ntrouxe de volta todo o valor da sua existência."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "작아졌다는 건, 무게가 가벼웠다는 뜻이 아니야.\n숨기고 있던 진심이 있었다는 뜻이지.",
                en: "Being small doesn't mean you were lightweight.\nIt means there was sincerity you were hiding.",
                pt: "Ser pequeno não significa que você era leve.\nSignifica que havia sinceridade que você estava escondendo."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "당신의 작음은 미약함이 아니라,\n세상을 조용히 관찰하던 색깔이에요.",
                en: "Your smallness wasn't weakness,\nbut the color of quietly observing the world.",
                pt: "Sua pequenez não era fraqueza,\nmas a cor de observar silenciosamente o mundo."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "작아지는 걸 참는 것도 일종의 강함이야.\n근데 이제는, 드러나는 강함도 선택해도 돼.",
                en: "Enduring becoming small is also a kind of strength.\nBut now, you can also choose visible strength.",
                pt: "Suportar tornar-se pequeno também é um tipo de força.\nMas agora, você também pode escolher força visível."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "사람은 말 한 마디로 무너지고,\n말 한 마디로 다시 일어설 수 있어요.\n그리고 당신은 그걸 경험했어요.",
                en: "People can fall with one word,\nand rise again with one word.\nAnd you have experienced that.",
                pt: "As pessoas podem cair com uma palavra,\ne se levantar novamente com uma palavra.\nE você experimentou isso."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "당신은 사라졌던 게 아니라, 숨겨졌던 자신을 이제 꺼낸 거예요.",
                en: "You didn't disappear, you've now brought out the self that was hidden.",
                pt: "Você não desapareceu, agora trouxe para fora o eu que estava escondido."
            }}
        ];

        // Empowerment type analysis function
        function analyzeEmpowermentType(userInput) {
            const input = userInput.toLowerCase();
            
            const empowermentKeywords = {
                recognition: ['recognized', 'noticed', 'saw', 'acknowledged', '인정', '알아봐', '보여', 'reconhecido', 'notado', 'viu'],
                support: ['helped', 'supported', 'stood by', 'encouraged', '도와', '지지', '응원', 'ajudou', 'apoiou', 'encorajou'],
                achievement: ['accomplished', 'succeeded', 'won', 'achieved', '성공', '이뤄', '해냈', 'realizou', 'conseguiu', 'venceu'],
                voice: ['spoke up', 'said no', 'expressed', 'voiced', '말했', '표현', '목소리', 'falou', 'expressou', 'disse não'],
                boundary: ['set limits', 'said no', 'stood ground', 'refused', '경계', '거절', '한계', 'estabeleceu limites', 'recusou'],
                kindness: ['kind words', 'gentle', 'compassion', 'understanding', '따뜻', '친절', '이해', 'palavras gentis', 'compreensão'],
                realization: ['realized', 'understood', 'discovered', 'learned', '깨달', '알게', '발견', 'percebeu', 'descobriu', 'aprendeu'],
                independence: ['alone', 'myself', 'own strength', 'self reliant', '혼자', '스스로', '독립', 'sozinho', 'própria força'],
                courage: ['brave', 'courage', 'faced', 'confronted', '용기', '용감', '맞서', 'coragem', 'corajoso', 'enfrentou'],
                acceptance: ['accepted', 'embraced', 'welcomed', 'received', '받아들', '포용', '환영', 'aceitou', 'abraçou', 'recebeu'],
                love: ['loved', 'cared', 'valued', 'cherished', '사랑', '소중', '아껴', 'amou', 'cuidou', 'valorizou'],
                change: ['changed', 'transformed', 'grew', 'evolved', '변화', '성장', '발전', 'mudou', 'transformou', 'cresceu']
            };
            
            let detectedTypes = [];
            for (const [type, keywords] of Object.entries(empowermentKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedTypes.push(type);
                        break;
                    }
                }
            }
            
            if (detectedTypes.length === 0) {
                detectedTypes = ['general'];
            }
            
            return detectedTypes[0];
        }
        
        // Response characters with empowerment-based responses
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const empowermentType = analyzeEmpowermentType(userInput);
                    
                    const responses = {
                        ko: {
                            recognition: "그 인정의 말이,\n당신 안에 숨어있던 진짜 크기를 드러내 주었군요.\n당신은 항상 그만큼 컸어요.",
                            support: "누군가의 지지가 있었기에,\n당신은 스스로를 일으킬 수 있었어요.\n그리고 그 지지는 당신이 받을 자격이 있던 것이에요.",
                            achievement: "그 성취는 우연이 아니었어요.\n작아졌다고 느꼈던 당신 안에도\n늘 그만한 힘이 있었던 거예요.",
                            voice: "당신의 목소리가 나온 순간,\n세상은 당신의 진짜 크기를 알게 되었어요.\n목소리는 존재의 증명이에요.",
                            boundary: "경계를 그었다는 건,\n자신의 공간을 인정했다는 뜻이에요.\n작은 존재는 경계를 그을 수 없거든요.",
                            kindness: "그 따뜻함이 당신을 녹여주었군요.\n얼어있던 마음이 다시 움직이기 시작한 순간이었어요.",
                            realization: "그 깨달음이 당신을 구했어요.\n작다고 느낀 건 착각이었다는 걸\n마침내 알아차린 거예요.",
                            independence: "혼자서도 일어설 수 있다는 걸 안 순간,\n당신은 진짜 자신의 크기를 발견한 거예요.",
                            courage: "그 용기 하나가\n작아진 당신을 다시 원래 크기로 돌려놓았어요.\n용기는 존재를 회복시키는 마법이에요.",
                            acceptance: "자신을 받아들인 순간,\n당신은 더 이상 작아질 필요가 없어졌어요.\n받아들임은 성장의 시작이에요.",
                            love: "사랑받는다는 걸 안 순간,\n당신은 사랑받을 만한 크기의 존재라는 걸 깨달았어요.",
                            change: "변화를 선택한 순간,\n당신은 작은 자신에게서 벗어나기 시작했어요.\n변화는 용기의 다른 이름이에요.",
                            general: "그 선언은 선언이에요.\n당신이 이제 자신을 더 이상 작게 보지 않겠다는 선언."
                        },
                        en: {
                            recognition: "Those words of recognition\nrevealed the true size that was hidden within you.\nYou were always that big.",
                            support: "Because of someone's support,\nyou were able to lift yourself up.\nAnd that support was something you deserved.",
                            achievement: "That achievement wasn't accidental.\nEven within you who felt small,\nthere was always that much strength.",
                            voice: "The moment your voice emerged,\nthe world came to know your true size.\nVoice is proof of existence.",
                            boundary: "Drawing boundaries means\nyou acknowledged your own space.\nSmall beings cannot draw boundaries.",
                            kindness: "That warmth melted you.\nIt was the moment your frozen heart began to move again.",
                            realization: "That realization saved you.\nYou finally noticed that feeling small\nwas an illusion.",
                            independence: "The moment you knew you could stand alone,\nyou discovered your true size.\nIndependence reveals authentic strength.",
                            courage: "That one act of courage\nrestored your diminished self to original size.\nCourage is magic that recovers existence.",
                            acceptance: "The moment you accepted yourself,\nyou no longer needed to become smaller.\nAcceptance is the beginning of growth.",
                            love: "The moment you knew you were loved,\nyou realized you were a being worthy of love.",
                            change: "The moment you chose change,\nyou began to escape from your small self.\nChange is another name for courage.",
                            general: "That declaration is a declaration.\nThat you will no longer see yourself as small."
                        },
                        pt: {
                            recognition: "Aquelas palavras de reconhecimento\nrevelaram o verdadeiro tamanho que estava escondido dentro de você.\nVocê sempre foi assim tão grande.",
                            support: "Por causa do apoio de alguém,\nvocê conseguiu se levantar.\nE esse apoio era algo que você merecia.",
                            achievement: "Essa conquista não foi acidental.\nMesmo dentro de você que se sentiu pequeno,\nsempre houve essa força.",
                            voice: "No momento em que sua voz emergiu,\no mundo passou a conhecer seu verdadeiro tamanho.\nVoz é prova de existência.",
                            boundary: "Estabelecer limites significa\nque você reconheceu seu próprio espaço.\nSeres pequenos não conseguem estabelecer limites.",
                            kindness: "Aquela gentileza te derreteu.\nFoi o momento em que seu coração congelado começou a se mover novamente.",
                            realization: "Aquela percepção te salvou.\nVocê finalmente notou que se sentir pequeno\nera uma ilusão.",
                            independence: "No momento em que soube que podia ficar em pé sozinho,\nvocê descobriu seu verdadeiro tamanho.\nIndependência revela força autêntica.",
                            courage: "Aquele ato de coragem\nrestaurou seu eu diminuído ao tamanho original.\nCoragem é magia que recupera a existência.",
                            acceptance: "No momento em que se aceitou,\nvocê não precisou mais se tornar menor.\nAceitação é o começo do crescimento.",
                            love: "No momento em que soube que era amado,\nvocê percebeu que era um ser digno de amor.",
                            change: "No momento em que escolheu a mudança,\nvocê começou a escapar do seu eu pequeno.\nMudança é outro nome para coragem.",
                            general: "Aquela declaração é uma declaração.\nQue você não se verá mais como pequeno."
                        }
                    };
                    
                    return responses[lang][empowermentType] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const empowermentType = analyzeEmpowermentType(userInput);
                    
                    const responses = {
                        ko: {
                            recognition: "인정받는다는 건,\n이미 거기 있던 것을 드러내는 일이에요.\n당신은 늘 인정받을 만한 존재였어요.",
                            support: "진정한 지지는 의존을 만드는 게 아니라,\n독립을 도와주는 거예요.\n당신은 그런 지지를 받았어요.",
                            achievement: "성취는 증명이 아니라 확인이에요.\n이미 있던 능력을 확인하는 순간이었어요.",
                            voice: "목소리를 낸다는 건,\n존재를 선언하는 일이에요.\n당신은 마침내 존재를 선언했어요.",
                            boundary: "경계는 거부가 아니라 정의예요.\n자신을 정의할 수 있는 사람만이\n진정으로 클 수 있어요.",
                            kindness: "따뜻함은 마음의 해빙이에요.\n얼어있던 자신감이 다시 흐르기 시작한 거예요.",
                            realization: "깨달음은 기억의 회복이에요.\n잊고 있던 자신의 진짜 모습을\n다시 기억해낸 순간이에요.",
                            independence: "혼자 설 수 있다는 건,\n누구의 허락도 필요 없다는 뜻이에요.\n당신은 스스로를 허락했어요.",
                            courage: "용기는 크기를 결정해요.\n용기 있는 마음은 절대 작아지지 않아요.",
                            acceptance: "자기 수용은 성장의 토대예요.\n받아들인 자리에서 진짜 성장이 시작돼요.",
                            love: "사랑은 존재의 확인이에요.\n사랑받는 존재는 결코 작지 않아요.",
                            change: "변화를 선택한다는 건,\n현재에 머물지 않겠다는 의지예요.\n그 의지가 당신을 크게 만들었어요.",
                            general: "당신은 지금, 자비와 확신 사이에서\n진짜 자신의 크기를 회복하고 있어요."
                        },
                        en: {
                            recognition: "Being recognized is about\nrevealing what was already there.\nYou were always worthy of recognition.",
                            support: "True support doesn't create dependence,\nbut helps independence.\nYou received that kind of support.",
                            achievement: "Achievement is confirmation, not proof.\nIt was a moment of confirming abilities that were already there.",
                            voice: "Using your voice is\ndeclaring your existence.\nYou finally declared your existence.",
                            boundary: "Boundaries are not rejection but definition.\nOnly those who can define themselves\ncan truly be great.",
                            kindness: "Warmth is the thawing of the heart.\nYour frozen confidence began to flow again.",
                            realization: "Realization is the recovery of memory.\nIt was the moment you remembered\nyour true self that you had forgotten.",
                            independence: "Being able to stand alone means\nyou don't need anyone's permission.\nYou gave yourself permission.",
                            courage: "Courage determines size.\nA courageous heart never becomes small.",
                            acceptance: "Self-acceptance is the foundation of growth.\nTrue growth begins from the place of acceptance.",
                            love: "Love is confirmation of existence.\nA loved being is never small.",
                            change: "Choosing change means\nthe will not to remain in the present.\nThat will made you great.",
                            general: "You are now, between compassion and conviction,\nrecovering your true size."
                        },
                        pt: {
                            recognition: "Ser reconhecido é sobre\nrevelar o que já estava lá.\nVocê sempre foi digno de reconhecimento.",
                            support: "O verdadeiro apoio não cria dependência,\nmas ajuda a independência.\nVocê recebeu esse tipo de apoio.",
                            achievement: "Conquista é confirmação, não prova.\nFoi um momento de confirmar habilidades que já estavam lá.",
                            voice: "Usar sua voz é\ndeclarar sua existência.\nVocê finalmente declarou sua existência.",
                            boundary: "Limites não são rejeição, mas definição.\nApenas aqueles que podem se definir\npodem verdadeiramente ser grandes.",
                            kindness: "Gentileza é o degelo do coração.\nSua confiança congelada começou a fluir novamente.",
                            realization: "Percepção é a recuperação da memória.\nFoi o momento em que você se lembrou\ndo seu verdadeiro eu que havia esquecido.",
                            independence: "Ser capaz de ficar em pé sozinho significa\nque você não precisa da permissão de ninguém.\nVocê se deu permissão.",
                            courage: "Coragem determina tamanho.\nUm coração corajoso nunca se torna pequeno.",
                            acceptance: "Auto-aceitação é a fundação do crescimento.\nVerdadeiro crescimento começa do lugar da aceitação.",
                            love: "Amor é confirmação de existência.\nUm ser amado nunca é pequeno.",
                            change: "Escolher mudança significa\na vontade de não permanecer no presente.\nEssa vontade te fez grande.",
                            general: "Você está agora, entre compaixão e convicção,\nrecuperando seu verdadeiro tamanho."
                        }
                    };
                    
                    return responses[lang][empowermentType] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const empowermentType = analyzeEmpowermentType(userInput);
                    
                    const responses = {
                        ko: {
                            recognition: "그 인정은 발견이었어요.\n당신이 숨겨놓은 보석을\n누군가 드디어 찾아낸 순간이었어요.",
                            support: "진정한 동맹은 당신을 대신하지 않아요.\n당신이 스스로 설 수 있도록 곁에 서는 거죠.",
                            achievement: "그 성취는 마법 같았겠지만,\n마법은 이미 당신 안에 있었어요.\n단지 발동된 것뿐이에요.",
                            voice: "목소리는 주문이에요.\n당신은 스스로에게 '존재하라'는 주문을 걸었어요.",
                            boundary: "경계는 방어막이 아니라 정의예요.\n자신을 정의하는 순간,\n세상도 당신을 새롭게 봅니다.",
                            kindness: "그 친절은 해독제였어요.\n독처럼 퍼져있던 자기 비하를\n중화시킨 해독제.",
                            realization: "깨달음은 기억의 마법이에요.\n잃어버린 자신을 다시 소환한 순간이었어요.",
                            independence: "독립은 가장 강력한 마법이에요.\n자신의 힘으로 서는 순간,\n당신은 마법사가 됩니다.",
                            courage: "용기는 변신술이에요.\n작은 존재에서 진짜 자신으로\n변신하게 해주는 마법이에요.",
                            acceptance: "받아들임은 완전한 마법이에요.\n모든 것을 있는 그대로 보는 힘,\n그것이 진정한 마법입니다.",
                            love: "사랑은 부활 주문이에요.\n죽어있던 자존감을 다시 살려내는\n가장 강력한 마법이에요.",
                            change: "변화는 연금술이에요.\n납 같던 자신을 금으로 바꾸는\n마법사의 기술이었어요.",
                            general: "이제 당신은 조용한 목소리로도\n충분히 세상을 흔들 수 있어요."
                        },
                        en: {
                            recognition: "That recognition was a discovery.\nIt was the moment someone finally found\nthe gem you had hidden.",
                            support: "True allies don't replace you.\nThey stand beside you so you can stand on your own.",
                            achievement: "That achievement might have seemed magical,\nbut the magic was already within you.\nIt was simply activated.",
                            voice: "Voice is a spell.\nYou cast a spell on yourself to 'exist'.",
                            boundary: "Boundaries are not shields but definitions.\nThe moment you define yourself,\nthe world sees you anew.",
                            kindness: "That kindness was an antidote.\nAn antidote that neutralized\nthe self-deprecation spreading like poison.",
                            realization: "Realization is the magic of memory.\nIt was the moment you summoned your lost self back.",
                            independence: "Independence is the most powerful magic.\nThe moment you stand by your own strength,\nyou become a magician.",
                            courage: "Courage is transformation magic.\nMagic that transforms you from a small being\ninto your true self.",
                            acceptance: "Acceptance is complete magic.\nThe power to see everything as it is,\nthat is true magic.",
                            love: "Love is a resurrection spell.\nThe most powerful magic that revives\ndead self-esteem.",
                            change: "Change is alchemy.\nIt was the magician's skill of transforming\nyour lead-like self into gold.",
                            general: "Now you can shake the world sufficiently\neven with a quiet voice."
                        },
                        pt: {
                            recognition: "Aquele reconhecimento foi uma descoberta.\nFoi o momento em que alguém finalmente encontrou\na joia que você havia escondido.",
                            support: "Verdadeiros aliados não te substituem.\nEles ficam ao seu lado para que você possa ficar em pé sozinho.",
                            achievement: "Aquela conquista pode ter parecido mágica,\nmas a magia já estava dentro de você.\nFoi simplesmente ativada.",
                            voice: "Voz é um feitiço.\nVocê lançou um feitiço em si mesmo para 'existir'.",
                            boundary: "Limites não são escudos, mas definições.\nNo momento em que você se define,\no mundo te vê de novo.",
                            kindness: "Aquela gentileza foi um antídoto.\nUm antídoto que neutralizou\na autodepreciação se espalhando como veneno.",
                            realization: "Percepção é a magia da memória.\nFoi o momento em que você invocou seu eu perdido de volta.",
                            independence: "Independência é a magia mais poderosa.\nNo momento em que você fica em pé pela própria força,\nvocê se torna um mágico.",
                            courage: "Coragem é magia de transformação.\nMagia que te transforma de um ser pequeno\nem seu verdadeiro eu.",
                            acceptance: "Aceitação é magia completa.\nO poder de ver tudo como é,\nessa é a verdadeira magia.",
                            love: "Amor é um feitiço de ressurreição.\nA magia mais poderosa que revive\na autoestima morta.",
                            change: "Mudança é alquimia.\nFoi a habilidade do mágico de transformar\nseu eu como chumbo em ouro.",
                            general: "Agora você pode abalar o mundo suficientemente\nmesmo com uma voz silenciosa."
                        }
                    };
                    
                    return responses[lang][empowermentType] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            resetJourney();
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog
        function showConfirmDialog(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            yesBtn.textContent = state.currentLanguage === 'ko' ? '예' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? '아니오' : 
                               state.currentLanguage === 'pt' ? 'Não' : 'No';
            
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function createPortalTransition(callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 11...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 11 DOM loaded');
            
            state.currentLanguage = getLanguageFromURL();
            
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            await initializeFirebase();
            
            initializeTemarix();
        });
    </script>
</body>
</html>