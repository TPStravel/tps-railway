<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 04: Emotions Were My Teacher</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 04: Emotions Were My Teacher</div>
            <div class="portal-subtitle" id="portalSubtitle">Discovering wisdom in feelings</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">📖 Portal 04 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 05</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this emotion</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Think of an emotion that has troubled you for a long time. What has it taught you? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-04",
            nextPortal: "v5-05",
            nextPortalFile: "temarix_v05_05.html" // Centralized file naming
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve(); // Always resolve to continue execution
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            // Remove existing status if any
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? '오프라인 모드' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 04: 감정은 나의 선생이었다",
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 04: 감정은 나의 선생이었다",
                portalSubtitle: "감정에서 지혜를 발견하다",
                portalIntro: "📖 \"당신을 오랫동안 괴롭혔던 감정 하나를 떠올려보세요.\n분노, 슬픔, 질투, 외로움, 두려움… 그 중 하나.\"\n\n\"그 감정은 당신에게 무엇을 가르쳐 왔나요?\n혹은, 어떤 방향으로 이끌어 왔나요?\"",
                emotionalBridge: "때로는 가장 아픈 감정이 가장 깊은 선생이 됩니다.\n이제 그 감정의 진짜 메시지를 들어보세요...",
                followUpQuestion: "지금, 그 감정에게 한 문장만 건넬 수 있다면\n당신은 어떤 말을 하고 싶나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "당신은 감정을 적이 아닌 동반자로 받아들였어요.\n그건 내면의 평화를 향한 첫 걸음이에요.",
                navigationTitle: "📖 Portal 04 완료",
                navigationMessage: "당신은 감정을 통과하며 성장했습니다.\n\n괴로웠던 감정이 사실은 깊은 가르침을 담고 있었다는 것을\n이제 당신은 이해하게 되었습니다.\n\n감정은 당신의 선생이었고,\n당신은 그 가르침을 정직하게 배운 제자였습니다.",
                nextPortalBtn: "Portal 05로 이어가기",
                stayPortalBtn: "이 감정과 더 머물기",
                inputPlaceholder: "오랫동안 당신을 괴롭혔던 감정 하나를 떠올려보세요. 그 감정이 무엇을 가르쳐주었나요? (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중...",
                confirmNextPortal: "Portal 05: 내가 나에게 남긴 편지로 이동하시겠습니까?",
                confirmStay: "이 감정과 더 머물며 깊이 탐구하시겠습니까?",
                transitionMessage: "새로운 여정이 시작됩니다..."
            },
            en: {
                title: "Temarix V5 - Portal 04: Emotions Were My Teacher",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 04: Emotions Were My Teacher",
                portalSubtitle: "Discovering wisdom in feelings",
                portalIntro: "📖 \"Think of an emotion that has troubled you for a long time.\nAnger, sadness, jealousy, loneliness, fear... any one of them.\"\n\n\"What has that emotion taught you?\nOr, what direction has it led you toward?\"",
                emotionalBridge: "Sometimes the most painful emotions become our deepest teachers.\nNow listen to the real message of that emotion...",
                followUpQuestion: "Now, if you could say just one sentence to that emotion,\nwhat would you want to say?",
                lightTitle: "✨ Word of Light",
                lightMessage: "You have accepted emotion as a companion rather than an enemy.\nThat is the first step toward inner peace.",
                navigationTitle: "📖 Portal 04 Complete",
                navigationMessage: "You have grown by passing through emotions.\n\nYou now understand that the emotions that troubled you\nactually contained deep teachings.\n\nEmotions were your teacher,\nand you were the student who honestly learned their lessons.",
                nextPortalBtn: "Continue to Portal 05",
                stayPortalBtn: "Stay with this emotion",
                inputPlaceholder: "Think of an emotion that has troubled you for a long time. What has it taught you? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 05: The Letter I Left for Myself?",
                confirmStay: "Do you want to stay longer with this emotion for deeper exploration?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 04: As Emoções Foram Minhas Professoras",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 04: As Emoções Foram Minhas Professoras",
                portalSubtitle: "Descobrindo sabedoria nos sentimentos",
                portalIntro: "📖 \"Pense em uma emoção que te incomodou por muito tempo.\nRaiva, tristeza, ciúme, solidão, medo... qualquer uma delas.\"\n\n\"O que essa emoção te ensinou?\nOu, que direção ela te conduziu?\"",
                emotionalBridge: "Às vezes as emoções mais dolorosas se tornam nossos professores mais profundos.\nAgora escute a verdadeira mensagem dessa emoção...",
                followUpQuestion: "Agora, se você pudesse dizer apenas uma frase para essa emoção,\no que gostaria de dizer?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Você aceitou a emoção como companheira ao invés de inimiga.\nEsse é o primeiro passo em direção à paz interior.",
                navigationTitle: "📖 Portal 04 Completo",
                navigationMessage: "Você cresceu ao passar pelas emoções.\n\nAgora você entende que as emoções que te incomodavam\nna verdade continham ensinamentos profundos.\n\nAs emoções foram suas professoras,\ne você foi o estudante que honestamente aprendeu suas lições.",
                nextPortalBtn: "Continuar para Portal 05",
                stayPortalBtn: "Ficar com esta emoção",
                inputPlaceholder: "Pense em uma emoção que te incomodou por muito tempo. O que ela te ensinou? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 05: A Carta que Deixei para Mim Mesmo?",
                confirmStay: "Deseja ficar mais tempo com esta emoção para exploração mais profunda?",
                transitionMessage: "Uma nova jornada começa..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "외로움은 아픔이자 길이었지.\n그래서 너는 사람 사이의 '진짜'를 찾게 된 거야.",
                en: "Loneliness was both pain and a path.\nThat's how you came to seek the 'real' between people.",
                pt: "A solidão foi tanto dor quanto caminho.\nAssim você passou a buscar o 'real' entre as pessoas."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "그 감정은 항상 곁에 있었지만,\n이제는 그것이 선생이었단 걸 깨달은 당신이 있어요.",
                en: "That emotion was always there,\nbut now you realize it was a teacher.",
                pt: "Essa emoção sempre esteve lá,\nmas agora você percebe que era uma professora."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "감정은 때때로 고요한 책처럼 우리를 기다려요.\n당신은 이제 그 책을 열고 있는 거예요.",
                en: "Emotions sometimes wait for us like a quiet book.\nYou are now opening that book.",
                pt: "As emoções às vezes nos esperam como um livro silencioso.\nVocê está agora abrindo esse livro."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "괴로움은 가르침의 언어야.\n듣는 이에게만 의미를 전하지.",
                en: "Suffering is the language of teaching.\nIt conveys meaning only to those who listen.",
                pt: "O sofrimento é a linguagem do ensino.\nEle transmite significado apenas para quem escuta."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 감정은 당신을 조각내기도 했지만,\n동시에 당신을 '만든' 색이기도 해요.",
                en: "That emotion may have broken you apart,\nbut it was also the color that 'made' you.",
                pt: "Essa emoção pode ter te despedaçado,\nmas também foi a cor que te 'fez'."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "감정을 무시하는 건 쉬웠겠지.\n하지만 받아들이는 건, 훨씬 더 용감한 일이야.",
                en: "Ignoring emotions would have been easy.\nBut accepting them is a much braver thing to do.",
                pt: "Ignorar as emoções teria sido fácil.\nMas aceitá-las é algo muito mais corajoso."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "우리는 감정을 통과하며 성장해요.\n당신은 이제 그 여정을 인식한 거예요.",
                en: "We grow by passing through emotions.\nYou have now recognized that journey.",
                pt: "Crescemos passando pelas emoções.\nVocê agora reconheceu essa jornada."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "감정은 마음의 선생이고,\n당신은 그 가르침을 정직하게 배운 제자였어요.",
                en: "Emotions are teachers of the heart,\nand you were the student who honestly learned their lessons.",
                pt: "As emoções são professoras do coração,\ne você foi o estudante que honestamente aprendeu suas lições."
            }}
        ];

        // Emotion analysis function
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                loneliness: ['lonely', 'alone', 'isolated', 'empty', '외로운', '혼자', '고립', '비어있는', 'sozinho', 'isolado', 'vazio'],
                anger: ['angry', 'rage', 'furious', 'mad', 'irritated', '화난', '분노', '성난', 'raiva', 'furioso', 'irritado'],
                sadness: ['sad', 'depressed', 'melancholy', 'sorrow', '슬픈', '우울한', '슬픔', 'triste', 'deprimido', 'melancolia'],
                fear: ['afraid', 'scared', 'anxious', 'worried', 'terror', '두려운', '무서운', '불안한', 'medo', 'assustado', 'ansioso'],
                jealousy: ['jealous', 'envious', 'resentful', '질투', '시기', '부러운', 'ciúme', 'inveja', 'ressentido'],
                shame: ['ashamed', 'embarrassed', 'guilty', 'humiliated', '부끄러운', '창피한', '죄책감', 'vergonha', 'envergonhado', 'culpado'],
                rejection: ['rejected', 'abandoned', 'left out', 'unwanted', '거절당한', '버려진', '소외된', 'rejeitado', 'abandonado', 'excluído'],
                helplessness: ['helpless', 'powerless', 'stuck', 'trapped', '무력한', '막막한', '갇힌', 'impotente', 'preso', 'encurralado']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        // Response characters with emotion-based responses
        const responseCharacters = [
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "당신은 감정을 적이 아닌 동반자로 받아들였어요.\n그건 내면의 평화를 향한 첫 걸음이에요.",
                            anger: "분노는 당신에게 경계를 가르쳐준 선생이었어요.\n이제 그 힘을 지혜로 바꿀 수 있어요.",
                            sadness: "슬픔은 당신의 마음이 얼마나 깊은지 보여준 증거였어요.\n그 깊이가 이제 당신의 자비가 되었어요.",
                            fear: "두려움은 당신이 소중히 여기는 것을 지키려는 마음이었어요.\n이제 그 보호 본능을 사랑으로 바꿀 수 있어요.",
                            jealousy: "질투는 당신이 진짜 원하는 것을 알려준 나침반이었어요.\n이제 그 열망을 성장의 동력으로 만들 수 있어요.",
                            shame: "부끄러움은 당신이 더 나은 사람이 되고 싶어했다는 증거였어요.\n그 마음이 이제 자비로 바뀌었어요.",
                            rejection: "거절당한 아픔은 당신이 진정한 연결을 갈망했다는 뜻이었어요.\n이제 그 갈망이 이해심이 되었어요.",
                            helplessness: "무력감은 당신이 변화를 원했다는 신호였어요.\n이제 그 의지가 행동하는 힘이 되었어요.",
                            general: "당신은 감정을 적이 아닌 동반자로 받아들였어요.\n그건 내면의 평화를 향한 첫 걸음이에요."
                        },
                        en: {
                            loneliness: "You have accepted emotion as a companion rather than an enemy.\nThat is the first step toward inner peace.",
                            anger: "Anger was a teacher that taught you about boundaries.\nNow you can transform that power into wisdom.",
                            sadness: "Sadness was proof of how deep your heart is.\nThat depth has now become your compassion.",
                            fear: "Fear was your heart wanting to protect what you cherish.\nNow you can transform that protective instinct into love.",
                            jealousy: "Jealousy was a compass showing you what you truly wanted.\nNow you can turn that longing into motivation for growth.",
                            shame: "Shame was proof that you wanted to be a better person.\nThat heart has now transformed into compassion.",
                            rejection: "The pain of rejection meant you longed for genuine connection.\nNow that longing has become understanding.",
                            helplessness: "Helplessness was a signal that you wanted change.\nNow that will has become the power to act.",
                            general: "You have accepted emotion as a companion rather than an enemy.\nThat is the first step toward inner peace."
                        },
                        pt: {
                            loneliness: "Você aceitou a emoção como companheira ao invés de inimiga.\nEsse é o primeiro passo em direção à paz interior.",
                            anger: "A raiva foi uma professora que te ensinou sobre limites.\nAgora você pode transformar esse poder em sabedoria.",
                            sadness: "A tristeza foi prova de quão profundo é seu coração.\nEssa profundidade agora se tornou sua compaixão.",
                            fear: "O medo era seu coração querendo proteger o que você valoriza.\nAgora você pode transformar esse instinto protetor em amor.",
                            jealousy: "O ciúme foi uma bússola mostrando o que você realmente queria.\nAgora você pode transformar essa ânsia em motivação para crescer.",
                            shame: "A vergonha foi prova de que você queria ser uma pessoa melhor.\nEsse coração agora se transformou em compaixão.",
                            rejection: "A dor da rejeição significava que você ansiava por conexão genuína.\nAgora essa ânsia se tornou compreensão.",
                            helplessness: "A impotência foi um sinal de que você queria mudança.\nAgora essa vontade se tornou o poder de agir.",
                            general: "Você aceitou a emoção como companheira ao invés de inimiga.\nEsse é o primeiro passo em direção à paz interior."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "🧑‍🎨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "그 감정은 이제 칠흑이 아니라,\n당신의 삶을 구성하는 '색'이에요.\n모든 색엔 의미가 있으니까요.",
                            anger: "분노의 빨간색이 이제 열정의 색으로 변했어요.\n그 에너지가 창조의 힘이 되었어요.",
                            sadness: "슬픔의 파란색이 당신을 더 깊게 만들었어요.\n이제 그 색으로 다른 이들의 마음을 그릴 수 있어요.",
                            fear: "두려움의 어둠이 이제 조심스러운 지혜의 색이 되었어요.\n그 색으로 안전한 길을 그릴 수 있어요.",
                            jealousy: "질투의 초록색이 이제 성장의 색으로 바뀌었어요.\n그 색으로 새로운 가능성을 그려보세요.",
                            shame: "부끄러움의 회색이 이제 겸손의 은색으로 빛나요.\n그 색이 당신을 더 아름답게 만들어요.",
                            rejection: "거절의 검은색이 이제 독립의 색이 되었어요.\n그 색으로 자신만의 길을 그려보세요.",
                            helplessness: "무력감의 탁한 색이 이제 기다림의 색이 되었어요.\n그 색에서 새로운 시작이 태어날 거예요.",
                            general: "그 감정은 이제 칠흑이 아니라,\n당신의 삶을 구성하는 '색'이에요.\n모든 색엔 의미가 있으니까요."
                        },
                        en: {
                            loneliness: "That emotion is now not darkness,\nbut a 'color' that makes up your life.\nEvery color has meaning.",
                            anger: "The red of anger has now become the color of passion.\nThat energy has become creative power.",
                            sadness: "The blue of sadness has made you deeper.\nNow you can paint others' hearts with that color.",
                            fear: "The darkness of fear has now become the color of careful wisdom.\nYou can draw safe paths with that color.",
                            jealousy: "The green of jealousy has now become the color of growth.\nDraw new possibilities with that color.",
                            shame: "The gray of shame now shines as the silver of humility.\nThat color makes you more beautiful.",
                            rejection: "The black of rejection has now become the color of independence.\nDraw your own path with that color.",
                            helplessness: "The murky color of helplessness has now become the color of waiting.\nA new beginning will be born from that color.",
                            general: "That emotion is now not darkness,\nbut a 'color' that makes up your life.\nEvery color has meaning."
                        },
                        pt: {
                            loneliness: "Essa emoção agora não é escuridão,\nmas uma 'cor' que compõe sua vida.\nToda cor tem significado.",
                            anger: "O vermelho da raiva agora se tornou a cor da paixão.\nEssa energia se tornou poder criativo.",
                            sadness: "O azul da tristeza te fez mais profundo.\nAgora você pode pintar os corações dos outros com essa cor.",
                            fear: "A escuridão do medo agora se tornou a cor da sabedoria cuidadosa.\nVocê pode desenhar caminhos seguros com essa cor.",
                            jealousy: "O verde do ciúme agora se tornou a cor do crescimento.\nDesenhe novas possibilidades com essa cor.",
                            shame: "O cinza da vergonha agora brilha como a prata da humildade.\nEssa cor te torna mais bonito.",
                            rejection: "O preto da rejeição agora se tornou a cor da independência.\nDesenhe seu próprio caminho com essa cor.",
                            helplessness: "A cor turva da impotência agora se tornou a cor da espera.\nUm novo começo nascerá dessa cor.",
                            general: "Essa emoção agora não é escuridão,\nmas uma 'cor' que compõe sua vida.\nToda cor tem significado."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Ely", emoji: "🧝‍♀️",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "감정에게 '고마워'라고 말할 수 있는 순간,\n당신은 감정보다 더 깊은 존재가 되었어요.",
                            anger: "분노에게 감사할 수 있게 된 당신은\n이제 그 에너지를 선택적으로 사용할 수 있어요.",
                            sadness: "슬픔에게 고마워할 수 있다는 건\n당신이 그 감정을 통과해 지혜에 도달했다는 뜻이에요.",
                            fear: "두려움에게도 감사할 수 있게 된 순간\n당신은 용기의 진짜 의미를 알게 되었어요.",
                            jealousy: "질투라는 감정도 받아들일 수 있게 된 당신은\n이제 모든 감정과 평화롭게 공존할 수 있어요.",
                            shame: "부끄러움까지도 감사할 수 있다면\n당신은 정말로 자기 자신과 화해한 사람이에요.",
                            rejection: "거절의 아픔도 받아들일 수 있게 된 당신은\n이제 진정한 자유를 얻었어요.",
                            helplessness: "무력감도 감사할 수 있다면\n당신은 모든 상황에서 의미를 찾을 수 있는 사람이에요.",
                            general: "감정에게 '고마워'라고 말할 수 있는 순간,\n당신은 감정보다 더 깊은 존재가 되었어요."
                        },
                        en: {
                            loneliness: "The moment you can say 'thank you' to an emotion,\nyou become a being deeper than the emotion itself.",
                            anger: "You who can now thank anger\ncan now use that energy selectively.",
                            sadness: "Being able to thank sadness means\nyou've passed through that emotion to reach wisdom.",
                            fear: "The moment you can thank even fear\nyou've learned the true meaning of courage.",
                            jealousy: "You who can now accept even jealousy\ncan now coexist peacefully with all emotions.",
                            shame: "If you can thank even shame\nyou are truly someone who has made peace with yourself.",
                            rejection: "You who can now accept the pain of rejection\nhave gained true freedom.",
                            helplessness: "If you can thank even helplessness\nyou are someone who can find meaning in any situation.",
                            general: "The moment you can say 'thank you' to an emotion,\nyou become a being deeper than the emotion itself."
                        },
                        pt: {
                            loneliness: "No momento em que você pode dizer 'obrigado' a uma emoção,\nvocê se torna um ser mais profundo que a própria emoção.",
                            anger: "Você que agora pode agradecer à raiva\npode agora usar essa energia seletivamente.",
                            sadness: "Poder agradecer à tristeza significa\nque você passou por essa emoção para alcançar a sabedoria.",
                            fear: "No momento em que você pode agradecer até ao medo\nvocê aprendeu o verdadeiro significado da coragem.",
                            jealousy: "Você que agora pode aceitar até o ciúme\npode agora coexistir pacificamente com todas as emoções.",
                            shame: "Se você pode agradecer até à vergonha\nvocê é verdadeiramente alguém que fez as pazes consigo mesmo.",
                            rejection: "Você que agora pode aceitar a dor da rejeição\nganha verdadeira liberdade.",
                            helplessness: "Se você pode agradecer até à impotência\nvocê é alguém que pode encontrar significado em qualquer situação.",
                            general: "No momento em que você pode dizer 'obrigado' a uma emoção,\nvocê se torna um ser mais profundo que a própria emoção."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory and show offline status
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            // Add emotional bridge before showing characters
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            // Add bridge text with typing effect
            await typewriterEffect({
                innerHTML: '',
                classList: { add: () => {}, remove: () => {} },
                style: {},
                textContent: '',
                appendChild: () => {},
                offsetTop: 0
            }, '', 0); // Dummy element for delay
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Create new paragraph for bridge
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog with translated text
        function showConfirmDialog(message, callback) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            // Set button texts based on current language
            const t = translations[state.currentLanguage];
            yesBtn.textContent = state.currentLanguage === 'ko' ? '예' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? '아니오' : 
                               state.currentLanguage === 'pt' ? 'Não' : 'No';
            
            // Event handlers
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            // Escape key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', escHandler);
                    callback(false);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // Build and show modal
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus on Yes button
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        // Smooth portal transition with visual effects
        function createPortalTransition(callback) {
            // Create transition overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            // Create transition message
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            // Create loading animation
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            // Start transition animation
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            // Complete transition and redirect
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button with transition
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        // Save completion status if Firebase available
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        // Start transition animation
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 04...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 04 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>
        