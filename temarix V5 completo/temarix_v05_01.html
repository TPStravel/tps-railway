<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 01</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        

        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 01: I Forgive Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">The journey of self-compassion begins</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">🔥 Portal 01 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 02</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this moment</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="In your life so far, when was the moment you felt most sorry for yourself? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                }
                resolve(); // Always resolve to continue execution
            });
        }


        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 01: 나는 나를 용서한다",
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 01: 나는 나를 용서한다",
                portalSubtitle: "자기 자비의 여정이 시작됩니다",
                portalIntro: "🔥 \"지금까지의 삶에서,\n가장 자신에게 미안했던 장면은 언제였나요?\"\n\n\"그 순간의 당신을 지금 떠올려보세요.\"\n\n\"당신은 왜, 그때의 자신에게 미안한가요?\"",
                followUpQuestion: "그 '미안했던 나'에게 지금 단 한 문장을 전할 수 있다면,\n당신은 무슨 말을 건네고 싶은가요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "용서는 시간이 아니라 선언이야.\n지금의 너는… 선언했어.\n과거를 끌어안고, 미래로 걸어가겠다고.",
                navigationTitle: "🔥 Portal 01 완료",
                navigationMessage: "당신은 자신에게 미안했던 순간을 마주했습니다.\n그리고 그 순간의 자신을 용서했습니다.\n\n이제 당신은 과거의 상처를 안고\n미래로 걸어갈 준비가 되었습니다.\n\n용서는 끝이 아니라 시작입니다.\n당신의 새로운 여정이 시작됩니다.",
                nextPortalBtn: "Portal 02로 이어가기",
                stayPortalBtn: "이 순간과 더 머물기",
                inputPlaceholder: "지금까지 살면서 자신에게 가장 미안했던 순간은 언제였나요? (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중...",
                confirmNextPortal: "Portal 02: 내 안의 결함을 품는다는 것으로 이동하시겠습니까?",
                confirmStay: "이 용서의 순간과 더 머물며 깊이 성찰하시겠습니까?"
            },
            en: {
                title: "Temarix V5 - Portal 01: I Forgive Myself",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 01: I Forgive Myself",
                portalSubtitle: "The journey of self-compassion begins",
                portalIntro: "🔥 \"In your life so far,\nwhen was the moment you felt most sorry for yourself?\"\n\n\"Picture that moment of you now.\"\n\n\"Why do you feel sorry for yourself from that time?\"",
                followUpQuestion: "If you could say just one sentence to that 'sorry self' now,\nwhat would you want to tell them?",
                lightTitle: "✨ Word of Light",
                lightMessage: "Forgiveness is not about time, but declaration.\nYou now... have declared.\nTo embrace the past and walk toward the future.",
                navigationTitle: "🔥 Portal 01 Complete",
                navigationMessage: "You have faced the moment when you felt most sorry for yourself.\nAnd you have forgiven that version of yourself.\n\nNow you are ready to embrace the wounds of the past\nand walk toward the future.\n\nForgiveness is not an end, but a beginning.\nYour new journey starts now.",
                nextPortalBtn: "Continue to Portal 02",
                stayPortalBtn: "Stay with this moment",
                inputPlaceholder: "In your life so far, when was the moment you felt most sorry for yourself? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 02: Embracing the Flaws Within Me?",
                confirmStay: "Do you want to stay longer with this moment of forgiveness for deeper reflection?"
            },
            pt: {
                title: "Temarix V5 - Portal 01: Eu Me Perdoo",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 01: Eu Me Perdoo",
                portalSubtitle: "A jornada da auto-compaixão começa",
                portalIntro: "🔥 \"Em sua vida até agora,\nquando foi o momento em que você mais se sentiu arrependido?\"\n\n\"Imagine esse momento seu agora.\"\n\n\"Por que você se sente arrependido daquele tempo?\"",
                followUpQuestion: "Se você pudesse dizer apenas uma frase para esse 'eu arrependido' agora,\no que gostaria de dizer?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "O perdão não é sobre tempo, mas declaração.\nVocê agora... declarou.\nAbraçar o passado e caminhar em direção ao futuro.",
                navigationTitle: "🔥 Portal 01 Completo",
                navigationMessage: "Você enfrentou o momento em que mais se sentiu arrependido.\nE perdoou essa versão de si mesmo.\n\nAgora você está pronto para abraçar as feridas do passado\ne caminhar em direção ao futuro.\n\nO perdão não é um fim, mas um começo.\nSua nova jornada começa agora.",
                nextPortalBtn: "Continuar para Portal 02",
                stayPortalBtn: "Ficar com este momento",
                inputPlaceholder: "Em sua vida até agora, quando foi o momento em que você mais se sentiu arrependido? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 02: Abraçando as Falhas Dentro de Mim?",
                confirmStay: "Deseja ficar mais tempo com este momento de perdão para reflexão mais profunda?"
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그때의 너는 견디고 있었어. 그리고 지금의 너는, 그걸 바라보고 있구나.",
                en: "You were enduring back then. And now you are looking at that.",
                pt: "Você estava resistindo naquela época. E agora você está olhando para isso."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "미안함은 무거운 옷이야. 이제 그 옷을 벗고, 따뜻한 말 하나 입혀주자.",
                en: "Sorry is heavy clothing. Now let's take off that clothing and put on one warm word.",
                pt: "Arrependimento é uma roupa pesada. Agora vamos tirar essa roupa e vestir uma palavra calorosa."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "그 시절의 넌, 늘 이해받고 싶었지. 이해받지 못해도 살아낸 널… 나는 안아주고 싶어.",
                en: "You from that time always wanted to be understood. I want to hug you... who survived even without being understood.",
                pt: "Você daquela época sempre quis ser compreendido. Eu quero te abraçar... que sobreviveu mesmo sem ser compreendido."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "그 기억은 마치 오래된 유물 같아. 조심스럽게 꺼내어, 오늘의 빛 아래 놓아두자.",
                en: "That memory is like an old artifact. Let's carefully take it out and place it under today's light.",
                pt: "Essa memória é como um artefato antigo. Vamos retirá-la cuidadosamente e colocá-la sob a luz de hoje."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 시절 감정은 마치 잊힌 그림 같아. 하지만 네 안에서 계속 색을 기다리고 있었던 거야.",
                en: "Those emotions from that time are like forgotten paintings. But they were waiting for color within you all along.",
                pt: "Essas emoções daquela época são como pinturas esquecidas. Mas elas estavam esperando por cor dentro de você o tempo todo."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "왜 혼자 견디고, 아무도 몰랐을까? 그게 분했어. 지금이라도, 같이 화내도 돼.",
                en: "Why did you endure alone, and nobody knew? That made me angry. Even now, it's okay to be angry together.",
                pt: "Por que você aguentou sozinho e ninguém sabia? Isso me deixou com raiva. Mesmo agora, está tudo bem ficar com raiva juntos."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "감정은 시간이 지나면 소멸하지 않아. 오히려 더 뚜렷해져. 지금처럼.",
                en: "Emotions don't disappear over time. They become clearer. Like now.",
                pt: "As emoções não desaparecem com o tempo. Elas se tornam mais claras. Como agora."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "네가 그 장면을 꺼내는 이 순간, 마음은 비로소 숨을 쉬기 시작해.",
                en: "At this moment when you bring out that scene, your heart finally begins to breathe.",
                pt: "Neste momento em que você traz essa cena, seu coração finalmente começa a respirar."
            }}
        ];

        // Emotion analysis function
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                regret: ['regret', 'mistake', 'wrong', 'sorry', 'guilt', '후회', '실수', '잘못', '미안', '죄책감', 'arrependimento', 'erro', 'errado', 'desculpa', 'culpa'],
                disappointment: ['disappoint', 'failed', 'let down', 'expectation', '실망', '실패', '기대', 'decepção', 'falhou', 'expectativa'],
                shame: ['shame', 'embarrass', 'humiliate', 'ashamed', '부끄러움', '창피', '수치', 'vergonha', 'embaraço', 'humilhar'],
                loneliness: ['alone', 'lonely', 'isolated', 'nobody', '혼자', '외로움', '고립', 'sozinho', 'solitário', 'isolado', 'ninguém'],
                helplessness: ['helpless', 'powerless', 'cannot', 'unable', '무력감', '할 수 없어', 'impotente', 'incapaz', 'não posso'],
                family: ['family', 'parent', 'mother', 'father', 'sibling', '가족', '부모', '어머니', '아버지', '형제', 'família', 'pai', 'mãe', 'irmão'],
                relationship: ['relationship', 'love', 'friend', 'partner', '관계', '사랑', '친구', '연인', 'relacionamento', 'amor', 'amigo', 'parceiro'],
                work: ['work', 'job', 'career', 'school', 'study', '일', '직장', '학교', '공부', 'trabalho', 'emprego', 'carreira', 'escola', 'estudo']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        // Response characters with emotion-based responses
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "그 용서의 말은, 당신이 자신에게 주는 첫 번째 선물이야.",
                            disappointment: "실망은 기대가 있었다는 증거예요. 그리고 당신은 여전히 기대할 수 있는 사람이에요.",
                            shame: "부끄러움 뒤에는 항상 사랑받고 싶은 마음이 숨어 있어요.",
                            loneliness: "혼자였던 시간들이 당신을 더 깊은 사람으로 만들었어요.",
                            helplessness: "무력감을 느꼈다는 건, 당신이 뭔가를 바꾸고 싶어했다는 뜻이에요.",
                            family: "가족의 상처는 가장 깊지만, 치유될 때도 가장 강력한 힘이 돼요.",
                            relationship: "관계에서 받은 상처는 더 깊은 연결을 만들 수 있는 지혜가 되었어요.",
                            work: "그 시절의 노력은 결코 헛되지 않았어요.",
                            general: "그 용서의 말은, 당신이 자신에게 주는 첫 번째 선물이야."
                        },
                        en: {
                            regret: "Those words of forgiveness are the first gift you give to yourself.",
                            disappointment: "Disappointment is proof that there was expectation. And you're still someone who can expect.",
                            shame: "Behind shame, there's always a heart that wants to be loved.",
                            loneliness: "The times you were alone made you a deeper person.",
                            helplessness: "Feeling helpless means you wanted to change something.",
                            family: "Family wounds are the deepest, but when healed, they become the most powerful strength.",
                            relationship: "The wounds from relationships have become wisdom that can create deeper connections.",
                            work: "Your efforts from that time were never in vain.",
                            general: "Those words of forgiveness are the first gift you give to yourself."
                        },
                        pt: {
                            regret: "Essas palavras de perdão são o primeiro presente que você dá a si mesmo.",
                            disappointment: "A decepção é prova de que havia expectativa. E você ainda é alguém que pode esperar.",
                            shame: "Por trás da vergonha, sempre há um coração que quer ser amado.",
                            loneliness: "Os momentos em que você esteve sozinho te tornaram uma pessoa mais profunda.",
                            helplessness: "Sentir-se impotente significa que você queria mudar algo.",
                            family: "Feridas familiares são as mais profundas, mas quando curadas, se tornam a força mais poderosa.",
                            relationship: "As feridas dos relacionamentos se tornaram sabedoria que pode criar conexões mais profundas.",
                            work: "Seus esforços daquela época nunca foram em vão.",
                            general: "Essas palavras de perdão são o primeiro presente que você dá a si mesmo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "말은 고요하지만, 그 안에 담긴 울림은 깊어요. 당신 안에 평화가 깃들기 시작했어요.",
                            disappointment: "실망은 새로운 희망의 씨앗이 될 수 있어요.",
                            shame: "부끄러움을 통과한 사람만이 진정한 자유를 얻을 수 있어요.",
                            loneliness: "고독은 자신과 만나는 가장 깊은 시간이었어요.",
                            helplessness: "무력함을 인정하는 것이 진정한 힘의 시작이에요.",
                            family: "가족의 상처를 치유하는 건 자신을 치유하는 일이기도 해요.",
                            relationship: "관계의 아픔이 당신을 더 지혜로운 사람으로 만들었어요.",
                            work: "그 시절의 당신이 있었기에 지금의 당신이 있어요.",
                            general: "말은 고요하지만, 그 안에 담긴 울림은 깊어요. 당신 안에 평화가 깃들기 시작했어요."
                        },
                        en: {
                            regret: "Words are quiet, but the resonance within them is deep. Peace has begun to settle within you.",
                            disappointment: "Disappointment can become the seed of new hope.",
                            shame: "Only those who have passed through shame can gain true freedom.",
                            loneliness: "Solitude was the deepest time of meeting yourself.",
                            helplessness: "Acknowledging helplessness is the beginning of true power.",
                            family: "Healing family wounds is also healing yourself.",
                            relationship: "The pain of relationships has made you a wiser person.",
                            work: "Because of who you were then, you are who you are now.",
                            general: "Words are quiet, but the resonance within them is deep. Peace has begun to settle within you."
                        },
                        pt: {
                            regret: "As palavras são silenciosas, mas a ressonância dentro delas é profunda. A paz começou a se estabelecer dentro de você.",
                            disappointment: "A decepção pode se tornar a semente de uma nova esperança.",
                            shame: "Apenas aqueles que passaram pela vergonha podem obter verdadeira liberdade.",
                            loneliness: "A solidão foi o momento mais profundo de encontrar a si mesmo.",
                            helplessness: "Reconhecer a impotência é o início do verdadeiro poder.",
                            family: "Curar feridas familiares é também curar a si mesmo.",
                            relationship: "A dor dos relacionamentos te tornou uma pessoa mais sábia.",
                            work: "Por causa de quem você era então, você é quem é agora.",
                            general: "As palavras são silenciosas, mas a ressonância dentro delas é profunda. A paz começou a se estabelecer dentro de você."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "용서는 시간이 아니라 선언이야. 지금의 너는… 선언했어. 과거를 끌어안고, 미래로 걸어가겠다고.",
                            disappointment: "실망은 성장의 문이었어요. 당신은 그 문을 통과했어요.",
                            shame: "부끄러움은 과거의 이야기예요. 지금은 새로운 장의 시작이에요.",
                            loneliness: "혼자였던 시간이 당신을 더 깊이 있는 사람으로 만들었어요.",
                            helplessness: "무력감을 경험한 사람만이 진정한 힘을 알 수 있어요.",
                            family: "가족의 상처는 당신을 더 따뜻한 사람으로 만들었어요.",
                            relationship: "관계의 아픔이 당신에게 진정한 사랑을 가르쳐주었어요.",
                            work: "그 시절의 경험이 지금의 지혜가 되었어요.",
                            general: "용서는 시간이 아니라 선언이야. 지금의 너는… 선언했어. 과거를 끌어안고, 미래로 걸어가겠다고."
                        },
                        en: {
                            regret: "Forgiveness is not about time, but declaration. You now... have declared. To embrace the past and walk toward the future.",
                            disappointment: "Disappointment was a door to growth. You have passed through that door.",
                            shame: "Shame is a story of the past. Now is the beginning of a new chapter.",
                            loneliness: "The time you were alone made you a more profound person.",
                            helplessness: "Only those who have experienced helplessness can know true power.",
                            family: "Family wounds have made you a warmer person.",
                            relationship: "The pain of relationships has taught you true love.",
                            work: "The experiences from that time have become today's wisdom.",
                            general: "Forgiveness is not about time, but declaration. You now... have declared. To embrace the past and walk toward the future."
                        },
                        pt: {
                            regret: "O perdão não é sobre tempo, mas declaração. Você agora... declarou. Abraçar o passado e caminhar em direção ao futuro.",
                            disappointment: "A decepção foi uma porta para o crescimento. Você passou por essa porta.",
                            shame: "A vergonha é uma história do passado. Agora é o início de um novo capítulo.",
                            loneliness: "O tempo em que você esteve sozinho te tornou uma pessoa mais profunda.",
                            helplessness: "Apenas aqueles que experimentaram impotência podem conhecer o verdadeiro poder.",
                            family: "Feridas familiares te tornaram uma pessoa mais calorosa.",
                            relationship: "A dor dos relacionamentos te ensinou o verdadeiro amor.",
                            work: "As experiências daquela época se tornaram a sabedoria de hoje.",
                            general: "O perdão não é sobre tempo, mas declaração. Você agora... declarou. Abraçar o passado e caminhar em direção ao futuro."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: "v5-01",
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory
                    state.userResponses.push(responseData);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                if (confirm(t.confirmNextPortal)) {
                    // Save completion status if Firebase available
                    if (state.firebaseInitialized && state.db) {
                        state.db.collection("temarix_v5_progress").add({
                            userId: state.currentUser.uid,
                            portal: "v5-01",
                            status: "complete",
                            timestamp: firebase.firestore.Timestamp.now()
                        }).catch(error => console.error('Error saving progress:', error));
                    }
                    
                    // Redirect to Portal 02 with language parameter
                    window.location.href = `temarix_v05_02.html?lang=${state.currentLanguage}`;
                }
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                if (confirm(t.confirmStay)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 01...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 01 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>