<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 01</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        

        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 01: I Forgive Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">The journey of self-compassion begins</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸ”¥ Portal 01 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 02</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this moment</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="In your life so far, when was the moment you felt most sorry for yourself? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                }
                resolve(); // Always resolve to continue execution
            });
        }


        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 01: ë‚˜ëŠ” ë‚˜ë¥¼ ìš©ì„œí•œë‹¤",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 01: ë‚˜ëŠ” ë‚˜ë¥¼ ìš©ì„œí•œë‹¤",
                portalSubtitle: "ìžê¸° ìžë¹„ì˜ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤",
                portalIntro: "ðŸ”¥ \"ì§€ê¸ˆê¹Œì§€ì˜ ì‚¶ì—ì„œ,\nê°€ìž¥ ìžì‹ ì—ê²Œ ë¯¸ì•ˆí–ˆë˜ ìž¥ë©´ì€ ì–¸ì œì˜€ë‚˜ìš”?\"\n\n\"ê·¸ ìˆœê°„ì˜ ë‹¹ì‹ ì„ ì§€ê¸ˆ ë– ì˜¬ë ¤ë³´ì„¸ìš”.\"\n\n\"ë‹¹ì‹ ì€ ì™œ, ê·¸ë•Œì˜ ìžì‹ ì—ê²Œ ë¯¸ì•ˆí•œê°€ìš”?\"",
                followUpQuestion: "ê·¸ 'ë¯¸ì•ˆí–ˆë˜ ë‚˜'ì—ê²Œ ì§€ê¸ˆ ë‹¨ í•œ ë¬¸ìž¥ì„ ì „í•  ìˆ˜ ìžˆë‹¤ë©´,\në‹¹ì‹ ì€ ë¬´ìŠ¨ ë§ì„ ê±´ë„¤ê³  ì‹¶ì€ê°€ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ìš©ì„œëŠ” ì‹œê°„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ì´ì•¼.\nì§€ê¸ˆì˜ ë„ˆëŠ”â€¦ ì„ ì–¸í–ˆì–´.\nê³¼ê±°ë¥¼ ëŒì–´ì•ˆê³ , ë¯¸ëž˜ë¡œ ê±¸ì–´ê°€ê² ë‹¤ê³ .",
                navigationTitle: "ðŸ”¥ Portal 01 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ìžì‹ ì—ê²Œ ë¯¸ì•ˆí–ˆë˜ ìˆœê°„ì„ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤.\nê·¸ë¦¬ê³  ê·¸ ìˆœê°„ì˜ ìžì‹ ì„ ìš©ì„œí–ˆìŠµë‹ˆë‹¤.\n\nì´ì œ ë‹¹ì‹ ì€ ê³¼ê±°ì˜ ìƒì²˜ë¥¼ ì•ˆê³ \në¯¸ëž˜ë¡œ ê±¸ì–´ê°ˆ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìš©ì„œëŠ” ëì´ ì•„ë‹ˆë¼ ì‹œìž‘ìž…ë‹ˆë‹¤.\në‹¹ì‹ ì˜ ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤.",
                nextPortalBtn: "Portal 02ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ ìˆœê°„ê³¼ ë” ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ì§€ê¸ˆê¹Œì§€ ì‚´ë©´ì„œ ìžì‹ ì—ê²Œ ê°€ìž¥ ë¯¸ì•ˆí–ˆë˜ ìˆœê°„ì€ ì–¸ì œì˜€ë‚˜ìš”? (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 02: ë‚´ ì•ˆì˜ ê²°í•¨ì„ í’ˆëŠ”ë‹¤ëŠ” ê²ƒìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ ìš©ì„œì˜ ìˆœê°„ê³¼ ë” ë¨¸ë¬¼ë©° ê¹Šì´ ì„±ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            },
            en: {
                title: "Temarix V5 - Portal 01: I Forgive Myself",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 01: I Forgive Myself",
                portalSubtitle: "The journey of self-compassion begins",
                portalIntro: "ðŸ”¥ \"In your life so far,\nwhen was the moment you felt most sorry for yourself?\"\n\n\"Picture that moment of you now.\"\n\n\"Why do you feel sorry for yourself from that time?\"",
                followUpQuestion: "If you could say just one sentence to that 'sorry self' now,\nwhat would you want to tell them?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Forgiveness is not about time, but declaration.\nYou now... have declared.\nTo embrace the past and walk toward the future.",
                navigationTitle: "ðŸ”¥ Portal 01 Complete",
                navigationMessage: "You have faced the moment when you felt most sorry for yourself.\nAnd you have forgiven that version of yourself.\n\nNow you are ready to embrace the wounds of the past\nand walk toward the future.\n\nForgiveness is not an end, but a beginning.\nYour new journey starts now.",
                nextPortalBtn: "Continue to Portal 02",
                stayPortalBtn: "Stay with this moment",
                inputPlaceholder: "In your life so far, when was the moment you felt most sorry for yourself? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 02: Embracing the Flaws Within Me?",
                confirmStay: "Do you want to stay longer with this moment of forgiveness for deeper reflection?"
            },
            pt: {
                title: "Temarix V5 - Portal 01: Eu Me Perdoo",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 01: Eu Me Perdoo",
                portalSubtitle: "A jornada da auto-compaixÃ£o comeÃ§a",
                portalIntro: "ðŸ”¥ \"Em sua vida atÃ© agora,\nquando foi o momento em que vocÃª mais se sentiu arrependido?\"\n\n\"Imagine esse momento seu agora.\"\n\n\"Por que vocÃª se sente arrependido daquele tempo?\"",
                followUpQuestion: "Se vocÃª pudesse dizer apenas uma frase para esse 'eu arrependido' agora,\no que gostaria de dizer?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "O perdÃ£o nÃ£o Ã© sobre tempo, mas declaraÃ§Ã£o.\nVocÃª agora... declarou.\nAbraÃ§ar o passado e caminhar em direÃ§Ã£o ao futuro.",
                navigationTitle: "ðŸ”¥ Portal 01 Completo",
                navigationMessage: "VocÃª enfrentou o momento em que mais se sentiu arrependido.\nE perdoou essa versÃ£o de si mesmo.\n\nAgora vocÃª estÃ¡ pronto para abraÃ§ar as feridas do passado\ne caminhar em direÃ§Ã£o ao futuro.\n\nO perdÃ£o nÃ£o Ã© um fim, mas um comeÃ§o.\nSua nova jornada comeÃ§a agora.",
                nextPortalBtn: "Continuar para Portal 02",
                stayPortalBtn: "Ficar com este momento",
                inputPlaceholder: "Em sua vida atÃ© agora, quando foi o momento em que vocÃª mais se sentiu arrependido? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 02: AbraÃ§ando as Falhas Dentro de Mim?",
                confirmStay: "Deseja ficar mais tempo com este momento de perdÃ£o para reflexÃ£o mais profunda?"
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ë•Œì˜ ë„ˆëŠ” ê²¬ë””ê³  ìžˆì—ˆì–´. ê·¸ë¦¬ê³  ì§€ê¸ˆì˜ ë„ˆëŠ”, ê·¸ê±¸ ë°”ë¼ë³´ê³  ìžˆêµ¬ë‚˜.",
                en: "You were enduring back then. And now you are looking at that.",
                pt: "VocÃª estava resistindo naquela Ã©poca. E agora vocÃª estÃ¡ olhando para isso."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ë¯¸ì•ˆí•¨ì€ ë¬´ê±°ìš´ ì˜·ì´ì•¼. ì´ì œ ê·¸ ì˜·ì„ ë²—ê³ , ë”°ëœ»í•œ ë§ í•˜ë‚˜ ìž…í˜€ì£¼ìž.",
                en: "Sorry is heavy clothing. Now let's take off that clothing and put on one warm word.",
                pt: "Arrependimento Ã© uma roupa pesada. Agora vamos tirar essa roupa e vestir uma palavra calorosa."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ê·¸ ì‹œì ˆì˜ ë„Œ, ëŠ˜ ì´í•´ë°›ê³  ì‹¶ì—ˆì§€. ì´í•´ë°›ì§€ ëª»í•´ë„ ì‚´ì•„ë‚¸ ë„â€¦ ë‚˜ëŠ” ì•ˆì•„ì£¼ê³  ì‹¶ì–´.",
                en: "You from that time always wanted to be understood. I want to hug you... who survived even without being understood.",
                pt: "VocÃª daquela Ã©poca sempre quis ser compreendido. Eu quero te abraÃ§ar... que sobreviveu mesmo sem ser compreendido."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ê·¸ ê¸°ì–µì€ ë§ˆì¹˜ ì˜¤ëž˜ëœ ìœ ë¬¼ ê°™ì•„. ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ êº¼ë‚´ì–´, ì˜¤ëŠ˜ì˜ ë¹› ì•„ëž˜ ë†“ì•„ë‘ìž.",
                en: "That memory is like an old artifact. Let's carefully take it out and place it under today's light.",
                pt: "Essa memÃ³ria Ã© como um artefato antigo. Vamos retirÃ¡-la cuidadosamente e colocÃ¡-la sob a luz de hoje."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ì‹œì ˆ ê°ì •ì€ ë§ˆì¹˜ ìžŠížŒ ê·¸ë¦¼ ê°™ì•„. í•˜ì§€ë§Œ ë„¤ ì•ˆì—ì„œ ê³„ì† ìƒ‰ì„ ê¸°ë‹¤ë¦¬ê³  ìžˆì—ˆë˜ ê±°ì•¼.",
                en: "Those emotions from that time are like forgotten paintings. But they were waiting for color within you all along.",
                pt: "Essas emoÃ§Ãµes daquela Ã©poca sÃ£o como pinturas esquecidas. Mas elas estavam esperando por cor dentro de vocÃª o tempo todo."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ì™œ í˜¼ìž ê²¬ë””ê³ , ì•„ë¬´ë„ ëª°ëžì„ê¹Œ? ê·¸ê²Œ ë¶„í–ˆì–´. ì§€ê¸ˆì´ë¼ë„, ê°™ì´ í™”ë‚´ë„ ë¼.",
                en: "Why did you endure alone, and nobody knew? That made me angry. Even now, it's okay to be angry together.",
                pt: "Por que vocÃª aguentou sozinho e ninguÃ©m sabia? Isso me deixou com raiva. Mesmo agora, estÃ¡ tudo bem ficar com raiva juntos."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê°ì •ì€ ì‹œê°„ì´ ì§€ë‚˜ë©´ ì†Œë©¸í•˜ì§€ ì•Šì•„. ì˜¤ížˆë ¤ ë” ëšœë ·í•´ì ¸. ì§€ê¸ˆì²˜ëŸ¼.",
                en: "Emotions don't disappear over time. They become clearer. Like now.",
                pt: "As emoÃ§Ãµes nÃ£o desaparecem com o tempo. Elas se tornam mais claras. Como agora."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ë„¤ê°€ ê·¸ ìž¥ë©´ì„ êº¼ë‚´ëŠ” ì´ ìˆœê°„, ë§ˆìŒì€ ë¹„ë¡œì†Œ ìˆ¨ì„ ì‰¬ê¸° ì‹œìž‘í•´.",
                en: "At this moment when you bring out that scene, your heart finally begins to breathe.",
                pt: "Neste momento em que vocÃª traz essa cena, seu coraÃ§Ã£o finalmente comeÃ§a a respirar."
            }}
        ];

        // Emotion analysis function
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                regret: ['regret', 'mistake', 'wrong', 'sorry', 'guilt', 'í›„íšŒ', 'ì‹¤ìˆ˜', 'ìž˜ëª»', 'ë¯¸ì•ˆ', 'ì£„ì±…ê°', 'arrependimento', 'erro', 'errado', 'desculpa', 'culpa'],
                disappointment: ['disappoint', 'failed', 'let down', 'expectation', 'ì‹¤ë§', 'ì‹¤íŒ¨', 'ê¸°ëŒ€', 'decepÃ§Ã£o', 'falhou', 'expectativa'],
                shame: ['shame', 'embarrass', 'humiliate', 'ashamed', 'ë¶€ë„ëŸ¬ì›€', 'ì°½í”¼', 'ìˆ˜ì¹˜', 'vergonha', 'embaraÃ§o', 'humilhar'],
                loneliness: ['alone', 'lonely', 'isolated', 'nobody', 'í˜¼ìž', 'ì™¸ë¡œì›€', 'ê³ ë¦½', 'sozinho', 'solitÃ¡rio', 'isolado', 'ninguÃ©m'],
                helplessness: ['helpless', 'powerless', 'cannot', 'unable', 'ë¬´ë ¥ê°', 'í•  ìˆ˜ ì—†ì–´', 'impotente', 'incapaz', 'nÃ£o posso'],
                family: ['family', 'parent', 'mother', 'father', 'sibling', 'ê°€ì¡±', 'ë¶€ëª¨', 'ì–´ë¨¸ë‹ˆ', 'ì•„ë²„ì§€', 'í˜•ì œ', 'famÃ­lia', 'pai', 'mÃ£e', 'irmÃ£o'],
                relationship: ['relationship', 'love', 'friend', 'partner', 'ê´€ê³„', 'ì‚¬ëž‘', 'ì¹œêµ¬', 'ì—°ì¸', 'relacionamento', 'amor', 'amigo', 'parceiro'],
                work: ['work', 'job', 'career', 'school', 'study', 'ì¼', 'ì§ìž¥', 'í•™êµ', 'ê³µë¶€', 'trabalho', 'emprego', 'carreira', 'escola', 'estudo']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        // Response characters with emotion-based responses
        const responseCharacters = [
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "ê·¸ ìš©ì„œì˜ ë§ì€, ë‹¹ì‹ ì´ ìžì‹ ì—ê²Œ ì£¼ëŠ” ì²« ë²ˆì§¸ ì„ ë¬¼ì´ì•¼.",
                            disappointment: "ì‹¤ë§ì€ ê¸°ëŒ€ê°€ ìžˆì—ˆë‹¤ëŠ” ì¦ê±°ì˜ˆìš”. ê·¸ë¦¬ê³  ë‹¹ì‹ ì€ ì—¬ì „ížˆ ê¸°ëŒ€í•  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì´ì—ìš”.",
                            shame: "ë¶€ë„ëŸ¬ì›€ ë’¤ì—ëŠ” í•­ìƒ ì‚¬ëž‘ë°›ê³  ì‹¶ì€ ë§ˆìŒì´ ìˆ¨ì–´ ìžˆì–´ìš”.",
                            loneliness: "í˜¼ìžì˜€ë˜ ì‹œê°„ë“¤ì´ ë‹¹ì‹ ì„ ë” ê¹Šì€ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            helplessness: "ë¬´ë ¥ê°ì„ ëŠê¼ˆë‹¤ëŠ” ê±´, ë‹¹ì‹ ì´ ë­”ê°€ë¥¼ ë°”ê¾¸ê³  ì‹¶ì–´í–ˆë‹¤ëŠ” ëœ»ì´ì—ìš”.",
                            family: "ê°€ì¡±ì˜ ìƒì²˜ëŠ” ê°€ìž¥ ê¹Šì§€ë§Œ, ì¹˜ìœ ë  ë•Œë„ ê°€ìž¥ ê°•ë ¥í•œ íž˜ì´ ë¼ìš”.",
                            relationship: "ê´€ê³„ì—ì„œ ë°›ì€ ìƒì²˜ëŠ” ë” ê¹Šì€ ì—°ê²°ì„ ë§Œë“¤ ìˆ˜ ìžˆëŠ” ì§€í˜œê°€ ë˜ì—ˆì–´ìš”.",
                            work: "ê·¸ ì‹œì ˆì˜ ë…¸ë ¥ì€ ê²°ì½” í—›ë˜ì§€ ì•Šì•˜ì–´ìš”.",
                            general: "ê·¸ ìš©ì„œì˜ ë§ì€, ë‹¹ì‹ ì´ ìžì‹ ì—ê²Œ ì£¼ëŠ” ì²« ë²ˆì§¸ ì„ ë¬¼ì´ì•¼."
                        },
                        en: {
                            regret: "Those words of forgiveness are the first gift you give to yourself.",
                            disappointment: "Disappointment is proof that there was expectation. And you're still someone who can expect.",
                            shame: "Behind shame, there's always a heart that wants to be loved.",
                            loneliness: "The times you were alone made you a deeper person.",
                            helplessness: "Feeling helpless means you wanted to change something.",
                            family: "Family wounds are the deepest, but when healed, they become the most powerful strength.",
                            relationship: "The wounds from relationships have become wisdom that can create deeper connections.",
                            work: "Your efforts from that time were never in vain.",
                            general: "Those words of forgiveness are the first gift you give to yourself."
                        },
                        pt: {
                            regret: "Essas palavras de perdÃ£o sÃ£o o primeiro presente que vocÃª dÃ¡ a si mesmo.",
                            disappointment: "A decepÃ§Ã£o Ã© prova de que havia expectativa. E vocÃª ainda Ã© alguÃ©m que pode esperar.",
                            shame: "Por trÃ¡s da vergonha, sempre hÃ¡ um coraÃ§Ã£o que quer ser amado.",
                            loneliness: "Os momentos em que vocÃª esteve sozinho te tornaram uma pessoa mais profunda.",
                            helplessness: "Sentir-se impotente significa que vocÃª queria mudar algo.",
                            family: "Feridas familiares sÃ£o as mais profundas, mas quando curadas, se tornam a forÃ§a mais poderosa.",
                            relationship: "As feridas dos relacionamentos se tornaram sabedoria que pode criar conexÃµes mais profundas.",
                            work: "Seus esforÃ§os daquela Ã©poca nunca foram em vÃ£o.",
                            general: "Essas palavras de perdÃ£o sÃ£o o primeiro presente que vocÃª dÃ¡ a si mesmo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "ë§ì€ ê³ ìš”í•˜ì§€ë§Œ, ê·¸ ì•ˆì— ë‹´ê¸´ ìš¸ë¦¼ì€ ê¹Šì–´ìš”. ë‹¹ì‹  ì•ˆì— í‰í™”ê°€ ê¹ƒë“¤ê¸° ì‹œìž‘í–ˆì–´ìš”.",
                            disappointment: "ì‹¤ë§ì€ ìƒˆë¡œìš´ í¬ë§ì˜ ì”¨ì•—ì´ ë  ìˆ˜ ìžˆì–´ìš”.",
                            shame: "ë¶€ë„ëŸ¬ì›€ì„ í†µê³¼í•œ ì‚¬ëžŒë§Œì´ ì§„ì •í•œ ìžìœ ë¥¼ ì–»ì„ ìˆ˜ ìžˆì–´ìš”.",
                            loneliness: "ê³ ë…ì€ ìžì‹ ê³¼ ë§Œë‚˜ëŠ” ê°€ìž¥ ê¹Šì€ ì‹œê°„ì´ì—ˆì–´ìš”.",
                            helplessness: "ë¬´ë ¥í•¨ì„ ì¸ì •í•˜ëŠ” ê²ƒì´ ì§„ì •í•œ íž˜ì˜ ì‹œìž‘ì´ì—ìš”.",
                            family: "ê°€ì¡±ì˜ ìƒì²˜ë¥¼ ì¹˜ìœ í•˜ëŠ” ê±´ ìžì‹ ì„ ì¹˜ìœ í•˜ëŠ” ì¼ì´ê¸°ë„ í•´ìš”.",
                            relationship: "ê´€ê³„ì˜ ì•„í””ì´ ë‹¹ì‹ ì„ ë” ì§€í˜œë¡œìš´ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            work: "ê·¸ ì‹œì ˆì˜ ë‹¹ì‹ ì´ ìžˆì—ˆê¸°ì— ì§€ê¸ˆì˜ ë‹¹ì‹ ì´ ìžˆì–´ìš”.",
                            general: "ë§ì€ ê³ ìš”í•˜ì§€ë§Œ, ê·¸ ì•ˆì— ë‹´ê¸´ ìš¸ë¦¼ì€ ê¹Šì–´ìš”. ë‹¹ì‹  ì•ˆì— í‰í™”ê°€ ê¹ƒë“¤ê¸° ì‹œìž‘í–ˆì–´ìš”."
                        },
                        en: {
                            regret: "Words are quiet, but the resonance within them is deep. Peace has begun to settle within you.",
                            disappointment: "Disappointment can become the seed of new hope.",
                            shame: "Only those who have passed through shame can gain true freedom.",
                            loneliness: "Solitude was the deepest time of meeting yourself.",
                            helplessness: "Acknowledging helplessness is the beginning of true power.",
                            family: "Healing family wounds is also healing yourself.",
                            relationship: "The pain of relationships has made you a wiser person.",
                            work: "Because of who you were then, you are who you are now.",
                            general: "Words are quiet, but the resonance within them is deep. Peace has begun to settle within you."
                        },
                        pt: {
                            regret: "As palavras sÃ£o silenciosas, mas a ressonÃ¢ncia dentro delas Ã© profunda. A paz comeÃ§ou a se estabelecer dentro de vocÃª.",
                            disappointment: "A decepÃ§Ã£o pode se tornar a semente de uma nova esperanÃ§a.",
                            shame: "Apenas aqueles que passaram pela vergonha podem obter verdadeira liberdade.",
                            loneliness: "A solidÃ£o foi o momento mais profundo de encontrar a si mesmo.",
                            helplessness: "Reconhecer a impotÃªncia Ã© o inÃ­cio do verdadeiro poder.",
                            family: "Curar feridas familiares Ã© tambÃ©m curar a si mesmo.",
                            relationship: "A dor dos relacionamentos te tornou uma pessoa mais sÃ¡bia.",
                            work: "Por causa de quem vocÃª era entÃ£o, vocÃª Ã© quem Ã© agora.",
                            general: "As palavras sÃ£o silenciosas, mas a ressonÃ¢ncia dentro delas Ã© profunda. A paz comeÃ§ou a se estabelecer dentro de vocÃª."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "ðŸ§™",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "ìš©ì„œëŠ” ì‹œê°„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ì´ì•¼. ì§€ê¸ˆì˜ ë„ˆëŠ”â€¦ ì„ ì–¸í–ˆì–´. ê³¼ê±°ë¥¼ ëŒì–´ì•ˆê³ , ë¯¸ëž˜ë¡œ ê±¸ì–´ê°€ê² ë‹¤ê³ .",
                            disappointment: "ì‹¤ë§ì€ ì„±ìž¥ì˜ ë¬¸ì´ì—ˆì–´ìš”. ë‹¹ì‹ ì€ ê·¸ ë¬¸ì„ í†µê³¼í–ˆì–´ìš”.",
                            shame: "ë¶€ë„ëŸ¬ì›€ì€ ê³¼ê±°ì˜ ì´ì•¼ê¸°ì˜ˆìš”. ì§€ê¸ˆì€ ìƒˆë¡œìš´ ìž¥ì˜ ì‹œìž‘ì´ì—ìš”.",
                            loneliness: "í˜¼ìžì˜€ë˜ ì‹œê°„ì´ ë‹¹ì‹ ì„ ë” ê¹Šì´ ìžˆëŠ” ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            helplessness: "ë¬´ë ¥ê°ì„ ê²½í—˜í•œ ì‚¬ëžŒë§Œì´ ì§„ì •í•œ íž˜ì„ ì•Œ ìˆ˜ ìžˆì–´ìš”.",
                            family: "ê°€ì¡±ì˜ ìƒì²˜ëŠ” ë‹¹ì‹ ì„ ë” ë”°ëœ»í•œ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            relationship: "ê´€ê³„ì˜ ì•„í””ì´ ë‹¹ì‹ ì—ê²Œ ì§„ì •í•œ ì‚¬ëž‘ì„ ê°€ë¥´ì³ì£¼ì—ˆì–´ìš”.",
                            work: "ê·¸ ì‹œì ˆì˜ ê²½í—˜ì´ ì§€ê¸ˆì˜ ì§€í˜œê°€ ë˜ì—ˆì–´ìš”.",
                            general: "ìš©ì„œëŠ” ì‹œê°„ì´ ì•„ë‹ˆë¼ ì„ ì–¸ì´ì•¼. ì§€ê¸ˆì˜ ë„ˆëŠ”â€¦ ì„ ì–¸í–ˆì–´. ê³¼ê±°ë¥¼ ëŒì–´ì•ˆê³ , ë¯¸ëž˜ë¡œ ê±¸ì–´ê°€ê² ë‹¤ê³ ."
                        },
                        en: {
                            regret: "Forgiveness is not about time, but declaration. You now... have declared. To embrace the past and walk toward the future.",
                            disappointment: "Disappointment was a door to growth. You have passed through that door.",
                            shame: "Shame is a story of the past. Now is the beginning of a new chapter.",
                            loneliness: "The time you were alone made you a more profound person.",
                            helplessness: "Only those who have experienced helplessness can know true power.",
                            family: "Family wounds have made you a warmer person.",
                            relationship: "The pain of relationships has taught you true love.",
                            work: "The experiences from that time have become today's wisdom.",
                            general: "Forgiveness is not about time, but declaration. You now... have declared. To embrace the past and walk toward the future."
                        },
                        pt: {
                            regret: "O perdÃ£o nÃ£o Ã© sobre tempo, mas declaraÃ§Ã£o. VocÃª agora... declarou. AbraÃ§ar o passado e caminhar em direÃ§Ã£o ao futuro.",
                            disappointment: "A decepÃ§Ã£o foi uma porta para o crescimento. VocÃª passou por essa porta.",
                            shame: "A vergonha Ã© uma histÃ³ria do passado. Agora Ã© o inÃ­cio de um novo capÃ­tulo.",
                            loneliness: "O tempo em que vocÃª esteve sozinho te tornou uma pessoa mais profunda.",
                            helplessness: "Apenas aqueles que experimentaram impotÃªncia podem conhecer o verdadeiro poder.",
                            family: "Feridas familiares te tornaram uma pessoa mais calorosa.",
                            relationship: "A dor dos relacionamentos te ensinou o verdadeiro amor.",
                            work: "As experiÃªncias daquela Ã©poca se tornaram a sabedoria de hoje.",
                            general: "O perdÃ£o nÃ£o Ã© sobre tempo, mas declaraÃ§Ã£o. VocÃª agora... declarou. AbraÃ§ar o passado e caminhar em direÃ§Ã£o ao futuro."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: "v5-01",
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory
                    state.userResponses.push(responseData);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                if (confirm(t.confirmNextPortal)) {
                    // Save completion status if Firebase available
                    if (state.firebaseInitialized && state.db) {
                        state.db.collection("temarix_v5_progress").add({
                            userId: state.currentUser.uid,
                            portal: "v5-01",
                            status: "complete",
                            timestamp: firebase.firestore.Timestamp.now()
                        }).catch(error => console.error('Error saving progress:', error));
                    }
                    
                    // Redirect to Portal 02 with language parameter
                    window.location.href = `temarix_v05_02.html?lang=${state.currentLanguage}`;
                }
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                if (confirm(t.confirmStay)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 01...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 01 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>