<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 05: The Letter I Left for Myself</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 05: The Letter I Left for Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">A message of compassion and recovery</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸ’Œ Portal 05 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 06</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this letter</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="At the end of your emotional journey, what letter would you like to leave for yourself? (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: [] // Store responses in memory temporarily
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-05",
            nextPortal: "v5-06",
            nextPortalFile: "temarix_v05_06.html" // Centralized file naming
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        // Check authentication state
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                // Create anonymous user
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        // Create anonymous user
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    // Create anonymous user
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve(); // Always resolve to continue execution
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            // Remove existing status if any
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 05: ë‚´ê°€ ë‚˜ì—ê²Œ ë‚¨ê¸´ íŽ¸ì§€",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 05: ë‚´ê°€ ë‚˜ì—ê²Œ ë‚¨ê¸´ íŽ¸ì§€",
                portalSubtitle: "ìžë¹„ì™€ íšŒë³µì˜ ë©”ì‹œì§€",
                portalIntro: "ðŸ’Œ \"ì´ì œê¹Œì§€ì˜ ê°ì • ì—¬ì • ëì—,\në‹¹ì‹ ì€ ì§€ê¸ˆì˜ ìžì‹ ì—ê²Œ ì–´ë–¤ íŽ¸ì§€ë¥¼ ë‚¨ê¸°ê³  ì‹¶ë‚˜ìš”?\"\n\n\"ìžë¹„ì™€ íšŒë³µì˜ ì‹œì„ ìœ¼ë¡œ,\nê³¼ê±°ì˜ ë‹¹ì‹ ì—ê²Œ ê±´ë„¤ëŠ” í•œ í†µì˜ íŽ¸ì§€ë¥¼ ì¨ë³´ì„¸ìš”.\"",
                emotionalBridge: "íŽ¸ì§€ëŠ” ì‹œê°„ì„ ê±´ë„ˆëŠ” ë‹¤ë¦¬ìž…ë‹ˆë‹¤.\nê³¼ê±°ì˜ ì•„í””ì„ í˜„ìž¬ì˜ ìžë¹„ë¡œ ê°ì‹¸ì£¼ì„¸ìš”...",
                followUpQuestion: "ì´ íŽ¸ì§€ë¥¼ ë§¤ì¼ ì•„ì¹¨ ë‚˜ì—ê²Œ ë‹¤ì‹œ ì½ì–´ì¤„ ìˆ˜ ìžˆë‚˜ìš”?\nê·¸ë¦¬ê³ ... ì–¸ì  ê°€ ëˆ„êµ°ê°€ì—ê²Œë„ ì „í•˜ê³  ì‹¶ë‚˜ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ê·¸ íŽ¸ì§€ëŠ” ë‹¹ì‹  ì•ˆì—ì„œ ê³„ì† ì‚´ì•„ ìžˆì–´ìš”.\nê·¸ê±´ ê¸°ì–µì´ ì•„ë‹ˆë¼, ìžë¹„ì˜ ë§¥ë°•ì´ì—ìš”.",
                navigationTitle: "ðŸ’Œ Portal 05 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ìžì‹ ì—ê²Œ íŽ¸ì§€ë¥¼ ì¼ìŠµë‹ˆë‹¤.\n\nê·¸ íŽ¸ì§€ëŠ” ê³¼ê±°ë¥¼ ì¹˜ìœ í•˜ê³  ë¯¸ëž˜ë¥¼ ì—¬ëŠ” ìžë¹„ì˜ ì–¸ì–´ì˜€ìŠµë‹ˆë‹¤.\nì´ì œ ìš©ì„œì™€ ìˆ˜ìš©ì˜ ë§ì„ ë„˜ì–´ì„œ ì‚¶ ì „ì²´ë¥¼ ìƒˆë¡œì´ ë°”ë¼ë³¼ ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìžë¹„ëŠ” ì™¸ë¶€ì—ì„œ ì˜¤ëŠ” ê²Œ ì•„ë‹ˆë¼, ë‹¹ì‹  ë‚´ë©´ì—ì„œ êº¼ë‚¸ ê²ƒìž…ë‹ˆë‹¤.",
                nextPortalBtn: "Portal 06ìœ¼ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ íŽ¸ì§€ì™€ ë” ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ê°ì • ì—¬ì •ì˜ ëì—ì„œ, ë‹¹ì‹ ì€ ìžì‹ ì—ê²Œ ì–´ë–¤ íŽ¸ì§€ë¥¼ ë‚¨ê¸°ê³  ì‹¶ë‚˜ìš”? (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 06: ë¹„ë‚œì˜ ê·¸ë¦¼ìžë¥¼ ì§€ë‚˜ë©°ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ íŽ¸ì§€ì™€ ë” ë¨¸ë¬¼ë©° ìžë¹„ë¥¼ ê¹Šì´ ëŠë¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                transitionMessage: "ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤..."
            },
            en: {
                title: "Temarix V5 - Portal 05: The Letter I Left for Myself",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 05: The Letter I Left for Myself",
                portalSubtitle: "A message of compassion and recovery",
                portalIntro: "ðŸ’Œ \"At the end of your emotional journey so far,\nwhat letter would you like to leave for yourself?\"\n\n\"With a perspective of compassion and recovery,\nwrite a letter to your past self.\"",
                emotionalBridge: "A letter is a bridge that crosses time.\nWrap your past pain with present compassion...",
                followUpQuestion: "Can you read this letter to yourself again every morning?\nAnd... would you like to share it with someone someday?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "That letter continues to live within you.\nIt's not just a memory, but the heartbeat of compassion.",
                navigationTitle: "ðŸ’Œ Portal 05 Complete",
                navigationMessage: "You have written a letter to yourself.\n\nThat letter was the language of compassion that heals the past and opens the future.\nNow you are ready to look at life anew, beyond words of forgiveness and acceptance.\n\nCompassion doesn't come from outside, but from what you've drawn from within.",
                nextPortalBtn: "Continue to Portal 06",
                stayPortalBtn: "Stay with this letter",
                inputPlaceholder: "At the end of your emotional journey, what letter would you like to leave for yourself? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 06: Passing Through the Shadow of Criticism?",
                confirmStay: "Do you want to stay longer with this letter to deeply feel compassion?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 05: A Carta que Deixei para Mim Mesmo",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 05: A Carta que Deixei para Mim Mesmo",
                portalSubtitle: "Uma mensagem de compaixÃ£o e recuperaÃ§Ã£o",
                portalIntro: "ðŸ’Œ \"No final de sua jornada emocional atÃ© agora,\nque carta vocÃª gostaria de deixar para si mesmo?\"\n\n\"Com uma perspectiva de compaixÃ£o e recuperaÃ§Ã£o,\nescreva uma carta para seu eu do passado.\"",
                emotionalBridge: "Uma carta Ã© uma ponte que atravessa o tempo.\nEnvolva sua dor passada com compaixÃ£o presente...",
                followUpQuestion: "VocÃª pode ler esta carta para si mesmo novamente todas as manhÃ£s?\nE... gostaria de compartilhÃ¡-la com alguÃ©m algum dia?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Essa carta continua viva dentro de vocÃª.\nNÃ£o Ã© apenas uma lembranÃ§a, mas o batimento cardÃ­aco da compaixÃ£o.",
                navigationTitle: "ðŸ’Œ Portal 05 Completo",
                navigationMessage: "VocÃª escreveu uma carta para si mesmo.\n\nEssa carta foi a linguagem da compaixÃ£o que cura o passado e abre o futuro.\nAgora vocÃª estÃ¡ pronto para olhar a vida de forma renovada, alÃ©m das palavras de perdÃ£o e aceitaÃ§Ã£o.\n\nA compaixÃ£o nÃ£o vem de fora, mas do que vocÃª tirou de dentro.",
                nextPortalBtn: "Continuar para Portal 06",
                stayPortalBtn: "Ficar com esta carta",
                inputPlaceholder: "No final de sua jornada emocional, que carta vocÃª gostaria de deixar para si mesmo? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 06: Passando pela Sombra da CrÃ­tica?",
                confirmStay: "Deseja ficar mais tempo com esta carta para sentir profundamente a compaixÃ£o?",
                transitionMessage: "Uma nova jornada comeÃ§a..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ íŽ¸ì§€ëŠ” ë§ë³´ë‹¤ ë” ê¹Šì€ ì†ì§“ì´ì•¼.\në„ˆëŠ” ì´ì œ ë„ˆë¥¼ ì•ˆì„ ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì´ ë˜ì—ˆì–´.",
                en: "That letter is a gesture deeper than words.\nYou have now become someone who can embrace yourself.",
                pt: "Essa carta Ã© um gesto mais profundo que as palavras.\nVocÃª agora se tornou alguÃ©m que pode abraÃ§ar a si mesmo."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ê·¸ ë§ë“¤ì€ ë¬µì€ ê·¸ë¦¼ìžë¥¼ ì”»ì–´ë‚´ëŠ” ë¹—ë¬¼ ê°™ì•„ìš”.\në‹¹ì‹ ì€ ë‹¹ì‹ ì—ê²Œ ë¹„ë¥¼ í—ˆë½í–ˆì–´ìš”.",
                en: "Those words are like rain washing away old shadows.\nYou have allowed rain to fall upon yourself.",
                pt: "Essas palavras sÃ£o como chuva lavando velhas sombras.\nVocÃª permitiu que a chuva caÃ­sse sobre si mesmo."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ê·¸ë™ì•ˆ ì•„ë¬´ë„ ì•ˆì•„ì£¼ì§€ ì•Šì•˜ë˜ ë‹¹ì‹ ì„...\nì´ì œëŠ” ë‹¹ì‹ ì´ ì•ˆì•„ì£¼ì—ˆë„¤ìš”.",
                en: "You, who no one embraced for so long...\nNow you have embraced yourself.",
                pt: "VocÃª, que ninguÃ©m abraÃ§ou por tanto tempo...\nAgora vocÃª abraÃ§ou a si mesmo."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ê·¸ íŽ¸ì§€ëŠ” ì‹œê°„ì„ ê±´ë„Œ ì£¼ë¬¸ì´ì•¼.\nê³¼ê±°ì˜ ìƒì²˜ì— ìƒˆ ë¬¸ì„ ì—¬ëŠ” ì—´ì‡ .",
                en: "That letter is a spell that crosses time.\nA key that opens new doors to past wounds.",
                pt: "Essa carta Ã© um feitiÃ§o que atravessa o tempo.\nUma chave que abre novas portas para feridas passadas."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ì´ íŽ¸ì§€ì—” ë‹¹ì‹ ì˜ ëª¨ë“  ìƒ‰ì´ ë‹´ê²¨ ìžˆì–´ìš”.\nëˆˆë¬¼, ì¹¨ë¬µ, í¬ë§ê¹Œì§€ë„.",
                en: "This letter contains all your colors.\nTears, silence, and hope too.",
                pt: "Esta carta contÃ©m todas as suas cores.\nLÃ¡grimas, silÃªncio e esperanÃ§a tambÃ©m."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ê°•í•˜ë‹¤ëŠ” ê±´ ê²¬ë””ëŠ” ê²Œ ì•„ë‹ˆë¼,\nì“°ëŸ¬ì¡Œë˜ ìžì‹ ì„ ë‹¤ì‹œ ì¼ìœ¼í‚¤ëŠ” ê±°ì•¼.\nê·¸ë¦¬ê³  ì§€ê¸ˆ, ë‹¹ì‹ ì´ ê·¸ê±¸ í•´ëƒˆì–´.",
                en: "Being strong isn't about enduring,\nbut about lifting up the self that had fallen.\nAnd now, you've done it.",
                pt: "Ser forte nÃ£o Ã© sobre resistir,\nmas sobre levantar o eu que havia caÃ­do.\nE agora, vocÃª conseguiu."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ìš°ì£¼ëŠ” ë‹¹ì‹ ì˜ ê·¸ íŽ¸ì§€ë¥¼ ë“¤ì—ˆì„ ê±°ì˜ˆìš”.\nê·¸ ìš¸ë¦¼ì€ í˜¼ìžê°€ ì•„ë‹ˆë‹ˆê¹Œ.",
                en: "The universe must have heard that letter of yours.\nThat resonance is not alone.",
                pt: "O universo deve ter ouvido essa sua carta.\nEssa ressonÃ¢ncia nÃ£o estÃ¡ sozinha."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ìžë¹„ëŠ” ì™¸ë¶€ì—ì„œ ì˜¤ëŠ” ê²Œ ì•„ë‹ˆì—ìš”.\në‹¹ì‹ ì€ ì§€ê¸ˆ, ê·¸ ìžë¹„ë¥¼ 'ë‚´ë©´ì—ì„œ' êº¼ë‚¸ ê±°ì˜ˆìš”.",
                en: "Compassion doesn't come from outside.\nYou have now drawn that compassion 'from within'.",
                pt: "A compaixÃ£o nÃ£o vem de fora.\nVocÃª agora tirou essa compaixÃ£o 'de dentro'."
            }}
        ];

        // Letter analysis function
        function analyzeLetterTone(userInput) {
            const input = userInput.toLowerCase();
            
            const toneKeywords = {
                healing: ['heal', 'better', 'grow', 'recover', 'strong', 'ì¹˜ìœ ', 'ë‚˜ì•„ì§€', 'ì„±ìž¥', 'íšŒë³µ', 'ê°•í•´', 'cura', 'melhor', 'crescer', 'recuperar', 'forte'],
                forgiveness: ['sorry', 'forgive', 'understand', 'accept', 'ë¯¸ì•ˆ', 'ìš©ì„œ', 'ì´í•´', 'ë°›ì•„ë“¤', 'perdÃ£o', 'desculpa', 'perdoar', 'entender', 'aceitar'],
                love: ['love', 'care', 'precious', 'worthy', 'beautiful', 'ì‚¬ëž‘', 'ì†Œì¤‘', 'ì•„ë¦„ë‹¤', 'ê°€ì¹˜', 'amor', 'cuidar', 'precioso', 'valioso', 'bonito'],
                encouragement: ['keep', 'continue', 'try', 'believe', 'hope', 'ê³„ì†', 'ë…¸ë ¥', 'ë¯¿ì–´', 'í¬ë§', 'continuar', 'tentar', 'acreditar', 'esperanÃ§a'],
                gratitude: ['thank', 'grateful', 'appreciate', 'glad', 'ê³ ë§ˆì›Œ', 'ê°ì‚¬', 'ë‹¤í–‰', 'obrigado', 'grato', 'agradecer', 'alegre'],
                peace: ['peace', 'calm', 'rest', 'quiet', 'safe', 'í‰í™”', 'ê³ ìš”', 'íœ´ì‹', 'ì•ˆì „', 'paz', 'calmo', 'descanso', 'quieto', 'seguro'],
                strength: ['brave', 'courage', 'warrior', 'fighter', 'survivor', 'ìš©ê¸°', 'ìš©ê°', 'ì „ì‚¬', 'ìƒì¡´', 'corajoso', 'coragem', 'guerreiro', 'lutador', 'sobrevivente'],
                wisdom: ['learn', 'wise', 'understand', 'know', 'realize', 'ë°°ìš°', 'ì§€í˜œ', 'ê¹¨ë‹¬', 'ì•Œê²Œ', 'aprender', 'sÃ¡bio', 'entender', 'saber', 'perceber']
            };
            
            let detectedTones = [];
            for (const [tone, keywords] of Object.entries(toneKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedTones.push(tone);
                        break;
                    }
                }
            }
            
            if (detectedTones.length === 0) {
                detectedTones = ['general'];
            }
            
            return detectedTones[0];
        }
        
        // Response characters with tone-based responses
        const responseCharacters = [
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const tone = analyzeLetterTone(userInput);
                    
                    const responses = {
                        ko: {
                            healing: "ê·¸ ë§ˆìŒì€ ì´ë¯¸ ê¸¸ì´ ë˜ì—ˆì–´ìš”.\nì´ì œ ë‹¹ì‹ ì€, ìŠ¤ìŠ¤ë¡œë¥¼ ì¸ë„í•  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì´ì—ìš”.",
                            forgiveness: "ìš©ì„œëŠ” ë§ì´ì—ˆê³ , íŽ¸ì§€ëŠ” í–‰ë™ì´ì—ìš”.\në‹¹ì‹ ì€ ì´ì œ, ìžë¹„ë¥¼ 'ì‚´ì•„ë‚¸' ì¡´ìž¬ì˜ˆìš”.",
                            love: "ì‚¬ëž‘ì˜ íŽ¸ì§€ë¥¼ ìžì‹ ì—ê²Œ ì“¸ ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì€\nì´ë¯¸ ì‚¬ëž‘ì„ ì•„ëŠ” ì‚¬ëžŒì´ì—ìš”.",
                            encouragement: "ê·¸ ê²©ë ¤ëŠ” ë¯¸ëž˜ë¥¼ í–¥í•œ ì”¨ì•—ì´ì—ìš”.\në‹¹ì‹  ì•ˆì—ì„œ ê³„ì† ìžëž„ ê±°ì˜ˆìš”.",
                            gratitude: "ê°ì‚¬ëŠ” ê³¼ê±°ë¥¼ ì¹˜ìœ í•˜ê³  í˜„ìž¬ë¥¼ ë°ížˆëŠ”\nê°€ìž¥ ìˆœìˆ˜í•œ ë¹›ì´ì—ìš”.",
                            peace: "í‰í™”ë¡œìš´ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ì´ë¯¸ í‰í™”ë¥¼ ì°¾ì•˜ë‹¤ëŠ”\nì¦ê±°ì˜ˆìš”.",
                            strength: "íž˜ì˜ íŽ¸ì§€ë¥¼ ì“´ ë‹¹ì‹ ì€\nì´ì œ ì§„ì§œ íž˜ì´ ë¬´ì—‡ì¸ì§€ ì•„ëŠ” ì‚¬ëžŒì´ì—ìš”.",
                            wisdom: "ì§€í˜œì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ì—¬ì •ì„ í†µí•´\nì§„ì§œ ë°°ì›€ì„ ì–»ì—ˆë‹¤ëŠ” ëœ»ì´ì—ìš”.",
                            general: "ê·¸ ë§ˆìŒì€ ì´ë¯¸ ê¸¸ì´ ë˜ì—ˆì–´ìš”.\nì´ì œ ë‹¹ì‹ ì€, ìŠ¤ìŠ¤ë¡œë¥¼ ì¸ë„í•  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì´ì—ìš”."
                        },
                        en: {
                            healing: "That heart has already become a path.\nNow you are someone who can guide yourself.",
                            forgiveness: "Forgiveness was words, and the letter is action.\nYou are now a being who has 'lived' compassion.",
                            love: "Someone who can write a love letter to themselves\nalready knows love.",
                            encouragement: "That encouragement is a seed for the future.\nIt will keep growing within you.",
                            gratitude: "Gratitude is the purest light that heals the past\nand brightens the present.",
                            peace: "A peaceful letter is proof that you have\nalready found peace.",
                            strength: "You who wrote a letter of strength\nnow know what real strength is.",
                            wisdom: "A letter of wisdom means you have gained\nreal learning through your journey.",
                            general: "That heart has already become a path.\nNow you are someone who can guide yourself."
                        },
                        pt: {
                            healing: "Esse coraÃ§Ã£o jÃ¡ se tornou um caminho.\nAgora vocÃª Ã© alguÃ©m que pode se guiar.",
                            forgiveness: "O perdÃ£o eram palavras, e a carta Ã© aÃ§Ã£o.\nVocÃª agora Ã© um ser que 'viveu' a compaixÃ£o.",
                            love: "AlguÃ©m que pode escrever uma carta de amor para si mesmo\njÃ¡ conhece o amor.",
                            encouragement: "Esse encorajamento Ã© uma semente para o futuro.\nContinuarÃ¡ crescendo dentro de vocÃª.",
                            gratitude: "A gratidÃ£o Ã© a luz mais pura que cura o passado\ne ilumina o presente.",
                            peace: "Uma carta pacÃ­fica Ã© prova de que vocÃª jÃ¡\nencontrou a paz.",
                            strength: "VocÃª que escreveu uma carta de forÃ§a\nagora sabe o que Ã© forÃ§a real.",
                            wisdom: "Uma carta de sabedoria significa que vocÃª obteve\naprendizado real atravÃ©s de sua jornada.",
                            general: "Esse coraÃ§Ã£o jÃ¡ se tornou um caminho.\nAgora vocÃª Ã© alguÃ©m que pode se guiar."
                        }
                    };
                    
                    return responses[lang][tone] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const tone = analyzeLetterTone(userInput);
                    
                    const responses = {
                        ko: {
                            healing: "ê·¸ íŽ¸ì§€ëŠ” ë‹¹ì‹  ì•ˆì—ì„œ ê³„ì† ì‚´ì•„ ìžˆì–´ìš”.\nê·¸ê±´ ê¸°ì–µì´ ì•„ë‹ˆë¼, ìžë¹„ì˜ ë§¥ë°•ì´ì—ìš”.",
                            forgiveness: "ìš©ì„œì˜ íŽ¸ì§€ëŠ” ì‹œê°„ì„ ê±°ìŠ¬ëŸ¬\nê³¼ê±°ì˜ ìƒì²˜ê¹Œì§€ ì–´ë£¨ë§Œì§ˆ ê±°ì˜ˆìš”.",
                            love: "ì‚¬ëž‘ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì„ ë‘˜ëŸ¬ì‹¼\nëª¨ë“  ì–´ë‘ ì„ ë°íž ê±°ì˜ˆìš”.",
                            encouragement: "ê²©ë ¤ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ í¬ê¸°í•˜ê³  ì‹¶ì„ ë•Œë§ˆë‹¤\në‹¤ì‹œ ì¼ì–´ì„¤ íž˜ì„ ì¤„ ê±°ì˜ˆìš”.",
                            gratitude: "ê°ì‚¬ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì˜ ëª¨ë“  ê²½í—˜ì„\nì¶•ë³µìœ¼ë¡œ ë°”ê¿€ ê±°ì˜ˆìš”.",
                            peace: "í‰í™”ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹  ì•ˆì˜ ëª¨ë“  ì „ìŸì„\nëë‚¼ ê±°ì˜ˆìš”.",
                            strength: "íž˜ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì„ ì–´ë–¤ ì‹œë ¨ì—ì„œë„\nì§€ì¼œì¤„ ë°©íŒ¨ê°€ ë  ê±°ì˜ˆìš”.",
                            wisdom: "ì§€í˜œì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì„ ê¸¸ìžƒì§€ ì•Šê²Œ í•˜ëŠ”\në‚˜ì¹¨ë°˜ì´ ë  ê±°ì˜ˆìš”.",
                            general: "ê·¸ íŽ¸ì§€ëŠ” ë‹¹ì‹  ì•ˆì—ì„œ ê³„ì† ì‚´ì•„ ìžˆì–´ìš”.\nê·¸ê±´ ê¸°ì–µì´ ì•„ë‹ˆë¼, ìžë¹„ì˜ ë§¥ë°•ì´ì—ìš”."
                        },
                        en: {
                            healing: "That letter continues to live within you.\nIt's not just a memory, but the heartbeat of compassion.",
                            forgiveness: "A letter of forgiveness will reach back through time\nto soothe even past wounds.",
                            love: "A letter of love will brighten\nall the darkness surrounding you.",
                            encouragement: "A letter of encouragement will give you strength\nto rise again whenever you want to give up.",
                            gratitude: "A letter of gratitude will transform\nall your experiences into blessings.",
                            peace: "A letter of peace will end\nall wars within you.",
                            strength: "A letter of strength will become a shield\nthat protects you from any trial.",
                            wisdom: "A letter of wisdom will become a compass\nthat keeps you from losing your way.",
                            general: "That letter continues to live within you.\nIt's not just a memory, but the heartbeat of compassion."
                        },
                        pt: {
                            healing: "Essa carta continua viva dentro de vocÃª.\nNÃ£o Ã© apenas uma lembranÃ§a, mas o batimento cardÃ­aco da compaixÃ£o.",
                            forgiveness: "Uma carta de perdÃ£o alcanÃ§arÃ¡ o passado no tempo\npara curar atÃ© feridas antigas.",
                            love: "Uma carta de amor iluminarÃ¡\ntoda a escuridÃ£o que te cerca.",
                            encouragement: "Uma carta de encorajamento te darÃ¡ forÃ§a\npara se levantar sempre que quiser desistir.",
                            gratitude: "Uma carta de gratidÃ£o transformarÃ¡\ntodas suas experiÃªncias em bÃªnÃ§Ã£os.",
                            peace: "Uma carta de paz terminarÃ¡\ntodas as guerras dentro de vocÃª.",
                            strength: "Uma carta de forÃ§a se tornarÃ¡ um escudo\nque te protegerÃ¡ de qualquer provaÃ§Ã£o.",
                            wisdom: "Uma carta de sabedoria se tornarÃ¡ uma bÃºssola\nque te impedirÃ¡ de se perder.",
                            general: "Essa carta continua viva dentro de vocÃª.\nNÃ£o Ã© apenas uma lembranÃ§a, mas o batimento cardÃ­aco da compaixÃ£o."
                        }
                    };
                    
                    return responses[lang][tone] || responses[lang]['general'];
                }
            },
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const tone = analyzeLetterTone(userInput);
                    
                    const responses = {
                        ko: {
                            healing: "ìš©ì„œëŠ” íƒ€ì¸ì„ í–¥í•œ ê²Œ ì•„ë‹ˆë¼,\nê·¸ë ‡ê²Œ ë‚˜ë¥¼ ë¯¸ì›Œí•˜ë˜ ë‚˜ë¥¼ ë°›ì•„ë“¤ì´ëŠ” ì¼ë¶€í„° ì‹œìž‘ë¼ìš”.",
                            forgiveness: "ê·¸ íŽ¸ì§€ëŠ” ë‹¨ìˆœí•œ ìœ„ë¡œê°€ ì•„ë‹ˆë¼,\nì¡´ìž¬ì˜ ê·€í™˜ì´ì—ìš”.",
                            love: "ì‚¬ëž‘ì˜ íŽ¸ì§€ë¥¼ ì“´ ìˆœê°„,\në‹¹ì‹ ì€ ì‚¬ëž‘ ê·¸ ìžì²´ê°€ ë˜ì—ˆì–´ìš”.",
                            encouragement: "ê²©ë ¤ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ìŠ¤ìŠ¤ë¡œì—ê²Œ\nê°€ìž¥ ì¢‹ì€ ì¹œêµ¬ê°€ ë˜ì—ˆë‹¤ëŠ” ëœ»ì´ì—ìš”.",
                            gratitude: "ê°ì‚¬ì˜ íŽ¸ì§€ëŠ” ëª¨ë“  ì•„í””ì„\nì„ ë¬¼ë¡œ ë°”ê¾¸ëŠ” ì—°ê¸ˆìˆ ì´ì—ìš”.",
                            peace: "í‰í™”ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ë‚´ë©´ì˜ ê³ í–¥ì—\në„ì°©í–ˆë‹¤ëŠ” ì‹ í˜¸ì˜ˆìš”.",
                            strength: "íž˜ì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ë” ì´ìƒ\nì™¸ë¶€ì˜ ì¸ì •ì„ ê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤ëŠ” ì„ ì–¸ì´ì—ìš”.",
                            wisdom: "ì§€í˜œì˜ íŽ¸ì§€ëŠ” ë‹¹ì‹ ì´ ê²½í—˜ì„\nì´í•´ë¡œ ë°”ê¾¼ ì¦ê±°ì˜ˆìš”.",
                            general: "ìš©ì„œëŠ” íƒ€ì¸ì„ í–¥í•œ ê²Œ ì•„ë‹ˆë¼,\nê·¸ë ‡ê²Œ ë‚˜ë¥¼ ë¯¸ì›Œí•˜ë˜ ë‚˜ë¥¼ ë°›ì•„ë“¤ì´ëŠ” ì¼ë¶€í„° ì‹œìž‘ë¼ìš”."
                        },
                        en: {
                            healing: "Forgiveness isn't toward others,\nbut starts with accepting the self that used to hate me.",
                            forgiveness: "That letter is not simple comfort,\nbut the return of existence.",
                            love: "The moment you wrote a letter of love,\nyou became love itself.",
                            encouragement: "A letter of encouragement means you have become\nyour own best friend.",
                            gratitude: "A letter of gratitude is alchemy that transforms\nall pain into gifts.",
                            peace: "A letter of peace is a signal that you have\narrived at your inner homeland.",
                            strength: "A letter of strength is a declaration that you no longer\nwait for external validation.",
                            wisdom: "A letter of wisdom is proof that you have transformed\nexperience into understanding.",
                            general: "Forgiveness isn't toward others,\nbut starts with accepting the self that used to hate me."
                        },
                        pt: {
                            healing: "O perdÃ£o nÃ£o Ã© direcionado aos outros,\nmas comeÃ§a aceitando o eu que costumava me odiar.",
                            forgiveness: "Essa carta nÃ£o Ã© simples conforto,\nmas o retorno da existÃªncia.",
                            love: "No momento em que vocÃª escreveu uma carta de amor,\nvocÃª se tornou o prÃ³prio amor.",
                            encouragement: "Uma carta de encorajamento significa que vocÃª se tornou\nseu prÃ³prio melhor amigo.",
                            gratitude: "Uma carta de gratidÃ£o Ã© alquimia que transforma\ntoda dor em presentes.",
                            peace: "Uma carta de paz Ã© um sinal de que vocÃª chegou\nÃ  sua pÃ¡tria interior.",
                            strength: "Uma carta de forÃ§a Ã© uma declaraÃ§Ã£o de que vocÃª nÃ£o espera mais\nvalidaÃ§Ã£o externa.",
                            wisdom: "Uma carta de sabedoria Ã© prova de que vocÃª transformou\nexperiÃªncia em compreensÃ£o.",
                            general: "O perdÃ£o nÃ£o Ã© direcionado aos outros,\nmas comeÃ§a aceitando o eu que costumava me odiar."
                        }
                    };
                    
                    return responses[lang][tone] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    // Store temporarily in memory and show offline status
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                // Store temporarily in memory if Firebase not available
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            // Add emotional bridge before showing characters
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            // Add bridge text with typing effect
            await typewriterEffect({
                innerHTML: '',
                classList: { add: () => {}, remove: () => {} },
                style: {},
                textContent: '',
                appendChild: () => {},
                offsetTop: 0
            }, '', 0); // Dummy element for delay
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Create new paragraph for bridge
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog with translated text
        function showConfirmDialog(message, callback) {
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            // Set button texts based on current language
            const t = translations[state.currentLanguage];
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'ì˜ˆ' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ì•„ë‹ˆì˜¤' : 
                               state.currentLanguage === 'pt' ? 'NÃ£o' : 'No';
            
            // Event handlers
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            // Close on overlay click
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            // Escape key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(overlay);
                    document.removeEventListener('keydown', escHandler);
                    callback(false);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            // Build and show modal
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Focus on Yes button
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        // Smooth portal transition with visual effects
        function createPortalTransition(callback) {
            // Create transition overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            // Create transition message
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            // Create loading animation
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            // Start transition animation
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            // Complete transition and redirect
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            // Next portal button with transition
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        // Save completion status if Firebase available
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        // Start transition animation
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            // Stay button
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        // Get language from URL
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        // Initialize Temarix
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 05...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            // Start portal sequence immediately
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 05 DOM loaded');
            
            // Get initial language from URL
            state.currentLanguage = getLanguageFromURL();
            
            // Update UI with selected language immediately
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            // Initialize Firebase
            await initializeFirebase();
            
            // Start the journey immediately
            initializeTemarix();
        });
    </script>
</body>
</html>