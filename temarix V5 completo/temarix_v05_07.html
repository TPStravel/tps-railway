<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 07: The Day I Named My Tears</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 07: The Day I Named My Tears</div>
            <div class="portal-subtitle" id="portalSubtitle">Giving meaning to what falls from within</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸ’§ Portal 07 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 08</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these tears</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me about an unforgettable tear from your life... (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: []
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-07",
            nextPortal: "v5-08",
            nextPortalFile: "temarix_v05_08.html"
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve();
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'ì˜¤í”„ë¼ì¸ ëª¨ë“œ' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 07: ëˆˆë¬¼ì—ê²Œ ì´ë¦„ì„ ì¤€ ë‚ ",
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 07: ëˆˆë¬¼ì—ê²Œ ì´ë¦„ì„ ì¤€ ë‚ ",
                portalSubtitle: "ë‚´ë©´ì—ì„œ í˜ëŸ¬ë‚˜ì˜¨ ê²ƒë“¤ì— ì˜ë¯¸ë¥¼ ë¶€ì—¬í•˜ê¸°",
                portalIntro: "ðŸ’§ \"ë‹¹ì‹ ì˜ ì‚¶ì—ì„œ, ìžŠížˆì§€ ì•ŠëŠ” í•œ ë°©ìš¸ì˜ ëˆˆë¬¼ì´ ìžˆë‹¤ë©´...\nê·¸ê±´ ì–¸ì œì˜€ë‚˜ìš”?\"\n\n\"ê·¸ ëˆˆë¬¼ì€ ì–´ë–¤ ê°ì •ì˜ ì´ë¦„ì„ ê°€ì§€ê³  ìžˆì—ˆë‚˜ìš”?\"",
                emotionalBridge: "ëˆˆë¬¼ì€ ë§ì´ ì—†ì§€ë§Œ, ê°ì •ì˜ ì§„ì‹¤ì„ ê°€ìž¥ ë¨¼ì € ë§í•©ë‹ˆë‹¤.\nì§€ê¸ˆ, ê·¸ ëˆˆë¬¼ì—ê²Œ ì´ë¦„ì„ ì¤„ ìˆ˜ ìžˆë‚˜ìš”?",
                followUpQuestion: "ê·¸ ëˆˆë¬¼ì„ ë‹¤ì‹œ ë– ì˜¬ë¦¬ë©°,\nì§€ê¸ˆ ê·¸ ê°ì •ì—ê²Œ í•œë§ˆë””ë¥¼ ê±´ë„¨ë‹¤ë©´ ë­ë¼ê³  í•˜ê³  ì‹¶ë‚˜ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ëˆˆë¬¼ì€ ì‚¬ë¼ì§€ì§€ ì•Šì•„ìš”.\nê°ì •ì˜ ë¬¼ê°ì´ ë˜ì–´, ì˜¤ëŠ˜ ë‹¹ì‹ ì„ ë” ì„ ëª…í•˜ê²Œ ë§Œë“¤ì£ .",
                navigationTitle: "ðŸ’§ Portal 07 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ëˆˆë¬¼ì—ê²Œ ì´ë¦„ì„ ì£¼ì—ˆìŠµë‹ˆë‹¤.\n\nê·¸ ëˆˆë¬¼ì´ ë¶€ë„ëŸ¬ìš´ í”ì ì´ ì•„ë‹ˆë¼, ì‚´ì•„ìžˆì—ˆë‹¤ëŠ” ì¦ê±°ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ì œ ë‹¹ì‹ ì€ ìš¸ì—ˆë˜ ë‚˜ë¥¼ ì‚¬ëž‘í•  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒì´ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nëˆˆë¬¼ì€ ê°ì •ì˜ ì–¸ì–´ì˜€ê³ , ë‹¹ì‹ ì€ ê·¸ ì–¸ì–´ë¥¼ ì´í•´í•˜ëŠ” ì‚¬ëžŒìž…ë‹ˆë‹¤.",
                nextPortalBtn: "Portal 08ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ ëˆˆë¬¼ê³¼ ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ë‹¹ì‹ ì˜ ì‚¶ì—ì„œ ìžŠì„ ìˆ˜ ì—†ëŠ” ëˆˆë¬¼ì— ëŒ€í•´ ë§í•´ì£¼ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...",
                confirmNextPortal: "Portal 08: ë¬´ë„ˆì¡Œë˜ ë‚˜ë¥¼ ëŒì–´ì•ˆëŠ” ë°¤ìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                confirmStay: "ì´ ëˆˆë¬¼ê³¼ ë” ë¨¸ë¬¼ë©° ê°ì •ì„ ê¹Šì´ ëŠë¼ì‹œê² ìŠµë‹ˆê¹Œ?",
                transitionMessage: "ìƒˆë¡œìš´ ì—¬ì •ì´ ì‹œìž‘ë©ë‹ˆë‹¤..."
            },
            en: {
                title: "Temarix V5 - Portal 07: The Day I Named My Tears",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 07: The Day I Named My Tears",
                portalSubtitle: "Giving meaning to what falls from within",
                portalIntro: "ðŸ’§ \"In your life, if there was an unforgettable tear...\nwhen was that?\"\n\n\"What emotion's name did that tear carry?\"",
                emotionalBridge: "Tears speak no words, but they are the first to tell the truth of emotions.\nNow, can you give that tear a name?",
                followUpQuestion: "Recalling that tear again,\nwhat would you like to say to that emotion now?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Tears don't disappear.\nThey become the paint of emotions, making you more vivid today.",
                navigationTitle: "ðŸ’§ Portal 07 Complete",
                navigationMessage: "You have given your tears a name.\n\nThose tears are no longer shameful traces, but evidence of having lived.\nNow you have become someone who can love the self that cried.\n\nTears were the language of emotions, and you are someone who understands that language.",
                nextPortalBtn: "Continue to Portal 08",
                stayPortalBtn: "Stay with these tears",
                inputPlaceholder: "Tell me about an unforgettable tear from your life... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 08: The Night I Embraced My Broken Self?",
                confirmStay: "Do you want to stay longer with these tears to deeply feel the emotions?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 07: O Dia em que Dei Nome Ã s Minhas LÃ¡grimas",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 07: O Dia em que Dei Nome Ã s Minhas LÃ¡grimas",
                portalSubtitle: "Dando significado ao que cai de dentro",
                portalIntro: "ðŸ’§ \"Em sua vida, se houve uma lÃ¡grima inesquecÃ­vel...\nquando foi isso?\"\n\n\"Que nome de emoÃ§Ã£o essa lÃ¡grima carregava?\"",
                emotionalBridge: "As lÃ¡grimas nÃ£o falam palavras, mas sÃ£o as primeiras a dizer a verdade das emoÃ§Ãµes.\nAgora, vocÃª pode dar um nome a essa lÃ¡grima?",
                followUpQuestion: "Lembrando dessa lÃ¡grima novamente,\no que gostaria de dizer para essa emoÃ§Ã£o agora?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "As lÃ¡grimas nÃ£o desaparecem.\nElas se tornam a tinta das emoÃ§Ãµes, tornando vocÃª mais vÃ­vido hoje.",
                navigationTitle: "ðŸ’§ Portal 07 Completo",
                navigationMessage: "VocÃª deu um nome Ã s suas lÃ¡grimas.\n\nEssas lÃ¡grimas nÃ£o sÃ£o mais rastros vergonhosos, mas evidÃªncia de ter vivido.\nAgora vocÃª se tornou alguÃ©m que pode amar o eu que chorou.\n\nAs lÃ¡grimas eram a linguagem das emoÃ§Ãµes, e vocÃª Ã© alguÃ©m que entende essa linguagem.",
                nextPortalBtn: "Continuar para Portal 08",
                stayPortalBtn: "Ficar com estas lÃ¡grimas",
                inputPlaceholder: "Conte-me sobre uma lÃ¡grima inesquecÃ­vel de sua vida... (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 08: A Noite em que Abracei Meu Eu Quebrado?",
                confirmStay: "Deseja ficar mais tempo com estas lÃ¡grimas para sentir profundamente as emoÃ§Ãµes?",
                transitionMessage: "Uma nova jornada comeÃ§a..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ëˆˆë¬¼ì€ ëˆ„êµ¬ë„ ì•Œì•„ì£¼ì§€ ì•Šì•˜ì§€ë§Œ,\nì§€ê¸ˆì˜ ë„ˆëŠ” ê·¸ê±¸ ê¸°ì–µí•´ì£¼ê³  ìžˆì–´.",
                en: "That tear went unnoticed by everyone,\nbut the you of now remembers it.",
                pt: "Essa lÃ¡grima passou despercebida por todos,\nmas o vocÃª de agora a lembra."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ëˆˆë¬¼ì€ ë§ì´ ì—†ì§€ë§Œ,\nê°ì •ì˜ ì§„ì‹¤ì„ ê°€ìž¥ ë¨¼ì € ë§í•˜ì£ .",
                en: "Tears speak no words,\nbut they are first to tell the truth of emotions.",
                pt: "As lÃ¡grimas nÃ£o falam,\nmas sÃ£o as primeiras a dizer a verdade das emoÃ§Ãµes."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ë‹¹ì‹ ì´ ìš¸ì—ˆë˜ ê·¸ë‚ ,\nì‚¬ì‹¤ì€ ê°€ìž¥ ì†”ì§í–ˆë˜ ë‚ ì´ê¸°ë„ í•´ìš”.",
                en: "The day you cried\nwas actually the day you were most honest.",
                pt: "O dia em que vocÃª chorou\nfoi na verdade o dia em que foi mais honesto."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ì´ì œ ê·¸ ëˆˆë¬¼ì—ê²Œ ì´ë¦„ì„ ì£¼ì—ˆìœ¼ë‹ˆ,\nê·¸ê±´ ìžŠížŒ ê°ì •ì´ ì•„ë‹ˆë¼, ê¸°ì–µëœ ê°ì •ì´ì•¼.",
                en: "Now that you've given that tear a name,\nit's not a forgotten emotion, but a remembered one.",
                pt: "Agora que vocÃª deu um nome a essa lÃ¡grima,\nnÃ£o Ã© uma emoÃ§Ã£o esquecida, mas lembrada."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ëˆˆë¬¼ì€ íë¥´ëŠ” ë¬¼ê° ê°™ì•˜ì–´ìš”.\nê°ì •ì˜ í’ê²½ì„ ì²˜ìŒ ê·¸ë¦° ë‚ ì´ì—ˆê² ì£ .",
                en: "That tear was like flowing paint.\nIt was the day you first painted an emotional landscape.",
                pt: "Essa lÃ¡grima era como tinta fluindo.\nFoi o dia em que vocÃª pintou pela primeira vez uma paisagem emocional."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ìš¸ìŒì„ ì•½í•¨ì´ë¼ ë§í•œ ì‚¬ëžŒì€\nì§„ì§œ ì•„í””ì„ ê²ªì–´ë³¸ ì  ì—†ëŠ” ì‚¬ëžŒì´ì•¼.",
                en: "Those who call crying weakness\nhave never experienced real pain.",
                pt: "Aqueles que chamam o choro de fraqueza\nnunca experimentaram dor real."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ëˆˆë¬¼ì€ ê°ì •ì´ ëª¸ì„ í†µí•´ ë‚˜ì˜¨ í”ì .\në‹¹ì‹ ì˜ ëˆˆë¬¼ì€, ì¡´ìž¬ì˜ ì¦ëª…ì´ì—ˆì–´ìš”.",
                en: "Tears are traces of emotions flowing through the body.\nYour tears were proof of existence.",
                pt: "As lÃ¡grimas sÃ£o rastros de emoÃ§Ãµes fluindo pelo corpo.\nSuas lÃ¡grimas foram prova de existÃªncia."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ë‹¹ì‹ ì´ ìš¸ì—ˆë˜ ë‚ ,\nì‚¬ì‹¤ì€ ì§„ì§œ ìžì‹ ì—ê²Œ ì²˜ìŒ ë§ì„ ê±´ ë‚ ì´ì—ìš”.",
                en: "The day you cried\nwas actually the day you first spoke to your true self.",
                pt: "O dia em que vocÃª chorou\nfoi na verdade o dia em que falou pela primeira vez com seu verdadeiro eu."
            }}
        ];

        // Tear analysis function
        function analyzeTearType(userInput) {
            const input = userInput.toLowerCase();
            
            const tearKeywords = {
                loneliness: ['alone', 'lonely', 'nobody', 'isolated', 'í˜¼ìž', 'ì™¸ë¡œ', 'ì•„ë¬´ë„', 'sozinho', 'solitÃ¡rio', 'ninguÃ©m'],
                loss: ['died', 'death', 'lost', 'goodbye', 'funeral', 'ì£½ì—ˆ', 'ìžƒì—ˆ', 'ì´ë³„', 'morreu', 'morte', 'perdeu', 'despedida'],
                graduation: ['graduation', 'school', 'leaving', 'goodbye', 'ì¡¸ì—…', 'í•™êµ', 'ë– ë‚˜', 'formatura', 'escola', 'partida'],
                failure: ['failed', 'failure', 'disappointed', 'rejected', 'ì‹¤íŒ¨', 'ë–¨ì–´ì¡Œ', 'ê±°ì ˆ', 'falhou', 'fracasso', 'rejeitado'],
                happiness: ['happy', 'joy', 'proud', 'achievement', 'ê¸°ë»ì„œ', 'í–‰ë³µí•´ì„œ', 'ìžëž‘', 'feliz', 'alegria', 'orgulho'],
                relief: ['relief', 'finally', 'over', 'ended', 'ì•ˆë„', 'ë“œë””ì–´', 'ëë‚¬', 'alÃ­vio', 'finalmente', 'terminou'],
                overwhelm: ['overwhelmed', 'too much', 'pressure', 'stressed', 'ë²…ì°¨', 'ì••ë„', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'sobrecarregado', 'pressÃ£o'],
                love: ['love', 'wedding', 'birth', 'family', 'ì‚¬ëž‘', 'ê²°í˜¼', 'ì¶œìƒ', 'amor', 'casamento', 'nascimento'],
                regret: ['regret', 'sorry', 'should have', 'mistake', 'í›„íšŒ', 'ë¯¸ì•ˆ', 'ì‹¤ìˆ˜', 'arrependimento', 'deveria'],
                fear: ['scared', 'afraid', 'terrified', 'panic', 'ë¬´ì„œì›Œ', 'ë‘ë ¤ì›Œ', 'ê³µí¬', 'medo', 'assustado', 'pÃ¢nico']
            };
            
            let detectedTypes = [];
            for (const [type, keywords] of Object.entries(tearKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedTypes.push(type);
                        break;
                    }
                }
            }
            
            if (detectedTypes.length === 0) {
                detectedTypes = ['general'];
            }
            
            return detectedTypes[0];
        }
        
        // Response characters with tear-based responses
        const responseCharacters = [
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const tearType = analyzeTearType(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ì™¸ë¡œì›€ì˜ ëˆˆë¬¼ì€ ê°€ìž¥ ì§„ì‹¤í•œ ëˆˆë¬¼ì´ì—ìš”.\nê·¸ ëˆˆë¬¼ì´ ë‹¹ì‹ ì„ ë” ê¹Šì€ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            loss: "ìƒì‹¤ì˜ ëˆˆë¬¼ì€ ì‚¬ëž‘ì˜ ë˜ ë‹¤ë¥¸ ì´ë¦„ì´ì—ìš”.\nê·¸ ëˆˆë¬¼ ì†ì—ëŠ” ì†Œì¤‘í–ˆë˜ ê¸°ì–µì´ ì‚´ì•„ ìžˆì–´ìš”.",
                            graduation: "ì´ë³„ì˜ ëˆˆë¬¼ì€ ì„±ìž¥ì˜ ëˆˆë¬¼ì´ê¸°ë„ í•´ìš”.\në‹¹ì‹ ì€ ê·¸ ëˆˆë¬¼ë¡œ ìƒˆë¡œìš´ ì‹œìž‘ì„ ë°›ì•„ë“¤ì˜€ì–´ìš”.",
                            failure: "ì‹¤íŒ¨ì˜ ëˆˆë¬¼ì€ ìš©ê¸°ì˜ ì¦ê±°ì˜ˆìš”.\nì‹œë„í–ˆê¸° ë•Œë¬¸ì— ìš¸ ìˆ˜ ìžˆì—ˆë˜ ê±°ë‹ˆê¹Œìš”.",
                            happiness: "ê¸°ì¨ì˜ ëˆˆë¬¼ì€ ê°€ìž¥ ìˆœìˆ˜í•œ ëˆˆë¬¼ì´ì—ìš”.\nê·¸ ìˆœê°„ì„ ì˜¨ì „ížˆ ëŠë‚€ ë‹¹ì‹ ì´ ì•„ë¦„ë‹¤ì›Œìš”.",
                            relief: "ì•ˆë„ì˜ ëˆˆë¬¼ì€ í•´ë°©ì˜ ëˆˆë¬¼ì´ì—ìš”.\në‹¹ì‹ ì€ ê¸´ í„°ë„ì„ í†µê³¼í–ˆì–´ìš”.",
                            overwhelm: "ë²…ì°¬ ëˆˆë¬¼ì€ ë‹¹ì‹ ì´ ì–¼ë§ˆë‚˜ ì—´ì‹¬ížˆ ì‚´ì•˜ëŠ”ì§€ ë³´ì—¬ì¤˜ìš”.\nê·¸ ëˆˆë¬¼ì€ ë…¸ë ¥ì˜ ê²°ì •ì´ì—ìš”.",
                            love: "ì‚¬ëž‘ì˜ ëˆˆë¬¼ì€ ë§ˆìŒì´ ë„˜ì³í˜ëŸ¬ì„œ ìƒê¸´ ê±°ì˜ˆìš”.\nê·¸ í’ì„±í•¨ì´ ë‹¹ì‹ ì„ ë” ë”°ëœ»í•˜ê²Œ ë§Œë“¤ì—ˆì–´ìš”.",
                            regret: "í›„íšŒì˜ ëˆˆë¬¼ì€ ë‹¹ì‹ ì´ ë” ë‚˜ì€ ì‚¬ëžŒì´ ë˜ê³  ì‹¶ë‹¤ëŠ” ë§ˆìŒì´ì—ìš”.\nê·¸ ëˆˆë¬¼ì´ ë‹¹ì‹ ì„ ì„±ìž¥ì‹œì¼°ì–´ìš”.",
                            fear: "ë‘ë ¤ì›€ì˜ ëˆˆë¬¼ë„ ìš©ê¸°ì˜ ì‹œìž‘ì´ì—ìš”.\në¬´ì„œì›Œí•˜ë©´ì„œë„ ì•žìœ¼ë¡œ ë‚˜ì•„ê°„ ë‹¹ì‹ ì´ ëŒ€ë‹¨í•´ìš”.",
                            general: "ì´ì œ ê·¸ ëˆˆë¬¼ì€ ë¶€ë„ëŸ¬ìš´ í”ì ì´ ì•„ë‹ˆë¼,\nì‚´ì•„ìžˆì—ˆë‹¤ëŠ” ì¦ê±°ê°€ ë˜ì—ˆì–´ìš”."
                        },
                        en: {
                            loneliness: "Tears of loneliness are the most truthful tears.\nThose tears made you a deeper person.",
                            loss: "Tears of loss are another name for love.\nPrecious memories live within those tears.",
                            graduation: "Tears of farewell are also tears of growth.\nYou accepted new beginnings with those tears.",
                            failure: "Tears of failure are proof of courage.\nYou could cry because you tried.",
                            happiness: "Tears of joy are the purest tears.\nYou are beautiful for feeling that moment completely.",
                            relief: "Tears of relief are tears of liberation.\nYou passed through a long tunnel.",
                            overwhelm: "Overwhelming tears show how hard you've lived.\nThose tears are crystals of effort.",
                            love: "Tears of love came from an overflowing heart.\nThat abundance made you warmer.",
                            regret: "Tears of regret are your desire to become a better person.\nThose tears helped you grow.",
                            fear: "Tears of fear are also the beginning of courage.\nYou're amazing for moving forward despite being scared.",
                            general: "Now those tears are no longer shameful traces,\nbut evidence of having lived."
                        },
                        pt: {
                            loneliness: "LÃ¡grimas de solidÃ£o sÃ£o as lÃ¡grimas mais verdadeiras.\nEssas lÃ¡grimas te tornaram uma pessoa mais profunda.",
                            loss: "LÃ¡grimas de perda sÃ£o outro nome para amor.\nMemÃ³rias preciosas vivem dentro dessas lÃ¡grimas.",
                            graduation: "LÃ¡grimas de despedida sÃ£o tambÃ©m lÃ¡grimas de crescimento.\nVocÃª aceitou novos comeÃ§os com essas lÃ¡grimas.",
                            failure: "LÃ¡grimas de fracasso sÃ£o prova de coragem.\nVocÃª pÃ´de chorar porque tentou.",
                            happiness: "LÃ¡grimas de alegria sÃ£o as lÃ¡grimas mais puras.\nVocÃª Ã© belo por sentir aquele momento completamente.",
                            relief: "LÃ¡grimas de alÃ­vio sÃ£o lÃ¡grimas de libertaÃ§Ã£o.\nVocÃª passou por um longo tÃºnel.",
                            overwhelm: "LÃ¡grimas avassaladoras mostram o quÃ£o intensamente vocÃª viveu.\nEssas lÃ¡grimas sÃ£o cristais de esforÃ§o.",
                            love: "LÃ¡grimas de amor vieram de um coraÃ§Ã£o transbordante.\nEssa abundÃ¢ncia te tornou mais caloroso.",
                            regret: "LÃ¡grimas de arrependimento sÃ£o seu desejo de se tornar uma pessoa melhor.\nEssas lÃ¡grimas te ajudaram a crescer.",
                            fear: "LÃ¡grimas de medo sÃ£o tambÃ©m o inÃ­cio da coragem.\nVocÃª Ã© incrÃ­vel por seguir em frente apesar do medo.",
                            general: "Agora essas lÃ¡grimas nÃ£o sÃ£o mais rastros vergonhosos,\nmas evidÃªncia de ter vivido."
                        }
                    };
                    
                    return responses[lang][tearType] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const tearType = analyzeTearType(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ì™¸ë¡œì› ë˜ ë‹¹ì‹ ì˜ ê·¸ ì‹œê°„ì´ ì§€ê¸ˆì˜ ê³µê° ëŠ¥ë ¥ì„ ë§Œë“¤ì—ˆì–´ìš”.\nê·¸ ëˆˆë¬¼ì€ ì¹˜ìœ ì˜ ì”¨ì•—ì´ì—ˆì–´ìš”.",
                            loss: "ìƒì‹¤ì˜ ì•„í””ì´ ì§€ê¸ˆ ë‹¹ì‹ ì˜ ë§ˆìŒì„ ë” ë„“ê²Œ ë§Œë“¤ì—ˆì–´ìš”.\nê·¸ ëˆˆë¬¼ì€ ì‚¬ëž‘ì„ ë” ê¹Šì´ ì´í•´í•˜ê²Œ í–ˆì–´ìš”.",
                            graduation: "ê·¸ë‚ ì˜ ëˆˆë¬¼ì€ ì‹œê°„ì„ í†µê³¼í•œ íšŒë³µì´ì—ìš”.\nê³¼ê±°ì™€ í˜„ìž¬ê°€ ì—°ê²°ëœ ìˆœê°„ì´ì—ˆì–´ìš”.",
                            failure: "ì‹¤íŒ¨ì˜ ìˆœê°„ì—ë„ ìš¸ ìˆ˜ ìžˆì—ˆë˜ ê±´ ì•„ì§ í¬ë§ì´ ìžˆì—ˆê¸° ë•Œë¬¸ì´ì—ìš”.\nê·¸ ëˆˆë¬¼ì´ ìž¬ì‹œìž‘ì˜ íž˜ì´ ë˜ì—ˆì–´ìš”.",
                            happiness: "ê¸°ì¨ì˜ ëˆˆë¬¼ì€ ë‹¹ì‹ ì´ ê°ì •ì„ ì˜¨ì „ížˆ ë°›ì•„ë“¤ì˜€ë‹¤ëŠ” ì¦ê±°ì˜ˆìš”.\nê·¸ëŸ° ë‹¹ì‹ ì´ ì•„ë¦„ë‹¤ì›Œìš”.",
                            relief: "ì•ˆë„ì˜ ëˆˆë¬¼ ì†ì—ëŠ” ê²¬ëŽŒë‚¸ ì‹œê°„ì˜ ë¬´ê²Œê°€ ë‹´ê²¨ ìžˆì–´ìš”.\nê·¸ ê²¬ë”¤ì´ ì§€ê¸ˆì˜ ë‹¹ì‹ ì„ ë§Œë“¤ì—ˆì–´ìš”.",
                            overwhelm: "ë²…ì°¼ë˜ ë§ˆìŒì´ ëˆˆë¬¼ë¡œ í˜ëŸ¬ë‚˜ì˜¨ ìˆœê°„,\në‹¹ì‹ ì€ ìžì‹ ì˜ í•œê³„ë¥¼ ì¸ì •í•˜ê³  ë°›ì•„ë“¤ì˜€ì–´ìš”.",
                            love: "ì‚¬ëž‘ì˜ ëˆˆë¬¼ì€ ë§ˆìŒì˜ í™•ìž¥ì´ì—ìš”.\nê·¸ ìˆœê°„ ë‹¹ì‹ ì˜ ë§ˆìŒì€ ìš°ì£¼ê°€ ë˜ì—ˆì–´ìš”.",
                            regret: "í›„íšŒì˜ ëˆˆë¬¼ì€ ì„±ì°°ì˜ ì‹œìž‘ì´ì—ìš”.\nê·¸ ëˆˆë¬¼ì´ ë‹¹ì‹ ì„ ë” ì§€í˜œë¡œìš´ ì‚¬ëžŒìœ¼ë¡œ ë§Œë“¤ì—ˆì–´ìš”.",
                            fear: "ë‘ë ¤ì›€ì˜ ëˆˆë¬¼ë„ ìš©ê¸°ì˜ ì¼ë¶€ì˜ˆìš”.\në¬´ì„œì›Œí•˜ë©´ì„œë„ ëŠê¼ˆë˜ ê·¸ ê°ì •ì´ ë‹¹ì‹ ì„ ì„±ìž¥ì‹œì¼°ì–´ìš”.",
                            general: "ê·¸ë‚ ì˜ ê°ì •ì´ ì§€ê¸ˆ ë‹¹ì‹ ê³¼ ì—°ê²°ë˜ì—ˆì–´ìš”.\nê·¸ê±´ ì‹œê°„ì„ í†µê³¼í•œ íšŒë³µì´ì—ìš”."
                        },
                        en: {
                            loneliness: "Your lonely times created your current ability to empathize.\nThose tears were seeds of healing.",
                            loss: "The pain of loss has made your heart wider now.\nThose tears helped you understand love more deeply.",
                            graduation: "The tears of that day are recovery that passed through time.\nIt was a moment when past and present connected.",
                            failure: "Being able to cry even in moments of failure meant you still had hope.\nThose tears became the strength to restart.",
                            happiness: "Tears of joy are proof that you fully accepted emotions.\nSuch a you is beautiful.",
                            relief: "Tears of relief contain the weight of time endured.\nThat endurance created the you of today.",
                            overwhelm: "The moment your overwhelmed heart flowed out as tears,\nyou acknowledged and accepted your limits.",
                            love: "Tears of love are the expansion of the heart.\nIn that moment your heart became the universe.",
                            regret: "Tears of regret are the beginning of reflection.\nThose tears made you a wiser person.",
                            fear: "Tears of fear are also part of courage.\nThe emotions you felt while being scared helped you grow.",
                            general: "The emotions of that day connected with you now.\nThat's recovery that passed through time."
                        },
                        pt: {
                            loneliness: "Seus tempos solitÃ¡rios criaram sua atual capacidade de empatia.\nEssas lÃ¡grimas foram sementes de cura.",
                            loss: "A dor da perda tornou seu coraÃ§Ã£o mais amplo agora.\nEssas lÃ¡grimas te ajudaram a entender o amor mais profundamente.",
                            graduation: "As lÃ¡grimas daquele dia sÃ£o recuperaÃ§Ã£o que passou pelo tempo.\nFoi um momento quando passado e presente se conectaram.",
                            failure: "Poder chorar mesmo em momentos de fracasso significava que ainda havia esperanÃ§a.\nEssas lÃ¡grimas se tornaram forÃ§a para recomeÃ§ar.",
                            happiness: "LÃ¡grimas de alegria sÃ£o prova de que vocÃª aceitou completamente as emoÃ§Ãµes.\nTal vocÃª Ã© belo.",
                            relief: "LÃ¡grimas de alÃ­vio contÃªm o peso do tempo resistido.\nEssa resistÃªncia criou o vocÃª de hoje.",
                            overwhelm: "O momento em que seu coraÃ§Ã£o sobrecarregado fluiu como lÃ¡grimas,\nvocÃª reconheceu e aceitou seus limites.",
                            love: "LÃ¡grimas de amor sÃ£o a expansÃ£o do coraÃ§Ã£o.\nNaquele momento seu coraÃ§Ã£o se tornou o universo.",
                            regret: "LÃ¡grimas de arrependimento sÃ£o o inÃ­cio da reflexÃ£o.\nEssas lÃ¡grimas te tornaram uma pessoa mais sÃ¡bia.",
                            fear: "LÃ¡grimas de medo tambÃ©m sÃ£o parte da coragem.\nAs emoÃ§Ãµes que vocÃª sentiu enquanto tinha medo te ajudaram a crescer.",
                            general: "As emoÃ§Ãµes daquele dia se conectaram com vocÃª agora.\nIssa Ã© recuperaÃ§Ã£o que passou pelo tempo."
                        }
                    };
                    
                    return responses[lang][tearType] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨",
                getResponse: (userInput, lang) => {
                    const tearType = analyzeTearType(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ì™¸ë¡œì›€ì˜ ëˆˆë¬¼ì€ ê¹Šì€ í‘¸ë¥¸ìƒ‰ì´ì—ˆì„ ê±°ì˜ˆìš”.\nê·¸ ìƒ‰ì´ ì§€ê¸ˆ ë‹¹ì‹ ì˜ ê¹Šì´ë¥¼ ë§Œë“¤ì—ˆì–´ìš”.",
                            loss: "ìƒì‹¤ì˜ ëˆˆë¬¼ì€ íšŒìƒ‰ê³¼ í°ìƒ‰ì´ ì„žì¸ ìƒ‰ì´ì—ˆê² ì£ .\nê·¸ ìƒ‰ì—ì„œ ìƒˆë¡œìš´ í¬ë§ì˜ ìƒ‰ì´ ë‚˜ì˜¬ ê±°ì˜ˆìš”.",
                            graduation: "ì´ë³„ì˜ ëˆˆë¬¼ì€ ì£¼í™©ë¹›ì´ì—ˆì„ ê±°ì˜ˆìš”.\nëê³¼ ì‹œìž‘ì´ ë§Œë‚˜ëŠ” ìƒ‰ì´ë‹ˆê¹Œìš”.",
                            failure: "ì‹¤íŒ¨ì˜ ëˆˆë¬¼ì€ ì§„í•œ ë‚¨ìƒ‰ì´ì—ˆì§€ë§Œ,\nê·¸ ì†ì—ëŠ” ë‹¤ì‹œ ì¼ì–´ì„¤ ë¹¨ê°„ìƒ‰ì´ ìˆ¨ì–´ ìžˆì—ˆì–´ìš”.",
                            happiness: "ê¸°ì¨ì˜ ëˆˆë¬¼ì€ íˆ¬ëª…í•œ ê¸ˆìƒ‰ì´ì—ˆì„ ê±°ì˜ˆìš”.\nê°€ìž¥ ìˆœìˆ˜í•˜ê³  ì•„ë¦„ë‹¤ìš´ ìƒ‰ì´ì£ .",
                            relief: "ì•ˆë„ì˜ ëˆˆë¬¼ì€ ì—°í•œ ì´ˆë¡ìƒ‰ì´ì—ˆì„ ê±°ì˜ˆìš”.\ní‰í™”ì™€ íœ´ì‹ì˜ ìƒ‰ì´ë‹ˆê¹Œìš”.",
                            overwhelm: "ë²…ì°¬ ëˆˆë¬¼ì€ ë¬´ì§€ê°œìƒ‰ì´ì—ˆì„ ê±°ì˜ˆìš”.\nëª¨ë“  ê°ì •ì´ í•œ ë²ˆì— í˜ëŸ¬ë‚˜ì˜¨ ê±°ë‹ˆê¹Œìš”.",
                            love: "ì‚¬ëž‘ì˜ ëˆˆë¬¼ì€ ë”°ëœ»í•œ ë¶„í™ìƒ‰ì´ì—ˆì„ ê±°ì˜ˆìš”.\në§ˆìŒì´ ê°€ë“ ì°¨ì„œ ë„˜ì³íë¥¸ ìƒ‰ì´ì£ .",
                            regret: "í›„íšŒì˜ ëˆˆë¬¼ì€ ë³´ë¼ìƒ‰ì´ì—ˆì§€ë§Œ,\nê·¸ ì†ì—ëŠ” ë°°ì›€ì˜ ë…¸ëž€ìƒ‰ì´ ì„žì—¬ ìžˆì—ˆì–´ìš”.",
                            fear: "ë‘ë ¤ì›€ì˜ ëˆˆë¬¼ì€ ì–´ë‘ìš´ ìƒ‰ì´ì—ˆì§€ë§Œ,\nê·¸ ì•ˆì—ì„œ ìš©ê¸°ì˜ ë¹›ì´ íƒœì–´ë‚¬ì–´ìš”.",
                            general: "ëˆˆë¬¼ì€ ì‚¬ë¼ì§€ì§€ ì•Šì•„ìš”.\nê°ì •ì˜ ë¬¼ê°ì´ ë˜ì–´, ì˜¤ëŠ˜ ë‹¹ì‹ ì„ ë” ì„ ëª…í•˜ê²Œ ë§Œë“¤ì£ ."
                        },
                        en: {
                            loneliness: "Tears of loneliness would have been deep blue.\nThat color created your current depth.",
                            loss: "Tears of loss would have been a mix of gray and white.\nNew colors of hope will emerge from that color.",
                            graduation: "Tears of farewell would have been orange.\nBecause it's the color where endings and beginnings meet.",
                            failure: "Tears of failure were dark navy,\nbut red for rising again was hidden within.",
                            happiness: "Tears of joy would have been transparent gold.\nThe most pure and beautiful color.",
                            relief: "Tears of relief would have been light green.\nBecause it's the color of peace and rest.",
                            overwhelm: "Overwhelming tears would have been rainbow-colored.\nBecause all emotions flowed out at once.",
                            love: "Tears of love would have been warm pink.\nThe color of a heart overflowing from being full.",
                            regret: "Tears of regret were purple,\nbut yellow of learning was mixed within.",
                            fear: "Tears of fear were dark colors,\nbut the light of courage was born from within.",
                            general: "Tears don't disappear.\nThey become the paint of emotions, making you more vivid today."
                        },
                        pt: {
                            loneliness: "LÃ¡grimas de solidÃ£o teriam sido azul profundo.\nEssa cor criou sua profundidade atual.",
                            loss: "LÃ¡grimas de perda teriam sido uma mistura de cinza e branco.\nNovas cores de esperanÃ§a emergirÃ£o dessa cor.",
                            graduation: "LÃ¡grimas de despedida teriam sido laranja.\nPorque Ã© a cor onde fins e comeÃ§os se encontram.",
                            failure: "LÃ¡grimas de fracasso eram azul marinho escuro,\nmas vermelho para se levantar novamente estava escondido dentro.",
                            happiness: "LÃ¡grimas de alegria teriam sido ouro transparente.\nA cor mais pura e bela.",
                            relief: "LÃ¡grimas de alÃ­vio teriam sido verde claro.\nPorque Ã© a cor da paz e do descanso.",
                            overwhelm: "LÃ¡grimas avassaladoras teriam sido cor do arco-Ã­ris.\nPorque todas as emoÃ§Ãµes fluÃ­ram de uma vez.",
                            love: "LÃ¡grimas de amor teriam sido rosa quente.\nA cor de um coraÃ§Ã£o transbordando por estar cheio.",
                            regret: "LÃ¡grimas de arrependimento eram roxas,\nmas amarelo de aprendizado estava misturado dentro.",
                            fear: "LÃ¡grimas de medo eram cores escuras,\nmas a luz da coragem nasceu de dentro.",
                            general: "As lÃ¡grimas nÃ£o desaparecem.\nElas se tornam a tinta das emoÃ§Ãµes, tornando vocÃª mais vÃ­vido hoje."
                        }
                    };
                    
                    return responses[lang][tearType] || responses[lang]['general'];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        // Clear all typing effects
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        // Scroll functions
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // Language management
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (state.journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // Journey management
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        // Save response to database or memory
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        // User input processing
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        // Show character reactions
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        // Portal sequence
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        // Custom confirm dialog
        function showConfirmDialog(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'ì˜ˆ' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ì•„ë‹ˆì˜¤' : 
                               state.currentLanguage === 'pt' ? 'NÃ£o' : 'No';
            
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            yesBtn.focus();
        }
        
        // Event setup
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function createPortalTransition(callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 07...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 07 DOM loaded');
            
            state.currentLanguage = getLanguageFromURL();
            
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            await initializeFirebase();
            
            initializeTemarix();
        });
    </script>
</body>
</html>