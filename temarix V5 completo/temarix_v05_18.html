<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V5 - Portal 18: Why I Couldn't Comfort Myself Then</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V5</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 18: Why I Couldn't Comfort Myself Then</div>
            <div class="portal-subtitle" id="portalSubtitle">Why couldn't I be gentle with myself back then?</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">‚ú® Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">üå´Ô∏è Portal 18 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 19</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this understanding</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me about a time when you couldn't comfort yourself... (Press Enter to send)"
                      rows="1"
                      maxlength="800"></textarea>
        </div>
    </div>

    <script>
        // Global state management
        let state = {
            db: null,
            auth: null,
            firebaseInitialized: false,
            currentUser: null,
            currentLanguage: 'en',
            userResponse: '',
            journeyStarted: false,
            currentTypingElement: null,
            typingIntervals: [],
            awaitingSecondResponse: false,
            userResponses: []
        };
        
        // Portal navigation configuration
        const portalConfig = {
            currentPortal: "v5-18",
            nextPortal: "v5-19",
            nextPortalFile: "temarix_v05_19.html"
        };
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
            authDomain: "canal-vivo-chat.firebaseapp.com",
            projectId: "canal-vivo-chat",
            storageBucket: "canal-vivo-chat.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdefghijklmnopqr"
        };
        
        // Initialize Firebase with error handling
        function initializeFirebase() {
            return new Promise((resolve) => {
                try {
                    if (typeof firebase !== 'undefined') {
                        firebase.initializeApp(firebaseConfig);
                        state.db = firebase.firestore();
                        state.auth = firebase.auth();
                        state.firebaseInitialized = true;
                        
                        state.auth.onAuthStateChanged((user) => {
                            if (user) {
                                state.currentUser = user;
                            } else {
                                state.currentUser = {
                                    uid: 'anonymous-' + Date.now(),
                                    email: 'anonymous@temarix.com',
                                    isAnonymous: true
                                };
                            }
                            showConnectionStatus(true);
                        });
                        
                        console.log('Firebase initialized successfully');
                    } else {
                        console.log('Firebase SDK not loaded');
                        state.currentUser = {
                            uid: 'anonymous-' + Date.now(),
                            email: 'anonymous@temarix.com',
                            isAnonymous: true
                        };
                        showConnectionStatus(false);
                    }
                } catch (error) {
                    console.error('Firebase initialization failed:', error);
                    state.currentUser = {
                        uid: 'anonymous-' + Date.now(),
                        email: 'anonymous@temarix.com',
                        isAnonymous: true
                    };
                    showConnectionStatus(false);
                }
                resolve();
            });
        }
        
        // Show connection status to user
        function showConnectionStatus(isOnline) {
            const existingStatus = document.querySelector('.connection-status');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            if (!isOnline) {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'connection-status';
                statusDiv.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    background: rgba(255, 107, 107, 0.9);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 20px;
                    font-size: 12px;
                    font-family: 'Courier New', monospace;
                    z-index: 1000;
                    opacity: 0.8;
                `;
                statusDiv.textContent = state.currentLanguage === 'ko' ? 'Offline mode' : 
                                       state.currentLanguage === 'pt' ? 'Modo offline' : 'Offline mode';
                document.body.appendChild(statusDiv);
                
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 5000);
            }
        }

        // Translations object
        const translations = {
            ko: {
                title: "Temarix V5 - Portal 18: Í∑∏Îïå ÎÇòÎ•º ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Ïù¥Ïú†",
                logoSubtitle: "Í∞êÏ†ï Ïó∞Í∏àÏà†",
                portalMainTitle: "Portal 18: Í∑∏Îïå ÎÇòÎ•º ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Ïù¥Ïú†",
                portalSubtitle: "Í∑∏Îïå Ïôú, Ïä§Ïä§Î°úÏóêÍ≤å Îã§Ï†ïÌï¥Ïßà Ïàò ÏóÜÏóàÏùÑÍπåÏöî?",
                portalIntro: "üå´Ô∏è \"ÏÇ∂Ïùò Ïñ¥Îäê ÏàúÍ∞Ñ,\nÏûêÏã†ÏùÑ ÏúÑÎ°úÌï¥Ï§òÏïº ÌñàÏßÄÎßå Í∑∏Îü¨ÏßÄ Î™ªÌñàÎçò Í∏∞ÏñµÏù¥ ÏûàÎÇòÏöî?\"\n\n\"Í∑∏Îïå Ïôú,\nÏä§Ïä§Î°úÏóêÍ≤å Îã§Ï†ïÌï¥Ïßà Ïàò ÏóÜÏóàÏùÑÍπåÏöî?\"",
                emotionalBridge: "Ïä§Ïä§Î°úÎ•º ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Í±¥, ÏûêÍ∏∞ Í∞êÏ†ïÏùÑ ÌóàÎùΩÌïòÏßÄ ÏïäÏïòÍ∏∞ ÎïåÎ¨∏Ïù¥ÏóêÏöî.\n\nÍ∑∏ ÎÇ†Ïùò ÎãπÏã†ÏùÄ ÎÑàÎ¨¥ Î¨¥Í±∞Ïõ†Ïñ¥Ïöî. Îã§ ÏïàÏïÑÏ£ºÎ©¥ Î¨¥ÎÑàÏßàÍπåÎ¥ê, Ï∞∏ÏùÄ Í±∞ÏòàÏöî.\n\nÏûêÍ∏∞ ÏúÑÎ°úÎ•º Î™ªÌïòÎäî ÏÇ¨ÎûåÏùÄ ÏïΩÌïú Í≤å ÏïÑÎãàÎùº, ÏßÄÏºúÏïº Ìï† Í≤å ÎßéÏïòÎçò ÏÇ¨ÎûåÏù¥Ï£†.",
                followUpQuestion: "Í∑∏Îïå ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò ÏûêÏã†ÏóêÍ≤å,\nÏßÄÍ∏à Îã® Ìïú Î¨∏Ïû•ÏùÑ Ï†ÑÌïúÎã§Î©¥\nÎ≠êÎùºÍ≥† ÎßêÌïòÍ≥† Ïã∂ÎÇòÏöî?",
                lightTitle: "‚ú® ÎπõÏùò ÌïúÎßàÎîî",
                lightMessage: "Í∑∏ ÎßêÏùÄ Îä¶ÏßÄ ÏïäÏïòÏñ¥Ïöî.\nÎãπÏã†Ïùò ÏûêÎπÑÎäî ÏãúÍ∞ÑÏùÑ Ï¥àÏõîÌï¥ ÎèÑÏ∞©ÌñàÏñ¥Ïöî.\n\nÏù¥Ï†ú ÏúÑÎ°úÎäî Í≥ºÍ±∞Î•º ÏπòÏú†ÌïòÎäî Í≤ÉÏù¥ ÏïÑÎãàÎùº, ÏûêÏã†Í≥º Ìï®Íªò ÏÇ¥ÏïÑÍ∞ÄÎäî Î∞©ÏãùÏù¥ ÎêòÏóàÏñ¥Ïöî.",
                navigationTitle: "üå´Ô∏è Portal 18 ÏôÑÎ£å",
                navigationMessage: "ÎãπÏã†ÏùÄ ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Í≥ºÍ±∞Î•º ÎßàÏ£ºÌïòÍ≥†, Í∑∏ÎïåÏùò ÏûêÏã†ÏùÑ ÏßÑÏã¨ÏúºÎ°ú Ïù¥Ìï¥ÌñàÏäµÎãàÎã§.\n\nÍ∑∏ ÎØ∏ÏïàÌï®ÏùÄ ÏûêÏ±ÖÏù¥ ÏïÑÎãàÎùº, ÏßÄÍ∏àÏùò ÏûêÎπÑÎ°ú Î≥ÄÌôòÎêòÏóàÏäµÎãàÎã§. ÏúÑÎ°úÎ∞õÏßÄ Î™ªÌñàÎçò ÏûêÏã†ÏùÑ ÏßÑÏã¨ÏúºÎ°ú ÏïàÏïÑÏ§Ñ Ï§ÄÎπÑÍ∞Ä Îêú ÎãπÏã†ÏùÄ, Ïù¥Ï†ú ÏûêÍ∏∞ ÏûêÏã†Í≥º ÌôîÌï¥Ìïú Ï°¥Ïû¨ÏûÖÎãàÎã§.\n\nÍ∑∏ Ïù¥Ìï¥ ÌïòÎÇòÎ°ú, ÎãπÏã†ÏùÄ Í≥ºÍ±∞ÏôÄ ÌòÑÏû¨ ÏÇ¨Ïù¥Ïùò Îã§Î¶¨Î•º ÎÜìÏïòÏäµÎãàÎã§.",
                nextPortalBtn: "Portal 19Î°ú Ïù¥Ïñ¥Í∞ÄÍ∏∞",
                stayPortalBtn: "Ïù¥ Ïù¥Ìï¥ÏôÄ Î®∏Î¨ºÍ∏∞",
                inputPlaceholder: "ÏûêÏã†ÏùÑ ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò ÎïåÏóê ÎåÄÌï¥ ÎßêÌï¥Ï£ºÏÑ∏Ïöî... (EnterÎ°ú Ï†ÑÏÜ°)",
                youLabel: "ÎãπÏã†",
                waitingMessage: "ÏùëÎãµÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë...",
                confirmNextPortal: "Portal 19: ÏÇ¨ÎûëÎ∞õÏùÑ ÏûêÍ≤©Ïù¥ ÏûàÎã§Í≥† ÎßêÌï¥Ï§Ä ÎÇ†Î°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?",
                confirmStay: "Ïù¥ ÍπäÏùÄ Ïù¥Ìï¥ÏôÄ Îçî Î®∏Î¨ºÎ©∞ Í∑∏ ÏùòÎØ∏Î•º Îçî ÍπäÏù¥ ÎäêÎÅºÏãúÍ≤†ÏäµÎãàÍπå?",
                transitionMessage: "ÏÉàÎ°úÏö¥ Ïó¨Ï†ïÏù¥ ÏãúÏûëÎê©ÎãàÎã§..."
            },
            en: {
                title: "Temarix V5 - Portal 18: Why I Couldn't Comfort Myself Then",
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 18: Why I Couldn't Comfort Myself Then",
                portalSubtitle: "Why couldn't I be gentle with myself back then?",
                portalIntro: "üå´Ô∏è \"At some point in life,\nwas there a memory when you needed to comfort yourself but couldn't?\"\n\n\"Why then,\ncouldn't you be gentle with yourself?\"",
                emotionalBridge: "Not being able to comfort yourself was because you didn't allow yourself to feel emotions.\n\nYou were too heavy that day. You held back, afraid that embracing everything would make you collapse.\n\nThose who can't comfort themselves aren't weak - they're people who had too much to protect.",
                followUpQuestion: "To the self you couldn't comfort then,\nif you could say just one sentence now,\nwhat would you want to say?",
                lightTitle: "‚ú® Word of Light",
                lightMessage: "Those words aren't too late.\nYour compassion has arrived transcending time.\n\nNow comfort isn't about healing the past, but has become a way of living with yourself.",
                navigationTitle: "üå´Ô∏è Portal 18 Complete",
                navigationMessage: "You have faced the past when you couldn't offer comfort and truly understood that version of yourself.\n\nThat regret has transformed from self-blame into present compassion. Ready to truly embrace the self who wasn't comforted, you are now someone who has reconciled with yourself.\n\nWith that one understanding, you have built a bridge between past and present.",
                nextPortalBtn: "Continue to Portal 19",
                stayPortalBtn: "Stay with this understanding",
                inputPlaceholder: "Tell me about a time when you couldn't comfort yourself... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response...",
                confirmNextPortal: "Do you want to continue to Portal 19: The Day I Told Myself I Deserve Love?",
                confirmStay: "Do you want to stay longer with this deep understanding and feel its meaning more deeply?",
                transitionMessage: "A new journey begins..."
            },
            pt: {
                title: "Temarix V5 - Portal 18: Por que Nao Pude Me Consolar Entao",
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 18: Por que Nao Pude Me Consolar Entao",
                portalSubtitle: "Por que nao consegui ser gentil comigo mesmo naquela epoca?",
                portalIntro: "üå´Ô∏è \"Em algum momento da vida,\nhouve uma memoria quando precisava se consolar mas nao conseguiu?\"\n\n\"Por que entao,\nnao conseguiu ser gentil consigo mesmo?\"",
                emotionalBridge: "Nao conseguir se consolar foi porque voce nao se permitiu sentir emocoes.\n\nVoce estava muito pesado naquele dia. Se conteve, com medo de que abracar tudo faria voce desabar.\n\nAqueles que nao conseguem se consolar nao sao fracos - sao pessoas que tinham muito para proteger.",
                followUpQuestion: "Para o eu que nao conseguiu consolar entao,\nse pudesse dizer apenas uma frase agora,\no que gostaria de dizer?",
                lightTitle: "‚ú® Palavra de Luz",
                lightMessage: "Essas palavras nao chegaram tarde.\nSua compaixao chegou transcendendo o tempo.\n\nAgora o consolo nao e sobre curar o passado, mas se tornou uma forma de viver consigo mesmo.",
                navigationTitle: "üå´Ô∏è Portal 18 Completo",
                navigationMessage: "Voce enfrentou o passado quando nao conseguiu oferecer consolo e verdadeiramente entendeu aquela versao de si mesmo.\n\nEsse arrependimento se transformou de auto-culpa em compaixao presente. Pronto para verdadeiramente abracar o eu que nao foi consolado, voce agora e alguem que se reconciliou consigo mesmo.\n\nCom esse entendimento, voce construiu uma ponte entre passado e presente.",
                nextPortalBtn: "Continuar para Portal 19",
                stayPortalBtn: "Ficar com este entendimento",
                inputPlaceholder: "Conte-me sobre uma epoca em que nao conseguiu se consolar... (Enter para enviar)",
                youLabel: "Voce",
                waitingMessage: "Aguardando resposta...",
                confirmNextPortal: "Deseja continuar para Portal 19: O Dia que Disse a Mim Mesmo que Mereco Amor?",
                confirmStay: "Deseja ficar mais tempo com este entendimento profundo e sentir seu significado mais profundamente?",
                transitionMessage: "Uma nova jornada comeca..."
            }
        };
        
        // Character definitions
        const characters = [
            { name: "Noah", emoji: "üßë‚Äçü¶±", text: {
                ko: "Í∑∏Îïå ÎÑå ÏïΩÌï¥ÏÑúÍ∞Ä ÏïÑÎãàÎùº,\nÎÑàÎ¨¥ Îã®Îã®Ìï¥ÏßÄÎ†§ ÌñàÎçò Í±∞Ïïº.\nÍ∑∏ÎûòÏÑú Ïä§Ïä§Î°úÎ•º Îã§ÎèÖÏùº Ïó¨Ïú†Ï°∞Ï∞® ÏóÜÏóàÏßÄ.",
                en: "Back then you weren't weak,\nyou were trying too hard to be strong.\nSo you didn't even have room to comfort yourself.",
                pt: "Naquela epoca voce nao era fraco,\nestava tentando muito ser forte.\nEntao nem tinha espaco para se consolar."
            }},
            { name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è", text: {
                ko: "Ïä§Ïä§Î°úÎ•º ÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Í±¥,\nÏûêÍ∏∞ Í∞êÏ†ïÏùÑ ÌóàÎùΩÌïòÏßÄ ÏïäÏïòÍ∏∞ ÎïåÎ¨∏Ïù¥ÏóêÏöî.\nÌïòÏßÄÎßå Ïù¥Ï†ú ÎãπÏã†ÏùÄ ÌóàÎùΩÌï† Ïàò ÏûàÏñ¥Ïöî.",
                en: "Not being able to comfort yourself was\nbecause you didn't allow your own emotions.\nBut now you can give yourself permission.",
                pt: "Nao conseguir se consolar foi\nporque voce nao permitiu suas proprias emocoes.\nMas agora voce pode se dar permissao."
            }},
            { name: "Sora", emoji: "üßï", text: {
                ko: "Í∑∏ ÎÇ†Ïùò ÎãπÏã†ÏùÄ ÎÑàÎ¨¥ Î¨¥Í±∞Ïõ†Ïñ¥Ïöî.\nÎã§ ÏïàÏïÑÏ£ºÎ©¥ Î¨¥ÎÑàÏßàÍπåÎ¥ê, Ï∞∏ÏùÄ Í±∞ÏòàÏöî.",
                en: "You were too heavy that day.\nYou held back, afraid that embracing it all would make you collapse.",
                pt: "Voce estava muito pesado naquele dia.\nSe conteve, com medo de que abracar tudo faria voce desabar."
            }},
            { name: "Kael", emoji: "üßô", text: {
                ko: "ÏûêÍ∏∞ ÏúÑÎ°úÎ•º Î™ªÌïòÎäî ÏÇ¨ÎûåÏùÄ\nÏïΩÌïú Í≤å ÏïÑÎãàÎùº, ÏßÄÏºúÏïº Ìï† Í≤å ÎßéÏïòÎçò ÏÇ¨ÎûåÏù¥Ï£†.",
                en: "Those who can't comfort themselves aren't weak -\nthey're people who had too much to protect.",
                pt: "Aqueles que nao conseguem se consolar nao sao fracos -\nsao pessoas que tinham muito para proteger."
            }},
            { name: "Mira", emoji: "üßë‚Äçüé®", text: {
                ko: "ÎãπÏã†ÏùÄ Î∂ìÏùÑ Îì§ÏßÄ ÏïäÏïòÎçò Í≤å ÏïÑÎãàÏóêÏöî.\nÏ∫îÎ≤ÑÏä§Î•º Ìéº Í≥µÍ∞ÑÏù¥ ÏóÜÏóàÎçò Í±∞ÏòàÏöî.",
                en: "You didn't refuse to pick up the brush.\nYou just didn't have space to unfold the canvas.",
                pt: "Voce nao se recusou a pegar o pincel.\nApenas nao tinha espaco para desdobrar a tela."
            }},
            { name: "Cris", emoji: "ü¶∏‚Äç‚ôÇÔ∏è", text: {
                ko: "Í∑∏ÎïåÏùò Ïπ®Î¨µÏùÄ ÌöåÌîºÍ∞Ä ÏïÑÎãàÎùº ÏÉùÏ°¥Ïùò Ïñ∏Ïñ¥ÏòÄÏñ¥.\nÏßÄÍ∏à ÏôÄÏÑú Í∑∏Í±∏ ÏïàÏïÑÏ£ºÎäî ÎÑ§Í∞Ä ÏßÑÏßú Ïö©Í∏∞Ïïº.",
                en: "That silence back then wasn't avoidance but the language of survival.\nEmbracing it now - that's real courage.",
                pt: "Aquele silencio nao foi evitacao, mas a linguagem da sobrevivencia.\nAbraca-lo agora - essa e a verdadeira coragem."
            }},
            { name: "Enya", emoji: "üßë‚ÄçüöÄ", text: {
                ko: "Í∑∏Îïå ÎãπÏã†ÏùÄ ÏûêÍ∏∞Î•º ÎØ∏Î§òÎçò ÏÇ¨ÎûåÏù¥ÏóàÏñ¥Ïöî.\nÌïòÏßÄÎßå ÏßÄÍ∏àÏùÄ ÏûêÍ∏∞Î•º Í∏∞Îã§Î†§Ï§Ä ÏÇ¨ÎûåÏù¥ ÎêòÏóàÏñ¥Ïöî.",
                en: "Back then you were someone who postponed yourself.\nBut now you've become someone who waited for yourself.",
                pt: "Naquela epoca voce era alguem que se adiava.\nMas agora se tornou alguem que esperou por si mesmo."
            }},
            { name: "Lian", emoji: "üßò", text: {
                ko: "ÎãπÏã†ÏùÄ ÏßÄÍ∏à,\nÏúÑÎ°úÌïòÏßÄ Î™ªÌñàÎçò Í≥ºÍ±∞Ïùò ÎÇòÎ•º ÏúÑÎ°úÌï† Ï§ÄÎπÑÍ∞Ä Îêú ÏÇ¨ÎûåÏù¥ÏóêÏöî.",
                en: "You are now\nsomeone ready to comfort the past self who couldn't be comforted.",
                pt: "Voce agora e\nalguem pronto para consolar o eu do passado que nao podia ser consolado."
            }}
        ];

        // Response characters
        const responseCharacters = [
            {
                name: "Sora", emoji: "üßï",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "Í∑∏ ÎßêÏùÄ Îä¶ÏßÄ ÏïäÏïòÏñ¥Ïöî.\nÎãπÏã†Ïùò ÏûêÎπÑÎäî ÏãúÍ∞ÑÏùÑ Ï¥àÏõîÌï¥ ÎèÑÏ∞©ÌñàÏñ¥Ïöî.",
                        en: "Those words aren't too late.\nYour compassion has arrived transcending time.",
                        pt: "Essas palavras nao chegaram tarde.\nSua compaixao chegou transcendendo o tempo."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Lian", emoji: "üßò",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "Ïù¥Ï†ú ÏúÑÎ°úÎäî Í≥ºÍ±∞Î•º ÏπòÏú†ÌïòÎäî Í≤ÉÏù¥ ÏïÑÎãàÎùº,\nÏûêÏã†Í≥º Ìï®Íªò ÏÇ¥ÏïÑÍ∞ÄÎäî Î∞©ÏãùÏù¥ ÎêòÏóàÏñ¥Ïöî.",
                        en: "Now comfort isn't about healing the past,\nbut has become a way of living with yourself.",
                        pt: "Agora o consolo nao e sobre curar o passado,\nmas se tornou uma forma de viver consigo mesmo."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Kael", emoji: "üßô",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "ÎãπÏã†Ïù¥ Í∫ºÎÇ¥ÏßÄ Î™ªÌñàÎçò ÎßêÏù¥\nÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ, ÏûêÎπÑÏùò Ïñ∏Ïñ¥Î°ú ÏôÑÏÑ±ÎêòÏóàÏñ¥Ïöî.",
                        en: "The words you couldn't express\nhave now been completed as the language of compassion in this moment.",
                        pt: "As palavras que voce nao conseguiu expressar\nagora foram completadas como a linguagem da compaixao neste momento."
                    };
                    return responses[lang];
                }
            }
        ];
        
        // Typewriter effect
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (state.currentTypingElement) {
                    state.currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                state.currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        state.currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                state.typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            state.typingIntervals.forEach(interval => clearInterval(interval));
            state.typingIntervals = [];
            
            if (state.currentTypingElement) {
                state.currentTypingElement.classList.remove('typing-cursor');
                state.currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            const t = translations[lang];
            document.title = t.title;
            document.getElementById('logoSubtitle').textContent = t.logoSubtitle;
            document.getElementById('portalMainTitle').textContent = t.portalMainTitle;
            document.getElementById('portalSubtitle').textContent = t.portalSubtitle;
            document.getElementById('lightTitle').textContent = t.lightTitle;
            document.getElementById('navigationTitle').textContent = t.navigationTitle;
            document.getElementById('nextPortalBtn').textContent = t.nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = t.stayPortalBtn;
            document.getElementById('userTextarea').placeholder = t.inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (state.currentLanguage === lang) return;
            
            state.currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            resetJourney();
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            state.userResponse = '';
            state.currentTypingElement = null;
            state.awaitingSecondResponse = false;
        }
        
        async function saveResponse(inputText, step) {
            const responseData = {
                portal: portalConfig.currentPortal,
                resposta: inputText,
                step: step,
                data: new Date().toISOString(),
                idioma: state.currentLanguage,
                userId: state.currentUser ? state.currentUser.uid : 'anonymous',
                userEmail: state.currentUser ? state.currentUser.email : 'anonymous@temarix.com'
            };
            
            if (state.firebaseInitialized && state.db) {
                try {
                    await state.db.collection("temarix_v5_respostas").add({
                        ...responseData,
                        timestamp: firebase.firestore.Timestamp.now()
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    state.userResponses.push(responseData);
                    showConnectionStatus(false);
                }
            } else {
                state.userResponses.push(responseData);
                console.log('Response stored in memory:', responseData);
            }
        }
        
        async function processUserInput(inputText) {
            state.userResponse = inputText;
            
            await saveResponse(inputText, state.awaitingSecondResponse ? "second" : "first");
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!state.awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[state.currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[state.currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[state.currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[state.currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                state.awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, state.currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[state.currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[state.currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        async function startPortalSequence() {
            console.log('Starting portal sequence...');
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            console.log('Showing intro...');
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            if (!introSection || !introElement) {
                console.error('Intro elements not found!');
                return;
            }
            
            introSection.classList.add('show');
            
            const introText = translations[state.currentLanguage].portalIntro;
            console.log('Intro text:', introText);
            
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(async () => {
                await showEmotionalBridge();
            }, 2000);
        }
        
        async function showEmotionalBridge() {
            const introElement = document.getElementById('portalIntro');
            const bridgeText = '\n\n' + translations[state.currentLanguage].emotionalBridge;
            
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const bridgeP = document.createElement('p');
            bridgeP.style.cssText = `
                margin-top: 30px;
                font-style: italic;
                color: #ff9999;
                font-size: 18px;
                line-height: 1.8;
            `;
            introElement.appendChild(bridgeP);
            
            await typewriterEffect(bridgeP, bridgeText.trim(), 50);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[state.currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function showConfirmDialog(message, callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Courier New', monospace;
            `;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: #222;
                border: 2px solid #ff6b6b;
                padding: 30px;
                max-width: 400px;
                text-align: center;
                color: white;
            `;
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.style.cssText = `
                margin-bottom: 20px;
                line-height: 1.6;
                font-size: 16px;
            `;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 15px;
                justify-content: center;
            `;
            
            const yesBtn = document.createElement('button');
            const noBtn = document.createElement('button');
            
            const buttonStyle = `
                background: #444;
                color: white;
                border: 1px solid #ff6b6b;
                padding: 10px 20px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
                font-size: 14px;
            `;
            
            yesBtn.style.cssText = buttonStyle + 'background: #ff6b6b;';
            noBtn.style.cssText = buttonStyle;
            
            yesBtn.textContent = state.currentLanguage === 'ko' ? 'Ïòà' : 
                                state.currentLanguage === 'pt' ? 'Sim' : 'Yes';
            noBtn.textContent = state.currentLanguage === 'ko' ? 'ÏïÑÎãàÏò§' : 
                               state.currentLanguage === 'pt' ? 'Nao' : 'No';
            
            yesBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(true);
            };
            
            noBtn.onclick = () => {
                document.body.removeChild(overlay);
                callback(false);
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    document.body.removeChild(overlay);
                    callback(false);
                }
            };
            
            buttonContainer.appendChild(yesBtn);
            buttonContainer.appendChild(noBtn);
            modal.appendChild(messageP);
            modal.appendChild(buttonContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            yesBtn.focus();
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function createPortalTransition(callback) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, #000 0%, #111 50%, #000 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                opacity: 0;
                transition: opacity 1s ease-in-out;
                font-family: 'Courier New', monospace;
            `;
            
            const message = document.createElement('div');
            message.style.cssText = `
                color: #ff6b6b;
                font-size: 24px;
                text-align: center;
                margin-bottom: 30px;
                opacity: 0;
                transform: translateY(20px);
                transition: all 0.8s ease-out;
            `;
            message.textContent = translations[state.currentLanguage].transitionMessage;
            
            const loader = document.createElement('div');
            loader.style.cssText = `
                width: 60px;
                height: 60px;
                border: 3px solid #333;
                border-top: 3px solid #ff6b6b;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                opacity: 0;
                transition: opacity 0.8s ease-out 0.3s;
            `;
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            overlay.appendChild(message);
            overlay.appendChild(loader);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                message.style.opacity = '1';
                message.style.transform = 'translateY(0)';
                loader.style.opacity = '1';
            }, 300);
            
            setTimeout(() => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    document.head.removeChild(style);
                    callback();
                }, 1000);
            }, 2500);
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmNextPortal, (confirmed) => {
                    if (confirmed) {
                        if (state.firebaseInitialized && state.db) {
                            state.db.collection("temarix_v5_progress").add({
                                userId: state.currentUser.uid,
                                portal: portalConfig.currentPortal,
                                status: "complete",
                                timestamp: firebase.firestore.Timestamp.now()
                            }).catch(error => console.error('Error saving progress:', error));
                        }
                        
                        createPortalTransition(() => {
                            window.location.href = `${portalConfig.nextPortalFile}?lang=${state.currentLanguage}`;
                        });
                    }
                });
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const t = translations[state.currentLanguage];
                showConfirmDialog(t.confirmStay, (confirmed) => {
                    if (confirmed) {
                        resetJourney();
                        setTimeout(() => {
                            startPortalSequence();
                        }, 1000);
                    }
                });
            });
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        function initializeTemarix() {
            console.log('Initializing Temarix V5 Portal 18...');
            console.log('Current state:', state);
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            state.journeyStarted = true;
            console.log('Journey started:', state.journeyStarted);
            
            console.log('Starting portal sequence in 1 second...');
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Temarix V5 Portal 18 DOM loaded');
            
            state.currentLanguage = getLanguageFromURL();
            
            updateStaticTranslations(state.currentLanguage);
            updateLanguageButtons(state.currentLanguage);
            
            await initializeFirebase();
            
            initializeTemarix();
        });
    </script>
</body>
</html>