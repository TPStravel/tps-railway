<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 01: Fragments of Broken Truth</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 01: Fragments of Broken Truth</div>
            <div class="portal-subtitle" id="portalSubtitle">The pieces of truth that cut through memories</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">ðŸ”¥ Portal 01 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 02</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these fragments</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What is that 'broken truth' that comes to mind? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì • ì—°ê¸ˆìˆ ",
                portalMainTitle: "Portal 01: ê¹¨ì§„ ì§„ì‹¤ì˜ íŒŒíŽ¸",
                portalSubtitle: "ê¸°ì–µ ì†ì„ ë² ì–´ê°€ëŠ” ì§„ì‹¤ì˜ ì¡°ê°ë“¤",
                portalIntro: "ðŸ”¥ \"ì§„ì‹¤ì´ í•­ìƒ ë¹›ë‚˜ëŠ” ê±´ ì•„ë‹ˆì—ìš”.\"\n\"ì–´ë–¤ ì§„ì‹¤ì€ ê¹¨ì ¸ì„œ ë§ˆìŒ ì–´ë”˜ê°€ì— ë°•ížŒ ì±„,\nì‹œê°„ì´ ì§€ë‚˜ë„ ì‚¬ë¼ì§€ì§€ ì•Šì£ .\"\n\n\"ì§€ê¸ˆ ë– ì˜¤ë¥´ëŠ” ê·¸ 'ê¹¨ì§„ ì§„ì‹¤'ì´ ìžˆë‹¤ë©´,\nê·¸ê²ƒì€ ëˆ„êµ¬ì— ëŒ€í•œ ê²ƒì´ì—ˆê³ ,\nì–´ë–¤ ìƒí™©ì´ì—ˆë‚˜ìš”?\"\n\n\"ê·¸ ì§„ì‹¤ì€â€¦ ë‹¹ì‹ ì—ê²Œ ì–´ë–¤ í”ì ì„ ë‚¨ê²¼ë‚˜ìš”?\"",
                followUpQuestion: "ê·¸ 'ê¹¨ì§„ ì§„ì‹¤'ì„ ì§ë©´í•œ ì´í›„,\në‹¹ì‹ ì€ ìžì‹ ì„ ì–´ë–»ê²Œ ë‹¤ë£¨ë©° ì‚´ì•„ì™”ë‚˜ìš”?\nê·¸ ì¡°ê°ì€ ì§€ê¸ˆë„ ë‹¹ì‹  ì•ˆì—ì„œ ë‚¨ì•„ ìžˆë‚˜ìš”?",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ê¹¨ì§„ ì§„ì‹¤ì€ ì‚¬ë¼ì§€ì§€ ì•Šì•˜ì–´ìš”.\në‹¨ì§€ ìƒˆë¡œìš´ í˜•íƒœë¡œ ë‹¹ì‹ ì˜ ì§€í˜œê°€ ë˜ì—ˆì„ ë¿ì´ì—ìš”.\nìƒì²˜ëŠ” ë¹›ì´ ë“¤ì–´ì˜¤ëŠ” ê³³ì´ê¸°ë„ í•˜ê±°ë“ ìš”.",
                navigationTitle: "ðŸ”¥ Portal 01 ì™„ë£Œ",
                navigationMessage: "ë‹¹ì‹ ì€ ê¹¨ì§„ ì§„ì‹¤ì˜ íŒŒíŽ¸ê³¼ ë§ˆì£¼í–ˆìŠµë‹ˆë‹¤.\nê·¸ ë‚ ì¹´ë¡œìš´ ì¡°ê°ë“¤ì€ ì´ì œ ë” ì´ìƒ ë‹¹ì‹ ì„ ë² ì§€ ì•Šì„ ê²ƒìž…ë‹ˆë‹¤.\nì˜¤ížˆë ¤ ë¹›ì„ êµ´ì ˆì‹œì¼œ ìƒˆë¡œìš´ ë¬´ì§€ê°œë¥¼ ë§Œë“¤ì–´ë‚¼ ê±°ì˜ˆìš”.\n\nì§„ì‹¤ì€ ì™„ì „í•  í•„ìš”ê°€ ì—†ë‹¤ëŠ” ê²ƒì„ ì•Œì•˜ìœ¼ë‹ˆê¹Œìš”.\nê¹¨ì§„ ì±„ë¡œë„, ì¶©ë¶„ížˆ ì•„ë¦„ë‹¤ìš¸ ìˆ˜ ìžˆë‹¤ëŠ” ê²ƒì„ ë°°ì› ìœ¼ë‹ˆê¹Œìš”.",
                nextPortalBtn: "Portal 02ë¡œ ì´ì–´ê°€ê¸°",
                stayPortalBtn: "ì´ íŒŒíŽ¸ê³¼ ë” ë¨¸ë¬¼ê¸°",
                inputPlaceholder: "ë– ì˜¤ë¥´ëŠ” ê·¸ 'ê¹¨ì§„ ì§„ì‹¤'ì€ ë¬´ì—‡ì¸ê°€ìš”? (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 01: Fragments of Broken Truth",
                portalSubtitle: "The pieces of truth that cut through memories",
                portalIntro: "ðŸ”¥ \"Truth doesn't always shine.\"\n\"Some truths shatter and lodge somewhere in the heart,\nnever disappearing even as time passes.\"\n\n\"If there's a 'broken truth' that comes to mind now,\nwho was it about,\nand what was the situation?\"\n\n\"That truth... what traces did it leave on you?\"",
                followUpQuestion: "After facing that 'broken truth',\nhow have you been treating yourself while living?\nDo those fragments still remain within you?",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "The broken truth hasn't disappeared.\nIt has simply become your wisdom in a new form.\nWounds are also places where light enters.",
                navigationTitle: "ðŸ”¥ Portal 01 Complete",
                navigationMessage: "You have faced the fragments of broken truth.\nThose sharp pieces will no longer cut you.\nInstead, they will refract light to create new rainbows.\n\nBecause you've learned that truth doesn't need to be perfect.\nYou've discovered that even broken, it can still be beautiful enough.",
                nextPortalBtn: "Continue to Portal 02",
                stayPortalBtn: "Stay with these fragments",
                inputPlaceholder: "What is that 'broken truth' that comes to mind? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 01: Fragmentos da Verdade Quebrada",
                portalSubtitle: "Os pedaÃ§os de verdade que cortam as memÃ³rias",
                portalIntro: "ðŸ”¥ \"A verdade nem sempre brilha.\"\n\"Algumas verdades se quebram e se alojam em algum lugar do coraÃ§Ã£o,\nnunca desaparecendo mesmo com o passar do tempo.\"\n\n\"Se hÃ¡ uma 'verdade quebrada' que vem Ã  mente agora,\nsobre quem era,\ne qual era a situaÃ§Ã£o?\"\n\n\"Essa verdade... que rastros deixou em vocÃª?\"",
                followUpQuestion: "ApÃ³s enfrentar essa 'verdade quebrada',\ncomo vocÃª tem se tratado enquanto vive?\nEsses fragmentos ainda permanecem dentro de vocÃª?",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "A verdade quebrada nÃ£o desapareceu.\nSimplesmente se tornou sua sabedoria em uma nova forma.\nFeridas tambÃ©m sÃ£o lugares onde a luz entra.",
                navigationTitle: "ðŸ”¥ Portal 01 Completo",
                navigationMessage: "VocÃª enfrentou os fragmentos da verdade quebrada.\nEsses pedaÃ§os afiados nÃ£o vÃ£o mais te cortar.\nEm vez disso, vÃ£o refratar a luz para criar novos arco-Ã­ris.\n\nPorque vocÃª aprendeu que a verdade nÃ£o precisa ser perfeita.\nVocÃª descobriu que mesmo quebrada, ainda pode ser bela o suficiente.",
                nextPortalBtn: "Continuar para Portal 02",
                stayPortalBtn: "Ficar com esses fragmentos",
                inputPlaceholder: "Qual Ã© essa 'verdade quebrada' que vem Ã  mente? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ë„ˆëŠ” ì‚¬ëž‘í•˜ë ¤ í–ˆì§€ë§Œ, ê·¸ ì‚¬ëž‘ ì†ì— ìˆ¨ì–´ ìžˆëŠ” ë‘ë ¤ì›€ì„ ì™¸ë©´í–ˆêµ¬ë‚˜.",
                en: "You tried to love, but you ignored the fear hidden within that love.",
                pt: "VocÃª tentou amar, mas ignorou o medo escondido dentro desse amor."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ë¬´ì„œì›€ì€ ì¢…ì¢… ê°€ìž¥ ê°€ê¹Œìš´ ì‚¬ëžŒì—ê²Œì„œ íƒœì–´ë‚˜. ê·¸ê±´ ë„¤ ìž˜ëª»ì´ ì•„ë‹ˆì•¼.",
                en: "Fear is often born from those closest to us. That's not your fault.",
                pt: "O medo muitas vezes nasce daqueles mais prÃ³ximos de nÃ³s. Isso nÃ£o Ã© culpa sua."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ì¡°ìš©í•œ ì§€ë°°ëŠ” ì†Œë¦¬ë³´ë‹¤ ê¹Šì€ ìƒì²˜ë¥¼ ë‚¨ê²¨ìš”. ê·¸ ì¹¨ë¬µ ì•ˆì—ì„œ ë„Œ ì–¼ë§ˆë‚˜ ìž‘ì•„ì¡Œì„ê¹Œ.",
                en: "Quiet domination leaves deeper wounds than noise. How small you must have felt in that silence.",
                pt: "A dominaÃ§Ã£o silenciosa deixa feridas mais profundas que o ruÃ­do. Como vocÃª deve ter se sentido pequeno nesse silÃªncio."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ì§„ì‹¤ì€ ì¡°ê°ë‚¬ì„ ë•Œ ë” ë‚ ì¹´ë¡­ì§€. ê·¸ ì¡°ê°ì´ ë„ˆë¥¼ ì°”ë €ë‹¤ë©´, ì´ì œëŠ” êº¼ë‚´ì•¼ í•´.",
                en: "Truth becomes sharper when it's shattered. If those fragments pierced you, now you must remove them.",
                pt: "A verdade fica mais afiada quando Ã© estilhaÃ§ada. Se esses fragmentos te perfuraram, agora vocÃª deve removÃª-los."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ì˜ ì¹¨ë¬µì€ ê·¸ë¦¼ìžì˜€ê³ , ë„Œ ê·¸ ê·¸ë¦¼ìž ì•ˆì—ì„œ ìžëžêµ¬ë‚˜.",
                en: "His silence was a shadow, and you grew up within that shadow.",
                pt: "O silÃªncio dele era uma sombra, e vocÃª cresceu dentro dessa sombra."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ì™œ ì–´ë¥¸ì´ ë˜ëŠ” ê±´ í•­ìƒ ì°¸ëŠ” ê±°ë¼ê³  ë°°ì›Œì•¼ í–ˆì„ê¹Œ? ê·¸ê²Œ ì •ì˜ëŠ” ì•„ë‹ˆì•¼.",
                en: "Why did we have to learn that growing up always means enduring? That's not justice.",
                pt: "Por que tivemos que aprender que crescer sempre significa suportar? Isso nÃ£o Ã© justiÃ§a."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ì§„ì‹¤ì„ ë³´ëŠ” ìˆœê°„, ì„¸ê³„ëŠ” ì¡°ê¸ˆ ë¶€ì„œì§€ì§€. í•˜ì§€ë§Œ ê·¸ê±´ ìƒˆë¡œìš´ ì„¸ê³„ì˜ ì„œê³¡ì´ì•¼.",
                en: "The moment you see truth, the world breaks a little. But that's the prelude to a new world.",
                pt: "No momento em que vocÃª vÃª a verdade, o mundo se quebra um pouco. Mas isso Ã© o prelÃºdio de um novo mundo."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ê·¸ ì¡°ê°ë‚œ ê°ì •, ì´ì œëŠ” ë§ë¡œ ë¹šì–´ë‚¼ ìˆ˜ ìžˆì–´. ë„¤ ì•ˆì˜ ì¹¨ë¬µì´ ê¹¨ì–´ì§€ê³  ìžˆì–´.",
                en: "Those fragmented emotions, now you can shape them into words. The silence within you is breaking.",
                pt: "Essas emoÃ§Ãµes fragmentadas, agora vocÃª pode moldÃ¡-las em palavras. O silÃªncio dentro de vocÃª estÃ¡ se quebrando."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                betrayal: ['betrayed', 'lied', 'deceived', 'trust', 'broken', 'ë°°ì‹ ', 'ê±°ì§“ë§', 'ì†ìž„', 'ì‹ ë¢°', 'ê¹¨ì§„', 'traÃ­do', 'mentiu', 'enganado', 'confianÃ§a', 'quebrado'],
                abandonment: ['left', 'abandoned', 'alone', 'gone', 'disappeared', 'ë– ë‚¬', 'ë²„ë ¸', 'í˜¼ìž', 'ì‚¬ë¼ì§„', 'deixou', 'abandonou', 'sozinho', 'foi embora', 'desapareceu'],
                family: ['father', 'mother', 'parent', 'family', 'dad', 'mom', 'ì•„ë²„ì§€', 'ì–´ë¨¸ë‹ˆ', 'ê°€ì¡±', 'ì•„ë¹ ', 'ì—„ë§ˆ', 'pai', 'mÃ£e', 'famÃ­lia'],
                control: ['control', 'dominate', 'manipulate', 'power', 'ì¡°ì¢…', 'ì§€ë°°', 'ì¡°ìž‘', 'ê¶Œë ¥', 'controlar', 'dominar', 'manipular', 'poder'],
                silence: ['silent', 'quiet', 'didn\'t speak', 'no words', 'ì¹¨ë¬µ', 'ì¡°ìš©', 'ë§í•˜ì§€', 'ë¬´ì–¸', 'silencioso', 'quieto', 'nÃ£o falou', 'sem palavras'],
                fear: ['scared', 'afraid', 'frightened', 'terror', 'ë¬´ì„œì›Œ', 'ë‘ë ¤ì›Œ', 'ê²ë‚˜', 'assustado', 'com medo', 'aterrorizado'],
                rejection: ['rejected', 'refused', 'denied', 'dismissed', 'ê±°ì ˆ', 'ê±°ë¶€', 'ë¬´ì‹œ', 'rejeitado', 'recusado', 'negado', 'dispensado'],
                discovery: ['found out', 'discovered', 'learned', 'realized', 'ì•Œê²Œ ëœ', 'ë°œê²¬', 'ê¹¨ë‹¬ì•˜', 'descobriu', 'aprendeu', 'percebeu']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            betrayal: "ìŠ¤ìŠ¤ë¡œë¥¼ ì§€í‚¤ëŠ” ë²•ì€ ë•Œë¡œ ì™¸ë¡œì›€ì´ ë¼ìš”. ë„¤ê°€ ë§Œë“  ê·¸ ê±°ë¦¬ë§Œí¼, ë„ˆë„ ìƒì²˜ë°›ì•˜ê² ì§€.",
                            abandonment: "ë– ë‚œ ì‚¬ëžŒì€ ë„¤ ë§ˆìŒë„ í•¨ê»˜ ê°€ì ¸ê°”ê² ì§€. ê·¸ ë¹ˆìžë¦¬ê°€ ì–¼ë§ˆë‚˜ ì•„í”ˆì§€ ì•Œì•„ìš”.",
                            family: "ê°€ì¡±ì˜ ìƒì²˜ëŠ” ê°€ìž¥ ê¹Šì–´ìš”. ì‚¬ëž‘í•´ì•¼ í•  ì‚¬ëžŒì—ê²Œ ë°›ì€ ìƒì²˜ë‹ˆê¹Œìš”.",
                            control: "ì¡°ìš©í•œ ì§€ë°°ëŠ” ì†Œë¦¬ë³´ë‹¤ ê¹Šì€ ìƒì²˜ë¥¼ ë‚¨ê²¨ìš”. ê·¸ ì¹¨ë¬µ ì•ˆì—ì„œ ë„Œ ì–¼ë§ˆë‚˜ ìž‘ì•„ì¡Œì„ê¹Œ.",
                            silence: "ë§í•˜ì§€ ì•Šì€ ì§„ì‹¤ì€ ê°€ìž¥ ë¬´ê±°ìš´ ì§ì´ ë¼ìš”. ê·¸ ë¬´ê²Œë¥¼ í˜¼ìž ì§Šì–´ì§€ëŠë¼ íž˜ë“¤ì—ˆê² ì–´ìš”.",
                            fear: "ë‘ë ¤ì›€ ì†ì—ì„œë„ ì‚´ì•„ë‚¨ì€ ë‹¹ì‹ ì´ ëŒ€ë‹¨í•´ìš”. ê·¸ ìš©ê¸°ë¥¼ ì¸ì •í•´ì£¼ì„¸ìš”.",
                            rejection: "ê±°ì ˆë‹¹í•œ ë§ˆìŒì€ ìžì‹ ì„ ì˜ì‹¬í•˜ê²Œ ë§Œë“¤ì–´ìš”. í•˜ì§€ë§Œ ê·¸ê±´ ë‹¹ì‹ ì˜ ê°€ì¹˜ì™€ëŠ” ë¬´ê´€í•´ìš”.",
                            discovery: "ì§„ì‹¤ì„ ë°œê²¬í•˜ëŠ” ìˆœê°„ì˜ ì¶©ê²©, ê·¸ ì•„í””ì„ ê²¬ëŽŒë‚¸ ë‹¹ì‹ ì´ ê°•í•´ìš”.",
                            general: "ê·¸ ì§„ì‹¤ì˜ ì¡°ê°ë“¤ì´ ë‹¹ì‹ ì„ ì•„í”„ê²Œ í–ˆì§€ë§Œ, ì´ì œëŠ” ì§€í˜œì˜ ì¼ë¶€ê°€ ë˜ì—ˆì–´ìš”."
                        },
                        en: {
                            betrayal: "Learning to protect yourself sometimes becomes loneliness. You must have been hurt as much as the distance you created.",
                            abandonment: "The person who left must have taken part of your heart with them. I know how painful that empty space must be.",
                            family: "Family wounds are the deepest. Because they're wounds from those who should have loved you.",
                            control: "Quiet domination leaves deeper wounds than noise. How small you must have felt in that silence.",
                            silence: "Unspoken truth becomes the heaviest burden. It must have been hard carrying that weight alone.",
                            fear: "You're amazing for surviving in that fear. Please acknowledge that courage.",
                            rejection: "A rejected heart makes you doubt yourself. But that has nothing to do with your worth.",
                            discovery: "The shock of discovering truth, you're strong for enduring that pain.",
                            general: "Those fragments of truth hurt you, but now they've become part of your wisdom."
                        },
                        pt: {
                            betrayal: "Aprender a se proteger Ã s vezes se torna solidÃ£o. VocÃª deve ter se machucado tanto quanto a distÃ¢ncia que criou.",
                            abandonment: "A pessoa que partiu deve ter levado parte do seu coraÃ§Ã£o junto. Sei como esse espaÃ§o vazio deve doer.",
                            family: "Feridas familiares sÃ£o as mais profundas. Porque sÃ£o feridas daqueles que deveriam ter te amado.",
                            control: "A dominaÃ§Ã£o silenciosa deixa feridas mais profundas que o ruÃ­do. Como vocÃª deve ter se sentido pequeno nesse silÃªncio.",
                            silence: "A verdade nÃ£o dita se torna o fardo mais pesado. Deve ter sido difÃ­cil carregar esse peso sozinho.",
                            fear: "VocÃª Ã© incrÃ­vel por ter sobrevivido nesse medo. Por favor, reconheÃ§a essa coragem.",
                            rejection: "Um coraÃ§Ã£o rejeitado faz vocÃª duvidar de si mesmo. Mas isso nÃ£o tem nada a ver com seu valor.",
                            discovery: "O choque de descobrir a verdade, vocÃª Ã© forte por ter suportado essa dor.",
                            general: "Esses fragmentos de verdade te machucaram, mas agora se tornaram parte da sua sabedoria."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            betrayal: "ì‹ ë¢°ëŠ” ë‹¤ì‹œ ë°°ìš¸ ìˆ˜ ìžˆì–´. ë„ˆëŠ” ì´ì œ ì§„ì‹¤ì„ ë§í•  ìˆ˜ ìžˆê²Œ ë˜ì—ˆìœ¼ë‹ˆê¹Œ.",
                            abandonment: "ë– ë‚˜ê°„ ì‚¬ëžŒì´ ë‚¨ê¸´ ë¹ˆìžë¦¬, ê·¸ê³³ì— ì´ì œ ë‹¹ì‹  ìžì‹ ì„ ì±„ì›Œë„£ì„ ìˆ˜ ìžˆì–´ìš”.",
                            family: "ê°€ì¡±ì˜ ì‚¬ëž‘ì„ ê¸°ëŒ€í–ˆë˜ ë‹¹ì‹ ì˜ ë§ˆìŒì€ í‹€ë¦¬ì§€ ì•Šì•˜ì–´ìš”. ê·¸ë“¤ì´ ì¤„ ìˆ˜ ì—†ì—ˆì„ ë¿ì´ì—ìš”.",
                            control: "ë¬´ì„œì›€ì€ ì¢…ì¢… ê°€ìž¥ ê°€ê¹Œìš´ ì‚¬ëžŒì—ê²Œì„œ íƒœì–´ë‚˜. ê·¸ê±´ ë„¤ ìž˜ëª»ì´ ì•„ë‹ˆì•¼.",
                            silence: "ì¹¨ë¬µ ì†ì— ìˆ¨ê²¨ì§„ ì§„ì‹¤ë“¤ì´ ì´ì œ ë§ì´ ë˜ê¸° ì‹œìž‘í–ˆì–´ìš”. ë‹¹ì‹ ì´ ìš©ê¸°ë¥¼ ëƒˆìœ¼ë‹ˆê¹Œìš”.",
                            fear: "ë‘ë ¤ì›€ì„ ëŠê¼ˆë‹¤ëŠ” ê±´ ë‹¹ì‹ ì´ ì‚´ì•„ìžˆë‹¤ëŠ” ì¦ê±°ì˜ˆìš”. ê·¸ ê°ì •ì„ ë¶€ë„ëŸ¬ì›Œí•˜ì§€ ë§ˆì„¸ìš”.",
                            rejection: "ê±°ì ˆì€ ëì´ ì•„ë‹ˆë¼ ìƒˆë¡œìš´ ì‹œìž‘ì˜ ì‹ í˜¸ì¼ ìˆ˜ ìžˆì–´ìš”. ë” ë§žëŠ” ìžë¦¬ë¥¼ ì°¾ê²Œ í•´ì£¼ë‹ˆê¹Œìš”.",
                            discovery: "ì§„ì‹¤ì„ ë§ˆì£¼í•˜ëŠ” ìš©ê¸°, ê·¸ê²ƒì´ ë‹¹ì‹ ì„ ë” ê°•í•˜ê²Œ ë§Œë“¤ì—ˆì–´ìš”.",
                            general: "ê¹¨ì§„ ì§„ì‹¤ë„ ì™„ì „í•œ ì§„ì‹¤ë§Œí¼ ê°€ì¹˜ìžˆì–´ìš”. ë‹¹ì‹ ì˜ ê²½í—˜ì´ ê·¸ê²ƒì„ ì¦ëª…í•´ìš”."
                        },
                        en: {
                            betrayal: "Trust can be learned again. Because you've now become able to speak the truth.",
                            abandonment: "The empty space left by those who departed, you can now fill it with yourself.",
                            family: "Your heart that expected family love wasn't wrong. They just couldn't give it.",
                            control: "Fear is often born from those closest to us. That's not your fault.",
                            silence: "The truths hidden in silence are now starting to become words. Because you found courage.",
                            fear: "Feeling fear is proof that you're alive. Don't be ashamed of that emotion.",
                            rejection: "Rejection might not be an end but a signal for a new beginning. It helps you find a more suitable place.",
                            discovery: "The courage to face truth, that's what made you stronger.",
                            general: "Even broken truth is as valuable as complete truth. Your experience proves that."
                        },
                        pt: {
                            betrayal: "A confianÃ§a pode ser aprendida novamente. Porque agora vocÃª se tornou capaz de falar a verdade.",
                            abandonment: "O espaÃ§o vazio deixado por aqueles que partiram, agora vocÃª pode preenchÃª-lo consigo mesmo.",
                            family: "Seu coraÃ§Ã£o que esperava amor familiar nÃ£o estava errado. Eles apenas nÃ£o conseguiram dar.",
                            control: "O medo muitas vezes nasce daqueles mais prÃ³ximos de nÃ³s. Isso nÃ£o Ã© culpa sua.",
                            silence: "As verdades escondidas no silÃªncio agora estÃ£o comeÃ§ando a se tornar palavras. Porque vocÃª encontrou coragem.",
                            fear: "Sentir medo Ã© prova de que vocÃª estÃ¡ vivo. NÃ£o se envergonhe dessa emoÃ§Ã£o.",
                            rejection: "A rejeiÃ§Ã£o pode nÃ£o ser um fim, mas um sinal para um novo comeÃ§o. Ajuda vocÃª a encontrar um lugar mais adequado.",
                            discovery: "A coragem de enfrentar a verdade, foi isso que te tornou mais forte.",
                            general: "Mesmo a verdade quebrada Ã© tÃ£o valiosa quanto a verdade completa. Sua experiÃªncia prova isso."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "ðŸ§™",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            betrayal: "ì´ì œëŠ” 'ì¡°ì‹¬'ì´ ì•„ë‹ˆë¼ 'ì„ íƒ'ì˜ ì‹œê°„ì´ì•¼. ì§„ì‹¤ì„ ì§ë©´í•œ ë„ˆëŠ”, ìŠ¤ìŠ¤ë¡œë¥¼ ë‹¤ì‹œ ë¹šì„ ìˆ˜ ìžˆì–´.",
                            abandonment: "ë– ë‚œ ê²ƒë“¤ì€ ê³µê°„ì„ ë§Œë“¤ì–´ì¤˜. ê·¸ ê³µê°„ì— ì´ì œ ë” ì§„ì‹¤í•œ ê²ƒë“¤ì´ ë“¤ì–´ì˜¬ ìˆ˜ ìžˆì–´.",
                            family: "ê°€ì¡±ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë°›ì€ ìƒì²˜ëŠ” ê°€ìž¥ ê¹Šì§€ë§Œ, ì¹˜ìœ ë  ë•Œë„ ê°€ìž¥ ê°•ë ¥í•œ íž˜ì´ ë¼.",
                            control: "ì§„ì‹¤ì€ ì¡°ê°ë‚¬ì„ ë•Œ ë” ë‚ ì¹´ë¡­ì§€. ê·¸ ì¡°ê°ì´ ë„ˆë¥¼ ì°”ë €ë‹¤ë©´, ì´ì œëŠ” êº¼ë‚´ì•¼ í•´.",
                            silence: "ë§í•˜ì§€ ëª»í•œ ì§„ì‹¤ì€ ë…ì´ ë˜ì§€ë§Œ, ë§í•´ì§„ ì§„ì‹¤ì€ ì•½ì´ ë¼. ë‹¹ì‹ ì´ ê·¸ ë³€í™”ë¥¼ ë§Œë“¤ì—ˆì–´.",
                            fear: "ë‘ë ¤ì›€ì€ ê±°ì§“ ì•ˆì „ì˜ ì‹ í˜¸ì•¼. ì§„ì§œ ì•ˆì „ì€ ì§„ì‹¤ì„ ë§ˆì£¼í•  ë•Œ ì˜¨ë‹¤.",
                            rejection: "ê±°ì ˆë‹¹í•œ ìžë¦¬ì—ì„œ í”¼ì–´ë‚˜ëŠ” ìžì¡´ê°ì´ ìžˆì–´. ê·¸ê²ƒì´ ì§„ì§œ íž˜ì´ì•¼.",
                            discovery: "ì§„ì‹¤ì„ ë°œê²¬í•˜ëŠ” ìˆœê°„ì€ íŒŒê´´ì´ìž ì°½ì¡°ì•¼. ë‹¹ì‹ ì€ ê·¸ ë‘ ê³¼ì •ì„ ëª¨ë‘ ê²½í—˜í–ˆì–´.",
                            general: "ê¹¨ì§„ ì§„ì‹¤ì˜ ì¡°ê°ë“¤ì´ ì´ì œ ìƒˆë¡œìš´ ëª¨ìžì´í¬ë¥¼ ë§Œë“¤ ìˆ˜ ìžˆì–´. ë” ì•„ë¦„ë‹¤ìš´ ê·¸ë¦¼ìœ¼ë¡œ."
                        },
                        en: {
                            betrayal: "Now it's time for 'choice', not 'caution'. Having faced truth, you can reshape yourself.",
                            abandonment: "What left creates space. More truthful things can now enter that space.",
                            family: "Wounds received in the name of family are deepest, but when healed, they become the most powerful strength.",
                            control: "Truth becomes sharper when shattered. If those fragments pierced you, now you must remove them.",
                            silence: "Unspoken truth becomes poison, but spoken truth becomes medicine. You made that transformation.",
                            fear: "Fear is a signal of false safety. Real safety comes when you face the truth.",
                            rejection: "There's a self-esteem that blooms from the place of rejection. That's real power.",
                            discovery: "The moment of discovering truth is both destruction and creation. You've experienced both processes.",
                            general: "The fragments of broken truth can now form a new mosaic. Into a more beautiful picture."
                        },
                        pt: {
                            betrayal: "Agora Ã© hora de 'escolha', nÃ£o 'cautela'. Tendo enfrentado a verdade, vocÃª pode se remodelar.",
                            abandonment: "O que partiu cria espaÃ§o. Coisas mais verdadeiras podem agora entrar nesse espaÃ§o.",
                            family: "Feridas recebidas em nome da famÃ­lia sÃ£o as mais profundas, mas quando curadas, se tornam a forÃ§a mais poderosa.",
                            control: "A verdade fica mais afiada quando estilhaÃ§ada. Se esses fragmentos te perfuraram, agora vocÃª deve removÃª-los.",
                            silence: "A verdade nÃ£o dita se torna veneno, mas a verdade dita se torna remÃ©dio. VocÃª fez essa transformaÃ§Ã£o.",
                            fear: "O medo Ã© um sinal de seguranÃ§a falsa. A seguranÃ§a real vem quando vocÃª enfrenta a verdade.",
                            rejection: "HÃ¡ uma autoestima que floresce do lugar da rejeiÃ§Ã£o. Esse Ã© o poder real.",
                            discovery: "O momento de descobrir a verdade Ã© tanto destruiÃ§Ã£o quanto criaÃ§Ã£o. VocÃª experimentou ambos os processos.",
                            general: "Os fragmentos da verdade quebrada podem agora formar um novo mosaico. Em uma imagem mais bela."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                // Mark Portal 01 as complete and navigate to Portal 02
                localStorage.setItem('temarix_v4_portal01_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '02');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 02: ìžƒì–´ë²„ë¦° ëª©ì†Œë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 02: Lost Voice.' :
                    'Indo para Portal 02: Voz Perdida.';
                alert(nextMessage);
                
                // Here you would navigate to the next portal
                // window.location.href = 'temarix_v04_02.html?lang=' + currentLanguage;
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    'ê¹¨ì§„ ì§„ì‹¤ì˜ íŒŒíŽ¸ê³¼ ë” ë¨¸ë¬¼ë©° ê¹Šì´ ì„±ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with the fragments of broken truth for deeper reflection?' :
                    'Deseja ficar mais tempo com os fragmentos da verdade quebrada para reflexÃ£o mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v4_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v4-01",
                        resposta: inputText,
                        step: awaitingSecondResponse ? "second" : "first",
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v4_portal01_response', JSON.stringify({
                    portal: "v4-01",
                    resposta: inputText,
                    step: awaitingSecondResponse ? "second" : "first",
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            // Show second round of character responses (3 characters as per the story)
            const secondResponseCharacters = [
                {
                    name: "Sora", emoji: "ðŸ§•",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "ìŠ¤ìŠ¤ë¡œë¥¼ ì§€í‚¤ëŠ” ë²•ì€ ë•Œë¡œ ì™¸ë¡œì›€ì´ ë¼ìš”. ë„¤ê°€ ë§Œë“  ê·¸ ê±°ë¦¬ë§Œí¼, ë„ˆë„ ìƒì²˜ë°›ì•˜ê² ì§€.",
                            en: "Learning to protect yourself sometimes becomes loneliness. You must have been hurt as much as the distance you created.",
                            pt: "Aprender a se proteger Ã s vezes se torna solidÃ£o. VocÃª deve ter se machucado tanto quanto a distÃ¢ncia que criou."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "ì‹ ë¢°ëŠ” ë‹¤ì‹œ ë°°ìš¸ ìˆ˜ ìžˆì–´. ë„ˆëŠ” ì´ì œ ì§„ì‹¤ì„ ë§í•  ìˆ˜ ìžˆê²Œ ë˜ì—ˆìœ¼ë‹ˆê¹Œ.",
                            en: "Trust can be learned again. Because you've now become able to speak the truth.",
                            pt: "A confianÃ§a pode ser aprendida novamente. Porque agora vocÃª se tornou capaz de falar a verdade."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Kael", emoji: "ðŸ§™",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "ì´ì œëŠ” 'ì¡°ì‹¬'ì´ ì•„ë‹ˆë¼ 'ì„ íƒ'ì˜ ì‹œê°„ì´ì•¼. ì§„ì‹¤ì„ ì§ë©´í•œ ë„ˆëŠ”, ìŠ¤ìŠ¤ë¡œë¥¼ ë‹¤ì‹œ ë¹šì„ ìˆ˜ ìžˆì–´.",
                            en: "Now it's time for 'choice', not 'caution'. Having faced truth, you can reshape yourself.",
                            pt: "Agora Ã© hora de 'escolha', nÃ£o 'cautela'. Tendo enfrentado a verdade, vocÃª pode se remodelar."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 01 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 01 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>
            