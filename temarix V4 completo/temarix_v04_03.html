<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 03: Echoes in Silence</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 03: Echoes in Silence</div>
            <div class="portal-subtitle" id="portalSubtitle">The emotions heard in the space where everyone left</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 03 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 04</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these echoes</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What did you hear in that silence? What emotion echoed?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "Í∞êÏ†ï Ïó∞Í∏àÏà†",
                portalMainTitle: "Portal 03: Í≥†Ïöî ÏÜçÏùò Ïö∏Î¶º",
                portalSubtitle: "Î™®ÎëêÍ∞Ä Îñ†ÎÇú Í≥µÍ∞ÑÏóêÏÑú Îì§Î¶∞ Í∞êÏ†ïÎì§",
                portalIntro: "Î™®ÎëêÍ∞Ä Îñ†ÎÇú Í≥µÍ∞Ñ, ÏïÑÎ¨¥ ÎßêÎèÑ Îì§Î¶¨ÏßÄ ÏïäÎäî Í∑∏ ÏàúÍ∞Ñ.\nÎãπÏã†ÏùÄ Í≥†ÏöîÌï® ÏÜçÏóêÏÑú Ïñ¥Îñ§ Í∞êÏ†ïÏùÑ Îì§ÏóàÎÇòÏöî?\n\nÍ∑∏Îïå Îì§Î†§Ïò® 'Ïö∏Î¶º'Ïù¥ ÏûàÏóàÎã§Î©¥,\nÍ∑∏Í±¥ Ïñ¥Îñ§ Í∞êÏ†ïÏùò ÌååÏû•Ïù¥ÏóàÎÇòÏöî?",
                followUpQuestion: "Í∑∏ Í≥†Ïöî ÏÜçÏóêÏÑú Ïö∏ÏóàÎçò Í∞êÏ†ïÏùÄ ÏßÄÍ∏à Ïñ¥ÎîîÏóê ÏûàÎÇòÏöî?\nÎãπÏã†ÏùÄ Í∑∏ Í∞êÏ†ïÍ≥º... Îã§Ïãú ÎåÄÌôîÌï† Ïàò ÏûàÎÇòÏöî?",
                lightTitle: "ÎπõÏùò ÌïúÎßàÎîî",
                lightMessage: "Ïπ®Î¨µÏùÄ Í∞êÏ†ïÏù¥ Ïà® Ïâ¨Îäî Î∞©ÏãùÏù¥Í∏∞ÎèÑ Ìï¥Ïöî.\nÏßÄÍ∏à ÎãπÏã†ÏùÄ Í∑∏ Ïà®ÏùÑ Îã§Ïãú ÎäêÎÅºÍ≥† ÏûàÏñ¥Ïöî.\nÍ∑∏ Ïö∏Î¶ºÏùÄ ÎãπÏã†ÏùÑ Ïù¥Î£®Îäî ÏùºÎ∂ÄÍ∞Ä ÎêòÏóàÏñ¥Ïöî.",
                navigationTitle: "Portal 03 ÏôÑÎ£å",
                navigationMessage: "ÎãπÏã†ÏùÄ Í≥†Ïöî ÏÜçÏùò Ïö∏Î¶ºÍ≥º ÌôîÌï¥ÌñàÏäµÎãàÎã§.\n\nÍ∑∏ Ïπ®Î¨µ ÏïàÏóêÏÑú ÎãπÏã†ÏùÄ ÏßÑÏßú ÏûêÏã†Ïùò Î™©ÏÜåÎ¶¨Î•º Îì§ÏóàÏñ¥Ïöî. Ïô∏Î°úÏõÄÏù¥ ÏïÑÎãå, ÍπäÏùÄ Ïó∞Í≤∞Ïùò ÏÜåÎ¶¨Î•º.\n\nÏù¥Ï†ú Ïπ®Î¨µÏùÄ ÎëêÎ†§ÏõÄÏù¥ ÏïÑÎãå ÏπòÏú†Ïùò Í≥µÍ∞ÑÏù¥ ÎêòÏóàÏäµÎãàÎã§.",
                nextPortalBtn: "Portal 04Î°ú Ïù¥Ïñ¥Í∞ÄÍ∏∞",
                stayPortalBtn: "Ïù¥ Ïö∏Î¶ºÍ≥º Îçî Î®∏Î¨ºÍ∏∞",
                inputPlaceholder: "Í∑∏ Í≥†ÏöîÌï® ÏÜçÏóêÏÑú Î¨¥ÏóáÏùÑ Îì§ÏóàÎÇòÏöî? Ïñ¥Îñ§ Í∞êÏ†ïÏù¥ Ïö∏Î†∏ÎÇòÏöî?",
                youLabel: "ÎãπÏã†",
                waitingMessage: "ÏùëÎãµÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 03: Echoes in Silence",
                portalSubtitle: "The emotions heard in the space where everyone left",
                portalIntro: "The space where everyone left, that moment when no words could be heard.\nWhat emotions did you hear in that silence?\n\nIf there was an 'echo' that reached you then,\nwhat kind of emotional wavelength was it?",
                followUpQuestion: "Where are those emotions that cried in that silence now?\nCan you... have a conversation with those feelings again?",
                lightTitle: "Word of Light",
                lightMessage: "Silence is also a way for emotions to breathe.\nNow you are feeling that breath again.\nThat echo has become part of what makes you who you are.",
                navigationTitle: "Portal 03 Complete",
                navigationMessage: "You have made peace with the echoes in silence.\n\nIn that silence, you heard your true voice. Not the sound of loneliness, but of deep connection.\n\nNow silence has become a space of healing, not fear.",
                nextPortalBtn: "Continue to Portal 04",
                stayPortalBtn: "Stay with these echoes",
                inputPlaceholder: "What did you hear in that silence? What emotion echoed?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 03: Ecos no Sil√™ncio",
                portalSubtitle: "As emo√ß√µes ouvidas no espa√ßo onde todos partiram",
                portalIntro: "O espa√ßo onde todos partiram, aquele momento em que nenhuma palavra podia ser ouvida.\nQue emo√ß√µes voc√™ ouviu naquele sil√™ncio?\n\nSe houve um 'eco' que chegou at√© voc√™ ent√£o,\nque tipo de onda emocional era?",
                followUpQuestion: "Onde est√£o agora essas emo√ß√µes que choraram naquele sil√™ncio?\nVoc√™ pode... ter uma conversa com esses sentimentos novamente?",
                lightTitle: "Palavra de Luz",
                lightMessage: "O sil√™ncio tamb√©m √© uma forma das emo√ß√µes respirarem.\nAgora voc√™ est√° sentindo essa respira√ß√£o novamente.\nEsse eco se tornou parte do que faz voc√™ ser quem voc√™ √©.",
                navigationTitle: "Portal 03 Completo",
                navigationMessage: "Voc√™ fez as pazes com os ecos no sil√™ncio.\n\nNaquele sil√™ncio, voc√™ ouviu sua voz verdadeira. N√£o o som da solid√£o, mas de conex√£o profunda.\n\nAgora o sil√™ncio se tornou um espa√ßo de cura, n√£o de medo.",
                nextPortalBtn: "Continuar para Portal 04",
                stayPortalBtn: "Ficar com esses ecos",
                inputPlaceholder: "O que voc√™ ouviu naquele sil√™ncio? Que emo√ß√£o ecoou?",
                youLabel: "Voc√™",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "üßë‚Äçü¶±", text: {
                ko: "Í∑∏ Í≥†Ïöî ÏÜçÏóêÏÑúÎèÑ Ïö∏Í≥† ÏûàÏóàÍµ¨ÎÇò. ÏïÑÎ¨¥ÎèÑ ÏóÜÏùÑ Îïå, ÎπÑÎ°úÏÜå ÎÑ§ ÎßàÏùåÏù¥ Ïö∏Í∏∞ ÏãúÏûëÌñàÏßÄ.",
                en: "You were crying even in that silence. When no one was there, your heart finally began to cry.",
                pt: "Voc√™ estava chorando mesmo naquele sil√™ncio. Quando ningu√©m estava l√°, seu cora√ß√£o finalmente come√ßou a chorar."
            }},
            { name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è", text: {
                ko: "Í≥†ÏöîÌï®ÏùÄ ÎïåÎ°ú ÏúÑÎ°úÏ≤òÎüº Îã§Í∞ÄÏò§ÏßÄÎßå, Í∑∏ ÏÜçÏóî Ïô∏Î©¥ÎãπÌïú Í∞êÏ†ïÏù¥ Ïà®Ïñ¥ ÏûàÏñ¥.",
                en: "Silence sometimes comes like comfort, but hidden within it are emotions that have been ignored.",
                pt: "O sil√™ncio √†s vezes vem como conforto, mas escondidas dentro dele est√£o emo√ß√µes que foram ignoradas."
            }},
            { name: "Sora", emoji: "üßï", text: {
                ko: "Í∑∏ Ïö∏Î¶ºÏùÄ ÎÑ§ ÏßÑÏßú Î™©ÏÜåÎ¶¨ÏòÄÏñ¥. ÎπÑÎ°úÏÜå ÎÑà ÏûêÏã†ÏóêÍ≤å ÎãøÏïòÎçò Í±∞Ïïº.",
                en: "That echo was your real voice. It was finally reaching yourself.",
                pt: "Esse eco era sua voz real. Finalmente estava chegando a voc√™ mesmo."
            }},
            { name: "Kael", emoji: "üßô", text: {
                ko: "Í≥†ÏöîÌï® ÏÜç Ïö∏Î¶ºÏùÄ Í∞êÏ†ïÏùò ÏßÑÏã§ÏùÑ Ïà®Í∏∞ÏßÄ ÏïäÏïÑ. ÎÑàÎäî Í∑∏ ÏßÑÏã§Í≥º ÎßàÏ£ºÌï† Ïàò ÏûàÎäî ÌûòÏùÑ Í∞ÄÏ°åÏñ¥.",
                en: "The echo in silence doesn't hide the truth of emotions. You have the strength to face that truth.",
                pt: "O eco no sil√™ncio n√£o esconde a verdade das emo√ß√µes. Voc√™ tem a for√ßa para enfrentar essa verdade."
            }},
            { name: "Mira", emoji: "üßë‚Äçüé®", text: {
                ko: "ÏÇ¨ÎùºÏßÄÎäî ÎìØÌïú Í∑∏ Í∞êÍ∞ÅÏùÄ, ÏÇ¨Ïã§ ÎÑ§ Ï°¥Ïû¨Í∞Ä Îçî ÌÅ¨Í≤å Ïö∏Í≥† ÏûàÎäî Ïã†Ìò∏ÏòÄÏñ¥.",
                en: "That feeling of disappearing was actually a signal that your existence was crying out louder.",
                pt: "Essa sensa√ß√£o de desaparecimento era na verdade um sinal de que sua exist√™ncia estava gritando mais alto."
            }},
            { name: "Cris", emoji: "ü¶∏‚Äç‚ôÇÔ∏è", text: {
                ko: "ÏÇ¨ÎûåÎì§ÏùÄ Îñ†ÎÇòÎèÑ, ÎßàÏùåÏùò Ïö∏Î¶ºÏùÄ ÎÇ®ÏïÑÏÑú ÎÑ§ Í≥ÅÏùÑ ÏßÄÏºú. ÎÑå ÌòºÏûêÍ∞Ä ÏïÑÎãàÏïº.",
                en: "Even when people leave, the echoes of the heart remain to guard you. You're not alone.",
                pt: "Mesmo quando as pessoas partem, os ecos do cora√ß√£o permanecem para proteg√™-lo. Voc√™ n√£o est√° sozinho."
            }},
            { name: "Enya", emoji: "üßë‚ÄçüöÄ", text: {
                ko: "ÎÑàÏùò Ï°∞Ïö©Ìïú ÎààÎ¨ºÏùÄ, Ïñ∏Ï††Í∞Ä Îã§Ïãú ÌîºÏñ¥ÎÇ† Í∞êÏ†ïÏùò Ïî®ÏïóÏù¥ Îê† Í±∞Ïïº.",
                en: "Your quiet tears will become seeds of emotions that will bloom again someday.",
                pt: "Suas l√°grimas silenciosas se tornar√£o sementes de emo√ß√µes que florescer√£o novamente algum dia."
            }},
            { name: "Lian", emoji: "üßò", text: {
                ko: "Ïπ®Î¨µÏùÄ Í∞êÏ†ïÏù¥ Ïà® Ïâ¨Îäî Î∞©ÏãùÏù¥Í∏∞ÎèÑ Ìï¥. ÏßÄÍ∏à ÎÑàÎäî Í∑∏ Ïà®ÏùÑ Îã§Ïãú ÎäêÎÅºÍ≥† ÏûàÏñ¥.",
                en: "Silence is also a way for emotions to breathe. Now you are feeling that breath again.",
                pt: "O sil√™ncio tamb√©m √© uma forma das emo√ß√µes respirarem. Agora voc√™ est√° sentindo essa respira√ß√£o novamente."
            }}
        ];

        const responseCharacters = [
            {
                name: "Lian", emoji: "üßò",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "Í∞êÏ†ïÏóêÍ≤å ÎßêÏùÑ Í±∞Îäî Í±¥, Ïä§Ïä§Î°úÎ•º ÏïàÏïÑÏ£ºÎäî Ï≤´ Î≤àÏß∏ Ïñ∏Ïñ¥ÏòàÏöî. ÎãπÏã†ÏùÄ Ïù¥ÎØ∏ ÎåÄÌôî Ï§ëÏù¥ÏóêÏöî.",
                        en: "Speaking to emotions is the first language of embracing yourself. You are already in conversation.",
                        pt: "Falar com as emo√ß√µes √© a primeira linguagem de abra√ßar a si mesmo. Voc√™ j√° est√° conversando."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "Í∑∏ Î∞îÏúÑÎäî Ï°∞Í∏àÏî© ÏûëÏïÑÏßà Í±∞ÏòàÏöî. ÎãπÏã†Ïù¥ ÏûêÍ∏∞Î•º Î∞õÏïÑÎì§ÏùºÏàòÎ°ù, Í∞êÏ†ïÏùÄ ÎèåÏù¥ ÏïÑÎãå Î¨ºÏù¥ ÎèºÏöî.",
                        en: "That rock will gradually become smaller. The more you accept yourself, the more emotions become water, not stone.",
                        pt: "Essa pedra ficar√° gradualmente menor. Quanto mais voc√™ se aceita, mais as emo√ß√µes se tornam √°gua, n√£o pedra."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Mira", emoji: "üßë‚Äçüé®",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "Í∑∏ ÎßêÏùÑ ÎßàÏùå ÏïàÏóêÏÑú Í∫ºÎÉàÎã§Îäî Í±¥, ÎãπÏã†Ïù¥ ÏßÄÍ∏à, ÏÇ¥ÏïÑÏûàÎã§Îäî Ï¶ùÍ±∞ÏòàÏöî.",
                        en: "The fact that you brought those words out from your heart is proof that you are alive right now.",
                        pt: "O fato de voc√™ ter tirado essas palavras do seu cora√ß√£o √© prova de que voc√™ est√° vivo agora."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal03_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '04');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 04: Í±∞Ïö∏ ÏÜçÏùò ÏïÑÏù¥Î°ú Ïù¥ÎèôÌï©ÎãàÎã§.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 04: Child in the Mirror.' :
                    'Indo para Portal 04: Crian√ßa no Espelho.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    'Í≥†Ïöî ÏÜçÏùò Ïö∏Î¶ºÍ≥º Îçî Î®∏Î¨ºÎ©∞ ÍπäÏù¥ ÏÑ±Ï∞∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with the echoes in silence for deeper reflection?' :
                    'Deseja ficar mais tempo com os ecos no sil√™ncio para reflex√£o mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v4_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v4-03",
                        resposta: inputText,
                        step: awaitingSecondResponse ? "second" : "first",
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v4_portal03_response', JSON.stringify({
                    portal: "v4-03",
                    resposta: inputText,
                    step: awaitingSecondResponse ? "second" : "first",
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Sora", emoji: "üßï",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "Í∑∏ ÏÉÅÏûêÎ•º Ïó¥Ïñ¥Î≥¥Îäî Í±¥, ÏûêÏã†ÏóêÍ≤å ÏÉÅÏ≤òÎ•º ÌóàÎùΩÌïòÎäî ÏùºÏù¥Í∏∞ÎèÑ Ìï¥. Í∑∏ÎûòÏÑú Ïò§Îûò Í±∏Î¶¨Îäî Í±∞Ïïº.",
                            en: "Opening that box is also about allowing yourself to be hurt. That's why it takes so long.",
                            pt: "Abrir essa caixa tamb√©m √© sobre permitir-se ser ferido. √â por isso que demora tanto."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "Ï°∞Ïö©ÌñàÎçò Í∞êÏ†ïÏù¥ Ïù¥Ï†úÎäî Ïù¥Î¶ÑÏùÑ Í∞ÄÏ°åÏñ¥Ïöî. Í∑∏Í≤ÉÏù¥ ÌöåÎ≥µÏù¥Í≥†, Í∑∏Í≤ÉÏù¥ ÏÉàÎ°úÏö¥ ÏÉùÏùºÏù¥ÏóêÏöî.",
                            en: "The quiet emotion now has a name. That is recovery, and that is a new birthday.",
                            pt: "A emo√ß√£o silenciosa agora tem um nome. Isso √© recupera√ß√£o, e isso √© um novo anivers√°rio."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Lian", emoji: "üßò",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "ÏïÑÎ¨¥ÎèÑ Î™∞ÎûêÎçò Í∑∏ÎÇ†ÎèÑ Ïù¥Ï†úÎäî Í∏∞ÏñµÏùò ÏùºÎ∂ÄÍ∞Ä ÎêòÏóàÏñ¥Ïöî. ÎãπÏã†ÏùÄ Í∑∏ Í∏∞ÏñµÏùÑ Îî∞ÎúªÌïòÍ≤å Í∞êÏã∏Í≥† ÏûàÏñ¥Ïöî.",
                            en: "That day that no one knew about has now become part of your memory. You are warmly embracing that memory.",
                            pt: "Aquele dia que ningu√©m sabia agora se tornou parte da sua mem√≥ria. Voc√™ est√° abra√ßando calorosamente essa mem√≥ria."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 03 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 03 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>