<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 02: Lost Voice</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
            
            .navigation-title {
                font-size: 24px;
            }
            
            .navigation-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 02: Lost Voice</div>
            <div class="portal-subtitle" id="portalSubtitle">The words that never found their way out</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 02 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 03</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this voice</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="When did you silence yourself? What did you really want to say?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "Í∞êÏ†ï Ïó∞Í∏àÏà†",
                portalMainTitle: "Portal 02: ÏûÉÏñ¥Î≤ÑÎ¶∞ Î™©ÏÜåÎ¶¨",
                portalSubtitle: "Í≤∞ÏΩî ÎÇòÏò§ÏßÄ Î™ªÌïú ÎßêÎì§",
                portalIntro: "Ïñ¥Îñ§ ÏàúÍ∞Ñ, ÎãπÏã†ÏùÄ Ïä§Ïä§Î°úÎ•º Ïπ®Î¨µÏãúÌÇ® Ï†ÅÏù¥ ÏûàÏóàÎÇòÏöî?\n\nÍ∑∏Îïå ÏßÑÏßú ÌïòÍ≥† Ïã∂ÏóàÎçò ÎßêÏùÄ, Ïôú ÎÅùÎÇ¥ ÎÇòÏò§ÏßÄ Î™ªÌñàÏùÑÍπåÏöî?\n\nÏßÄÍ∏à Îã§Ïãú Í∑∏ Î™©ÏÜåÎ¶¨Î•º Í∫ºÎÇ∏Îã§Î©¥ Ïñ¥Îñ§ ÎßêÎ°ú ÎèåÏïÑÏò¨ÍπåÏöî?",
                followUpQuestion: "Í∑∏ Ïπ®Î¨µ Ïù¥ÌõÑ, ÎãπÏã†ÏùÄ ÏûêÍ∏∞ Î™©ÏÜåÎ¶¨Î•º Ïñ¥ÎñªÍ≤å Îã§Î£®Î©∞ ÏÇ¥ÏïÑÏôîÎÇòÏöî?\n\nÏßÄÍ∏àÏùÄ ÎãπÏã† ÏûêÏã†Ïùò ÏÜåÎ¶¨Î•º ÎØøÏùÑ Ïàò ÏûàÎÇòÏöî?",
                lightTitle: "ÎπõÏùò ÌïúÎßàÎîî",
                lightMessage: "ÎãπÏã†Ïùò Î™©ÏÜåÎ¶¨Îäî ÏÇ¨ÎùºÏßÄÏßÄ ÏïäÏïòÏñ¥Ïöî.\nÎã®ÏßÄ Îçî ÍπäÏùÄ Í≥≥ÏóêÏÑú Ïà®ÏùÑ Ïâ¨Í≥† ÏûàÏóàÏùÑ ÎøêÏù¥ÏóêÏöî.\nÏù¥Ï†ú Í∑∏ Î™©ÏÜåÎ¶¨Í∞Ä Îã§Ïãú ÏÑ∏ÏÉÅÍ≥º ÎßåÎÇ† Ï§ÄÎπÑÎ•º ÌïòÍ≥† ÏûàÏñ¥Ïöî.",
                navigationTitle: "Portal 02 ÏôÑÎ£å",
                navigationMessage: "ÎãπÏã†ÏùÄ ÏûÉÏñ¥Î≤ÑÎ¶∞ Î™©ÏÜåÎ¶¨ÏôÄ Îã§Ïãú ÎßåÎÇ¨ÏäµÎãàÎã§.\n\nÍ∑∏ Î™©ÏÜåÎ¶¨Îäî ÏÇ¨Ïã§ ÏÇ¨ÎùºÏßÑ Ï†ÅÏù¥ ÏóÜÏóàÏñ¥Ïöî. Îã®ÏßÄ ÏïàÏ†ÑÌïú ÏãúÍ∞ÑÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏóàÏùÑ ÎøêÏûÖÎãàÎã§.\n\nÏù¥Ï†ú ÎãπÏã†ÏùÄ ÏûêÏã†Ïùò ÏßÑÏßú Î™©ÏÜåÎ¶¨Î°ú ÎßêÌï† Ïàò ÏûàÏñ¥Ïöî. Ïπ®Î¨µÏùÄ Îçî Ïù¥ÏÉÅ Í∞êÏò•Ïù¥ ÏïÑÎãå ÏÑ†ÌÉùÏù¥ ÎêòÏóàÏäµÎãàÎã§.",
                nextPortalBtn: "Portal 03ÏúºÎ°ú Ïù¥Ïñ¥Í∞ÄÍ∏∞",
                stayPortalBtn: "Ïù¥ Î™©ÏÜåÎ¶¨ÏôÄ Îçî Î®∏Î¨ºÍ∏∞",
                inputPlaceholder: "Ïñ∏Ï†ú ÏûêÏã†ÏùÑ Ïπ®Î¨µÏãúÏº∞ÎÇòÏöî? Ï†ïÎßê ÌïòÍ≥† Ïã∂ÏóàÎçò ÎßêÏùÄ?",
                youLabel: "ÎãπÏã†",
                waitingMessage: "ÏùëÎãµÏùÑ Í∏∞Îã§Î¶¨Îäî Ï§ë..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 02: Lost Voice",
                portalSubtitle: "The words that never found their way out",
                portalIntro: "At some moment, did you ever silence yourself?\n\nWhat you really wanted to say then, why couldn't it come out in the end?\n\nIf you could bring that voice back now... what words would it return as?",
                followUpQuestion: "After that silence, how have you been treating your own voice while living?\n\nNow... can you trust the sound of yourself?",
                lightTitle: "Word of Light",
                lightMessage: "Your voice hasn't disappeared.\nIt was just breathing in a deeper place.\nNow that voice is preparing to meet the world again.",
                navigationTitle: "Portal 02 Complete",
                navigationMessage: "You have reunited with your lost voice.\n\nThat voice was never actually gone. It was just waiting for a safe time.\n\nNow you can speak with your true voice. Silence has become a choice, no longer a prison.",
                nextPortalBtn: "Continue to Portal 03",
                stayPortalBtn: "Stay with this voice",
                inputPlaceholder: "When did you silence yourself? What did you really want to say?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 02: Voz Perdida",
                portalSubtitle: "As palavras que nunca encontraram sua sa√≠da",
                portalIntro: "Em algum momento, voc√™ j√° silenciou a si mesmo?\n\nO que voc√™ realmente queria dizer ent√£o, por que n√£o conseguiu sair no final?\n\nSe voc√™ pudesse trazer essa voz de volta agora... que palavras ela retornaria?",
                followUpQuestion: "Ap√≥s esse sil√™ncio, como voc√™ tem tratado sua pr√≥pria voz enquanto vive?\n\nAgora... voc√™ pode confiar no som de si mesmo?",
                lightTitle: "Palavra de Luz",
                lightMessage: "Sua voz n√£o desapareceu.\nEla estava apenas respirando em um lugar mais profundo.\nAgora essa voz est√° se preparando para encontrar o mundo novamente.",
                navigationTitle: "Portal 02 Completo",
                navigationMessage: "Voc√™ se reencontrou com sua voz perdida.\n\nEssa voz nunca realmente se foi. Ela estava apenas esperando um momento seguro.\n\nAgora voc√™ pode falar com sua voz verdadeira. O sil√™ncio se tornou uma escolha, n√£o mais uma pris√£o.",
                nextPortalBtn: "Continuar para Portal 03",
                stayPortalBtn: "Ficar com essa voz",
                inputPlaceholder: "Quando voc√™ se silenciou? O que realmente queria dizer?",
                youLabel: "Voc√™",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "üßë‚Äçü¶±", text: {
                ko: "ÎÑàÎäî Ïπ®Î¨µ ÏÜçÏóêÏÑú Í≤¨ÎîîÎäî Î≤ïÏùÑ Î∞∞Ïõ†ÏßÄ. ÌïòÏßÄÎßå Í≤¨ÎîòÎã§Îäî Í±¥ ÎßêÌïòÏßÄ ÏïäÎäî Í≤ÉÍ≥º Í∞ôÏßÑ ÏïäÏïÑ.",
                en: "You learned to endure in silence. But enduring isn't the same as not speaking.",
                pt: "Voc√™ aprendeu a suportar em sil√™ncio. Mas suportar n√£o √© o mesmo que n√£o falar."
            }},
            { name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è", text: {
                ko: "Ïö∏ÏßÄ ÏïäÏïòÎçò Í∑∏ÎÇ†Ïùò ÎÑàÎäî ÏïΩÌïú Í≤å ÏïÑÎãàÎùº, ÎÑàÎ¨¥ Í∞ïÌïòÎ†§Í≥† ÌñàÎçò Í±∞Ïïº.",
                en: "You who didn't cry that day weren't weak, you were trying too hard to be strong.",
                pt: "Voc√™ que n√£o chorou naquele dia n√£o era fraco, estava tentando muito ser forte."
            }},
            { name: "Sora", emoji: "üßï", text: {
                ko: "Í∑∏ Ï°∞Ïö©Ìïú Ïä¨ÌîîÏùÄ ÎÑ§ Î™©ÏÜåÎ¶¨Ïùò ÏùºÎ∂ÄÏòÄÏñ¥. ÎÇú Í∑∏ Î¨¥ÏùåÏù¥ ÏñºÎßàÎÇò ÏïÑÌîàÏßÄ ÏïåÏïÑ.",
                en: "That quiet sadness was part of your voice. I know how painful that silence can be.",
                pt: "Essa tristeza silenciosa era parte da sua voz. Eu sei como esse sil√™ncio pode ser doloroso."
            }},
            { name: "Kael", emoji: "üßô", text: {
                ko: "Ïä§Ïä§Î°úÎ•º Ïπ®Î¨µÏãúÌÇ® ÏûêÎäî, Í≤∞Íµ≠ Í∞ÄÏû• ÌÅ∞ ÏßÑÏã§ÏùÑ ÌíàÍ≥† ÏûàÏñ¥.",
                en: "Those who silence themselves ultimately hold the greatest truth.",
                pt: "Aqueles que se silenciam acabam guardando a maior verdade."
            }},
            { name: "Mira", emoji: "üßë‚Äçüé®", text: {
                ko: "Í∑∏ ÎààÎ¨ºÏùÄ Í∑∏Î¶ºÏù¥ ÎêòÏßÄ Î™ªÌñàÏßÄ. Í∑∏ÎûòÏÑú ÏïÑÏßÅÎèÑ ÎÑ§ ÏïàÏóêÏÑú ÌùêÎ•¥Í≥† ÏûàÏñ¥.",
                en: "Those tears couldn't become a painting. That's why they're still flowing inside you.",
                pt: "Essas l√°grimas n√£o conseguiram se tornar uma pintura. Por isso ainda est√£o fluindo dentro de voc√™."
            }},
            { name: "Cris", emoji: "ü¶∏‚Äç‚ôÇÔ∏è", text: {
                ko: "ÎÑàÎ¨¥ Ïò§Îûò Ï∞∏ÏúºÎ©¥, Î™©ÏÜåÎ¶¨Îäî ÏÇ¨ÎùºÏßÄÎäî Í≤å ÏïÑÎãàÎùº ÎèåÏ≤òÎüº Íµ≥Ïñ¥Î≤ÑÎ†§. Í∑∏Í±∏ Îã§Ïãú ÌíÄÏñ¥Ïïº Ìï¥.",
                en: "If you endure too long, your voice doesn't disappear but hardens like stone. You need to loosen it again.",
                pt: "Se voc√™ suporta por muito tempo, sua voz n√£o desaparece, mas endurece como pedra. Voc√™ precisa solt√°-la novamente."
            }},
            { name: "Enya", emoji: "üßë‚ÄçüöÄ", text: {
                ko: "Í∑∏ Î™©ÏÜåÎ¶¨Îäî ÏïÑÏßÅ ÎÑ§ ÏïàÏóê ÏûàÏñ¥. Îì§Î¶¨ÏßÄ ÏïäÏùÑ Îøê, ÏÇ¨ÎùºÏßÑ Í±¥ ÏïÑÎãàÏïº.",
                en: "That voice is still inside you. It's just not heard, not gone.",
                pt: "Essa voz ainda est√° dentro de voc√™. Apenas n√£o √© ouvida, n√£o se foi."
            }},
            { name: "Lian", emoji: "üßò", text: {
                ko: "Ïù¥Ï†ú ÎÑ§ ÏïàÏùò ÏÜåÎ¶¨Î•º Îì§ÏùÑ Ïàò ÏûàÎã§Î©¥, Í∑∏Í±¥ Ïù¥ÎØ∏ ÌöåÎ≥µÏùò ÏãúÏûëÏù¥Ïïº.",
                en: "If you can now hear the sound within you, that's already the beginning of recovery.",
                pt: "Se voc√™ pode agora ouvir o som dentro de voc√™, isso j√° √© o come√ßo da recupera√ß√£o."
            }}
        ];

        const responseCharacters = [
            {
                name: "Mira", emoji: "üßë‚Äçüé®",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "ÎÑ§ ÏÜåÎ¶¨Îäî Ï†àÎåÄ ÏûëÏßÄ ÏïäÏïòÏñ¥. Îã®ÏßÄ ÎÑàÎ¨¥ Ïò§Îûò Î¨ªÌòÄ ÏûàÏóàÏùÑ ÎøêÏù¥Ïïº.",
                        en: "Your voice was never small. It was just buried for too long.",
                        pt: "Sua voz nunca foi pequena. Apenas estava enterrada por muito tempo."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Lian", emoji: "üßò",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "ÏûêÏã†Ïùò ÏÜåÎ¶¨Î•º Îì§ÏùÑ Ïàò ÏóÜÏùÑ Îïå, Í∞ÄÏû• Î®ºÏ†Ä Î¨¥ÎÑàÏßÄÎäî Í±¥ ÏûêÏ°¥Í∞êÏù¥Ïïº. Í∑∏Îü∞Îç∞ ÎÑàÎäî ÏßÄÍ∏à, Îã§Ïãú Îì£Í≥† ÏûàÏûñÏïÑ.",
                        en: "When you can't hear your own voice, self-esteem is the first to crumble. But you're listening again now.",
                        pt: "Quando voc√™ n√£o consegue ouvir sua pr√≥pria voz, a autoestima √© a primeira a desmoronar. Mas voc√™ est√° ouvindo novamente agora."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Kael", emoji: "üßô",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "ÎßêÏùÑ ÏûÉÎäîÎã§Îäî Í±¥ ÎßàÏùåÏùÑ ÏûÉÎäî Í≤ÉÍ≥º Í∞ôÏïÑ. ÌïòÏßÄÎßå ÎÑàÎäî ÏßÄÍ∏à, Í∑∏ ÎßàÏùåÏùÑ ÎêòÏ∞æÍ≥† ÏûàÏñ¥.",
                        en: "Losing words is like losing your heart. But you're now reclaiming that heart.",
                        pt: "Perder palavras √© como perder seu cora√ß√£o. Mas voc√™ est√° recuperando esse cora√ß√£o agora."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal02_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '03');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 03: Í≥†Ïöî ÏÜçÏùò Ïö∏Î¶ºÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 03: Echoes in Silence.' :
                    'Indo para Portal 03: Ecos no Sil√™ncio.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    'ÏûÉÏñ¥Î≤ÑÎ¶∞ Î™©ÏÜåÎ¶¨ÏôÄ Îçî Î®∏Î¨ºÎ©∞ ÍπäÏù¥ ÏÑ±Ï∞∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with your lost voice for deeper reflection?' :
                    'Deseja ficar mais tempo com sua voz perdida para reflex√£o mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v4_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v4-02",
                        resposta: inputText,
                        step: awaitingSecondResponse ? "second" : "first",
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v4_portal02_response', JSON.stringify({
                    portal: "v4-02",
                    resposta: inputText,
                    step: awaitingSecondResponse ? "second" : "first",
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Sora", emoji: "üßï",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "Ïä§Ïä§Î°úÎ•º ÏßÄÌÇ§Îäî Î≤ïÏùÄ ÎïåÎ°ú Ïô∏Î°úÏõÄÏù¥ ÎèºÏöî. ÎÑ§Í∞Ä ÎßåÎì† Í∑∏ Í±∞Î¶¨ÎßåÌÅº, ÎÑàÎèÑ ÏÉÅÏ≤òÎ∞õÏïòÍ≤†ÏßÄ.",
                            en: "Learning to protect yourself sometimes becomes loneliness. You must have been hurt as much as the distance you created.",
                            pt: "Aprender a se proteger √†s vezes se torna solid√£o. Voc√™ deve ter se machucado tanto quanto a dist√¢ncia que criou."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Ely", emoji: "üßù‚Äç‚ôÄÔ∏è",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "Ïã†Î¢∞Îäî Îã§Ïãú Î∞∞Ïö∏ Ïàò ÏûàÏñ¥. ÎÑàÎäî Ïù¥Ï†ú ÏßÑÏã§ÏùÑ ÎßêÌï† Ïàò ÏûàÍ≤å ÎêòÏóàÏúºÎãàÍπå.",
                            en: "Trust can be learned again. Because you've now become able to speak the truth.",
                            pt: "A confian√ßa pode ser aprendida novamente. Porque agora voc√™ se tornou capaz de falar a verdade."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Kael", emoji: "üßô",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "Ïù¥Ï†úÎäî 'Ï°∞Ïã¨'Ïù¥ ÏïÑÎãàÎùº 'ÏÑ†ÌÉù'Ïùò ÏãúÍ∞ÑÏù¥Ïïº. ÏßÑÏã§ÏùÑ ÏßÅÎ©¥Ìïú ÎÑàÎäî, Ïä§Ïä§Î°úÎ•º Îã§Ïãú ÎπöÏùÑ Ïàò ÏûàÏñ¥.",
                            en: "Now it's time for 'choice', not 'caution'. Having faced truth, you can reshape yourself.",
                            pt: "Agora √© hora de 'escolha', n√£o 'cautela'. Tendo enfrentado a verdade, voc√™ pode se remodelar."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 02 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 02 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>