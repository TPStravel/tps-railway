<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 22: The Day No One Knew</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 22: The Day No One Knew</div>
            <div class="portal-subtitle" id="portalSubtitle">Silent tears in solitude</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 22 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 23</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these memories</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Was there a day when you cried quietly and no one knew? What happened and why did it remain your secret?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        const translations = {
            ko: {
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 22: 아무도 모르는 날",
                portalSubtitle: "고독 속의 조용한 눈물",
                portalIntro: "당신의 인생에서,\n아무도 모르게 조용히 울었던 날이 있었나요?\n\n그 날, 당신은 어떤 이유로 감정을 숨겼고,\n그 울음은 어디로 흘러갔나요?",
                followUpQuestion: "지금 그 날의 당신에게\n한 문장을 선물한다면,\n어떤 말로 시작하고 싶나요?",
                lightTitle: "빛의 한마디",
                lightMessage: "그 문장은 그날의 너에게 도착했어요. 지금 당신이, 스스로를 껴안은 거예요.\n조용했던 감정이 이제는 이름을 가졌어요. 그것이 회복이고, 그것이 새로운 생일이에요.\n이제는 아무도 몰랐던 날이 아니라 당신이 기억한 날이 되었어요. 더 이상 잊힌 감정이 아니에요.",
                navigationTitle: "Portal 22 완료",
                navigationMessage: "당신은 조용했던 감정을 기억하고 자신을 축하할 수 있는 사람이 되었습니다.\n\n아무도 몰랐던 그날의 눈물을 인정하며, 혼자였던 순간에도 당신이 살아있었음을 확인했습니다.\n\n이제 당신은 더 이상 감정을 숨기지 않고, 자신의 마음을 소중히 여길 수 있는 힘을 얻었습니다.",
                nextPortalBtn: "Portal 23으로 이어가기",
                stayPortalBtn: "이 기억들과 더 머물기",
                inputPlaceholder: "아무도 모르게 조용히 울었던 날이 있었나요? 무슨 일이 있었고 왜 비밀로 남겨두었나요?",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 22: The Day No One Knew",
                portalSubtitle: "Silent tears in solitude",
                portalIntro: "In your life,\nwas there a day when you cried quietly and no one knew?\n\nThat day, for what reason did you hide your emotions,\nand where did those tears flow to?",
                followUpQuestion: "If you could give that version of yourself\none sentence as a gift,\nwhat words would you start with?",
                lightTitle: "Word of Light",
                lightMessage: "That sentence has reached the you from that day. Right now, you have embraced yourself.\nThose quiet emotions now have a name. That is recovery, and that is a new birthday.\nNow it's no longer a day no one knew about, but a day you remember. It's no longer a forgotten emotion.",
                navigationTitle: "Portal 22 Complete",
                navigationMessage: "You have become someone who can remember quiet emotions and celebrate yourself.\n\nBy acknowledging the tears from that day no one knew about, you confirmed that you were alive even in moments of solitude.\n\nNow you have gained the strength to no longer hide your emotions and to cherish your own heart.",
                nextPortalBtn: "Continue to Portal 23",
                stayPortalBtn: "Stay with these memories",
                inputPlaceholder: "Was there a day when you cried quietly and no one knew? What happened and why did it remain your secret?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 22: O Dia Que Ninguém Soube",
                portalSubtitle: "Lágrimas silenciosas na solidão",
                portalIntro: "Em sua vida,\nhouve um dia quando você chorou silenciosamente e ninguém soube?\n\nNesse dia, por que razão você escondeu suas emoções,\ne para onde essas lágrimas fluíram?",
                followUpQuestion: "Se você pudesse dar àquela versão de si mesmo\numa frase como presente,\ncom que palavras você começaria?",
                lightTitle: "Palavra de Luz",
                lightMessage: "Essa frase chegou ao você daquele dia. Agora você abraçou a si mesmo.\nEssas emoções silenciosas agora têm um nome. Isso é recuperação, e isso é um novo aniversário.\nAgora não é mais um dia que ninguém soube, mas um dia que você lembra. Não é mais uma emoção esquecida.",
                navigationTitle: "Portal 22 Completo",
                navigationMessage: "Você se tornou alguém que pode lembrar emoções silenciosas e celebrar a si mesmo.\n\nAo reconhecer as lágrimas daquele dia que ninguém soube, você confirmou que estava vivo mesmo em momentos de solidão.\n\nAgora você ganhou a força para não mais esconder suas emoções e para valorizar seu próprio coração.",
                nextPortalBtn: "Continuar para Portal 23",
                stayPortalBtn: "Ficar com essas memórias",
                inputPlaceholder: "Houve um dia quando você chorou silenciosamente e ninguém soube? O que aconteceu e por que permaneceu seu segredo?",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그날, 세상은 조용했지만 너의 마음은 가장 크게 울고 있었어. 나는 그 울림을 들었어.",
                en: "That day, the world was quiet but your heart was crying the loudest. I heard that echo.",
                pt: "Naquele dia, o mundo estava silencioso, mas seu coração estava chorando mais alto. Eu ouvi esse eco."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "조용한 울음은 가장 깊은 외침이에요. 아무도 몰랐다는 사실이 그 감정을 더 외롭게 만들었죠.",
                en: "Silent tears are the deepest cry. The fact that no one knew made that emotion even more lonely.",
                pt: "Lágrimas silenciosas são o grito mais profundo. O fato de ninguém saber tornou essa emoção ainda mais solitária."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "너는 축하받지 못한 게 아니라, 감정을 감췄던 거예요. 그날 너는 이미 충분히 소중했어요.",
                en: "You weren't uncelebrated, you hid your emotions. That day you were already precious enough.",
                pt: "Você não foi negligenciado, você escondeu suas emoções. Naquele dia você já era precioso o suficiente."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "사라진 날이 아니라, 기억 속에 감춰진 날이었지. 지금 너는 그날을 다시 불러내고 있어.",
                en: "It wasn't a day that disappeared, but a day hidden in memory. Now you're calling that day back.",
                pt: "Não foi um dia que desapareceu, mas um dia escondido na memória. Agora você está chamando aquele dia de volta."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그날의 조명은 꺼졌지만, 너의 마음 안엔 작은 불빛 하나가 남아 있었어. 지금 그 불빛이 다시 켜지고 있어.",
                en: "The lights from that day went out, but there was a small light left in your heart. Now that light is turning on again.",
                pt: "As luzes daquele dia se apagaram, mas havia uma pequena luz deixada em seu coração. Agora essa luz está se acendendo novamente."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "왜 그날 아무도 없었을까? 그건 네가 부족해서가 아니야. 세상이 잠시 등을 돌렸을 뿐이야.",
                en: "Why was no one there that day? It wasn't because you were lacking. The world just turned its back for a moment.",
                pt: "Por que não havia ninguém naquele dia? Não foi porque você estava em falta. O mundo apenas virou as costas por um momento."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "그 조용한 생일의 감정은, 지금 이 여정 속에서 드디어 말이 되었어. 네가 꺼냈기 때문에.",
                en: "The emotions from that quiet birthday have finally become words in this journey. Because you brought them out.",
                pt: "As emoções daquele aniversário silencioso finalmente se tornaram palavras nesta jornada. Porque você as trouxe para fora."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "아무도 몰랐던 그날도 이제는 기억의 일부가 되었어요. 당신은 그 기억을 따뜻하게 감싸고 있어요.",
                en: "That day no one knew about has now become part of memory. You are warmly embracing that memory.",
                pt: "Aquele dia que ninguém soube agora se tornou parte da memória. Você está abraçando calorosamente essa memória."
            }}
        ];

        const responseCharacters = [
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "그 문장은 그날의 너에게 도착했어요. 지금 당신이, 스스로를 껴안은 거예요.",
                        en: "That sentence has reached the you from that day. Right now, you have embraced yourself.",
                        pt: "Essa frase chegou ao você daquele dia. Agora você abraçou a si mesmo."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Ely", emoji: "🧝‍♀️",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "조용했던 감정이 이제는 이름을 가졌어요. 그것이 회복이고, 그것이 새로운 생일이에요.",
                        en: "Those quiet emotions now have a name. That is recovery, and that is a new birthday.",
                        pt: "Essas emoções silenciosas agora têm um nome. Isso é recuperação, e isso é um novo aniversário."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Enya", emoji: "🧑‍🚀",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "이제는 아무도 몰랐던 날이 아니라 당신이 기억한 날이 되었어요. 더 이상 잊힌 감정이 아니에요.",
                        en: "Now it's no longer a day no one knew about, but a day you remember. It's no longer a forgotten emotion.",
                        pt: "Agora não é mais um dia que ninguém soube, mas um dia que você lembra. Não é mais uma emoção esquecida."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal22_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '23');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 23: 용기가 없었던 순간으로 이동합니다.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 23: Moments Without Courage.' :
                    'Indo para Portal 23: Momentos Sem Coragem.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    '이 기억들과 더 머물며 깊이 성찰하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with these memories for deeper reflection?' :
                    'Deseja ficar mais tempo com essas memórias para reflexão mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            console.log('Processing user input:', inputText);
            localStorage.setItem('temarix_v4_portal22_response', JSON.stringify({
                portal: "v4-22",
                resposta: inputText,
                step: awaitingSecondResponse ? "second" : "first",
                data: new Date().toISOString(),
                idioma: currentLanguage
            }));
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Noah", emoji: "🧑‍🦱",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "그 말은 끝이 아니라 시작이에요. 이제 당신은 새로운 이야기를 쓸 수 있어요.",
                            en: "Those words aren't an ending but a beginning. Now you can write a new story.",
                            pt: "Essas palavras não são um fim, mas um começo. Agora você pode escrever uma nova história."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Kael", emoji: "🧙",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "조용했던 감정을 인정하는 건, 자신에게 돌아오는 첫 번째 걸음이에요.",
                            en: "Acknowledging quiet emotions is the first step of returning to yourself.",
                            pt: "Reconhecer emoções silenciosas é o primeiro passo para retornar a si mesmo."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Mira", emoji: "🧑‍🎨",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "당신이 써내려간 그 위로의 말이, 앞으로의 모든 순간을 밝힐 거예요.",
                            en: "Those comforting words you've written will illuminate all moments to come.",
                            pt: "Essas palavras consoladoras que você escreveu iluminarão todos os momentos por vir."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 22 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 22 DOM loaded');
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>