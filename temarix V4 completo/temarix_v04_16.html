<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 16: Hidden Wounds</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 16: Hidden Wounds</div>
            <div class="portal-subtitle" id="portalSubtitle">Wounds that no one noticed</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 16 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 17</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these wounds</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Do you have wounds that no one ever noticed? What happened and how has it affected you?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        const translations = {
            ko: {
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 16: 들키지 않은 상처",
                portalSubtitle: "아무도 눈치채지 못한 상처",
                portalIntro: "당신이 아무에게도 들키지 않았던 상처가 있다면,\n그건 어떤 순간에 생긴 것이었나요?\n\n그 상처를 감추었던 이유는 무엇이었고,\n지금까지 그것이 당신에게 어떤 영향을 주었나요?",
                followUpQuestion: "지금 그 상처에게 한마디 한다면,\n어떤 말을 해주고 싶나요?\n\n그리고, 그 감정을 스스로에게도\n인정할 수 있나요?",
                lightTitle: "빛의 한마디",
                lightMessage: "당신은 방금, 들키지 않았던 감정을 세상에 초대했어요.\n그건 치유의 초대장이에요.\n이제 그 상처는 혼자가 아니에요.",
                navigationTitle: "Portal 16 완료",
                navigationMessage: "당신은 들키지 않은 상처를 마주했습니다.\n\n그 상처를 말로 꺼내는 순간, 비로소 치유가 시작됩니다. 당신이 인정한 감정은 더 이상 외면받지 않아도 됩니다.\n\n이제 당신은 감춰진 상처를 꺼낸 채로 다음 여정을 걸을 수 있습니다.",
                nextPortalBtn: "Portal 17로 이어가기",
                stayPortalBtn: "이 상처와 더 머물기",
                inputPlaceholder: "아무도 눈치채지 못한 상처가 있나요? 무슨 일이 있었고 어떤 영향을 주었나요?",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 16: Hidden Wounds",
                portalSubtitle: "Wounds that no one noticed",
                portalIntro: "Do you have wounds that no one ever noticed?\n\nWhat kind of moment created those wounds,\nand why did you hide that pain?\n\nHow has it affected you until now?",
                followUpQuestion: "If you could say something\nto those wounds right now,\nwhat would you tell them?\n\nAnd can you acknowledge\nthose feelings to yourself?",
                lightTitle: "Word of Light",
                lightMessage: "You just invited your hidden emotions into the world.\nThat's an invitation to healing.\nThose wounds are no longer alone.",
                navigationTitle: "Portal 16 Complete",
                navigationMessage: "You have faced your hidden wounds.\n\nThe moment you speak those wounds into words, healing finally begins. The emotions you've acknowledged no longer need to be ignored.\n\nNow you can walk the next journey with your hidden wounds brought into the light.",
                nextPortalBtn: "Continue to Portal 17",
                stayPortalBtn: "Stay with these wounds",
                inputPlaceholder: "Do you have wounds that no one ever noticed? What happened and how has it affected you?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 16: Feridas Escondidas",
                portalSubtitle: "Feridas que ninguém notou",
                portalIntro: "Você tem feridas que ninguém jamais notou?\n\nQue tipo de momento criou essas feridas,\ne por que você escondeu essa dor?\n\nComo isso te afetou até agora?",
                followUpQuestion: "Se você pudesse dizer algo\npara essas feridas agora,\no que você diria a elas?\n\nE você pode reconhecer\nessas emoções para si mesmo?",
                lightTitle: "Palavra de Luz",
                lightMessage: "Você acabou de convidar suas emoções escondidas para o mundo.\nEsse é um convite para a cura.\nEssas feridas não estão mais sozinhas.",
                navigationTitle: "Portal 16 Completo",
                navigationMessage: "Você enfrentou suas feridas escondidas.\n\nNo momento em que você transforma essas feridas em palavras, a cura finalmente começa. As emoções que você reconheceu não precisam mais ser ignoradas.\n\nAgora você pode caminhar na próxima jornada com suas feridas escondidas trazidas à luz.",
                nextPortalBtn: "Continuar para Portal 17",
                stayPortalBtn: "Ficar com essas feridas",
                inputPlaceholder: "Você tem feridas que ninguém jamais notou? O que aconteceu e como isso te afetou?",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그 침묵 속에서 넌 혼자 울고 있었지. 들키지 않은 상처일수록 더 오래 남아.",
                en: "In that silence, you were crying alone. Hidden wounds last longer than visible ones.",
                pt: "Naquele silêncio, você estava chorando sozinho. Feridas escondidas duram mais que as visíveis."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "부끄러움이라는 감정은 때로 죄책감처럼 달라붙지. 하지만 너의 잘못은 아니었어.",
                en: "The emotion of shame sometimes clings like guilt. But it wasn't your fault.",
                pt: "A emoção da vergonha às vezes se agarra como culpa. Mas não foi sua culpa."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "그때 너는 혼자가 아니었어. 단지, 아무도 네 마음을 보려 하지 않았을 뿐이야.",
                en: "You weren't alone then. It's just that no one tried to see your heart.",
                pt: "Você não estava sozinho então. É só que ninguém tentou ver seu coração."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "말하지 않았다는 건, 너의 감정이 틀렸다는 뜻이 아니야. 오히려 너는 참는 걸 배운 아이였어.",
                en: "Not speaking doesn't mean your emotions were wrong. Rather, you were a child who learned to endure.",
                pt: "Não falar não significa que suas emoções estavam erradas. Na verdade, você era uma criança que aprendeu a suportar."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 날의 네 눈빛을 그릴 수 있다면, 아마 지금도 마음 한 켠이 아플 거야.",
                en: "If I could paint the look in your eyes that day, it would probably still hurt somewhere in my heart.",
                pt: "Se eu pudesse pintar o olhar em seus olhos naquele dia, provavelmente ainda doeria em algum lugar do meu coração."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "어른이라는 이유로, 상처를 줘도 되는 사람은 없어. 너는 부당한 침묵에 갇혀 있었던 거야.",
                en: "Being an adult doesn't give anyone the right to hurt you. You were trapped in unjust silence.",
                pt: "Ser adulto não dá a ninguém o direito de te machucar. Você estava preso em silêncio injusto."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "그 상처는 아직도 네가 말을 꺼내지 못하는 곳에 있어. 하지만 오늘, 네가 그걸 꺼냈어. 그건 큰 용기야.",
                en: "That wound is still in the place where you can't speak. But today, you brought it out. That's great courage.",
                pt: "Essa ferida ainda está no lugar onde você não consegue falar. Mas hoje, você a trouxe para fora. Isso é grande coragem."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "들키지 않은 상처는 말해지는 순간, 비로소 치유를 시작해요. 당신은 그 문을 연 거예요.",
                en: "Hidden wounds begin to heal the moment they are spoken. You have opened that door.",
                pt: "Feridas escondidas começam a curar no momento em que são faladas. Você abriu essa porta."
            }}
        ];

        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "이제 그 상처는 혼자가 아니에요. 당신이 인정했기 때문에, 그 감정은 외면받지 않아도 돼요.",
                        en: "Now those wounds are not alone. Because you acknowledged them, those emotions don't have to be ignored.",
                        pt: "Agora essas feridas não estão sozinhas. Porque você as reconheceu, essas emoções não precisam ser ignoradas."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "스스로의 감정을 정당화하는 건, 단순한 용기를 넘어선 회복의 시작이에요.",
                        en: "Validating your own emotions is the beginning of recovery that goes beyond simple courage.",
                        pt: "Validar suas próprias emoções é o início da recuperação que vai além da simples coragem."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "당신은 방금, 들키지 않았던 감정을 세상에 초대했어요. 그건 치유의 초대장이에요.",
                        en: "You just invited your hidden emotions into the world. That's an invitation to healing.",
                        pt: "Você acabou de convidar suas emoções escondidas para o mundo. Esse é um convite para a cura."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal16_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '17');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 17: 다시 걷는 장면 속으로로 이동합니다.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 17: Walking Back Into The Scene.' :
                    'Indo para Portal 17: Caminhando de Volta Para a Cena.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    '들키지 않은 상처와 더 머물며 깊이 성찰하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with your hidden wounds for deeper reflection?' :
                    'Deseja ficar mais tempo com suas feridas escondidas para reflexão mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            console.log('Processing user input:', inputText);
            localStorage.setItem('temarix_v4_portal16_response', JSON.stringify({
                portal: "v4-16",
                resposta: inputText,
                step: awaitingSecondResponse ? "second" : "first",
                data: new Date().toISOString(),
                idioma: currentLanguage
            }));
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Noah", emoji: "🧑‍🦱",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "그 말을 스스로에게 해준다는 건, 당신이 자신을 용서하기 시작했다는 뜻이에요.",
                            en: "Saying those words to yourself means you've started to forgive yourself.",
                            pt: "Dizer essas palavras para si mesmo significa que você começou a se perdoar."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Ely", emoji: "🧝‍♀️",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "감춰진 상처를 인정하는 건 자신에게 주는 가장 큰 선물이에요. 당신은 그걸 해냈어요.",
                            en: "Acknowledging hidden wounds is the greatest gift you can give yourself. You've done that.",
                            pt: "Reconhecer feridas escondidas é o maior presente que você pode dar a si mesmo. Você fez isso."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Mira", emoji: "🧑‍🎨",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "그 상처들이 이제는 그림의 일부가 될 수 있어요. 아픔도 당신 이야기의 중요한 색깔이에요.",
                            en: "Those wounds can now become part of the painting. Pain is also an important color in your story.",
                            pt: "Essas feridas agora podem se tornar parte da pintura. A dor também é uma cor importante em sua história."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 16 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 16 DOM loaded');
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>