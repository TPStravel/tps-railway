<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 18: The Moment I Failed To Protect Myself</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 18: The Moment I Failed To Protect Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">When I couldn't guard my heart</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 18 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 19</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with this moment</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Was there a moment when you felt you failed to protect yourself? What happened and how has it affected you?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        const translations = {
            ko: {
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 18: 나를 지키지 못했던 순간",
                portalSubtitle: "내 마음을 지켜주지 못했을 때",
                portalIntro: "당신이 스스로를 지키지 못했다고 느꼈던 순간이 있었나요?\n\n그때 당신은 어떤 선택을 했고,\n그 선택은 지금의 당신에게 어떤 흔적을 남겼나요?",
                followUpQuestion: "그때의 당신에게 지금 돌아간다면,\n어떤 말을 해주고 싶나요?\n\n그리고, 지금의 당신은\n더 이상 자신을 지우지 않기 위해\n어떤 다짐을 할 수 있을까요?",
                lightTitle: "빛의 한마디",
                lightMessage: "나를 지키지 못했던 그 순간과 화해한 당신.\n과거를 마주한 용기는 현재의 당신을 더 단단하게 만들어요.\n당신은 지금, 새로운 선택을 준비하고 있어요.",
                navigationTitle: "Portal 18 완료",
                navigationMessage: "당신은 자신을 지키지 못했다고 느꼈던 순간을 마주했습니다.\n\n그 순간이 당신의 잘못이 아니었음을, 그리고 그때의 선택이 생존을 위한 본능이었음을 인정했습니다.\n\n이제 당신은 자신을 보호하는 새로운 방법을 배우며, 더 이상 자신을 지우지 않기로 다짐할 수 있습니다.",
                nextPortalBtn: "Portal 19로 이어가기",
                stayPortalBtn: "이 순간과 더 머물기",
                inputPlaceholder: "스스로를 지키지 못했다고 느꼈던 순간이 있었나요? 무슨 일이 있었고 어떤 영향을 주었나요?",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 18: The Moment I Failed To Protect Myself",
                portalSubtitle: "When I couldn't guard my heart",
                portalIntro: "Was there a moment when you felt\nyou failed to protect yourself?\n\nWhat choice did you make then,\nand what traces has that choice\nleft on who you are today?",
                followUpQuestion: "If you could go back to yourself in that moment,\nwhat would you want to say?\n\nAnd what commitment can you make now\nto never erase yourself again?",
                lightTitle: "Word of Light",
                lightMessage: "You who have reconciled with that moment when you failed to protect yourself.\nThe courage to face the past makes your present self stronger.\nYou are now preparing to make new choices.",
                navigationTitle: "Portal 18 Complete",
                navigationMessage: "You have faced the moment when you felt you failed to protect yourself.\n\nYou acknowledged that it wasn't your fault, and that your choice then was an instinct for survival.\n\nNow you can learn new ways to protect yourself and commit to never erasing yourself again.",
                nextPortalBtn: "Continue to Portal 19",
                stayPortalBtn: "Stay with this moment",
                inputPlaceholder: "Was there a moment when you felt you failed to protect yourself? What happened and how has it affected you?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 18: O Momento Em Que Falhei Em Me Proteger",
                portalSubtitle: "Quando não consegui guardar meu coração",
                portalIntro: "Houve um momento em que você sentiu\nque falhou em se proteger?\n\nQue escolha você fez então,\ne que marcas essa escolha\ndeixou em quem você é hoje?",
                followUpQuestion: "Se você pudesse voltar para si mesmo naquele momento,\no que gostaria de dizer?\n\nE que compromisso você pode fazer agora\npara nunca mais se apagar?",
                lightTitle: "Palavra de Luz",
                lightMessage: "Você que se reconciliou com aquele momento em que falhou em se proteger.\nA coragem de enfrentar o passado torna seu eu presente mais forte.\nVocê está agora se preparando para fazer novas escolhas.",
                navigationTitle: "Portal 18 Completo",
                navigationMessage: "Você enfrentou o momento em que sentiu que falhou em se proteger.\n\nVocê reconheceu que não foi sua culpa, e que sua escolha então foi um instinto de sobrevivência.\n\nAgora você pode aprender novas maneiras de se proteger e se comprometer a nunca mais se apagar.",
                nextPortalBtn: "Continuar para Portal 19",
                stayPortalBtn: "Ficar com este momento",
                inputPlaceholder: "Houve um momento em que você sentiu que falhou em se proteger? O que aconteceu e como isso te afetou?",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그 순간 넌 혼자였지. 누가 널 대신 지켜줬어야 했는데, 아무도 없었어.",
                en: "You were alone in that moment. Someone should have protected you instead, but no one was there.",
                pt: "Você estava sozinho naquele momento. Alguém deveria ter te protegido, mas não havia ninguém."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "자신을 지키지 못한 게 아니라, 그 상황이 너무 위협적이었던 거야. 네 잘못이 아니야.",
                en: "You didn't fail to protect yourself, the situation was too threatening. It wasn't your fault.",
                pt: "Você não falhou em se proteger, a situação era muito ameaçadora. Não foi sua culpa."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "그날의 너는 충분히 두려웠어. 말하지 않은 게 아니라, 말할 수 없었던 거야.",
                en: "You were frightened enough that day. You didn't choose not to speak, you couldn't speak.",
                pt: "Você estava assustado o suficiente naquele dia. Você não escolheu não falar, você não conseguia falar."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "자기 방어를 배우기 전에 상처받은 사람은, 늘 죄책감을 먼저 배워. 그건 네가 잘못한 게 아니야.",
                en: "Those who get hurt before learning self-defense always learn guilt first. That's not something you did wrong.",
                pt: "Aqueles que se machucam antes de aprender autodefesa sempre aprendem a culpa primeiro. Isso não é algo que você fez de errado."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그때 넌 미소라는 방패를 들고 있었어. 울지 않으려, 무너지지 않으려… 그건 마지막 힘이었지.",
                en: "You were holding a shield of smiles then. Trying not to cry, not to break down... that was your last strength.",
                pt: "Você estava segurando um escudo de sorrisos então. Tentando não chorar, não desmoronar... essa era sua última força."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "그걸 강요한 사람은 책임을 지지 않았지. 대신 너만 스스로를 책망했어. 이젠 바뀌어야 해.",
                en: "The person who forced that didn't take responsibility. Instead, only you blamed yourself. That needs to change now.",
                pt: "A pessoa que forçou isso não assumiu responsabilidade. Em vez disso, apenas você se culpou. Isso precisa mudar agora."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "그 선택은 네가 살아남기 위해 만든 본능이었어. 그건 결코 약함이 아니야.",
                en: "That choice was an instinct you created to survive. That was never weakness.",
                pt: "Essa escolha foi um instinto que você criou para sobreviver. Isso nunca foi fraqueza."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "지금 너는 그때의 너를 바라보며 보호하고 싶다는 마음을 품고 있어. 그것이 치유의 첫걸음이야.",
                en: "Now you're looking at that version of yourself with a desire to protect. That's the first step of healing.",
                pt: "Agora você está olhando para aquela versão de si mesmo com o desejo de proteger. Esse é o primeiro passo da cura."
            }}
        ];

        const responseCharacters = [
            {
                name: "Ely", emoji: "🧝‍♀️",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "진심은 무기가 아니야. 오히려 가장 부드러운 방패야. 너를 지키는 방식이 달라진 거야.",
                        en: "Sincerity isn't a weapon. It's actually the softest shield. Your way of protecting yourself has changed.",
                        pt: "A sinceridade não é uma arma. É na verdade o escudo mais suave. Sua maneira de se proteger mudou."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "너는 이제, 자신을 지키는 방법을 배우고 있어. 늦지 않았어.",
                        en: "You are now learning how to protect yourself. It's not too late.",
                        pt: "Você está agora aprendendo como se proteger. Não é tarde demais."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "과거를 마주한 용기는 현재의 너를 더 단단하게 만들어. 너는 지금, 새로운 선택을 준비하고 있어.",
                        en: "The courage to face the past makes your present self stronger. You are now preparing to make new choices.",
                        pt: "A coragem de enfrentar o passado torna seu eu presente mais forte. Você está agora se preparando para fazer novas escolhas."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal18_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '19');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 19: 소리 없이 흐른 감정으로 이동합니다.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 19: Emotions That Flowed Silently.' :
                    'Indo para Portal 19: Emoções Que Fluíram Silenciosamente.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    '이 순간과 더 머물며 깊이 성찰하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with this moment for deeper reflection?' :
                    'Deseja ficar mais tempo com este momento para reflexão mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            console.log('Processing user input:', inputText);
            localStorage.setItem('temarix_v4_portal18_response', JSON.stringify({
                portal: "v4-18",
                resposta: inputText,
                step: awaitingSecondResponse ? "second" : "first",
                data: new Date().toISOString(),
                idioma: currentLanguage
            }));
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Noah", emoji: "🧑‍🦱",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "그 말을 스스로에게 해준다는 건, 당신이 자신을 용서하기 시작했다는 뜻이에요.",
                            en: "Saying those words to yourself means you've started to forgive yourself.",
                            pt: "Dizer essas palavras para si mesmo significa que você começou a se perdoar."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Cris", emoji: "🦸‍♂️",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "이제는 당신이 자신의 수호자가 되어주세요. 그 다짐이 진짜 힘이에요.",
                            en: "Now you become your own guardian. That commitment is real strength.",
                            pt: "Agora você se torna seu próprio guardião. Esse compromisso é força real."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Enya", emoji: "🧑‍🚀",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "당신은 지금, 과거의 상처를 미래의 보호막으로 바꾸고 있어요.",
                            en: "You are now transforming past wounds into future protection.",
                            pt: "Você está agora transformando feridas passadas em proteção futura."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 18 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 18 DOM loaded');
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>
                