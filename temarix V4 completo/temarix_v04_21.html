<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V4 - Portal 21: The Me Who Pretended Not To Be Me</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ff9999;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ff6b6b;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ff6b6b;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .follow-up-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .follow-up-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #ff6b6b;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ff6b6b;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }
        
        .navigation-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .navigation-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .nav-btn:hover {
            background: #666;
            border-color: #ff6b6b;
        }
        
        .nav-btn.primary {
            background: #ff6b6b;
            color: #fff;
            font-weight: bold;
        }
        
        .nav-btn.primary:hover {
            background: #ff8888;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ff6b6b;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ff6b6b;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .follow-up-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .navigation-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V4</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Alchemy</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 21: The Me Who Pretended Not To Be Me</div>
            <div class="portal-subtitle" id="portalSubtitle">Hiding behind masks</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="follow-up-section" id="followUpSection">
                <div class="follow-up-question" id="followUpQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>
            
            <div class="navigation-section" id="navigationSection">
                <div class="navigation-title" id="navigationTitle">Portal 21 Complete</div>
                <div class="navigation-message" id="navigationMessage"></div>
                <div class="navigation-buttons">
                    <button class="nav-btn primary" id="nextPortalBtn">Continue to Portal 22</button>
                    <button class="nav-btn" id="stayPortalBtn">Stay with these reflections</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="When did you have to hide yourself? What 'pretending' did you choose and for whom?"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        const translations = {
            ko: {
                logoSubtitle: "감정 연금술",
                portalMainTitle: "Portal 21: 내가 아닌 척했던 나",
                portalSubtitle: "가면 뒤에 숨은 모습",
                portalIntro: "당신은 언제, 스스로를 숨기며 살아야 했던 적이 있었나요?\n\n그 '척함'은 누구를 위해 선택한 것이었고,\n그동안 당신 안에 어떤 감정의 틈을 남겼나요?",
                followUpQuestion: "그 가면을 쓰고 살았던 당신에게\n지금 어떤 말을 해주고 싶나요?\n\n그리고 이제는,\n진짜 나를 어떻게 다시 꺼내고 싶으신가요?",
                lightTitle: "빛의 한마디",
                lightMessage: "당신은 드디어 자신에게 돌아올 수 있는 허락을 내렸어요. 그것이 가장 진실한 회복이에요.\n감정을 숨기지 않겠다는 그 다짐은 다시 태어나는 선언이에요. 당신은 새로 시작하고 있어요.\n이제는 네가 아닌 척하지 않아도 돼. 진짜 너는, 이 여정 속에서 살아 있어.",
                navigationTitle: "Portal 21 완료",
                navigationMessage: "당신은 '내가 아닌 척했던 나'를 놓고 진짜 자신으로서 걸을 준비가 되었습니다.\n\n가면 뒤에 숨어 있던 진정한 감정을 마주하며, 자신을 위한 선택을 할 수 있는 용기를 발견했습니다.\n\n이제 당신은 더 이상 다른 사람의 기대에 맞춰 살지 않고, 진정한 자신으로 다음 여정을 걸을 수 있습니다.",
                nextPortalBtn: "Portal 22로 이어가기",
                stayPortalBtn: "이 성찰과 더 머물기",
                inputPlaceholder: "언제 자신을 숨겨야 했나요? 어떤 '척함'을 선택했고, 누구를 위해서였나요?",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Alchemy",
                portalMainTitle: "Portal 21: The Me Who Pretended Not To Be Me",
                portalSubtitle: "Hiding behind masks",
                portalIntro: "When did you have to hide yourself and live a life that wasn't truly yours?\n\nWho was that 'pretending' chosen for,\nand what emotional gaps did it leave within you during that time?",
                followUpQuestion: "What would you like to say\nto the version of yourself who lived behind that mask?\n\nAnd now,\nhow do you want to bring your real self back out?",
                lightTitle: "Word of Light",
                lightMessage: "You have finally given yourself permission to return to who you truly are. That is the most authentic recovery.\nThat commitment to no longer hide your emotions is a declaration of rebirth. You are starting anew.\nNow you don't have to pretend to be someone you're not. The real you is alive in this journey.",
                navigationTitle: "Portal 21 Complete",
                navigationMessage: "You are ready to let go of 'the me who pretended not to be me' and walk as your true self.\n\nBy facing the genuine emotions that were hidden behind the mask, you discovered the courage to make choices for yourself.\n\nNow you can walk the next journey as your authentic self, no longer living to meet others' expectations.",
                nextPortalBtn: "Continue to Portal 22",
                stayPortalBtn: "Stay with these reflections",
                inputPlaceholder: "When did you have to hide yourself? What 'pretending' did you choose and for whom?",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Alquimia Emocional",
                portalMainTitle: "Portal 21: O Eu Que Fingiu Não Ser Eu",
                portalSubtitle: "Se escondendo atrás de máscaras",
                portalIntro: "Quando você teve que se esconder e viver uma vida que não era verdadeiramente sua?\n\nPara quem essa 'fingimento' foi escolhido,\ne que lacunas emocionais isso deixou dentro de você durante esse tempo?",
                followUpQuestion: "O que você gostaria de dizer\npara a versão de si mesmo que vivia atrás dessa máscara?\n\nE agora,\ncomo você quer trazer seu verdadeiro eu de volta?",
                lightTitle: "Palavra de Luz",
                lightMessage: "Você finalmente se deu permissão para retornar a quem você realmente é. Essa é a recuperação mais autêntica.\nEsse compromisso de não mais esconder suas emoções é uma declaração de renascimento. Você está começando de novo.\nAgora você não precisa fingir ser alguém que não é. O verdadeiro você está vivo nesta jornada.",
                navigationTitle: "Portal 21 Completo",
                navigationMessage: "Você está pronto para deixar ir 'o eu que fingiu não ser eu' e caminhar como seu verdadeiro eu.\n\nAo enfrentar as emoções genuínas que estavam escondidas atrás da máscara, você descobriu a coragem de fazer escolhas para si mesmo.\n\nAgora você pode caminhar a próxima jornada como seu eu autêntico, não mais vivendo para atender às expectativas dos outros.",
                nextPortalBtn: "Continuar para Portal 22",
                stayPortalBtn: "Ficar com essas reflexões",
                inputPlaceholder: "Quando você teve que se esconder? Que 'fingimento' você escolheu e para quem?",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그렇게 네가 아닌 척하며 살아온 날들 속에서, 너는 얼마나 스스로를 지우고 있었을까.",
                en: "In all those days of pretending to be someone you're not, how much of yourself were you erasing?",
                pt: "Em todos aqueles dias fingindo ser alguém que você não é, quanto de si mesmo você estava apagando?"
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "세상이 요구한 모습에 맞춰 살아왔다는 건 네가 그만큼 사랑받고 싶었다는 증거야. 그건 부끄러운 게 아니야.",
                en: "Living to match what the world demanded is proof of how much you wanted to be loved. That's nothing to be ashamed of.",
                pt: "Viver para corresponder ao que o mundo exigia é prova de quanto você queria ser amado. Não há nada de que se envergonhar nisso."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "사람들이 보던 네 웃음 속엔 말하지 못한 눈물이 숨어 있었겠지. 난 그 눈물의 무게를 알아요.",
                en: "Behind the smile that people saw, there were unspoken tears hiding. I know the weight of those tears.",
                pt: "Por trás do sorriso que as pessoas viam, havia lágrimas não ditas se escondendo. Eu conheço o peso dessas lágrimas."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "'척한다'는 건 살아남기 위한 방식이기도 해. 하지만 오래되면, 자기 자신에게조차 길을 잃게 되지.",
                en: "'Pretending' is also a way to survive. But when it goes on too long, you lose your way even to yourself.",
                pt: "'Fingir' também é uma forma de sobreviver. Mas quando dura muito tempo, você perde o caminho até para si mesmo."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 가면은 화려했지만, 뒤에는 아무도 몰랐던 감정의 색들이 있었겠지.",
                en: "That mask was glamorous, but behind it were emotional colors that no one knew about.",
                pt: "Essa máscara era glamorosa, mas por trás dela havia cores emocionais que ninguém conhecia."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "그렇게 살아야 했다는 게 나에겐 더 분해. 네 진짜 얼굴이 사라진 건 아니잖아.",
                en: "That you had to live that way makes me angrier. Your real face hasn't disappeared, you know.",
                pt: "Que você teve que viver assim me deixa mais irritado. Seu rosto verdadeiro não desapareceu, sabe."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "너는 지금, 그 가면을 벗기 위해 이 여정에 들어선 거야. 그 자체가 이미 큰 걸음이야.",
                en: "You've entered this journey to remove that mask. That itself is already a big step.",
                pt: "Você entrou nesta jornada para remover essa máscara. Isso por si só já é um grande passo."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "그 '척한 나'를 놓아주는 일은 진짜 자신을 초대하는 일이에요. 당신은 그 문을 열고 있어요.",
                en: "Letting go of that 'pretending self' is inviting your true self. You are opening that door.",
                pt: "Deixar ir esse 'eu fingido' é convidar seu verdadeiro eu. Você está abrindo essa porta."
            }}
        ];

        const responseCharacters = [
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "당신은 드디어 자신에게 돌아올 수 있는 허락을 내렸어요. 그것이 가장 진실한 회복이에요.",
                        en: "You have finally given yourself permission to return to who you truly are. That is the most authentic recovery.",
                        pt: "Você finalmente se deu permissão para retornar a quem você realmente é. Essa é a recuperação mais autêntica."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Ely", emoji: "🧝‍♀️",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "감정을 숨기지 않겠다는 그 다짐은 다시 태어나는 선언이에요. 당신은 새로 시작하고 있어요.",
                        en: "That commitment to no longer hide your emotions is a declaration of rebirth. You are starting anew.",
                        pt: "Esse compromisso de não mais esconder suas emoções é uma declaração de renascimento. Você está começando de novo."
                    };
                    return responses[lang];
                }
            },
            {
                name: "Enya", emoji: "🧑‍🚀",
                getResponse: (userInput, lang) => {
                    const responses = {
                        ko: "이제는 네가 아닌 척하지 않아도 돼. 진짜 너는, 이 여정 속에서 살아 있어.",
                        en: "Now you don't have to pretend to be someone you're not. The real you is alive in this journey.",
                        pt: "Agora você não precisa fingir ser alguém que não é. O verdadeiro você está vivo nesta jornada."
                    };
                    return responses[lang];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        let awaitingSecondResponse = false;
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('navigationTitle').textContent = translations[lang].navigationTitle;
            document.getElementById('nextPortalBtn').textContent = translations[lang].nextPortalBtn;
            document.getElementById('stayPortalBtn').textContent = translations[lang].stayPortalBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'followUpSection', 'userInputSection',
                'userReactionsSection', 'lightMessageSection', 'navigationSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('followUpQuestion').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('navigationMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
            awaitingSecondResponse = false;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('nextPortalBtn').addEventListener('click', function() {
                localStorage.setItem('temarix_v4_portal21_complete', 'true');
                localStorage.setItem('temarix_v4_current_portal', '22');
                
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 22: 아무도 모르는 날로 이동합니다.' :
                    currentLanguage === 'en' ? 
                    'Moving to Portal 22: The Day No One Knew.' :
                    'Indo para Portal 22: O Dia Que Ninguém Soube.';
                alert(nextMessage);
            });
            
            document.getElementById('stayPortalBtn').addEventListener('click', function() {
                const stayMessage = currentLanguage === 'ko' ? 
                    '이 성찰과 더 머물며 깊이 탐구하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to stay longer with these reflections for deeper exploration?' :
                    'Deseja ficar mais tempo com essas reflexões para exploração mais profunda?';
                
                if (confirm(stayMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            console.log('Processing user input:', inputText);
            localStorage.setItem('temarix_v4_portal21_response', JSON.stringify({
                portal: "v4-21",
                resposta: inputText,
                step: awaitingSecondResponse ? "second" : "first",
                data: new Date().toISOString(),
                idioma: currentLanguage
            }));
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                if (!awaitingSecondResponse) {
                    showUserReactions(inputText);
                } else {
                    showSecondUserReactions(inputText);
                }
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFollowUpQuestion();
            }, 2000);
        }
        
        async function showFollowUpQuestion() {
            const followUpSection = document.getElementById('followUpSection');
            const followUpQuestionEl = document.getElementById('followUpQuestion');
            
            followUpSection.classList.add('show');
            
            await typewriterEffect(followUpQuestionEl, translations[currentLanguage].followUpQuestion, 50);
            
            setTimeout(() => {
                awaitingSecondResponse = true;
                enableUserInput();
            }, 1500);
        }
        
        async function showSecondUserReactions(userInput) {
            const secondResponseCharacters = [
                {
                    name: "Noah", emoji: "🧑‍🦱",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "그 말은 끝이 아니라 시작이에요. 이제 당신은 새로운 이야기를 쓸 수 있어요.",
                            en: "Those words aren't an ending but a beginning. Now you can write a new story.",
                            pt: "Essas palavras não são um fim, mas um começo. Agora você pode escrever uma nova história."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Kael", emoji: "🧙",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "진짜 자신을 찾는 건, 과거를 부정하는 게 아니라 통합하는 거예요.",
                            en: "Finding your true self isn't about denying the past, but integrating it.",
                            pt: "Encontrar seu verdadeiro eu não é negar o passado, mas integrá-lo."
                        };
                        return responses[lang];
                    }
                },
                {
                    name: "Mira", emoji: "🧑‍🎨",
                    getResponse: (input, lang) => {
                        const responses = {
                            ko: "당신이 써내려간 그 진심이, 앞으로의 모든 페이지를 밝힐 거예요.",
                            en: "That sincerity you've written down will illuminate all the pages to come.",
                            pt: "Essa sinceridade que você escreveu iluminará todas as páginas por vir."
                        };
                        return responses[lang];
                    }
                }
            ];
            
            const reactionsSection = document.getElementById('userReactionsSection');
            
            for (let i = 0; i < secondResponseCharacters.length; i++) {
                const char = secondResponseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < secondResponseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showNavigationSection();
            }, 2000);
        }
        
        async function showNavigationSection() {
            const navigationSection = document.getElementById('navigationSection');
            const navigationMessage = document.getElementById('navigationMessage');
            
            navigationSection.classList.add('show');
            
            const messageText = translations[currentLanguage].navigationMessage;
            await typewriterEffect(navigationMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(navigationSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V4 Portal 21 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                enableUserInput();
            }, 2000);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V4 Portal 21 DOM loaded');
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>