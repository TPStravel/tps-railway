<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V2 - Portal 05: When Emotions You Thought Were Forgotten Return</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            word-break: keep-all;
            overflow-wrap: break-word;
        }
        
        /* 상단 헤더 */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #fff;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        /* 언어 버튼 3개 */
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #87cefa;
            color: #000;
        }
        
        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
            min-height: 150vh;
        }
        
        /* 텍스트 섹션들 */
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #87cefa;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #87cefa;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #87cefa;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .user-response strong {
            color: #87cefa;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .continue-section {
            margin: 50px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 0;
            min-height: 200px;
        }
        
        .continue-text {
            color: #fff;
            font-size: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .continue-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .continue-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 18px 35px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .continue-btn:hover {
            background: #666;
        }
        
        .continue-btn.primary {
            background: #87cefa;
            color: #000;
        }
        
        .continue-btn.primary:hover {
            background: #b0d4f1;
        }
        
        /* 하단 고정 입력창 */
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #87cefa;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #87cefa;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        /* 스크롤바 스타일링 */
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        /* 애니메이션 */
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .continue-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .continue-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- 상단 헤더 -->
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V2</div>
            <div class="logo-subtitle" id="logoSubtitle">The Tremor of Emotion</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 05: When Emotions You Thought Were Forgotten Return</div>
            <div class="portal-subtitle" id="portalSubtitle">The moment past emotions knock on your door</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <!-- 메인 콘텐츠 영역 -->
    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <!-- 포털 인트로 -->
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <!-- 캐릭터 응답 섹션 -->
            <div class="character-responses-section" id="characterResponsesSection">
                <!-- 8명의 캐릭터 응답이 순차적으로 표시됩니다 -->
            </div>

            <!-- 빛의 한마디 -->
            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <!-- 질문 섹션 -->
            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <!-- 사용자 입력 영역 -->
            <div class="user-input-section" id="userInputSection">
                <!-- 사용자 응답이 여기에 표시됩니다 -->
            </div>
            
            <!-- 사용자 응답 후 캐릭터 반응 -->
            <div class="user-reactions-section" id="userReactionsSection">
                <!-- 사용자 응답 후 3명의 캐릭터 반응이 여기에 표시됩니다 -->
            </div>
            
            <!-- 계속하기 버튼 섹션 -->
            <div class="continue-section" id="continueSection">
                <div class="continue-text" id="continueText"></div>
                <div class="continue-buttons">
                    <button class="continue-btn primary" id="continueYesBtn">Continue to Portal 06</button>
                    <button class="continue-btn" id="continueNoBtn">Pause the journey</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 하단 고정 입력창 -->
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Share about the emotions that returned to you... (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // 메모리 기반 사용자 스토리지 (localStorage 대신)
        let memoryStorage = {
            mockUser: null
        };
        
        // Firebase 모의 객체 (실제 구현에서는 Firebase SDK 사용)
        const firebase = {
            auth: () => ({
                onAuthStateChanged: (callback) => {
                    // 모의 인증 상태 체크 (메모리 기반)
                    setTimeout(() => {
                        callback(memoryStorage.mockUser);
                    }, 100);
                }
            })
        };

        // 번역 데이터
        const translations = {
            ko: {
                logoSubtitle: "감정의 떨림",
                portalMainTitle: "Portal 05: 잊혀졌다고 믿었던 감정이 다시 올 때",
                portalSubtitle: "과거의 감정이 문을 두드리는 순간",
                portalIntro: "'이젠 괜찮다'고 생각했던 감정이\n어느 날, 갑자기 다시 찾아옵니다.\n지나간 줄 알았고, 끝난 줄 알았고,\n이젠 안 아플 줄 알았는데…\n\n그 감정은 무언가에 스치듯 다시 떠오르고,\n우리는 아무 준비 없이 그때로 돌아가죠.\n\n당신은 지금,\n이미 끝났다고 믿었던 감정과\n다시 마주하게 될 준비가 되었나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "감정은 끝나지 않았기 때문에 돌아오는 게 아닙니다.\n당신이 이제 그것을 꺼내도 괜찮은 사람이 되었기 때문에\n조용히 문을 두드립니다.",
                portalQuestion: "당신에게 다시 찾아온 감정이 있다면,\n그 감정은 어떤 모습으로 돌아왔나요?\n\n무엇이 그 기억을 다시 불러왔고,\n이번에는 그 감정을 어떻게 마주하고 싶으신가요?",
                continueText: "과거의 감정과 다시 마주한 이 여정을 계속하시겠습니까?",
                continueYes: "Portal 06으로 계속하시겠습니까?",
                continueNo: "여정을 일시정지하시겠습니까?",
                inputPlaceholder: "다시 찾아온 감정에 대해 털어놓아 보세요... (Enter로 전송)",
                youLabel: "당신",
                languageChangeConfirm: "언어를 변경하면 여정이 처음부터 다시 시작됩니다.\n계속하시겠습니까?",
                waitingMessage: "응답을 기다리는 중...",
                // 캐릭터 대화
                charEly: "과거에서 온 감정은 실패가 아니라,\n치유되지 않은 진실입니다.\n다시 돌아온 건, 다시 돌아보라는 뜻입니다.",
                charCris: "헐~ 그 감정 아직 있었어?\n야, 진짜 질기다…\n그래도 이번엔 좀 덜 아프지 않았어요? 😉",
                charZafirah: "기억은 흐려져도, 감정은 남습니다.\n그리고 감정은 늘 '기다림'의 형태로 돌아오죠.\n그 감정을 이번엔, 안아줄 수 있나요?",
                charRami: "돌아온 감정은 망령이 아니라 징후입니다.\n'여전히 살아 있다'는 징후.\n그것을 무시하지 마세요.",
                charSamir: "(그는 두 손으로 모래를 움켜쥐었다가,\n천천히 바람에 흘려보낸다.\n흘러가는 모래 속에, 당신도 조용히 감정을 실어보낸다.)",
                charLayla: "그 감정이 돌아온 건,\n당신이 이제는 감당할 수 있는 사람이 되었기 때문이에요.\n예전의 당신이 아니라는 뜻이에요.",
                charNabir: "또 그 감정이야?\n그만 좀 해. 몇 번을 되새김질할 건데?\n이제 좀 털고 일어나지 그래?",
                charAzhar: "끝났다고? 웃기지 마.\n그 감정 안 끝났잖아. 그냥 도망친 거지.\n이번엔 도망 못 간다. 똑바로 마주 봐."
            },
            en: {
                logoSubtitle: "The Tremor of Emotion",
                portalMainTitle: "Portal 05: When Emotions You Thought Were Forgotten Return",
                portalSubtitle: "The moment past emotions knock on your door",
                portalIntro: "Emotions you thought were 'okay now'\nsuddenly return one day.\nYou thought they had passed, thought they were over,\nthought they wouldn't hurt anymore…\n\nThose emotions brush against something and resurface,\nand we return to that time without any preparation.\n\nAre you now ready\nto face again the emotions\nyou believed were already finished?",
                lightTitle: "✨ Word of Light",
                lightMessage: "Emotions don't return because they never ended.\nThey quietly knock on your door because\nyou've become someone who can now handle them.",
                portalQuestion: "If there's an emotion that has returned to you,\nin what form did that emotion come back?\n\nWhat brought that memory back again,\nand how do you want to face that emotion this time?",
                continueText: "Will you continue this journey of facing past emotions again?",
                continueYes: "Continue to Portal 06?",
                continueNo: "Pause the journey?",
                inputPlaceholder: "Share about the emotions that returned to you... (Press Enter to send)",
                youLabel: "You",
                languageChangeConfirm: "Changing the language will restart the journey from the beginning.\nDo you want to continue?",
                waitingMessage: "Waiting for response...",
                charEly: "Emotions from the past are not failures,\nbut unhealed truths.\nTheir return means to look back again.",
                charCris: "Wow~ that emotion was still there?\nMan, it's really persistent…\nBut it hurt a bit less this time, didn't it? 😉",
                charZafirah: "Memories may fade, but emotions remain.\nAnd emotions always return in the form of 'waiting.'\nCan you embrace that emotion this time?",
                charRami: "Returned emotions are not ghosts but signs.\nSigns that you're 'still alive.'\nDon't ignore them.",
                charSamir: "(He grasps sand in both hands,\nthen slowly lets it flow in the wind.\nIn the flowing sand, you also quietly send your emotions.)",
                charLayla: "That emotion returned because\nyou've become someone who can handle it now.\nIt means you're not the same person as before.",
                charNabir: "That emotion again?\nCome on, stop. How many times will you ruminate?\nWhy don't you just shake it off and get up?",
                charAzhar: "Over? Don't be ridiculous.\nThat emotion isn't over. You just ran away.\nYou can't run this time. Face it straight."
            },
            pt: {
                logoSubtitle: "O Tremor da Emoção",
                portalMainTitle: "Portal 05: Quando Emoções Que Você Pensou Que Foram Esquecidas Retornam",
                portalSubtitle: "O momento em que emoções do passado batem à sua porta",
                portalIntro: "Emoções que você pensou que estavam 'bem agora'\nde repente retornam um dia.\nVocê pensou que tinham passado, pensou que acabaram,\npensou que não doeriam mais…\n\nEssas emoções roçam em algo e ressurgem,\ne retornamos àquele tempo sem qualquer preparação.\n\nVocê está agora pronto\npara enfrentar novamente as emoções\nque acreditava já terem terminado?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Emoções não retornam porque nunca terminaram.\nElas batem silenciosamente à sua porta porque\nvocê se tornou alguém que agora pode lidar com elas.",
                portalQuestion: "Se há uma emoção que retornou para você,\nem que forma essa emoção voltou?\n\nO que trouxe essa memória de volta novamente,\ne como você quer enfrentar essa emoção desta vez?",
                continueText: "Você continuará esta jornada de enfrentar emoções do passado novamente?",
                continueYes: "Continuar para o Portal 06?",
                continueNo: "Pausar a jornada?",
                inputPlaceholder: "Compartilhe sobre as emoções que retornaram para você... (Enter para enviar)",
                youLabel: "Você",
                languageChangeConfirm: "Mudar o idioma reiniciará a jornada desde o início.\nDeseja continuar?",
                waitingMessage: "Aguardando resposta...",
                charEly: "Emoções do passado não são falhas,\nmas verdades não curadas.\nSeu retorno significa olhar para trás novamente.",
                charCris: "Uau~ essa emoção ainda estava lá?\nCara, é realmente persistente…\nMas doeu um pouco menos desta vez, não doeu? 😉",
                charZafirah: "Memórias podem desvanecer, mas emoções permanecem.\nE emoções sempre retornam na forma de 'espera.'\nVocê pode abraçar essa emoção desta vez?",
                charRami: "Emoções retornadas não são fantasmas, mas sinais.\nSinais de que você ainda está 'vivo.'\nNão as ignore.",
                charSamir: "(Ele segura areia em ambas as mãos,\nentão lentamente a deixa fluir no vento.\nNa areia que flui, você também silenciosamente envia suas emoções.)",
                charLayla: "Essa emoção retornou porque\nvocê se tornou alguém que pode lidar com ela agora.\nSignifica que você não é a mesma pessoa de antes.",
                charNabir: "Essa emoção de novo?\nPor favor, pare. Quantas vezes você vai ruminar?\nPor que não simplesmente se livra disso e se levanta?",
                charAzhar: "Acabou? Não seja ridículo.\nEssa emoção não acabou. Você só fugiu.\nVocê não pode fugir desta vez. Encare de frente."
            }
        };
        
        // 캐릭터 데이터
        const characters = [
            { name: "Ely", emoji: "👑", key: "charEly" },
            { name: "Cris", emoji: "🃏", key: "charCris" },
            { name: "Zafirah", emoji: "🧕", key: "charZafirah" },
            { name: "Rami", emoji: "🔮", key: "charRami" },
            { name: "Samir", emoji: "🐪", key: "charSamir" },
            { name: "Layla", emoji: "💠", key: "charLayla" },
            { name: "Nabir", emoji: "🦂", key: "charNabir" },
            { name: "Azhar", emoji: "🔥", key: "charAzhar" }
        ];
        
        // ============ 감정 분석 시스템 ============
        
        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            // 감정 키워드 매핑
            const emotionKeywords = {
                nostalgia: ['그리워', '그리움', '추억', '예전', '과거', '그때', 'miss', 'nostalgia', 'memory', 'past', 'saudade', 'passado'],
                regret: ['후회', '돌이키', '왜 그랬', '했어야', '안 했', 'regret', 'should have', 'wish', 'arrependiment', 'deveria'],
                sadness: ['슬프', '울고', '눈물', '우울', '암울', '절망', 'sad', 'cry', 'tear', 'depress', 'triste', 'choro'],
                love: ['사랑', '좋아', '마음', '애정', '그리워', 'love', 'miss', 'care', 'feelings', 'amor', 'sente falta'],
                anger: ['화가', '분노', '짜증', '빡쳐', '열받', '억울', 'angry', 'mad', 'furious', 'rage', 'raiva', 'irritad'],
                fear: ['무서', '두려', '겁나', '걱정', '불안', 'fear', 'scare', 'afraid', 'worry', 'medo', 'preocup'],
                loneliness: ['외로', '혼자', '고립', '소외', '버림', 'lonely', 'alone', 'isolated', 'abandon', 'solidão', 'sozinho'],
                guilt: ['죄책감', '미안', '죄송', '잘못', '탓', 'guilt', 'sorry', 'wrong', 'fault', 'culpa', 'desculpa'],
                anxiety: ['불안', '초조', '떨려', '긴장', '걱정', 'anxiety', 'nervous', 'worry', 'tense', 'ansiedade', 'nervoso'],
                acceptance: ['받아들', '인정', '괜찮', '이해', '용서', 'accept', 'okay', 'understand', 'forgive', 'aceitar', 'perdoar']
            };
            
            // 감정 분석
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            // 감정이 감지되지 않으면 기본값 설정
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0]; // 첫 번째 감지된 감정 반환
        }
        
        // 반응 캐릭터들 (Portal 05 전용)
        const responseCharacters = [
            {
                name: "Return", emoji: "🔄",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            nostalgia: "그리움이 다시 찾아왔군요. 그 감정은 사라진 게 아니라 당신 안에서 조용히 기다리고 있었어요. 이제는 그 그리움을 달달하지 않은 추억으로, 아름다운 경험으로 받아들일 수 있을 거예요.",
                            regret: "후회가 다시 문을 두드렸나요? 하지만 이번에는 달라요. 그 후회는 이제 당신을 무너뜨리려는 게 아니라, 더 나은 선택을 하는 지혜를 주려고 왔어요. 과거를 바꿀 수는 없지만, 지금은 달라질 수 있어요.",
                            sadness: "슬픔이 돌아왔지만, 예전처럼 당신을 압도하지는 않을 거예요. 이제 당신은 그 슬픔과 함께 있을 줄 아는 사람이 되었으니까요. 슬픔도 당신의 일부로 받아들이면서도, 그것에 매몰되지 않을 수 있어요.",
                            love: "그 사랑이 다시 마음을 두드리고 있나요? 이번에는 아프지 않은 형태로 돌아왔을 거예요. 그 사랑이 주었던 아름다운 순간들, 성장시켜준 경험들을 이제는 감사히 받아들일 수 있을 거예요.",
                            anger: "분노가 되돌아왔지만, 이번에는 그 분노 속에 숨어있는 메시지를 들을 수 있을 거예요. 무엇이 당신을 화나게 했는지, 무엇을 지키고 싶었는지. 그 분노를 건설적인 에너지로 바꿀 때가 왔어요.",
                            fear: "두려움이 다시 찾아왔지만, 이제 당신은 그 두려움의 진짜 정체를 알 수 있어요. 그것이 당신을 보호하려던 마음이었는지, 아니면 성장을 막는 장벽이었는지. 이번에는 두려움과 대화할 수 있을 거예요.",
                            loneliness: "외로움이 돌아왔지만, 이제는 그 외로움 속에서도 자신과의 깊은 만남을 가질 수 있어요. 혼자라는 것이 버림받은 게 아니라, 자신을 더 깊이 알아가는 시간이 될 수 있어요.",
                            guilt: "죄책감이 다시 마음을 누르려 하지만, 이번에는 그 감정을 성찰의 기회로 바꿀 수 있어요. 죄책감이 가르쳐주는 교훈을 배우고, 더 나은 선택을 할 수 있는 사람이 되었으니까요.",
                            anxiety: "불안이 돌아왔지만, 이제는 그 불안이 당신을 마비시키지 않을 거예요. 불안 속에 숨어있는 진짜 걱정이 무엇인지 알아보고, 하나씩 해결해나갈 수 있는 힘이 생겼어요.",
                            acceptance: "받아들임의 마음으로 그 감정을 맞이하고 있나요? 그렇다면 이제 정말로 그 감정과 평화롭게 공존할 수 있을 거예요. 저항하지 않고 받아들일 때, 감정은 자연스럽게 흘러갑니다.",
                            general: "돌아온 감정이 무엇이든, 이번에는 당신이 더 성숙한 마음으로 맞이할 수 있을 거예요. 그 감정이 가르쳐주려는 것이 무엇인지 들어보세요. 모든 감정에는 의미가 있어요."
                        },
                        en: {
                            nostalgia: "Nostalgia has returned. That emotion wasn't gone, it was quietly waiting inside you. Now you can accept that longing as memories that aren't bitter, as beautiful experiences.",
                            regret: "Did regret knock on your door again? But this time is different. That regret isn't here to break you down, but to give you wisdom for better choices. You can't change the past, but now can be different.",
                            sadness: "Sadness has returned, but it won't overwhelm you like before. You've become someone who knows how to be with that sadness. You can accept sadness as part of you without being buried in it.",
                            love: "Is that love knocking on your heart again? This time it returned in a form that doesn't hurt. You'll be able to gratefully accept the beautiful moments that love gave, the experiences that made you grow.",
                            anger: "Anger has returned, but this time you'll be able to hear the message hidden in that anger. What made you angry, what you wanted to protect. It's time to transform that anger into constructive energy.",
                            fear: "Fear has returned, but now you can know the true identity of that fear. Whether it was a heart trying to protect you, or a barrier preventing growth. This time you'll be able to dialogue with fear.",
                            loneliness: "Loneliness has returned, but now you can have deep encounters with yourself even in that loneliness. Being alone isn't abandonment, but time to know yourself more deeply.",
                            guilt: "Guilt tries to press on your heart again, but this time you can turn that emotion into an opportunity for reflection. You've become someone who can learn from what guilt teaches and make better choices.",
                            anxiety: "Anxiety has returned, but now it won't paralyze you. You have the power to discover what real worry is hidden in anxiety and solve it step by step.",
                            acceptance: "Are you welcoming that emotion with acceptance? Then you'll truly be able to coexist peacefully with that emotion. When you accept without resistance, emotions flow naturally.",
                            general: "Whatever emotion has returned, this time you'll be able to welcome it with a more mature heart. Listen to what that emotion is trying to teach you. Every emotion has meaning."
                        },
                        pt: {
                            nostalgia: "A nostalgia retornou. Essa emoção não tinha ido embora, estava silenciosamente esperando dentro de você. Agora você pode aceitar essa saudade como memórias que não são amargas, como experiências bonitas.",
                            regret: "O arrependimento bateu à sua porta novamente? Mas desta vez é diferente. Esse arrependimento não está aqui para destruí-lo, mas para dar sabedoria para melhores escolhas. Você não pode mudar o passado, mas agora pode ser diferente.",
                            sadness: "A tristeza retornou, mas não o dominará como antes. Você se tornou alguém que sabe como estar com essa tristeza. Você pode aceitar tristeza como parte de você sem ser enterrado nela.",
                            love: "Esse amor está batendo no seu coração novamente? Desta vez retornou em uma forma que não dói. Você será capaz de aceitar com gratidão os belos momentos que o amor deu, as experiências que fizeram você crescer.",
                            anger: "A raiva retornou, mas desta vez você será capaz de ouvir a mensagem escondida nessa raiva. O que te deixou com raiva, o que você queria proteger. É hora de transformar essa raiva em energia construtiva.",
                            fear: "O medo retornou, mas agora você pode conhecer a verdadeira identidade desse medo. Se era um coração tentando protegê-lo, ou uma barreira impedindo crescimento. Desta vez você será capaz de dialogar com o medo.",
                            loneliness: "A solidão retornou, mas agora você pode ter encontros profundos consigo mesmo mesmo nessa solidão. Estar sozinho não é abandono, mas tempo para se conhecer mais profundamente.",
                            guilt: "A culpa tenta pressionar seu coração novamente, mas desta vez você pode transformar essa emoção em uma oportunidade de reflexão. Você se tornou alguém que pode aprender com o que a culpa ensina e fazer melhores escolhas.",
                            anxiety: "A ansiedade retornou, mas agora não o paralisará. Você tem o poder de descobrir que preocupação real está escondida na ansiedade e resolvê-la passo a passo.",
                            acceptance: "Você está recebendo essa emoção com aceitação? Então você verdadeiramente será capaz de coexistir pacificamente com essa emoção. Quando você aceita sem resistência, emoções fluem naturalmente.",
                            general: "Qualquer emoção que tenha retornado, desta vez você será capaz de recebê-la com um coração mais maduro. Escute o que essa emoção está tentando ensinar. Toda emoção tem significado."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Wisdom", emoji: "🦉",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            nostalgia: "그리움이 돌아온 건 당신이 이제 그 기억을 객관적으로 볼 수 있게 되었기 때문이에요. 예전에는 그 기억에 사로잡혔다면, 이제는 그 기억에서 배울 점을 찾을 수 있어요. 그리움도 지혜의 형태로 다가올 수 있답니다.",
                            regret: "후회가 다시 찾아온 건, 당신이 이제 과거의 실수를 교훈으로 바꿀 준비가 되었다는 신호예요. 후회는 단순한 자책이 아니라, 더 나은 미래를 위한 나침반이 될 수 있어요. 그 후회가 가르쳐주는 것을 들어보세요.",
                            sadness: "슬픔이 돌아왔다는 것은 당신이 이제 그 슬픔의 깊이를 이해할 수 있게 되었다는 뜻이에요. 슬픔은 우리에게 무엇이 정말 소중했는지를 가르쳐줍니다. 그 슬픔 속에서 진짜 가치를 발견할 수 있을 거예요.",
                            love: "사랑이 다시 마음을 두드리는 건, 당신이 이제 사랑의 진정한 의미를 이해할 수 있게 되었기 때문이에요. 소유하려는 사랑이 아니라, 주고받는 사랑의 아름다움을 이제는 알 수 있어요.",
                            anger: "분노가 돌아온 건 당신이 이제 그 분노 뒤에 숨은 진짜 메시지를 들을 준비가 되었기 때문이에요. 분노는 때로 우리의 가치관이 무엇인지를 명확히 보여주는 거울이에요. 그 거울을 들여다보세요.",
                            fear: "두려움이 다시 찾아온 건 당신이 이제 진짜 용기가 무엇인지 배울 준비가 되었다는 신호예요. 용기는 두려움이 없는 게 아니라, 두려움과 함께 걸어가는 거예요. 이제 그 비밀을 알 수 있을 거예요.",
                            loneliness: "외로움이 돌아온 건 당신이 이제 진정한 독립과 자립이 무엇인지 배울 때가 되었기 때문이에요. 외로움은 때로 자신만의 내면의 풍요로움을 발견하게 해주는 선생님이에요.",
                            guilt: "죄책감이 다시 찾아온 건 당신이 이제 진정한 책임감과 성숙함을 배울 준비가 되었다는 뜻이에요. 죄책감을 통해 더 나은 판단력을 기를 수 있어요. 그것이 죄책감이 주는 선물이에요.",
                            anxiety: "불안이 돌아온 건 당신이 이제 진정한 평안이 무엇인지 알아갈 때가 되었기 때문이에요. 불안은 때로 우리가 정말 중요하게 여기는 것이 무엇인지를 알려주는 신호등이에요.",
                            acceptance: "받아들임의 마음으로 그 감정을 맞이한다면, 당신은 이미 큰 지혜를 얻은 거예요. 저항하지 않고 받아들이는 것, 그것이 진정한 성숙함이에요. 당신은 이미 그 경지에 도달했어요.",
                            general: "어떤 감정이 돌아왔든, 그것은 당신이 더 깊은 이해와 지혜를 얻을 준비가 되었다는 신호예요. 감정은 우리의 선생님이에요. 그들이 가르쳐주려는 교훈에 귀 기울여보세요."
                        },
                        en: {
                            nostalgia: "Nostalgia returned because you can now view those memories objectively. If you were once captivated by those memories, now you can find lessons to learn from them. Nostalgia can also approach in the form of wisdom.",
                            regret: "Regret returning is a signal that you're now ready to transform past mistakes into lessons. Regret isn't just self-blame, but can become a compass for a better future. Listen to what that regret is teaching you.",
                            sadness: "Sadness returning means you can now understand the depth of that sadness. Sadness teaches us what was truly precious. You'll be able to discover real value within that sadness.",
                            love: "Love knocking on your heart again is because you can now understand love's true meaning. Not possessive love, but the beauty of giving and receiving love - you can know this now.",
                            anger: "Anger returned because you're now ready to hear the real message hidden behind that anger. Anger is sometimes a mirror that clearly shows what our values are. Look into that mirror.",
                            fear: "Fear returning is a signal that you're ready to learn what real courage is. Courage isn't the absence of fear, but walking together with fear. Now you'll be able to know that secret.",
                            loneliness: "Loneliness returned because it's time for you to learn what true independence and self-reliance are. Loneliness is sometimes a teacher that helps you discover your own inner richness.",
                            guilt: "Guilt returning means you're ready to learn true responsibility and maturity. Through guilt, you can develop better judgment. That's the gift guilt gives.",
                            anxiety: "Anxiety returned because it's time for you to discover what true peace is. Anxiety is sometimes a traffic light that tells us what we truly value.",
                            acceptance: "If you welcome that emotion with acceptance, you've already gained great wisdom. Accepting without resistance - that's true maturity. You've already reached that level.",
                            general: "Whatever emotion has returned, it's a signal that you're ready to gain deeper understanding and wisdom. Emotions are our teachers. Listen to the lessons they're trying to teach."
                        },
                        pt: {
                            nostalgia: "A nostalgia retornou porque você agora pode ver essas memórias objetivamente. Se uma vez você foi cativado por essas memórias, agora você pode encontrar lições para aprender com elas. A nostalgia também pode se aproximar na forma de sabedoria.",
                            regret: "O arrependimento retornar é um sinal de que você está agora pronto para transformar erros passados em lições. Arrependimento não é apenas auto-culpa, mas pode se tornar uma bússola para um futuro melhor. Escute o que esse arrependimento está ensinando.",
                            sadness: "A tristeza retornar significa que você agora pode entender a profundidade dessa tristeza. A tristeza nos ensina o que era verdadeiramente precioso. Você será capaz de descobrir valor real dentro dessa tristeza.",
                            love: "O amor batendo no seu coração novamente é porque você agora pode entender o verdadeiro significado do amor. Não amor possessivo, mas a beleza de dar e receber amor - você pode saber isso agora.",
                            anger: "A raiva retornou porque você está agora pronto para ouvir a mensagem real escondida por trás dessa raiva. A raiva às vezes é um espelho que mostra claramente quais são nossos valores. Olhe nesse espelho.",
                            fear: "O medo retornar é um sinal de que você está pronto para aprender o que é coragem real. Coragem não é a ausência de medo, mas caminhar junto com o medo. Agora você será capaz de conhecer esse segredo.",
                            loneliness: "A solidão retornou porque é hora de você aprender o que são verdadeira independência e auto-suficiência. A solidão às vezes é um professor que ajuda você a descobrir sua própria riqueza interior.",
                            guilt: "A culpa retornar significa que você está pronto para aprender verdadeira responsabilidade e maturidade. Através da culpa, você pode desenvolver melhor julgamento. Esse é o presente que a culpa dá.",
                            anxiety: "A ansiedade retornou porque é hora de você descobrir o que é verdadeira paz. A ansiedade às vezes é um semáforo que nos diz o que realmente valorizamos.",
                            acceptance: "Se você recebe essa emoção com aceitação, você já ganhou grande sabedoria. Aceitar sem resistência - essa é verdadeira maturidade. Você já alcançou esse nível.",
                            general: "Qualquer emoção que tenha retornado, é um sinal de que você está pronto para ganhar compreensão e sabedoria mais profundas. Emoções são nossos professores. Escute as lições que estão tentando ensinar."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Circle", emoji: "🔮",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            nostalgia: "그리움은 원형으로 돌아옵니다. 끝이 있는 것 같지만 사실은 새로운 시작이기도 해요. 당신이 그리워하는 것들이 다시 찾아온 건, 이제 그것들을 새로운 관점에서 볼 준비가 되었기 때문이에요. 같은 감정이지만 다른 의미를 갖게 될 거예요.",
                            regret: "후회는 나선형으로 움직입니다. 같은 자리로 돌아온 것 같지만 사실은 더 높은 위치에서 그 경험을 바라보고 있어요. 이번의 후회는 예전과 다른 깊이를 가질 거예요. 더 성숙한 시각으로 과거를 볼 수 있게 되었으니까요.",
                            sadness: "슬픔의 순환이 다시 시작되었나요? 하지만 이번에는 그 슬픔이 당신을 같은 곳으로 데려가지 않을 거예요. 경험이라는 계단을 하나 더 올라선 상태에서 만나는 슬픔은 다른 모습일 거예요. 더 지혜로운 슬픔이 될 수 있어요.",
                            love: "사랑은 영원한 순환입니다. 떠났다가 돌아오고, 사라졌다가 다시 나타나죠. 하지만 돌아온 사랑은 예전과 같지 않아요. 더 깊고, 더 이해심 있고, 더 자유로운 형태의 사랑이 될 거예요.",
                            anger: "분노의 바퀴가 다시 돌기 시작했나요? 하지만 이제 그 바퀴를 멈출 수 있는 힘이 있어요. 같은 분노라도 이제는 그것을 다른 방향으로 이끌 수 있어요. 파괴적이 아닌 창조적인 에너지로 바꿀 수 있어요.",
                            fear: "두려움의 원이 다시 그려지고 있지만, 이번에는 그 원을 벗어날 수 있는 문을 찾을 수 있을 거예요. 같은 두려움이라도 이제는 그것이 허상인지 실체인지 구분할 수 있는 눈이 생겼어요.",
                            loneliness: "외로움의 순환 속에서도 이제는 자신만의 중심을 찾을 수 있어요. 외로움이 돌고 돌아도 당신은 그 중심에서 흔들리지 않을 수 있어요. 고요한 중심에서 외로움을 관찰할 수 있게 되었어요.",
                            guilt: "죄책감의 고리가 다시 연결되었지만, 이번에는 그 고리를 끊을 수 있는 열쇠를 가지고 있어요. 같은 죄책감이라도 이제는 그것을 용서와 성장의 기회로 바꿀 수 있어요.",
                            anxiety: "불안의 소용돌이가 다시 시작되었지만, 이번에는 그 중심에서 고요함을 유지할 수 있어요. 불안이 돌고 돌아도 당신의 내면은 평온할 수 있어요. 태풍의 눈처럼 말이에요.",
                            acceptance: "받아들임의 원 안에서 모든 감정들이 자연스럽게 순환할 수 있게 되었네요. 저항하지 않고 흘려보내는 것, 그것이 진정한 자유예요. 당신은 그 자유를 체험하고 있어요.",
                            general: "모든 감정은 원형으로 움직입니다. 떠났다가 돌아오고, 사라졌다가 다시 나타나죠. 하지만 같은 자리로 돌아온 것 같아도 당신은 이미 다른 사람이 되어 있어요. 그것이 인생의 나선형 여정이에요."
                        },
                        en: {
                            nostalgia: "Nostalgia returns in circles. It seems to have an end but is actually a new beginning too. The things you long for returned because you're ready to see them from a new perspective. Same emotion but will have different meaning.",
                            regret: "Regret moves in spirals. It seems to return to the same place but you're actually viewing that experience from a higher position. This regret will have different depth than before. You can now view the past with a more mature perspective.",
                            sadness: "Has the cycle of sadness begun again? But this time that sadness won't take you to the same place. Sadness met while having climbed one more step of experience will look different. It can become wiser sadness.",
                            love: "Love is an eternal cycle. It leaves and returns, disappears and reappears. But returned love isn't the same as before. It will be deeper, more understanding, more free form of love.",
                            anger: "Has anger's wheel started turning again? But now you have the power to stop that wheel. Even the same anger can now be led in different directions. You can transform it into creative rather than destructive energy.",
                            fear: "Fear's circle is being drawn again, but this time you'll be able to find the door to escape that circle. Even the same fear - now you have eyes to distinguish whether it's illusion or reality.",
                            loneliness: "Even in loneliness's cycle, you can now find your own center. Even as loneliness goes round and round, you can remain unshaken at that center. You've learned to observe loneliness from a quiet center.",
                            guilt: "Guilt's chain has connected again, but this time you have the key to break that chain. Even the same guilt can now be transformed into an opportunity for forgiveness and growth.",
                            anxiety: "Anxiety's whirlpool has started again, but this time you can maintain tranquility at its center. Even as anxiety spins round and round, your inner self can be peaceful. Like the eye of a storm.",
                            acceptance: "Within acceptance's circle, all emotions can naturally circulate. Not resisting and letting flow - that's true freedom. You're experiencing that freedom.",
                            general: "All emotions move in circles. They leave and return, disappear and reappear. But even if they seem to return to the same place, you've already become a different person. That's life's spiral journey."
                        },
                        pt: {
                            nostalgia: "A nostalgia retorna em círculos. Parece ter um fim mas na verdade também é um novo começo. As coisas que você sente saudade retornaram porque você está pronto para vê-las de uma nova perspectiva. Mesma emoção mas terá significado diferente.",
                            regret: "O arrependimento se move em espirais. Parece retornar ao mesmo lugar mas você está na verdade vendo essa experiência de uma posição mais alta. Este arrependimento terá profundidade diferente do anterior. Você agora pode ver o passado com perspectiva mais madura.",
                            sadness: "O ciclo da tristeza começou novamente? Mas desta vez essa tristeza não o levará ao mesmo lugar. Tristeza encontrada enquanto subiu mais um degrau de experiência parecerá diferente. Pode se tornar tristeza mais sábia.",
                            love: "O amor é um ciclo eterno. Ele parte e retorna, desaparece e reaparece. Mas o amor retornado não é o mesmo de antes. Será forma de amor mais profunda, mais compreensiva, mais livre.",
                            anger: "A roda da raiva começou a girar novamente? Mas agora você tem o poder de parar essa roda. Mesmo a mesma raiva agora pode ser conduzida em direções diferentes. Você pode transformá-la em energia criativa ao invés de destrutiva.",
                            fear: "O círculo do medo está sendo desenhado novamente, mas desta vez você será capaz de encontrar a porta para escapar desse círculo. Mesmo o mesmo medo - agora você tem olhos para distinguir se é ilusão ou realidade.",
                            loneliness: "Mesmo no ciclo da solidão, você agora pode encontrar seu próprio centro. Mesmo enquanto a solidão gira e gira, você pode permanecer inabalável nesse centro. Você aprendeu a observar a solidão de um centro silencioso.",
                            guilt: "A corrente da culpa se conectou novamente, mas desta vez você tem a chave para quebrar essa corrente. Mesmo a mesma culpa agora pode ser transformada em oportunidade de perdão e crescimento.",
                            anxiety: "O redemoinho da ansiedade começou novamente, mas desta vez você pode manter tranquilidade em seu centro. Mesmo enquanto a ansiedade gira e gira, seu eu interior pode estar em paz. Como o olho de uma tempestade.",
                            acceptance: "Dentro do círculo da aceitação, todas as emoções podem circular naturalmente. Não resistir e deixar fluir - essa é a verdadeira liberdade. Você está experimentando essa liberdade.",
                            general: "Todas as emoções se movem em círculos. Elas partem e retornam, desaparecem e reaparecem. Mas mesmo se parecem retornar ao mesmo lugar, você já se tornou uma pessoa diferente. Essa é a jornada espiral da vida."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en'; // 기본 언어를 영어로 설정
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        // ============ 여정 초기화 함수 ============
        
        function resetJourney() {
            console.log('=== 여정 초기화 시작 ===');
            
            // 1. 모든 타이핑 효과 완전 정리
            clearAllTypingEffects();
            
            // 추가 안전장치 - 모든 timer 정리
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            // 2. 모든 콘텐츠 섹션 완전 초기화
            const sectionsToReset = [
                'portalIntroSection',
                'characterResponsesSection', 
                'lightMessageSection',
                'portalQuestionSection',
                'userInputSection',
                'userReactionsSection',
                'continueSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    } else {
                        const textElements = section.querySelectorAll('.portal-intro, .light-message, .portal-question, .continue-text');
                        textElements.forEach(el => {
                            el.innerHTML = '';
                            el.textContent = '';
                        });
                    }
                }
            });
            
            // 3. 특정 요소들 개별 초기화
            const portalIntro = document.getElementById('portalIntro');
            const lightMessage = document.getElementById('lightMessage');
            const portalQuestion = document.getElementById('portalQuestion');
            const continueText = document.getElementById('continueText');
            
            if (portalIntro) portalIntro.innerHTML = '';
            if (lightMessage) lightMessage.innerHTML = '';
            if (portalQuestion) portalQuestion.innerHTML = '';
            if (continueText) continueText.innerHTML = '';
            
            // 4. 텍스트영역 완전 초기화
            const userTextarea = document.getElementById('userTextarea');
            if (userTextarea) {
                userTextarea.disabled = false;
                userTextarea.value = '';
                userTextarea.style.height = 'auto';
                userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            }
            
            // 5. 스크롤 위치 초기화
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.scrollTop = 0;
            }
            
            // 6. 상태 변수 완전 초기화
            userResponse = '';
            currentTypingElement = null;
            
            console.log('=== 여정 초기화 완료 ===');
        }
        
        // ============ 개선된 언어 변경 함수 ============
        
        function changeLanguage(lang) {
            if (!translations[lang]) {
                console.error('지원하지 않는 언어:', lang);
                return;
            }
            
            if (currentLanguage === lang) {
                return;
            }
            
            if (journeyStarted) {
                const confirmMessage = translations[currentLanguage].languageChangeConfirm;
                const shouldRestart = confirm(confirmMessage);
                
                if (!shouldRestart) {
                    return;
                }
            }
            
            const previousLanguage = currentLanguage;
            currentLanguage = lang;
            
            console.log(`언어 변경: ${previousLanguage} → ${currentLanguage}`);
            
            if (journeyStarted) {
                resetJourney();
            }
            
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                setTimeout(() => {
                    console.log(`새로운 언어(${currentLanguage})로 여정 재시작`);
                    startPortalSequence();
                }, 1000);
            }
        }
        
        // ============ UI 업데이트 함수들 ============
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            // 개별 요소 업데이트
            const elements = [
                'logoSubtitle',
                'portalMainTitle', 
                'portalSubtitle',
                'lightTitle',
                'continueYesBtn',
                'continueNoBtn'
            ];
            
            elements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element && translations[lang]) {
                    const key = elementId.replace('Btn', 'Button').replace('Subtitle', 'Subtitle');
                    let translationKey = key;
                    
                    const keyMapping = {
                        'logoSubtitle': 'logoSubtitle',
                        'portalMainTitle': 'portalMainTitle',
                        'portalSubtitle': 'portalSubtitle',
                        'lightTitle': 'lightTitle',
                        'continueYesButton': 'continueYes',
                        'continueNoButton': 'continueNo'
                    };
                    
                    translationKey = keyMapping[key] || key;
                    
                    if (translations[lang][translationKey]) {
                        element.textContent = translations[lang][translationKey];
                    }
                }
            });
            
            // placeholder 업데이트
            const textarea = document.getElementById('userTextarea');
            if (textarea) textarea.placeholder = translations[lang].inputPlaceholder;
        }
        
        // ============ 개선된 타이핑 효과 + 스크롤 추적 시스템 ============
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        
                        setTimeout(() => {
                            if (document.contains(element)) {
                                scrollToFollowTyping(element);
                            }
                        }, 200);
                        
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        // ============ 스마트 스크롤 시스템 ============
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        // ============ 언어 버튼 이벤트 설정 ============
        
        function setupLanguageButtons() {
            const langButtons = document.querySelectorAll('.lang-btn');
            
            langButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const newLang = this.dataset.lang;
                    changeLanguage(newLang);
                });
            });
        }
        
        // ============ 메인 여정 시스템 ============
        
        function initializeTemarix() {
            console.log('=== Temarix Portal 05 초기화 시작 ===');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        // ============ 여정 단계들 ============
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            const introText = translations[currentLanguage].portalIntro;
            await typewriterEffect(introElement, introText, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = `${char.emoji} ${char.name}`;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const dialogueText = translations[currentLanguage][char.key];
                await typewriterEffect(dialogueDiv, dialogueText, 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            const lightText = translations[currentLanguage].lightMessage;
            await typewriterEffect(lightMessageEl, lightText, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            const questionText = translations[currentLanguage].portalQuestion;
            await typewriterEffect(questionEl, questionText, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        // ============ 사용자 입력 시스템 ============
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', handleTextareaKeydown);
            
            document.getElementById('continueYesBtn').addEventListener('click', function() {
                processContinue('Y');
            });
            
            document.getElementById('continueNoBtn').addEventListener('click', function() {
                processContinue('N');
            });
        }
        
        function handleTextareaKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const inputValue = this.value.trim();
                
                if (inputValue) {
                    processUserInput(inputValue);
                }
            }
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = `<strong>${youLabel}:</strong> "${text}"`;
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = `${char.emoji} ${char.name}`;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showContinueOption();
            }, 2000);
        }
        
        async function showContinueOption() {
            const continueSection = document.getElementById('continueSection');
            const continueText = document.getElementById('continueText');
            
            continueSection.classList.add('show');
            
            const questionText = translations[currentLanguage].continueText;
            await typewriterEffect(continueText, questionText, 50);
            
            setTimeout(() => {
                scrollToElement(continueSection);
            }, 500);
        }
        
        function processContinue(input) {
            if (input === 'Y') {
                const message = currentLanguage === 'ko' ? 
                    'Portal 06이 곧 준비됩니다. 계속해서 더 깊은 감정의 여정이 이어집니다.' :
                    currentLanguage === 'en' ? 
                    'Portal 06 will be ready soon. The journey into deeper emotions continues.' :
                    'Portal 06 estará pronto em breve. A jornada para emoções mais profundas continua.';
                alert(message);
            } else if (input === 'N') {
                const message = currentLanguage === 'ko' ? 
                    '여정이 일시 중지되었습니다. 언제든 다시 돌아와 계속하세요.' :
                    currentLanguage === 'en' ? 
                    'The journey has been paused. Come back and continue anytime.' :
                    'A jornada foi pausada. Volte e continue a qualquer momento.';
                alert(message);
            }
        }
        
        // ============ 초기화 ============
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V2 Portal 05 DOM 로드 완료');
            
            // 자동 로그인 처리 (로그인 모달 제거)
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>