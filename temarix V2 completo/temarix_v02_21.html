<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V2 - Portal 21: The Longing for Warm Words</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            word-break: keep-all;
            overflow-wrap: break-word;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #fff;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #ffd700;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #ffd700;
            color: #000;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
            min-height: 150vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #ffd700;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #ffd700;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .user-response strong {
            color: #ffd700;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .continue-section {
            margin: 50px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 0;
            min-height: 200px;
        }
        
        .continue-text {
            color: #fff;
            font-size: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: keep-all;
        }
        
        .continue-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .continue-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 18px 35px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .continue-btn:hover {
            background: #666;
        }
        
        .continue-btn.primary {
            background: #ffd700;
            color: #000;
        }
        
        .continue-btn.primary:hover {
            background: #ffed4e;
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #ffd700;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #ffd700;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .continue-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .continue-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V2</div>
            <div class="logo-subtitle" id="logoSubtitle">The Tremor of Emotion</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 21: The Longing for Warm Words</div>
            <div class="portal-subtitle" id="portalSubtitle">The word that the heart thirsted for</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="continue-section" id="continueSection">
                <div class="continue-text" id="continueText"></div>
                <div class="continue-buttons">
                    <button class="continue-btn primary" id="continueYesBtn">Continue to Portal 22</button>
                    <button class="continue-btn" id="continueNoBtn">Pause the journey</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Share that one word you wanted to hear..."
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyC2u94Oz2W5eeqBlqs88cs7rgSmzBEAnjQ",
    authDomain: "canal-vivo-chat.firebaseapp.com",
    projectId: "canal-vivo-chat",
    storageBucket: "canal-vivo-chat.appspot.com",
    messagingSenderId: "975226660544",
    appId: "1:975226660544:web:56b55bb3e2a58bed03ef25"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let memoryStorage = { mockUser: null };

        const translations = {
            ko: {
                logoSubtitle: "감정의 떨림",
                portalMainTitle: "Portal 21: 따뜻한 말의 갈망",
                portalSubtitle: "마음이 목말랐던 그 한마디",
                portalIntro: "💝 많은 걸 바란 게 아니었어요.\n큰 도움도, 위대한 조언도 아니었어요.\n그저 짧고 진심 어린 한마디,\n\"괜찮아\", \"고생했어\", \"나는 네 편이야\"…\n\n그 말을 기다리며 수없이 참았고,\n끝내 오지 않은 그 한마디에\n나라는 사람이 조용히 무너졌습니다.\n\n이곳은 당신이 목말랐던 따뜻한 말들과\n마주하는 치유의 공간입니다.\n누군가의 진심 어린 위로를 기다렸던\n그 간절했던 마음을 인정하는 곳입니다.",
                lightTitle: "빛의 한마디",
                lightMessage: "당신이 기다렸던 말은\n당신이 가장 먼저 스스로에게 해주었어야 할 말이었습니다.",
                portalQuestion: "❓ 당신은 지금도\n그 한마디를 누구에게서 듣고 싶나요?\n그 말이 당신에게 어떤 의미였을까요?",
                continueText: "따뜻한 말의 갈망을 인정하고 다음 여정으로 나아갈 준비가 되셨나요?",
                continueYes: "Portal 22로 계속하기",
                continueNo: "여정을 일시정지하기",
                inputPlaceholder: "당신이 듣고 싶었던 그 한마디를 털어놓아 보세요...",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "The Tremor of Emotion",
                portalMainTitle: "Portal 21: The Longing for Warm Words",
                portalSubtitle: "The word that the heart thirsted for",
                portalIntro: "💝 It wasn't much I wanted.\nNot great help, not grand advice.\nJust one short, heartfelt word,\n\"It's okay\", \"You worked hard\", \"I'm on your side\"…\n\nI endured countless times waiting for those words,\nand when that one phrase never came,\nwho I was quietly crumbled.\n\nThis is a healing space where you face\nthe warm words you thirsted for.\nA place to acknowledge that earnest heart\nthat waited for someone's sincere comfort.",
                lightTitle: "Word of Light",
                lightMessage: "The words you waited for\nwere what you should have said to yourself first.",
                portalQuestion: "❓ Who do you still want to hear\nthat one word from now?\nWhat would those words have meant to you?",
                continueText: "Are you ready to acknowledge your longing for warm words and move forward to the next journey?",
                continueYes: "Continue to Portal 22",
                continueNo: "Pause the journey",
                inputPlaceholder: "Share that one word you wanted to hear...",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "O Tremor da Emocao",
                portalMainTitle: "Portal 21: A Saudade de Palavras Carinhosas",
                portalSubtitle: "A palavra que o coração sedento esperava",
                portalIntro: "💝 Não era muito o que eu queria.\nNão grande ajuda, não conselhos grandiosos.\nApenas uma palavra curta e sincera,\n\"Está tudo bem\", \"Você se esforçou\", \"Estou do seu lado\"…\n\nSuportei incontáveis vezes esperando por essas palavras,\ne quando essa frase nunca veio,\nquem eu era desmoronou silenciosamente.\n\nEste é um espaço de cura onde você enfrenta\nas palavras carinhosas que você desejava.\nUm lugar para reconhecer esse coração sincero\nque esperou pelo conforto genuíno de alguém.",
                lightTitle: "Palavra de Luz",
                lightMessage: "As palavras que você esperou\neram o que deveria ter dito a si mesmo primeiro.",
                portalQuestion: "❓ De quem você ainda quer ouvir\nessa palavra agora?\nO que essas palavras teriam significado para você?",
                continueText: "Está pronto para reconhecer sua saudade de palavras carinhosas e seguir em frente para a próxima jornada?",
                continueYes: "Continuar para o Portal 22",
                continueNo: "Pausar a jornada",
                inputPlaceholder: "Compartilhe essa palavra que queria ouvir...",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        // Characters and responses
        const characters = [
            { name: "Ely", emoji: "👑", text: {
                ko: "그 말 한마디를 기다렸던 당신은\n약한 게 아니라,\n사랑에 목말랐던 존재였습니다.",
                en: "You who waited for that one word\nweren't weak,\nbut a being thirsting for love.",
                pt: "Você que esperou por essa palavra\nnão era fraco,\nmas um ser sedento de amor."
            }},
            { name: "Cris", emoji: "🃏", text: {
                ko: "진짜 그거 있어요.\n어려운 말 말고 그냥\n'힘들었겠다'\n그거 하나면 마음이 무너져요. 좋은 의미로.",
                en: "That's really a thing.\nNot difficult words, just\n'It must have been hard'\nThat one thing breaks your heart. In a good way.",
                pt: "Isso é realmente uma coisa.\nNão palavras difíceis, apenas\n'Deve ter sido difícil'\nEssa coisa quebra seu coração. No bom sentido."
            }},
            { name: "Zafirah", emoji: "🧕", text: {
                ko: "당신이 원했던 건\n사람이 아니라 존재의 인정이었을 거예요.\n당신의 마음을 있는 그대로 보는 눈빛.",
                en: "What you wanted wasn't a person\nbut recognition of existence.\nEyes that see your heart as it is.",
                pt: "O que você queria não era uma pessoa\nmas reconhecimento de existência.\nOlhos que veem seu coração como ele é."
            }},
            { name: "Rami", emoji: "🔮", text: {
                ko: "말은 때로\n가장 순수한 감정의 그릇이 됩니다.\n그리고 당신은, 그 그릇을 받을 자격이 있습니다.",
                en: "Words sometimes become\nthe purest vessel for emotions.\nAnd you deserve to receive that vessel.",
                pt: "Palavras às vezes se tornam\no recipiente mais puro para emoções.\nE você merece receber esse recipiente."
            }},
            { name: "Samir", emoji: "🐪", text: {
                ko: "(그는 아무 말 없이,\n당신의 어깨 위에 가볍게 손을 올립니다.\n그 손은 말 대신 전하는 진심입니다.)",
                en: "(He silently\nplaces his hand gently on your shoulder.\nThat hand conveys sincerity instead of words.)",
                pt: "(Ele silenciosamente\ncoloca sua mão gentilmente no seu ombro.\nEssa mão transmite sinceridade em vez de palavras.)"
            }},
            { name: "Layla", emoji: "💠", text: {
                ko: "그 말,\n지금이라도 내가 해줄게요.\n'당신은 괜찮았고, 충분히 애썼어요.'",
                en: "Those words,\nI'll say them to you even now.\n'You were okay, you tried hard enough.'",
                pt: "Essas palavras,\nvou dizê-las para você mesmo agora.\n'Você estava bem, se esforçou o suficiente.'"
            }},
            { name: "Nabir", emoji: "🦂", text: {
                ko: "그래서 그런 말 한마디 없었다고\n아직까지 삐져 있는 거야?\n진짜 유치하다.",
                en: "So you're still sulking because\nyou didn't get that one word?\nReally childish.",
                pt: "Então você ainda está emburrado porque\nnão recebeu essa palavra?\nRealmente infantil."
            }},
            { name: "Azhar", emoji: "🔥", text: {
                ko: "말 한마디에 목 맸어?\n그 말 없었다고 지금까지 무너진 채 살아?\n그럼 그냥 무너져 있어.",
                en: "You hung onto one word?\nYou've lived broken until now because you didn't get it?\nThen just stay broken.",
                pt: "Você se apegou a uma palavra?\nViveu quebrado até agora porque não a recebeu?\nEntão continue quebrado."
            }}
        ];
        
        const responseCharacters = [
            { name: "Healing", emoji: "🌙", text: {
                ko: "그 말을 간절히 원했던 마음, 나는 다 이해해요. 당신은 그 말을 들을 자격이 충분한 사람이에요. 지금이라도 내가 그 따뜻한 말을 전해드릴게요.",
                en: "That heart that desperately wanted those words, I understand it all. You're someone who deserves to hear those words. Even now, I'll deliver those warm words to you.",
                pt: "Esse coração que desesperadamente queria essas palavras, eu entendo tudo. Você é alguém que merece ouvir essas palavras. Mesmo agora, vou entregar essas palavras carinhosas para você."
            }},
            { name: "Understanding", emoji: "💝", text: {
                ko: "따뜻한 말을 갈망했던 당신의 마음을 진심으로 이해해요. 그건 인간으로서 가장 자연스러운 욕구였어요. 당신은 그 말을 들을 자격이 있어요.",
                en: "I truly understand your heart that longed for warm words. That was the most natural human desire. You deserve to hear those words.",
                pt: "Entendo verdadeiramente seu coração que ansiava por palavras carinhosas. Esse era o desejo humano mais natural. Você merece ouvir essas palavras."
            }},
            { name: "Support", emoji: "🤗", text: {
                ko: "그 한마디를 기다렸던 당신, 이제는 내가 그 말을 해드릴게요. '당신은 충분히 좋은 사람이에요. 정말로요.' 이 말이 당신 마음에 닿길 바라요.",
                en: "You who waited for that one word, now I'll say it to you. 'You're a good enough person. Really.' I hope these words reach your heart.",
                pt: "Você que esperou por essa palavra, agora vou dizê-la para você. 'Você é uma pessoa boa o suficiente. Realmente.' Espero que essas palavras toquem seu coração."
            }}
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        // FIXED typewriterEffect function - VERSÃO FUNCIONAL COMPLETA
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('continueYesBtn').textContent = translations[lang].continueYes;
            document.getElementById('continueNoBtn').textContent = translations[lang].continueNo;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'continueSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('continueText').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueYesBtn').addEventListener('click', function() {
                // Real redirect to Portal 22 with language support
                window.location.href = "temarix_v02_22.html?lang=" + currentLanguage;
            });
            
            document.getElementById('continueNoBtn').addEventListener('click', function() {
                const message = currentLanguage === 'ko' ? 
                    '여정이 일시 중지되었습니다. 언제든 다시 돌아와 계속하세요.' :
                    currentLanguage === 'en' ? 
                    'The journey has been paused. Come back and continue anytime.' :
                    'A jornada foi pausada. Volte e continue a qualquer momento.';
                alert(message);
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            // Save user response to Firestore
            try {
                await db.collection("temarix_v2_respostas").add({
                    uid: memoryStorage.mockUser.uid,
                    email: memoryStorage.mockUser.email,
                    portal: "v2-21",
                    resposta: inputText,
                    data: firebase.firestore.Timestamp.now(),
                    idioma: currentLanguage
                });
                console.log('Response saved to Firestore successfully');
            } catch (error) {
                console.error('Error saving to Firestore:', error);
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions();
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions() {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showContinueOption();
            }, 2000);
        }
        
        async function showContinueOption() {
            const continueSection = document.getElementById('continueSection');
            const continueText = document.getElementById('continueText');
            
            continueSection.classList.add('show');
            
            await typewriterEffect(continueText, translations[currentLanguage].continueText, 50);
            
            setTimeout(() => {
                scrollToElement(continueSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('=== Temarix Portal 21 초기화 시작 ===');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V2 Portal 21 DOM 로드 완료');
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>