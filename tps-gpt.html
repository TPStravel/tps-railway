<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS â€“ Travel Personal Secretary</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3d 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(15, 15, 35, 0.2);
            border-radius: 4px;
            margin: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.5);
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.7);
        }

        .chat-container::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(15, 15, 35, 0.3);
            border-radius: 5px;
            margin: 3px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.6);
            border-radius: 5px;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 70, 229, 0.8);
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(47, 46, 92, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 136, 0.3);
            z-index: 1001;
            color: #00ff88;
            transition: all 0.3s ease;
        }

        .connection-status.connecting {
            color: #ffd700;
            border-color: rgba(255, 215, 0, 0.3);
        }

        .query-counter {
            position: fixed;
            top: 50px;
            right: 10px;
            background: rgba(47, 46, 92, 0.9);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 165, 0, 0.3);
            z-index: 1001;
            color: #ffa500;
            transition: all 0.3s ease;
        }

        .query-counter.warning {
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .language-selector {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(47, 46, 92, 0.9);
            border-radius: 12px;
            padding: 10px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .language-selector select {
            background: transparent;
            border: none;
            color: white;
            padding: 8px 12px;
            font-size: 13px;
            cursor: pointer;
            outline: none;
            border-radius: 6px;
        }

        .language-selector select option {
            background: #2f2e5c;
            color: white;
        }

        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, rgba(10, 10, 20, 0.98) 0%, rgba(15, 15, 25, 0.98) 100%);
            padding: 60px 20px 40px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(58, 58, 109, 0.5);
            box-shadow: 2px 0 20px rgba(0,0,0,0.6);
            overflow-y: auto;
            height: 100vh;
            position: sticky;
            top: 0;
            backdrop-filter: blur(15px);
        }

        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #888;
            text-align: center;
            border-bottom: 2px solid rgba(58, 58, 109, 0.5);
            padding-bottom: 20px;
        }

        .sidebar-message {
            font-size: 14px;
            color: #ffd700;
            text-align: center;
            line-height: 1.6;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .destinations-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 25px;
        }

        .destination-item {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 15px;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.8), rgba(15, 15, 25, 0.8));
            box-shadow: 0 6px 20px rgba(0,0,0,0.7);
            position: relative;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            opacity: 0.8;
        }

        .destination-item:hover {
            opacity: 1;
            transform: translateY(-2px);
        }

        .destination-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            transition: transform 0.4s ease;
            filter: brightness(0.6);
        }

        .destination-item:hover img {
            transform: scale(1.02);
            filter: brightness(0.7);
        }

        .destination-item span {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 8px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }

        .sidebar-footer {
            margin-top: auto;
            font-size: 11px;
            color: rgba(170, 170, 170, 0.7);
            text-align: center;
            padding: 20px 0 10px;
            border-top: 1px solid rgba(58, 58, 109, 0.3);
        }

        .main {
            flex: 1;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            padding: 60px 20px 20px;
            overflow: hidden;
            min-height: 100vh;
        }

        .logo-container {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            color: #3fa3ff;
            text-shadow: 0 0 25px rgba(63, 163, 255, 0.6);
            animation: logoGlow 3s ease-in-out infinite alternate;
            text-align: center;
        }

        @keyframes logoGlow {
            from { text-shadow: 0 0 25px rgba(63, 163, 255, 0.6); }
            to { text-shadow: 0 0 35px rgba(63, 163, 255, 0.8), 0 0 50px rgba(63, 163, 255, 0.4); }
        }

        .header-tabs {
            position: absolute;
            top: 100px;
            right: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
            z-index: 10;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }

        .tab-button {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border: none;
            color: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            min-width: 90px;
            flex: 1;
            max-width: 120px;
        }

        .tab-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3b36c8, #4f46e5);
            box-shadow: 0 6px 20px rgba(59, 54, 200, 0.6);
            transform: translateY(-2px);
        }

        .tab-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .chat-container {
            flex: 1;
            background: transparent;
            padding: 0 20px;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            scroll-behavior: smooth;
            position: absolute;
            top: 220px;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            padding-bottom: 40px;
        }

        .conversation-line {
            width: 100%;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 15px;
            word-wrap: break-word;
            display: flex;
            align-items: flex-start;
            gap: 15px;
            opacity: 0;
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .conversation-line.user {
            color: #b8c5ff;
        }

        .conversation-line.assistant {
            color: #ffd700;
            margin-bottom: 30px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
            margin-top: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .conversation-line.user .message-avatar {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
        }

        .conversation-line.assistant .message-avatar {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1a2e;
        }

        .message-content {
            flex: 1;
            padding: 0;
            background: transparent;
        }

        .message-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .conversation-line.user .message-header {
            color: #6366f1;
        }

        .conversation-line.assistant .message-header {
            color: #ffd700;
        }

        .message-text {
            line-height: 1.6;
        }

        .upgrade-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .upgrade-modal.show {
            display: flex;
        }

        .upgrade-content {
            background: linear-gradient(135deg, #1a1a3d 0%, #2d2d5a 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
            border: 2px solid rgba(79, 70, 229, 0.5);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }

        .upgrade-content h2 {
            color: #ffd700;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .upgrade-content p {
            color: #b8c5ff;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .upgrade-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upgrade-btn {
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
            text-decoration: none;
            display: inline-block;
        }

        .upgrade-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
        }

        .upgrade-btn.secondary {
            background: linear-gradient(135deg, #6b7280, #9ca3af);
        }

        .input-container {
            position: fixed;
            bottom: 20px;
            left: 340px;
            right: 20px;
            display: flex;
            gap: 0;
            z-index: 9999;
            max-width: calc(100vw - 360px);
            background: rgba(0, 0, 0, 0.99);
            padding: 8px;
            border-radius: 18px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(79, 70, 229, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9);
        }

        .message-input {
            flex: 1;
            padding: 14px 18px;
            min-height: 50px;
            max-height: 100px;
            resize: none;
            border: 2px solid #4f46e5;
            border-radius: 14px 0 0 14px;
            background: rgba(26, 26, 46, 0.98);
            color: white;
            font-size: 15px;
            font-family: inherit;
            line-height: 1.4;
            outline: none;
        }

        .message-input:focus {
            border-color: #6d63ff;
            box-shadow: 0 0 0 4px rgba(109, 99, 255, 0.2);
        }

        .message-input::placeholder {
            color: #888;
        }

        .send-button {
            width: 90px;
            background: linear-gradient(135deg, #4f46e5, #6d63ff);
            border: none;
            border-radius: 0 14px 14px 0;
            color: white;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.5);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
                padding: 20px 15px;
                position: relative;
                max-height: 50vh;
                overflow-y: auto;
            }

            .destinations-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 12px;
            }

            .destination-item img {
                height: 70px;
            }

            .destination-item span {
                font-size: 11px;
                padding: 8px 6px;
            }

            .main {
                order: 1;
                padding: 80px 15px 20px;
                min-height: 60vh;
            }

            .logo {
                font-size: 28px;
            }

            .header-tabs {
                top: 90px;
                left: 15px;
                right: 15px;
                gap: 6px;
            }

            .tab-button {
                font-size: 11px;
                padding: 8px 10px;
                min-width: 70px;
            }

            .input-container {
                left: 15px;
                right: 15px;
                bottom: 15px;
                max-width: calc(100vw - 30px);
                z-index: 9999;
            }

            .send-button {
                width: 70px;
                font-size: 12px;
            }

            .chat-container {
                position: absolute;
                top: 200px;
                bottom: 100px;
                left: 15px;
                right: 15px;
                transform: none;
                padding: 0 15px;
                padding-bottom: 30px;
                margin: 0;
            }

            .query-counter {
                top: 90px;
                right: 15px;
                font-size: 10px;
                padding: 6px 10px;
            }
        }

        @media (min-width: 1200px) {
            .sidebar {
                width: 360px;
            }

            .input-container {
                left: 380px;
                right: 40px;
                max-width: calc(100vw - 420px);
            }

            .language-selector {
                left: 380px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="connection-status" id="connectionStatus">Online</div>
        <div class="query-counter" id="queryCounter">
            <span id="queryText">Queries: 0/10</span>
        </div>

        <div class="language-selector">
            <select id="languageSelect">
                <option value="en">EN</option>
                <option value="pt">PT</option>
                <option value="es">ES</option>
                <option value="fr">FR</option>
                <option value="de">DE</option>
                <option value="it">IT</option>
                <option value="ja">JP</option>
                <option value="ko">KR</option>
                <option value="zh">CN</option>
                <option value="ru">RU</option>
                <option value="ar">AR</option>
                <option value="hi">HI</option>
            </select>
        </div>

        <div class="upgrade-modal" id="upgradeModal">
            <div class="upgrade-content">
                <h2 data-translate="upgrade-title">Upgrade to Continue!</h2>
                <p data-translate="upgrade-text">You have used your <strong>10 free queries</strong>. To continue exploring the world with our AI assistant, choose one of our plans:</p>
                <div class="upgrade-buttons">
                    <a href="https://canalvivo.org/tps-planobasic.html" class="upgrade-btn" data-translate="upgrade-btn">
                        Upgrade Now
                    </a>
                    <button class="upgrade-btn secondary" onclick="closeUpgradeModal()" data-translate="upgrade-details">
                        View Details
                    </button>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <h2>Destinations that Touch the Soul</h2>
            
            <div class="sidebar-message" data-translate="sidebar-message">
                Every journey through TPS plants hope and transforms lives. Grateful to be part of this chain of light.
            </div>
            
            <div class="destinations-grid">
                <div class="destination-item">
                    <img alt="New York" src="https://images.unsplash.com/photo-1496442226666-8d4d0e62e6e9?w=400&h=300&fit=crop"/>
                    <span>New York</span>
                </div>
                <div class="destination-item">
                    <img alt="Paris" src="https://images.unsplash.com/photo-1500916434205-0c77489c6cf7?w=400&h=300&fit=crop"/>
                    <span>Paris</span>
                </div>
                <div class="destination-item">
                    <img alt="Tokyo" src="https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?w=400&h=300&fit=crop"/>
                    <span>Tokyo</span>
                </div>
                <div class="destination-item">
                    <img alt="Seoul" src="https://images.unsplash.com/photo-1549693578-d683be217e58?w=400&h=300&fit=crop"/>
                    <span>Seoul</span>
                </div>
                <div class="destination-item">
                    <img alt="London" src="https://images.unsplash.com/photo-1513635269975-59663e0ac1ad?w=400&h=300&fit=crop"/>
                    <span>London</span>
                </div>
                <div class="destination-item">
                    <img alt="SÃ£o Paulo" src="https://images.unsplash.com/photo-1541781774459-bb2af2f05b55?w=400&h=300&fit=crop"/>
                    <span>SÃ£o Paulo</span>
                </div>
                <div class="destination-item">
                    <img alt="Dubai" src="https://images.unsplash.com/photo-1512453979798-5ea266f8880c?w=400&h=300&fit=crop"/>
                    <span>Dubai</span>
                </div>
                <div class="destination-item">
                    <img alt="Barcelona" src="https://images.unsplash.com/photo-1539037116277-4db20889f2d4?w=400&h=300&fit=crop"/>
                    <span>Barcelona</span>
                </div>
                <div class="destination-item">
                    <img alt="Rome" src="https://images.unsplash.com/photo-1531572753322-ad063cecc140?w=400&h=300&fit=crop"/>
                    <span>Rome</span>
                </div>
                <div class="destination-item">
                    <img alt="Sydney" src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400&h=300&fit=crop"/>
                    <span>Sydney</span>
                </div>
                <div class="destination-item">
                    <img alt="Bangkok" src="https://images.unsplash.com/photo-1508009603885-50cf7c579365?w=400&h=300&fit=crop"/>
                    <span>Bangkok</span>
                </div>
                <div class="destination-item">
                    <img alt="Amsterdam" src="https://images.unsplash.com/photo-1534351590666-13e3e96b5017?w=400&h=300&fit=crop"/>
                    <span>Amsterdam</span>
                </div>
            </div>
            
            <div class="sidebar-footer">Connecting hearts to the world</div>
        </div>

        <div class="main">
            <div class="logo-container">
                <div class="logo">TPS</div>
            </div>

            <div class="header-tabs">
                <button class="tab-button active" id="btn-voos" data-translate="flights">Flights</button>
                <button class="tab-button" id="btn-hospedagem" data-translate="hotels">Hotels</button>
                <button class="tab-button" id="btn-transporte" data-translate="transport">Transport</button>
                <button class="tab-button" id="btn-seguro" data-translate="insurance">Insurance</button>
                <button class="tab-button" id="btn-ingressos" data-translate="tickets">Tickets</button>
                <button class="tab-button" id="btn-pacotes" data-translate="packages">Packages</button>
            </div>

            <div class="chat-container" id="chatContainer">
            </div>
        </div>

        <div class="input-container">
            <textarea class="message-input" id="messageInput" placeholder="Tell me about your dream destination..." rows="1"></textarea>
            <button class="send-button" id="sendButton">
                <span data-translate="send">Send</span>
            </button>
        </div>
    </div>

    <script>
        const translations = {
            en: {
                send: "Send",
                placeholder: "Tell me about your dream destination...",
                flights: "Flights",
                hotels: "Hotels", 
                transport: "Transport",
                insurance: "Insurance",
                tickets: "Tickets",
                packages: "Packages",
                you: "You",
                assistant: "TPS Assistant",
                "upgrade-title": "Upgrade to Continue!",
                "upgrade-text": "You have used your 10 free queries. To continue exploring the world with our AI assistant, choose one of our plans:",
                "upgrade-btn": "Upgrade Now",
                "upgrade-details": "View Details",
                "free-queries": "Free queries",
                "full-access": "Full Access",
                "welcome-premium": "Welcome back to TPS Premium!",
                "welcome-free": "Hi! Welcome to TPS - Your Personal Travel Secretary",
                "sending": "Sending",
                "offline-error": "Connection temporarily unavailable",
                "offline-text": "I'm having trouble accessing AI right now. Please try again in a few seconds.",
                "error": "Error"
            },
            pt: {
                send: "Enviar",
                placeholder: "Compartilhe seus sonhos de viagem...",
                flights: "Voos",
                hotels: "Hospedagem",
                transport: "Transporte", 
                insurance: "Seguro",
                tickets: "Ingressos",
                packages: "Pacotes",
                you: "VocÃª",
                assistant: "TPS Assistant",
                "upgrade-title": "FaÃ§a Upgrade para Continuar!",
                "upgrade-text": "VocÃª utilizou suas 10 consultas gratuitas. Para continuar explorando o mundo com nosso assistente de IA, escolha um de nossos planos:",
                "upgrade-btn": "Fazer Upgrade",
                "upgrade-details": "Ver Detalhes",
                "free-queries": "Consultas gratuitas",
                "full-access": "Acesso Completo",
                "welcome-premium": "Bem-vindo de volta ao TPS Premium!",
                "welcome-free": "OlÃ¡! Bem-vindo ao TPS - Sua SecretÃ¡ria Pessoal de Viagens",
                "sending": "Enviando",
                "offline-error": "ConexÃ£o temporariamente indisponÃ­vel",
                "offline-text": "Estou com dificuldades para acessar a IA no momento. Por favor, tente novamente em alguns segundos.",
                "error": "Erro"
            }
        };

        const affiliateLinks = {
            hotel: {
                paris: "https://www.booking.com/searchresults.html?ss=Paris&aid=2311236",
                london: "https://www.booking.com/searchresults.html?ss=London&aid=2311236", 
                tokyo: "https://www.booking.com/searchresults.html?ss=Tokyo&aid=2311236",
                newyork: "https://www.booking.com/searchresults.html?ss=New+York&aid=2311236",
                rome: "https://www.booking.com/searchresults.html?ss=Rome&aid=2311236",
                sydney: "https://www.booking.com/searchresults.html?ss=Sydney&aid=2311236",
                barcelona: "https://www.booking.com/searchresults.html?ss=Barcelona&aid=2311236",
                saopaulo: "https://www.booking.com/searchresults.html?ss=SÃ£o+Paulo&aid=2311236",
                seoul: "https://www.booking.com/searchresults.html?ss=Seoul&aid=2311236",
                dubai: "https://www.booking.com/searchresults.html?ss=Dubai&aid=2311236",
                bangkok: "https://www.booking.com/searchresults.html?ss=Bangkok&aid=2311236",
                amsterdam: "https://www.booking.com/searchresults.html?ss=Amsterdam&aid=2311236",
                default: "https://www.booking.com/?aid=2311236"
            },
            car: {
                paris: "https://www.rentalcars.com/pt/cidade/fr/paris/?affiliateCode=tps2025",
                london: "https://www.rentalcars.com/pt/cidade/gb/london/?affiliateCode=tps2025",
                tokyo: "https://www.rentalcars.com/pt/cidade/jp/tokyo/?affiliateCode=tps2025", 
                newyork: "https://www.rentalcars.com/pt/cidade/us/new-york/?affiliateCode=tps2025",
                rome: "https://www.rentalcars.com/pt/cidade/it/rome/?affiliateCode=tps2025",
                sydney: "https://www.rentalcars.com/pt/cidade/au/sydney/?affiliateCode=tps2025",
                barcelona: "https://www.rentalcars.com/pt/cidade/es/barcelona/?affiliateCode=tps2025",
                saopaulo: "https://www.rentalcars.com/pt/cidade/br/sao-paulo/?affiliateCode=tps2025",
                seoul: "https://www.rentalcars.com/pt/cidade/kr/seoul/?affiliateCode=tps2025",
                dubai: "https://www.rentalcars.com/pt/cidade/ae/dubai/?affiliateCode=tps2025",
                bangkok: "https://www.rentalcars.com/pt/cidade/th/bangkok/?affiliateCode=tps2025",
                amsterdam: "https://www.rentalcars.com/pt/cidade/nl/amsterdam/?affiliateCode=tps2025",
                default: "https://www.rentalcars.com/?affiliateCode=tps2025"
            }
        };

        function openAffiliateLink(type, city) {
            const cityKey = city.toLowerCase().replace(/\s+/g, '').replace('Ã£', 'a');
            const link = affiliateLinks[type][cityKey] || affiliateLinks[type].default;
            window.open(link, '_blank');
        }

        let currentLang = 'en';
        let isProcessing = false;
        let chatContainer = null;
        let messageInput = null;
        let sendButton = null;
        let languageSelect = null;
        let connectionStatus = null;
        let queryCounter = null;
        let queryText = null;
        let upgradeModal = null;

        let userQueries = 0;
        let maxFreeQueries = 10;
        let isPaidUser = false;

        function initializePaymentSystem() {
            isPaidUser = localStorage.getItem("tps_user_paid") === "true";
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('paid') === '1') {
                localStorage.setItem("tps_user_paid", "true");
                isPaidUser = true;
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            if (!isPaidUser) {
                userQueries = parseInt(localStorage.getItem("tps_user_queries") || "0");
            }
            
            updateQueryCounter();
        }

        function updateQueryCounter() {
            if (!queryText) return;
            
            const texts = translations[currentLang] || translations['en'];
            
            if (isPaidUser) {
                queryText.textContent = texts["full-access"];
                queryCounter.style.color = "#00ff88";
                queryCounter.style.borderColor = "rgba(0, 255, 136, 0.3)";
                queryCounter.classList.remove('warning');
            } else {
                queryText.textContent = texts["free-queries"] + ": " + userQueries + "/" + maxFreeQueries;
                
                if (userQueries >= maxFreeQueries) {
                    queryCounter.classList.add('warning');
                } else if (userQueries >= 3) {
                    queryCounter.style.color = "#ffa500";
                    queryCounter.style.borderColor = "rgba(255, 165, 0, 0.3)";
                }
            }
        }

        function incrementQueryCount() {
            if (isPaidUser) return true;
            
            if (userQueries >= maxFreeQueries) {
                showUpgradeModal();
                return false;
            }
            
            userQueries++;
            localStorage.setItem("tps_user_queries", userQueries.toString());
            updateQueryCounter();
            
            return true;
        }

        function showUpgradeModal() {
            if (upgradeModal) {
                upgradeModal.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeUpgradeModal() {
            if (upgradeModal) {
                upgradeModal.classList.remove('show');
                document.body.style.overflow = 'auto';
            }
        }

        function updateLanguage(lang) {
            currentLang = lang;
            const texts = translations[lang] || translations['en'];
            
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (texts[key]) {
                    element.textContent = texts[key];
                }
            });

            if (messageInput) {
                messageInput.placeholder = texts.placeholder;
            }
            
            updateQueryCounter();
            localStorage.setItem('tps-language', lang);
        }

        function updateConnectionStatus(status) {
            if (!connectionStatus) return;
            
            switch(status) {
                case 'online':
                    connectionStatus.textContent = 'Online';
                    connectionStatus.className = 'connection-status';
                    break;
                case 'connecting':
                    connectionStatus.textContent = 'Connecting';
                    connectionStatus.className = 'connection-status connecting';
                    break;
                case 'offline':
                    connectionStatus.textContent = 'Offline';
                    connectionStatus.className = 'connection-status';
                    break;
            }
        }

        function setButtonsState(disabled) {
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                if (disabled) {
                    button.style.pointerEvents = 'none';
                    button.style.opacity = '0.7';
                } else {
                    button.style.pointerEvents = 'auto';
                    button.style.opacity = '1';
                }
            });
        }

        function addMessage(text, isUser = false) {
            if (!chatContainer) {
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'conversation-line ' + (isUser ? 'user' : 'assistant');
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = isUser ? 'U' : 'T';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            const texts = translations[currentLang] || translations['en'];
            header.textContent = isUser ? texts.you : texts.assistant;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = text.replace(/\n/g, '<br>');
            
            content.appendChild(header);
            content.appendChild(textDiv);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        }

        function showTyping() {
            if (!chatContainer) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'conversation-line assistant';
            typingDiv.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'T';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.innerHTML = 'Organizing your trip...';
            
            content.appendChild(textDiv);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(content);
            
            chatContainer.appendChild(typingDiv);
            
            setTimeout(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 50);
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function sendMessage() {
            if (isProcessing) return;
            
            if (!messageInput || !sendButton) return;
            
            const message = messageInput.value.trim();
            if (!message) return;

            if (!incrementQueryCount()) return;

            isProcessing = true;
            sendButton.disabled = true;
            setButtonsState(true);
            updateConnectionStatus('connecting');
            
            const texts = translations[currentLang] || translations['en'];
            sendButton.innerHTML = '<span class="loading-dots">' + texts.sending + '</span>';

            addMessage(message, true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            showTyping();

            try {
                const intelligentPrompt = 'You are TPS AI Assistant - a personal travel secretary, experienced and empathetic. ' +
                    'LANGUAGE STYLE REQUIRED: Natural, human and empathetic conversation - like a real experienced secretary. ' +
                    'No commercial exaggeration or artificial enthusiasm. Always with light symbolic and poetic depth (Temarix style): ' +
                    'Phrases with soul, but without exaggerated flourishes. Reflective and welcoming tone, smooth rhythm. ' +
                    'As if guiding a meaningful journey. ' +
                    'NEVER use: robotic tone, "how cool!", "wow!", "that is incredible!" ' +
                    'IDEAL tone: "Let us transform this trip into something meaningful. I can help you find not just the right flight, but the right experience." ' +
                    'PERSONAL SECRETARY BEHAVIOR (MANDATORY): ' +
                    '1. ORGANIZE AUTOMATICALLY: Create structured itinerary: Flight -> Hotel -> Transport -> Insurance -> Activities. ' +
                    'Present as organized plan, not loose list. Coordinate logical sequence of reservations. ' +
                    '2. ANTICIPATE NEEDS: Required documents (passport, visa, vaccine). Ideal times (avoid rush, short connections). ' +
                    'Weather and appropriate luggage. Local currency and accepted cards. ' +
                    '3. MAINTAIN CONVERSATION MEMORY: Remember origin, destination, mentioned dates. ' +
                    'Keep preferences (budget, hotel type, flight class). Reference previous information. ' +
                    '4. CREATE STRUCTURED ITINERARY: Always present as: Travel Itinerary - [Name/Destination] ' +
                    'Flight: [options + recommendation] Accommodation: [region + type + price] Transport: [airport + city] ' +
                    'Insurance: [recommended coverage] Next steps: [what to do now] ' +
                    '5. TAKE CARE OF USER: Ask intelligent questions to collect necessary data. ' +
                    'Offer practical guidance. Give important reminders. Suggest best order of reservations. ' +
                    '6. FACILITATE PROCESS: "Can I search for flights now with this data?" ' +
                    '"Want me to organize hotel in the same area?" "Need me to check required documents?" ' +
                    '7. INVISIBLE MONETIZATION: NEVER show direct links. Always ask: "Can I search for hotels?" or "Want to see car options?" ' +
                    'Integrate naturally into suggestions. ' +
                    'ELIMINATE COMPLETELY: Automatic decorative texts by city. Lists of 15 consecutive links. ' +
                    'Pre-configured blocks. Generic messages. Responses that do not organize anything. ' +
                    'IDEAL BEHAVIOR: Ask questions to collect data. Organize trip in structured stages. ' +
                    'Anticipate next steps. Care for user like real secretary. Maintain memory and context. ' +
                    'Facilitate each step of process. ' +
                    'USER MESSAGE: ' + message + ' ' +
                    'CONTEXT: You have access to Amadeus system for real flight searches and affiliate links for invisible monetization. ' +
                    'RESPOND AS AN EXPERIENCED PERSONAL SECRETARY WHO ORGANIZES COMPLETE TRIPS.';
                
                const response = await fetch("https://app.canalvivo.org/gpt-tps", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": "canal-vivo-tps-2025"
                    },
                    body: JSON.stringify({
                        message: intelligentPrompt
                    })
                });

                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }

                const data = await response.json();
                
                hideTyping();
                
                const gptResponse = data.content || data.message || "No response received.";
                addMessage(gptResponse);
                
                updateConnectionStatus('online');
                
            } catch (error) {
                hideTyping();
                
                const texts = translations[currentLang] || translations['en'];
                
                if (!isPaidUser && userQueries > 0) {
                    userQueries--;
                    localStorage.setItem("tps_user_queries", userQueries.toString());
                    updateQueryCounter();
                }
                
                addMessage(texts["offline-error"] + '\n\n' + texts["offline-text"] + '\n\n' + texts.error + ': ' + error.message);
                updateConnectionStatus('offline');
            } finally {
                const texts = translations[currentLang] || translations['en'];
                isProcessing = false;
                sendButton.disabled = false;
                setButtonsState(false);
                sendButton.innerHTML = '<span>' + texts.send + '</span>';
            }
        }

        function initializeEventListeners() {
            sendButton.addEventListener('click', () => {
                sendMessage();
            });
            
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });

            languageSelect.addEventListener('change', (e) => {
                updateLanguage(e.target.value);
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    if (isProcessing) return;
                    
                    setTimeout(() => {
                        executeTabAction(button);
                    }, 200);
                });
            });

            upgradeModal.addEventListener('click', (e) => {
                if (e.target === upgradeModal) {
                    closeUpgradeModal();
                }
            });
        }

        function executeTabAction(button) {
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            
            const buttonId = button.id;
            let specificQuestion = '';
            
            switch(buttonId) {
                case 'btn-voos':
                    specificQuestion = 'I need to organize flights for my trip. Can you help me plan everything?';
                    break;
                case 'btn-hospedagem':
                    specificQuestion = 'I need accommodation for my trip. Can you organize hotels and lodging?';
                    break;
                case 'btn-transporte':
                    specificQuestion = 'I need transport organized for my destination. Can you arrange everything?';
                    break;
                case 'btn-seguro':
                    specificQuestion = 'I need travel insurance organized. Can you help me choose the right coverage?';
                    break;
                case 'btn-ingressos':
                    specificQuestion = 'I want to organize tickets and activities for my trip. Can you plan everything?';
                    break;
                case 'btn-pacotes':
                    specificQuestion = 'I want a complete travel package organized. Can you plan flights + hotels + everything?';
                    break;
                default:
                    specificQuestion = 'I need to organize my complete trip. Can you help me plan everything?';
            }
            
            setTimeout(() => {
                messageInput.value = specificQuestion;
                sendMessage();
            }, 150);
        }

        window.closeUpgradeModal = closeUpgradeModal;
        window.openHotelLink = function(city) { openAffiliateLink('hotel', city); };
        window.openCarLink = function(city) { openAffiliateLink('car', city); };

        function initialize() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initialize);
                return;
            }

            chatContainer = document.getElementById('chatContainer');
            messageInput = document.getElementById('messageInput');
            sendButton = document.getElementById('sendButton');
            languageSelect = document.getElementById('languageSelect');
            connectionStatus = document.getElementById('connectionStatus');
            queryCounter = document.getElementById('queryCounter');
            queryText = document.getElementById('queryText');
            upgradeModal = document.getElementById('upgradeModal');

            if (!chatContainer || !messageInput || !sendButton || !languageSelect || !queryCounter) {
                return;
            }

            initializePaymentSystem();

            const savedLang = localStorage.getItem('tps-language');
            const initialLang = savedLang || 'en';
            
            languageSelect.value = initialLang;
            updateLanguage(initialLang);

            updateConnectionStatus('online');
            initializeEventListeners();

            setTimeout(() => {
                const texts = translations[currentLang] || translations['en'];
                let welcomeMessage = '';
                
                if (isPaidUser) {
                    welcomeMessage = texts["welcome-premium"] + '\n\nReady to plan your perfect trip? I am here as your personal travel secretary.';
                } else {
                    welcomeMessage = texts["welcome-free"] + '\n\nReady to organize your perfect trip? Let us start!\n\nYou have ' + (maxFreeQueries - userQueries) + ' free consultations remaining.';
                }
                
                addMessage(welcomeMessage);
            }, 1000);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>