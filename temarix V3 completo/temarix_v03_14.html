<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 14: Comfort That Never Reached My Fingertips</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 14: Comfort That Never Reached My Fingertips</div>
            <div class="portal-subtitle" id="portalSubtitle">The Warmth That Almost Touched Me</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">🤲 Portal 14 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 15</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you like to say to that comfort, or to that person? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 14: 손끝에 닿지 않았던 위로",
                portalSubtitle: "나에게 거의 다가왔던 온기",
                portalIntro: "🤲 누군가의 위로가 아주 가까이 있었지만,\n끝내 닿지 않았던 순간이 있었나요?\n\n그 손끝에 닿지 않은 위로는,\n당신에게 어떤 감정을 남겼나요?\n\n말 없이 다가왔던 친구가 있었어요.\n분명 나를 위로하고 싶어 했는데…\n나는 끝내 그 손을 잡지 못했어요.",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "너는 그 손을 놓친 게 아니라 지금, 마음으로 다시 잡고 있어.",
                portalQuestion: "🤲 그때의 위로에게, 혹은 그 사람에게 지금 전하고 싶은 말이 있나요?",
                finalTitle: "🤲 Portal 14 완료",
                finalMessage: "당신은 용기 있게 놓쳤던 위로를 되돌아보았습니다.\n\n그때 받지 못했던 따뜻함이\n사실은 여전히 거기 있었다는 것을\n지금에서야 느낄 수 있게 되었어요.\n\n위로는 시간을 초월해 전해지고\n감사의 마음은 그 위로를 완성시킵니다.\n당신은 이제 그 온기를 받을 준비가 되었어요.\n\n다음 Portal에서는 마지막 작별의 문장을\n탐험하는 여정이 이어집니다.",
                continueBtn: "Portal 15로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "그때의 위로에게, 혹은 그 사람에게 지금 전하고 싶은 말을 해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 14: Comfort That Never Reached My Fingertips",
                portalSubtitle: "The Warmth That Almost Touched Me",
                portalIntro: "🤲 Was there a moment when someone's comfort was very close,\nbut never quite reached you?\n\nWhat emotions did that comfort\nthat never touched your fingertips leave with you?\n\nThere was a friend who approached silently.\nThey clearly wanted to comfort me...\nbut I never managed to take their hand.",
                lightTitle: "✨ Word of Light",
                lightMessage: "You didn't miss that hand - now, you're holding it again with your heart.",
                portalQuestion: "🤲 Is there something you want to say to that comfort, or to that person, now?",
                finalTitle: "🤲 Portal 14 Complete",
                finalMessage: "You have courageously looked back\nat the comfort you missed.\n\nYou can now feel that the warmth\nyou couldn't receive back then\nwas actually still there.\n\nComfort transcends time\nand gratitude completes that comfort.\nYou are now ready to receive that warmth.\n\nIn the next Portal, a journey continues\nto explore the final farewell sentence.",
                continueBtn: "Move to Portal 15",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you like to say to that comfort, or to that person? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 14: Conforto Que Nunca Alcançou Minhas Pontas dos Dedos",
                portalSubtitle: "O Calor Que Quase Me Tocou",
                portalIntro: "🤲 Houve um momento em que o conforto de alguém estava muito próximo,\nmas nunca chegou até você?\n\nQue emoções aquele conforto\nque nunca tocou suas pontas dos dedos deixaram com você?\n\nHavia um amigo que se aproximou silenciosamente.\nEles claramente queriam me consolar...\nmas eu nunca consegui pegar a mão deles.",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Você não perdeu aquela mão - agora, você está segurando-a novamente com seu coração.",
                portalQuestion: "🤲 Há algo que você quer dizer para aquele conforto, ou para aquela pessoa, agora?",
                finalTitle: "🤲 Portal 14 Completo",
                finalMessage: "Você corajosamente olhou para trás\npara o conforto que perdeu.\n\nVocê agora pode sentir que o calor\nque não conseguiu receber naquela época\nna verdade ainda estava lá.\n\nO conforto transcende o tempo\ne a gratidão completa esse conforto.\nVocê agora está pronto para receber esse calor.\n\nNo próximo Portal, uma jornada continua\npara explorar a frase final de despedida.",
                continueBtn: "Ir para Portal 15",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "O que você gostaria de dizer para aquele conforto, ou para aquela pessoa? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "가끔은 위로조차도 두려워. 손 내밀려다 다시 숨게 되지.",
                en: "Sometimes even comfort becomes frightening. You reach out your hand but then hide again.",
                pt: "Às vezes até o conforto se torna assustador. Você estende a mão, mas depois se esconde novamente."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "그 사람도 말없이 마음을 전하려 했을 거야. 너는 그걸… 느꼈지?",
                en: "That person was also trying to convey their heart silently. You... felt that, didn't you?",
                pt: "Essa pessoa também estava tentando transmitir seu coração silenciosamente. Você... sentiu isso, não foi?"
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "위로가 닿지 않았다는 건 누구의 잘못이 아니라, 두 마음의 속도가 달랐던 거야.",
                en: "That comfort didn't reach you - it's no one's fault, just two hearts moving at different speeds.",
                pt: "Aquele conforto não chegou até você - não é culpa de ninguém, apenas dois corações se movendo em velocidades diferentes."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "닿지 않은 위로는 상처가 되기도 해. 그러나 동시에, 기억으로 남아 너를 지키지.",
                en: "Comfort that doesn't reach can become a wound. But at the same time, it remains as memory and protects you.",
                pt: "O conforto que não alcança pode se tornar uma ferida. Mas ao mesmo tempo, permanece como memória e te protege."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 순간은 흐릿한 보라색 같아. 애틋하고, 어쩌면 조금 서늘했을지도.",
                en: "That moment is like a hazy purple. Tender, and perhaps a little cool.",
                pt: "Aquele momento é como um roxo nebuloso. Terno, e talvez um pouco frio."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "넌 그 손을 피한 게 아니야. 다만, 받아들일 준비가 안 됐던 것뿐이야.",
                en: "You didn't avoid that hand. You just weren't ready to accept it.",
                pt: "Você não evitou aquela mão. Você simplesmente não estava pronto para aceitá-la."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "닿지 않았어도, 그 온기는 남아. 넌 그걸 기억하고 있는 거야.",
                en: "Even though it didn't reach, that warmth remains. You're remembering it.",
                pt: "Mesmo que não tenha alcançado, aquele calor permanece. Você está se lembrando disso."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "지금이라도 그 손을 떠올릴 수 있다면, 그것만으로도 위로는 다시 흐르기 시작한 거야.",
                en: "If you can remember that hand even now, that alone means comfort has begun to flow again.",
                pt: "Se você pode se lembrar daquela mão mesmo agora, isso por si só significa que o conforto começou a fluir novamente."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                gratitude: ['thank', 'grateful', 'appreciate', 'sorry', '고마', '감사', '미안', 'obrigado', 'grato', 'desculpa'],
                recognition: ['felt', 'knew', 'understood', 'saw', '느꼈', '알았', '이해했', '봤', 'senti', 'sabia', 'entendi', 'vi'],
                regret: ['should have', 'wish', 'if only', 'missed', '했어야', '그랬으면', '놓쳤', 'deveria ter', 'queria', 'se ao menos'],
                understanding: ['understand', 'know', 'realize', 'see', '이해', '알겠', '깨달', '알아', 'entender', 'sei', 'perceber'],
                acceptance: ['accept', 'receive', 'take', 'embrace', '받아들', '받을', '잡을', '안을', 'aceitar', 'receber', 'abraçar'],
                connection: ['together', 'close', 'near', 'with me', '함께', '가까이', '곁에', '같이', 'junto', 'perto', 'comigo'],
                healing: ['heal', 'comfort', 'warm', 'peace', '치유', '위로', '따뜻', '평화', 'curar', 'conforto', 'calor', 'paz'],
                love: ['love', 'care', 'precious', 'important', '사랑', '소중', '중요', 'amor', 'cuidado', 'precioso', 'importante']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Ely", emoji: "🧝‍♀️",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            gratitude: "그 말은 늦지 않았어. 위로는 종종… 마음을 통해 천천히 도착하니까.",
                            recognition: "네가 느꼈다는 그 사실만으로도, 그 위로는 성공한 거야. 완전히 닿았어.",
                            regret: "후회하지 마. 그때는 그럴 수밖에 없었던 거야. 지금 이렇게 기억해주는 것만으로도 충분해.",
                            understanding: "이해한다는 것은 시간을 뛰어넘는 위로야. 그 사람도 지금 느끼고 있을 거야.",
                            acceptance: "이제 받아들일 준비가 됐구나. 그 위로가 다시 흘러들어올 수 있어.",
                            connection: "마음과 마음이 이어진 거야. 거리는 중요하지 않았어.",
                            healing: "그 위로가 시간을 거슬러 올라가서, 상처를 치유하고 있어.",
                            love: "사랑은 닿지 않아도 전해져. 네가 그걸 증명했어.",
                            general: "그 말은 늦지 않았어. 위로는 종종… 마음을 통해 천천히 도착하니까."
                        },
                        en: {
                            gratitude: "Those words aren't too late. Comfort often... arrives slowly through the heart.",
                            recognition: "Just the fact that you felt it means that comfort succeeded. It reached you completely.",
                            regret: "Don't regret it. You had no choice back then. Just remembering it like this now is enough.",
                            understanding: "Understanding is comfort that transcends time. That person is probably feeling it now too.",
                            acceptance: "Now you're ready to accept it. That comfort can flow into you again.",
                            connection: "Heart connected to heart. Distance didn't matter.",
                            healing: "That comfort is traveling back through time, healing the wounds.",
                            love: "Love is conveyed even when it doesn't reach. You proved that.",
                            general: "Those words aren't too late. Comfort often... arrives slowly through the heart."
                        },
                        pt: {
                            gratitude: "Essas palavras não são tarde demais. O conforto frequentemente... chega devagar através do coração.",
                            recognition: "Apenas o fato de você ter sentido isso significa que aquele conforto foi bem-sucedido. Te alcançou completamente.",
                            regret: "Não se arrependa. Você não tinha escolha naquela época. Apenas lembrar disso assim agora é suficiente.",
                            understanding: "Entender é conforto que transcende o tempo. Aquela pessoa provavelmente está sentindo isso agora também.",
                            acceptance: "Agora você está pronto para aceitar. Aquele conforto pode fluir para você novamente.",
                            connection: "Coração conectado ao coração. A distância não importava.",
                            healing: "Aquele conforto está viajando de volta no tempo, curando as feridas.",
                            love: "O amor é transmitido mesmo quando não alcança. Você provou isso.",
                            general: "Essas palavras não são tarde demais. O conforto frequentemente... chega devagar através do coração."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            gratitude: "지금 그 감사를 말한 네가 오히려 누군가의 위로가 될 수 있어.",
                            recognition: "인식하는 순간, 그 위로는 완성됐어. 닿지 않은 게 아니라 다른 방식으로 도달한 거야.",
                            regret: "후회는 과거를 붙잡지만, 감사는 과거를 자유롭게 해줘.",
                            understanding: "이해는 가장 깊은 형태의 위로야. 시간의 벽도 뛰어넘어.",
                            acceptance: "받아들이는 마음이 생긴 순간, 모든 위로가 다시 가능해져.",
                            connection: "진정한 연결은 물리적 접촉을 넘어서. 지금 그 연결을 느끼고 있어.",
                            healing: "치유는 지금 이 순간에도 일어나고 있어. 과거와 현재가 함께 아물어가.",
                            love: "사랑은 시공간을 초월해. 네가 그 증거야.",
                            general: "지금 그 감사를 말한 네가 오히려 누군가의 위로가 될 수 있어."
                        },
                        en: {
                            gratitude: "You, who expressed that gratitude now, can become someone else's comfort.",
                            recognition: "The moment you recognized it, that comfort was completed. It didn't fail to reach - it arrived in a different way.",
                            regret: "Regret holds onto the past, but gratitude sets the past free.",
                            understanding: "Understanding is the deepest form of comfort. It even transcends the walls of time.",
                            acceptance: "The moment you developed an accepting heart, all comfort became possible again.",
                            connection: "True connection goes beyond physical touch. You're feeling that connection now.",
                            healing: "Healing is happening even at this moment. Past and present are healing together.",
                            love: "Love transcends time and space. You are the proof of that.",
                            general: "You, who expressed that gratitude now, can become someone else's comfort."
                        },
                        pt: {
                            gratitude: "Você, que expressou essa gratidão agora, pode se tornar o conforto de outra pessoa.",
                            recognition: "No momento em que você reconheceu isso, aquele conforto foi completado. Não falhou em alcançar - chegou de uma maneira diferente.",
                            regret: "O arrependimento se agarra ao passado, mas a gratidão liberta o passado.",
                            understanding: "Entender é a forma mais profunda de conforto. Até transcende as paredes do tempo.",
                            acceptance: "No momento em que você desenvolveu um coração que aceita, todo conforto se tornou possível novamente.",
                            connection: "A verdadeira conexão vai além do toque físico. Você está sentindo essa conexão agora.",
                            healing: "A cura está acontecendo mesmo neste momento. Passado e presente estão se curando juntos.",
                            love: "O amor transcende tempo e espaço. Você é a prova disso.",
                            general: "Você, que expressou essa gratidão agora, pode se tornar o conforto de outra pessoa."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Enya", emoji: "🧑‍🚀",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            gratitude: "너는 그 손을 놓친 게 아니라 지금, 마음으로 다시 잡고 있어.",
                            recognition: "그걸 알아봤다는 것 자체가 기적이야. 우주는 때로 이런 식으로 연결해줘.",
                            regret: "후회는 우주선의 연료가 될 수 없어. 하지만 감사는 새로운 궤도를 만들어줘.",
                            understanding: "이해는 빛의 속도보다 빨라. 지금 그 사람에게도 닿았을 거야.",
                            acceptance: "받아들이는 순간, 너는 더 이상 혼자 떠도는 행성이 아니야.",
                            connection: "우주에서 가장 강한 힘은 중력이 아니라 마음의 연결이야.",
                            healing: "치유는 시간여행 같아. 과거의 상처를 현재의 사랑으로 감싸주는 거야.",
                            love: "사랑은 우주에서 가장 빠른 신호야. 어떤 거리든 뛰어넘어.",
                            general: "너는 그 손을 놓친 게 아니라 지금, 마음으로 다시 잡고 있어."
                        },
                        en: {
                            gratitude: "You didn't miss that hand - now, you're holding it again with your heart.",
                            recognition: "The very fact that you recognized it is a miracle. The universe sometimes connects us this way.",
                            regret: "Regret can't become fuel for a spaceship. But gratitude creates new orbits.",
                            understanding: "Understanding is faster than the speed of light. It probably reached that person now too.",
                            acceptance: "The moment you accept, you're no longer a planet drifting alone.",
                            connection: "The strongest force in the universe isn't gravity, but the connection of hearts.",
                            healing: "Healing is like time travel. Wrapping past wounds with present love.",
                            love: "Love is the fastest signal in the universe. It leaps over any distance.",
                            general: "You didn't miss that hand - now, you're holding it again with your heart."
                        },
                        pt: {
                            gratitude: "Você não perdeu aquela mão - agora, você está segurando-a novamente com seu coração.",
                            recognition: "O próprio fato de você ter reconhecido isso é um milagre. O universo às vezes nos conecta dessa forma.",
                            regret: "O arrependimento não pode se tornar combustível para uma nave espacial. Mas a gratidão cria novas órbitas.",
                            understanding: "Entender é mais rápido que a velocidade da luz. Provavelmente alcançou aquela pessoa agora também.",
                            acceptance: "No momento em que você aceita, você não é mais um planeta à deriva sozinho.",
                            connection: "A força mais forte do universo não é a gravidade, mas a conexão dos corações.",
                            healing: "A cura é como viagem no tempo. Envolvendo feridas passadas com amor presente.",
                            love: "O amor é o sinal mais rápido do universo. Salta sobre qualquer distância.",
                            general: "Você não perdeu aquela mão - agora, você está segurando-a novamente com seu coração."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 15가 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 15 will be ready soon!' :
                    'Portal 15 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 14를 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 14?' :
                    'Deseja reiniciar o Portal 14?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-14",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-14",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 14 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 14 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>