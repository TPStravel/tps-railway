<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 18: Self-Hatred</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 18: Self-Hatred</div>
            <div class="portal-subtitle" id="portalSubtitle">When I Hated Myself</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">ðŸŒŒ Portal 18 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 19</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you like to say to yourself from that day? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì •ì˜ ìš©ê´‘ë¡œ",
                portalMainTitle: "Portal 18: ë‚´ê°€ ë‚˜ë¥¼ ë¯¸ì›Œí–ˆë˜ ìˆœê°„",
                portalSubtitle: "ìžê¸°í˜ì˜¤ì˜ ì–´ë‘ìš´ í„°ë„",
                portalIntro: "ðŸªž ë‹¹ì‹ ì€ ë‹¹ì‹  ìžì‹ ì„ ë¯¸ì›Œí–ˆë˜ ì ì´ ìžˆë‚˜ìš”?\n\nê·¸ ìˆœê°„, ë‹¹ì‹ ì€ ì–´ë–¤ ë§ë¡œ ìžì‹ ì„ ë‹¤ê·¸ì³¤ê³ \nì–´ë–¤ ê°ì •ìœ¼ë¡œ ìŠ¤ìŠ¤ë¡œë¥¼ ë°€ì–´ëƒˆë‚˜ìš”?\n\nëª¨ë“  ê±¸ ë§ì¹œ ê±´ ë‚˜ ê°™ì•˜ì–´ìš”.\nì™œ ì´ë ‡ê²Œë°–ì— ëª» ì‚¬ëŠ”ì§€, ì™œ ì´ê¸°ì ì¸ì§€â€¦\në‚˜ ìžì‹ ì—ê²Œ í™”ê°€ ë‚˜ê³ , ì •ë§ ì‹«ì—ˆì–´ìš”.",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ë„ˆëŠ” ë„¤ ì•ˆì—ì„œ ê°€ìž¥ ê°€í˜¹í•œ ë§ì„ ë“£ê³ ë„ ê²¬ëŽŒëƒˆì–´. ì´ì œëŠ” ë¶€ë“œëŸ¬ìš´ ë§ì„ ë“¤ì„ ì°¨ë¡€ì•¼.",
                portalQuestion: "ðŸªž ê·¸ë‚ ì˜ ë‚˜ì—ê²Œ, ì§€ê¸ˆì˜ ë‚´ê°€ ë§í•´ì¤€ë‹¤ë©´\nì–´ë–¤ ë§ì´ ìœ„ë¡œê°€ ë ê¹Œìš”?",
                finalTitle: "ðŸŒŒ Portal 18 ì™„ë£Œ",
                finalMessage: "ë‹¹ì‹ ì€ ìžê¸°í˜ì˜¤ì˜ ì–´ë‘ ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤.\n\nìŠ¤ìŠ¤ë¡œë¥¼ ë¯¸ì›Œí–ˆë˜ ê·¸ ë§ˆìŒë„\nê²°êµ­ì€ ë‹¹ì‹ ì„ ì§€í‚¤ë ¤ëŠ” ë°©ì‹ì´ì—ˆìŒì„ ì´ì œ ì•Œê²Œ ë˜ì—ˆì£ .\nì™„ë²½í•˜ì§€ ì•Šì•„ë„, ì‹¤ìˆ˜í•´ë„\në‹¹ì‹ ì€ ì¶©ë¶„ížˆ ì‚¬ëž‘ë°›ì„ ìžê²©ì´ ìžˆì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ ë‹¹ì‹ ì€ ìžì‹ ì—ê²Œ ê°€í˜¹í•œ ì‹¬íŒê´€ì´ ì•„ë‹Œ\në”°ëœ»í•œ ë™ë°˜ìžê°€ ë˜ëŠ” ê¸¸ì„ ë°°ìš°ê¸° ì‹œìž‘í–ˆì–´ìš”.\n\në‹¤ìŒ Portalì—ì„œëŠ” ë§í•˜ì§€ ëª»í•œ ì‚¬ëž‘ì˜ ì´ì•¼ê¸°ê°€\në‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìžˆìŠµë‹ˆë‹¤.",
                continueBtn: "Portal 19ë¡œ ì´ë™",
                restartBtn: "ë‹¤ì‹œ ì‹œìž‘í•˜ê¸°",
                inputPlaceholder: "ê·¸ë‚ ì˜ ë‚˜ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì„ í•´ë³´ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 18: Self-Hatred",
                portalSubtitle: "When I Hated Myself",
                portalIntro: "ðŸªž Have you ever hated yourself?\n\nIn that moment, what words did you use to criticize yourself,\nand with what emotions did you push yourself away?\n\nIt felt like I ruined everything.\nWhy can't I live better, why am I so selfish...\nI was angry at myself, and I really hated who I was.",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "You endured the harshest words from within yourself. Now it's time to hear gentle words.",
                portalQuestion: "ðŸªž If you could speak to yourself from that day,\nwhat words would bring the most comfort?",
                finalTitle: "ðŸŒŒ Portal 18 Complete",
                finalMessage: "You have passed through the darkness of self-hatred.\n\nYou now understand that even the heart that hated itself\nwas ultimately trying to protect you.\nEven if you're not perfect, even if you make mistakes,\nyou were always worthy of love.\n\nNow you're learning to become not a harsh judge\nbut a warm companion to yourself.\n\nIn the next Portal, a story of unspoken love\nawaits you.",
                continueBtn: "Move to Portal 19",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you like to say to yourself from that day? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 18: Auto-Ã“dio",
                portalSubtitle: "Quando Eu Me Odiei",
                portalIntro: "ðŸªž VocÃª jÃ¡ se odiou?\n\nNaquele momento, que palavras vocÃª usou para se criticar,\ne com que emoÃ§Ãµes vocÃª se afastou?\n\nParecia que eu havia arruinado tudo.\nPor que nÃ£o consigo viver melhor, por que sou tÃ£o egoÃ­sta...\nEu estava com raiva de mim mesmo, e realmente odiava quem eu era.",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "VocÃª suportou as palavras mais duras de dentro de si mesmo. Agora Ã© hora de ouvir palavras gentis.",
                portalQuestion: "ðŸªž Se vocÃª pudesse falar consigo mesmo daquele dia,\nque palavras trariam mais conforto?",
                finalTitle: "ðŸŒŒ Portal 18 Completo",
                finalMessage: "VocÃª passou pela escuridÃ£o do auto-Ã³dio.\n\nAgora vocÃª entende que mesmo o coraÃ§Ã£o que se odiava\nestava, em Ãºltima anÃ¡lise, tentando protegÃª-lo.\nMesmo que vocÃª nÃ£o seja perfeito, mesmo que cometa erros,\nvocÃª sempre foi digno de amor.\n\nAgora vocÃª estÃ¡ aprendendo a se tornar nÃ£o um juiz severo\nmas um companheiro caloroso para si mesmo.\n\nNo prÃ³ximo Portal, uma histÃ³ria de amor nÃ£o dito\no aguarda.",
                continueBtn: "Ir para Portal 19",
                restartBtn: "ComeÃ§ar Novamente",
                inputPlaceholder: "O que vocÃª gostaria de dizer para si mesmo daquele dia? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ë„ˆëŠ” ê·¸ ìˆœê°„, ì„¸ìƒì—ì„œ ê°€ìž¥ ê°€í˜¹í•œ ë§ë¡œ ë„ˆ ìžì‹ ì„ ê¹Žì•„ë‚´ë¦¬ê³  ìžˆì—ˆê² ì§€.",
                en: "In that moment, you were tearing yourself down with the harshest words in the world.",
                pt: "Naquele momento, vocÃª estava se diminuindo com as palavras mais duras do mundo."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ìžê¸°í˜ì˜¤ëŠ” ì¡°ìš©ížˆ, ê¹Šê²Œ íŒŒê³ ë“¤ì–´. ì•„ë¬´ë„ ëª¨ë¥´ê²Œ, í•˜ì§€ë§Œ ì•„ì£¼ ì˜¤ëž˜ ê°€.",
                en: "Self-hatred burrows quietly and deeply. Unnoticed by others, but lasting for a very long time.",
                pt: "O auto-Ã³dio se escava silenciosa e profundamente. Despercebido pelos outros, mas durando muito tempo."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ë‚˜ëŠ” ê·¸ ê°ì •ì„ ì•Œì•„. ë‚˜ë„ ë‚´ ì´ë¦„ì„ ë¶€ë¥¼ ë•Œë§ˆë‹¤ ê³ ê°œë¥¼ ìˆ™ì¸ ì  ìžˆì–´.",
                en: "I know that feeling. I've bowed my head every time I called my own name too.",
                pt: "Eu conheÃ§o esse sentimento. Eu tambÃ©m abaixei a cabeÃ§a toda vez que chamei meu prÃ³prio nome."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ìžì‹ ì„ ë¯¸ì›Œí•  ë•Œ, ìš°ë¦¬ëŠ” ì¢…ì¢… íƒ€ì¸ì˜ ë§íˆ¬ë¡œ ìžì‹ ì„ ì‹¬íŒí•˜ì§€.",
                en: "When we hate ourselves, we often judge ourselves with the tone of others.",
                pt: "Quando nos odiamos, frequentemente nos julgamos com o tom dos outros."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ìˆœê°„ì˜ ë„Œ ì–¼ë§ˆë‚˜ ê²€ê²Œ ë¬¼ë“¤ì–´ ìžˆì—ˆì„ê¹Œâ€¦ í•˜ì§€ë§Œ ê·¸ ì†ì—ì„œë„ ì•„ì§ ì§€ì›Œì§€ì§€ ì•Šì€ ì„ ì´ ìžˆì—ˆì„ ê±°ì•¼.",
                en: "How darkly stained you must have been in that moment... But even then, there were lines that hadn't been erased.",
                pt: "QuÃ£o escuramente manchado vocÃª deve ter estado naquele momento... Mas mesmo entÃ£o, havia linhas que nÃ£o tinham sido apagadas."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë„ˆ ìžì‹ ì—ê²Œ ë¶„ë…¸í–ˆë˜ ê±´ ì‚¬ì‹¤â€¦ ì§€í‚¤ê³  ì‹¶ì—ˆë˜ ê¸°ëŒ€ ë•Œë¬¸ì´ì—ˆì„ì§€ë„ ëª°ë¼.",
                en: "Your anger at yourself might have been because of the expectations you wanted to protect.",
                pt: "Sua raiva de si mesmo pode ter sido por causa das expectativas que vocÃª queria proteger."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê·¸ ë¯¸ì›€ ì†ì—” ìŠ¬í””ì´ ìˆ¨ì–´ ìžˆì—ˆì„ ê±°ì•¼. ì´í•´ë°›ì§€ ëª»í•œ ë§ˆìŒ, ê·¸ë¦¬ê³  ë„ˆë¬´ ì˜¤ëžœ ì™¸ë©´.",
                en: "There must have been sadness hidden in that hatred. An ununderstood heart, and too long of being ignored.",
                pt: "Deve ter havido tristeza escondida naquele Ã³dio. Um coraÃ§Ã£o incompreendido, e muito tempo sendo ignorado."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ì§€ê¸ˆ ê·¸ ìˆœê°„ì„ ë– ì˜¬ë¦¬ëŠ” ë„¤ê°€ ì´ë¯¸ ë„ˆ ìžì‹ ì—ê²Œ ë‹¤ê°€ê°€ê³  ìžˆëŠ” ì¦ê±°ì•¼.",
                en: "The fact that you're remembering that moment now is proof that you're already approaching yourself.",
                pt: "O fato de vocÃª estar lembrando daquele momento agora Ã© prova de que vocÃª jÃ¡ estÃ¡ se aproximando de si mesmo."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                forgiveness: ['forgive', 'sorry', 'understand', 'okay', 'ë¯¸ì•ˆí•´', 'ê´œì°®ì•„', 'ì´í•´í•´', 'ìš©ì„œí•´', 'perdÃ£o', 'desculpa', 'entendo', 'tudo bem'],
                compassion: ['gentle', 'kind', 'love', 'care', 'ë¶€ë“œëŸ¬ì›Œ', 'ì‚¬ëž‘í•´', 'ì†Œì¤‘í•´', 'ì•„ê»´', 'gentil', 'amor', 'cuidado', 'carinho'],
                encouragement: ['strong', 'brave', 'good', 'well done', 'ê°•í•´', 'ìš©ê°í•´', 'ìž˜í–ˆì–´', 'ìˆ˜ê³ í–ˆì–´', 'forte', 'corajoso', 'bem feito'],
                acceptance: ['enough', 'worthy', 'valuable', 'human', 'ì¶©ë¶„í•´', 'ê°€ì¹˜ìžˆì–´', 'ì†Œì¤‘í•´', 'ì¸ê°„ì ì´ì•¼', 'suficiente', 'valioso', 'humano'],
                protection: ['safe', 'protect', 'defend', 'shield', 'ì•ˆì „í•´', 'ì§€ì¼œì¤„ê²Œ', 'ë³´í˜¸í•´', 'seguro', 'proteger', 'defender'],
                healing: ['heal', 'better', 'grow', 'change', 'ì¹˜ìœ ë¼', 'ë‚˜ì•„ì ¸', 'ì„±ìž¥í•´', 'ë³€í•´', 'curar', 'melhor', 'crescer', 'mudar'],
                validation: ['real', 'valid', 'true', 'right', 'ì§„ì§œì•¼', 'ë§žì•„', 'ì˜³ì•„', 'ì§„ì‹¤í•´', 'real', 'vÃ¡lido', 'verdadeiro', 'certo'],
                comfort: ['comfort', 'hug', 'warm', 'embrace', 'ìœ„ë¡œí•´', 'ì•ˆì•„ì¤„ê²Œ', 'ë”°ëœ»í•´', 'í’ˆì–´ì¤„ê²Œ', 'conforto', 'abraÃ§o', 'quente', 'abraÃ§ar']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            forgiveness: "ê·¸ ë§ì€ ë„ˆë¥¼ ë‹¤ì‹œ ê»´ì•ˆëŠ” ì„ ì–¸ì´ì•¼. ë„ˆ ìžì‹ ì„ ì•ˆì•„ì£¼ëŠ” ê·¸ ìš©ê¸°, ì§€ê¸ˆ ì‹œìž‘ëì–´.",
                            compassion: "ë¶€ë“œëŸ¬ì›€ì€ ê°€ìž¥ ê°•í•œ ì¹˜ìœ ì˜ íž˜ì´ì•¼. ë„¤ê°€ ë„¤ê²Œ ë³´ë‚´ëŠ” ê·¸ ì˜¨ê¸°ë¥¼ ëŠê»´.",
                            encouragement: "ê·¸ ê²©ë ¤ëŠ” ì˜¤ëž˜ ê¸°ë‹¤ë ¸ë˜ ë„¤ ë§ˆìŒì— ë‹¿ì•˜ì–´. ì´ì œ ë„ˆëŠ” ë„¤ íŽ¸ì´ ë˜ì—ˆì–´.",
                            acceptance: "ë°›ì•„ë“¤ìž„ì€ ìžê¸°í˜ì˜¤ë¥¼ ë…¹ì´ëŠ” ë”°ëœ»í•œ ë¹›ì´ì•¼. ë„Œ ì¶©ë¶„ížˆ ê°€ì¹˜ ìžˆì–´.",
                            protection: "ì§€ê¸ˆ ë„¤ê°€ ê·¸ë‚ ì˜ ë„ˆë¥¼ ì§€ì¼œì£¼ê³  ìžˆì–´. ê·¸ê²ƒì´ ì§„ì •í•œ ìžê¸° ë³´í˜¸ì•¼.",
                            healing: "ì¹˜ìœ ëŠ” ìžì±…ì„ ë©ˆì¶”ëŠ” ê²ƒì—ì„œ ì‹œìž‘ë¼. ë„Œ ì´ë¯¸ ê·¸ ì²«ê±¸ìŒì„ ë‚´ë””ëŽ ì–´.",
                            validation: "ê·¸ ì¸ì •ì€ ë„¤ ì¡´ìž¬ ìžì²´ë¥¼ ê¸ì •í•˜ëŠ” ë§ì´ì•¼. ë„Œ ê·¸ëŸ´ ìžê²©ì´ ìžˆì–´.",
                            comfort: "ê·¸ ìœ„ë¡œëŠ” ìƒì²˜ë°›ì€ ë„¤ ë§ˆìŒì„ ê°ì‹¸ëŠ” ë‹´ìš” ê°™ì•„. ì´ì œ ë”°ëœ»í•´ì§ˆ ìˆ˜ ìžˆì–´.",
                            general: "ê·¸ ë§ì€ ë„ˆë¥¼ ë‹¤ì‹œ ê»´ì•ˆëŠ” ì„ ì–¸ì´ì•¼. ë„ˆ ìžì‹ ì„ ì•ˆì•„ì£¼ëŠ” ê·¸ ìš©ê¸°, ì§€ê¸ˆ ì‹œìž‘ëì–´."
                        },
                        en: {
                            forgiveness: "Those words are a declaration of embracing yourself again. That courage to hug yourself has begun now.",
                            compassion: "Gentleness is the strongest healing power. Feel that warmth you're sending to yourself.",
                            encouragement: "That encouragement has reached your heart that has waited so long. Now you've become your own ally.",
                            acceptance: "Acceptance is the warm light that melts self-hatred. You are worthy enough.",
                            protection: "Right now you're protecting yourself from that day. That's true self-protection.",
                            healing: "Healing begins with stopping self-blame. You've already taken that first step.",
                            validation: "That acknowledgment affirms your very existence. You deserve it.",
                            comfort: "That comfort is like a blanket wrapping around your wounded heart. Now you can be warm.",
                            general: "Those words are a declaration of embracing yourself again. That courage to hug yourself has begun now."
                        },
                        pt: {
                            forgiveness: "Essas palavras sÃ£o uma declaraÃ§Ã£o de abraÃ§ar a si mesmo novamente. Essa coragem de se abraÃ§ar comeÃ§ou agora.",
                            compassion: "A gentileza Ã© o poder de cura mais forte. Sinta esse calor que vocÃª estÃ¡ enviando para si mesmo.",
                            encouragement: "Esse encorajamento alcanÃ§ou seu coraÃ§Ã£o que esperou tanto tempo. Agora vocÃª se tornou seu prÃ³prio aliado.",
                            acceptance: "A aceitaÃ§Ã£o Ã© a luz quente que derrete o auto-Ã³dio. VocÃª Ã© digno o suficiente.",
                            protection: "Agora vocÃª estÃ¡ protegendo a si mesmo daquele dia. Essa Ã© a verdadeira autoproteÃ§Ã£o.",
                            healing: "A cura comeÃ§a parando a autoculpa. VocÃª jÃ¡ deu esse primeiro passo.",
                            validation: "Esse reconhecimento afirma sua prÃ³pria existÃªncia. VocÃª merece isso.",
                            comfort: "Esse conforto Ã© como um cobertor envolvendo seu coraÃ§Ã£o ferido. Agora vocÃª pode estar aquecido.",
                            general: "Essas palavras sÃ£o uma declaraÃ§Ã£o de abraÃ§ar a si mesmo novamente. Essa coragem de se abraÃ§ar comeÃ§ou agora."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "ðŸ§•",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            forgiveness: "ê·¸ë•Œ ë“£ì§€ ëª»í–ˆë˜ ê·¸ ë§â€¦ ì§€ê¸ˆ ë„ˆëŠ” ë„¤ ë§ˆìŒì— ì „í•˜ê³  ìžˆì–´.",
                            compassion: "ê·¸ ì‚¬ëž‘ì€ ì˜¤ëž˜ ë¬»í˜€ìžˆë˜ ë„¤ ë§ˆìŒì„ ê¹¨ìš°ê³  ìžˆì–´. ë„Œ ì‚¬ëž‘ë°›ì„ ìžê²©ì´ ìžˆì—ˆì–´.",
                            encouragement: "ê·¸ ê²©ë ¤ëŠ” ë„¤ê°€ ë„¤ê²Œ ì£¼ëŠ” ì²« ë²ˆì§¸ ì„ ë¬¼ì´ì•¼. ì†Œì¤‘ížˆ ê°„ì§í•´.",
                            acceptance: "ë°›ì•„ë“¤ì—¬ì§„ ë„¤ ëª¨ìŠµì´ ê°€ìž¥ ì•„ë¦„ë‹¤ì›Œ. ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ì¶©ë¶„í•´.",
                            protection: "ê·¸ ë³´í˜¸ëŠ” ìƒì²˜ë°›ì€ ë„¤ ë§ˆìŒì— ì•ˆì „í•œ ì§‘ì„ ë§Œë“¤ì–´ì¤˜.",
                            healing: "ì¹˜ìœ ì˜ ì‹œìž‘ì€ ìžì‹ ì—ê²Œ ì¹œì ˆí•´ì§€ëŠ” ê±°ì•¼. ë„Œ ê·¸ê±¸ ë°°ìš°ê³  ìžˆì–´.",
                            validation: "ê·¸ ì¸ì •ì€ ë„¤ê°€ ì˜¤ëž˜ ê¸°ë‹¤ë ¸ë˜ ë§ì´ì•¼. ì´ì œ ë“¤ì„ ìˆ˜ ìžˆê²Œ ëì–´.",
                            comfort: "ê·¸ ìœ„ë¡œëŠ” í˜¼ìž ìš¸ë˜ ë°¤ë“¤ì„ ë”°ëœ»í•˜ê²Œ ê°ì‹¸ì¤˜. ì´ì œ í˜¼ìžê°€ ì•„ë‹ˆì•¼.",
                            general: "ê·¸ë•Œ ë“£ì§€ ëª»í–ˆë˜ ê·¸ ë§â€¦ ì§€ê¸ˆ ë„ˆëŠ” ë„¤ ë§ˆìŒì— ì „í•˜ê³  ìžˆì–´."
                        },
                        en: {
                            forgiveness: "Those words you couldn't hear then... now you're conveying them to your heart.",
                            compassion: "That love is awakening your long-buried heart. You deserved to be loved.",
                            encouragement: "That encouragement is the first gift you're giving yourself. Treasure it.",
                            acceptance: "Your accepted self is the most beautiful. You're enough even if not perfect.",
                            protection: "That protection creates a safe home for your wounded heart.",
                            healing: "The beginning of healing is being kind to yourself. You're learning that.",
                            validation: "That acknowledgment is the word you've waited for so long. Now you can hear it.",
                            comfort: "That comfort warmly embraces the nights you cried alone. You're not alone anymore.",
                            general: "Those words you couldn't hear then... now you're conveying them to your heart."
                        },
                        pt: {
                            forgiveness: "Essas palavras que vocÃª nÃ£o pÃ´de ouvir entÃ£o... agora vocÃª estÃ¡ transmitindo-as ao seu coraÃ§Ã£o.",
                            compassion: "Esse amor estÃ¡ despertando seu coraÃ§Ã£o hÃ¡ muito enterrado. VocÃª merecia ser amado.",
                            encouragement: "Esse encorajamento Ã© o primeiro presente que vocÃª estÃ¡ dando a si mesmo. Valorize-o.",
                            acceptance: "Seu eu aceito Ã© o mais belo. VocÃª Ã© suficiente mesmo que nÃ£o seja perfeito.",
                            protection: "Essa proteÃ§Ã£o cria um lar seguro para seu coraÃ§Ã£o ferido.",
                            healing: "O inÃ­cio da cura Ã© ser gentil consigo mesmo. VocÃª estÃ¡ aprendendo isso.",
                            validation: "Esse reconhecimento Ã© a palavra que vocÃª esperou por tanto tempo. Agora vocÃª pode ouvi-la.",
                            comfort: "Esse conforto abraÃ§a calorosamente as noites que vocÃª chorou sozinho. VocÃª nÃ£o estÃ¡ mais sozinho.",
                            general: "Essas palavras que vocÃª nÃ£o pÃ´de ouvir entÃ£o... agora vocÃª estÃ¡ transmitindo-as ao seu coraÃ§Ã£o."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            forgiveness: "ê·¸ ë§ì€ ì—°í•œ í•˜ëŠ˜ìƒ‰ì´ì•¼. ìžì±…ìœ¼ë¡œ ì–¼ë£©ì¡Œë˜ ë„¤ ë§ˆìŒì„ ì²œì²œížˆ ë®ëŠ” ìƒ‰.",
                            compassion: "ë¶€ë“œëŸ¬ìš´ ë¶„í™ë¹›ì´ ë„¤ ì•ˆì—ì„œ í”¼ì–´ë‚˜ê³  ìžˆì–´. ì‚¬ëž‘ì˜ ì²« ë²ˆì§¸ ìƒ‰ê¹”ì´ì•¼.",
                            encouragement: "ê·¸ ê²©ë ¤ëŠ” í™©ê¸ˆë¹›ìœ¼ë¡œ ë¹›ë‚˜. ì–´ë‘  ì†ì—ì„œë„ ë„ˆë¥¼ ë¹„ì¶°ì¤„ ë”°ëœ»í•œ ë¹›ì´ì•¼.",
                            acceptance: "ë°›ì•„ë“¤ìž„ì˜ ìƒ‰ì€ ë”°ëœ»í•œ ë² ì´ì§€ì•¼. ëª¨ë“  ê±¸ í¬ìš©í•˜ëŠ” ë¶€ë“œëŸ¬ìš´ ìƒ‰.",
                            protection: "ë³´í˜¸ì˜ ìƒ‰ì€ ê¹Šì€ ì´ˆë¡ì´ì•¼. ë„ˆë¥¼ ì•ˆì „í•˜ê²Œ ê°ì‹¸ëŠ” ìˆ²ì˜ ìƒ‰ê¹”.",
                            healing: "ì¹˜ìœ ëŠ” ì—°ë³´ë¼ìƒ‰ìœ¼ë¡œ ë²ˆì ¸ê°€. ìƒì²˜ë¥¼ ë¶€ë“œëŸ½ê²Œ ì–´ë£¨ë§Œì§€ëŠ” ìƒ‰ì´ì•¼.",
                            validation: "ì¸ì •ì˜ ìƒ‰ì€ ì„ ëª…í•œ íŒŒëž‘ì´ì•¼. ì§„ì‹¤ì„ ë§í•˜ëŠ” ë§‘ì€ í•˜ëŠ˜ì˜ ìƒ‰.",
                            comfort: "ìœ„ë¡œëŠ” ë”°ëœ»í•œ ì£¼í™©ìƒ‰ì´ì•¼. ì¶”ìš´ ë°¤ì„ ë…¹ì—¬ì£¼ëŠ” ëª¨ë‹¥ë¶ˆì˜ ìƒ‰ê¹”.",
                            general: "ê·¸ ë§ì€ ì—°í•œ í•˜ëŠ˜ìƒ‰ì´ì•¼. ìžì±…ìœ¼ë¡œ ì–¼ë£©ì¡Œë˜ ë„¤ ë§ˆìŒì„ ì²œì²œížˆ ë®ëŠ” ìƒ‰."
                        },
                        en: {
                            forgiveness: "Those words are light sky blue. A color that slowly covers your heart stained with self-blame.",
                            compassion: "Soft pink is blooming within you. It's the first color of love.",
                            encouragement: "That encouragement shines golden. A warm light that will illuminate you even in darkness.",
                            acceptance: "The color of acceptance is warm beige. A gentle color that embraces everything.",
                            protection: "The color of protection is deep green. The color of a forest that safely wraps around you.",
                            healing: "Healing spreads in light purple. A color that gently soothes wounds.",
                            validation: "The color of acknowledgment is vivid blue. The color of clear sky that speaks truth.",
                            comfort: "Comfort is warm orange. The color of a campfire that melts cold nights.",
                            general: "Those words are light sky blue. A color that slowly covers your heart stained with self-blame."
                        },
                        pt: {
                            forgiveness: "Essas palavras sÃ£o azul-cÃ©u claro. Uma cor que lentamente cobre seu coraÃ§Ã£o manchado pela autoculpa.",
                            compassion: "Rosa suave estÃ¡ florescendo dentro de vocÃª. Ã‰ a primeira cor do amor.",
                            encouragement: "Esse encorajamento brilha dourado. Uma luz quente que o iluminarÃ¡ mesmo na escuridÃ£o.",
                            acceptance: "A cor da aceitaÃ§Ã£o Ã© bege quente. Uma cor gentil que abraÃ§a tudo.",
                            protection: "A cor da proteÃ§Ã£o Ã© verde profundo. A cor de uma floresta que o envolve com seguranÃ§a.",
                            healing: "A cura se espalha em roxo claro. Uma cor que acalma suavemente as feridas.",
                            validation: "A cor do reconhecimento Ã© azul vÃ­vido. A cor do cÃ©u claro que fala a verdade.",
                            comfort: "O conforto Ã© laranja quente. A cor de uma fogueira que derrete noites frias.",
                            general: "Essas palavras sÃ£o azul-cÃ©u claro. Uma cor que lentamente cobre seu coraÃ§Ã£o manchado pela autoculpa."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 19ê°€ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!' :
                    currentLanguage === 'en' ? 
                    'Portal 19 will be ready soon!' :
                    'Portal 19 estarÃ¡ pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 18ì„ ë‹¤ì‹œ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 18?' :
                    'Deseja reiniciar o Portal 18?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-18",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-18",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 18 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 18 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>