<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 09: The Fragments of Broken Silence</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 09: The Fragments of Broken Silence</div>
            <div class="portal-subtitle" id="portalSubtitle">When the Silence Finally Shattered</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">🪞 Portal 09 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 10</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you like to say to that emotion that burst out that day? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 09: 부서진 침묵의 조각",
                portalSubtitle: "침묵이 마침내 깨어진 순간",
                portalIntro: "🪞 깨어진 건 침묵이었을까요, 아니면 당신 자신이었을까요?\n\n어느 날 그냥 터졌을 거예요. 아무도 예상하지 못한 순간에.\n당신조차 놀랐겠죠. 그동안 눌러왔던 말들이 갑자기 튀어나와 버렸을 때.\n\n그 침묵은 오랫동안 쌓인 파도였습니다.\n결국 터질 수밖에 없는 운명이었어요.\n\n\"왜 항상 끝까지 참아야만 했을까?\"\n\"그 폭발은 내 잘못이 아니었어.\"\n\"그건 정당한 반응이었어.\"\n\n그 조각 속에서, 당신은 어떤 감정을 가장 먼저 마주했나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "부서진 조각들을 모으려 하지 않아도 됩니다. 깨진 채로도 당신은 계속 숨 쉴 수 있습니다.",
                portalQuestion: "🪞 그날 터져 나온 감정에게, 지금 당신은 어떤 말을 해주고 싶나요?",
                finalTitle: "🪞 Portal 09 완료",
                finalMessage: "당신은 용기 있게 부서진 침묵의 조각들을 마주했습니다.\n\n그동안 억눌러왔던 감정이 터져나왔던 그 순간을\n더 이상 부끄러워하지 않게 되었죠.\n\n그 감정은 당신을 보호하려던 목소리였다는 것을\n이제는 이해할 수 있게 되었습니다.\n\n다음 Portal에서는 당신도 몰랐던\n자신의 표정을 발견하는 여정이 이어집니다.",
                continueBtn: "Portal 10으로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "그날 터져나온 감정에게 지금 어떤 말을 해주고 싶은지 말해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 09: The Fragments of Broken Silence",
                portalSubtitle: "When the Silence Finally Shattered",
                portalIntro: "🪞 What broke—was it the silence, or was it you yourself?\n\nOne day it just burst out. In a moment no one expected.\nYou were probably surprised too. When the words you'd been holding down suddenly erupted.\n\nThat silence was a wave that had been building for a long time.\nIt was destined to burst eventually.\n\n\"Why did I always have to endure until the very end?\"\n\"That explosion wasn't my fault.\"\n\"It was a justified reaction.\"\n\nAmidst those fragments, which emotion did you encounter first?",
                lightTitle: "✨ Word of Light",
                lightMessage: "You don't need to gather the broken pieces. Even while shattered, you can continue breathing.",
                portalQuestion: "🪞 What would you like to say to that emotion that burst out that day?",
                finalTitle: "🪞 Portal 09 Complete",
                finalMessage: "You have courageously faced the fragments of broken silence.\n\nYou no longer feel ashamed of that moment\nwhen your suppressed emotions burst forth.\n\nYou can now understand that those emotions\nwere voices trying to protect you.\n\nIn the next Portal, a journey continues\nto discover expressions of yourself\nthat even you didn't know.",
                continueBtn: "Move to Portal 10",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you like to say to that emotion that burst out that day? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 09: Os Fragmentos do Silêncio Quebrado",
                portalSubtitle: "Quando o Silêncio Finalmente se Despedaçou",
                portalIntro: "🪞 O que se quebrou—foi o silêncio, ou foi você mesmo?\n\nUm dia simplesmente explodiu. Em um momento que ninguém esperava.\nVocê provavelmente ficou surpreso também. Quando as palavras que você estava segurando de repente irromperam.\n\nAquele silêncio era uma onda que vinha se formando há muito tempo.\nEstava destinado a explodir eventualmente.\n\n\"Por que eu sempre tinha que aguentar até o fim?\"\n\"Aquela explosão não foi minha culpa.\"\n\"Foi uma reação justificada.\"\n\nEm meio a esses fragmentos, qual emoção você encontrou primeiro?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Você não precisa juntar os pedaços quebrados. Mesmo despedaçado, você pode continuar respirando.",
                portalQuestion: "🪞 O que você gostaria de dizer para aquela emoção que explodiu naquele dia?",
                finalTitle: "🪞 Portal 09 Completo",
                finalMessage: "Você corajosamente enfrentou os fragmentos do silêncio quebrado.\n\nVocê não se sente mais envergonhado daquele momento\nquando suas emoções suprimidas explodiram.\n\nAgora você pode entender que essas emoções\neram vozes tentando protegê-lo.\n\nNo próximo Portal, uma jornada continua\npara descobrir expressões de si mesmo\nque nem você conhecia.",
                continueBtn: "Ir para Portal 10",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "O que você gostaria de dizer para aquela emoção que explodiu naquele dia? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "그 침묵은 오랫동안 쌓인 파도였지. 결국 터질 수밖에 없는 운명이었어.",
                en: "That silence was a wave that had been building for a long time. It was destined to burst eventually.",
                pt: "Aquele silêncio era uma onda que vinha se formando há muito tempo. Estava destinado a explodir eventualmente."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "말하지 않은 감정도 살아 있어. 언젠가는, 반드시 모양을 바꾸어 나오게 되어 있지.",
                en: "Unspoken emotions are also alive. Someday, they are bound to emerge in a different form.",
                pt: "Emoções não faladas também estão vivas. Um dia, elas estão destinadas a emergir em uma forma diferente."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "너는 오래 기다렸고, 오래 참았고, 오래 외로웠어. 그 날은 너의 마지막 방어선이 무너진 순간이었겠지.",
                en: "You waited long, endured long, and were lonely for long. That day was when your last line of defense collapsed.",
                pt: "Você esperou muito, aguentou muito, e ficou solitário por muito tempo. Aquele dia foi quando sua última linha de defesa desabou."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "침묵은 보호막이 되기도 하지만, 감옥이 되기도 해. 그 조각은 네 안의 감옥이 부서진 증거야.",
                en: "Silence can be a shield, but it can also be a prison. Those fragments are evidence that the prison inside you was broken.",
                pt: "O silêncio pode ser um escudo, mas também pode ser uma prisão. Esses fragmentos são evidência de que a prisão dentro de você foi quebrada."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 깨진 조각 속엔 네 진짜 목소리가 비쳤을 거야. 비록 날카로웠어도, 그건 진짜였어.",
                en: "Your true voice must have reflected in those broken fragments. Even though it was sharp, it was real.",
                pt: "Sua verdadeira voz deve ter se refletido naqueles fragmentos quebrados. Mesmo sendo afiada, era real."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "왜 항상 끝까지 참아야만 했을까? 그 폭발은 네 잘못이 아니야. 그건 정당한 반응이었어.",
                en: "Why did you always have to endure until the very end? That explosion wasn't your fault. It was a justified reaction.",
                pt: "Por que você sempre tinha que aguentar até o fim? Aquela explosão não foi sua culpa. Foi uma reação justificada."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "그 순간 너는 너를 해방시킨 거야. 비명을 지른 게 아니라, 생존을 선택한 거지.",
                en: "At that moment, you liberated yourself. You didn't scream—you chose survival.",
                pt: "Naquele momento, você se libertou. Você não gritou—você escolheu a sobrevivência."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "그 조각들을 모으려 하지 않아도 돼. 부서진 채로도 너는 계속 숨 쉴 수 있어.",
                en: "You don't need to gather those fragments. Even while broken, you can continue breathing.",
                pt: "Você não precisa juntar esses fragmentos. Mesmo quebrado, você pode continuar respirando."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                regret: ['sorry', 'regret', 'mistake', 'apologize'],
                understanding: ['understand', 'needed', 'protecting', 'survival'],
                acceptance: ['accept', 'okay', 'fine', 'peace'],
                gratitude: ['thank', 'grateful', 'helped', 'saved'],
                relief: ['relief', 'free', 'liberated', 'released'],
                validation: ['justified', 'right', 'valid', 'normal'],
                compassion: ['tired', 'exhausted', 'enough', 'hard'],
                healing: ['heal', 'better', 'recover', 'grow']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "미안해할 필요 없어. 그 감정은 너를 보호하려 했던 거야.",
                            understanding: "이제야 그 목소리를 이해해줬구나. 그건 네 안의 용기였어.",
                            acceptance: "받아들이는 마음이 보여. 그 순간도 너의 일부였어.",
                            gratitude: "고마워하는 마음이 따뜻해. 그 감정도 네 감사를 기다렸을 거야.",
                            relief: "해방되는 기분이 들지? 이제 숨통이 트인 거야.",
                            validation: "맞아, 그건 정당한 반응이었어. 네가 틀리지 않았어.",
                            compassion: "너무 오래 참았구나. 이제는 스스로를 돌봐줘도 돼.",
                            healing: "치유가 시작됐어. 부서진 곳에서 새로운 빛이 들어올 거야.",
                            general: "그 감정은 너를 보호하려 했어. 비록 서툴렀더라도, 그건 네 안의 용기였어."
                        },
                        en: {
                            regret: "You don't need to apologize. That emotion was trying to protect you.",
                            understanding: "You finally understood that voice. It was courage within you.",
                            acceptance: "I see your accepting heart. That moment was also part of you.",
                            gratitude: "Your grateful heart is warm. That emotion might have been waiting for your thanks.",
                            relief: "You feel liberated, don't you? Now you can breathe freely.",
                            validation: "Yes, it was a justified reaction. You weren't wrong.",
                            compassion: "You endured for too long. Now you can take care of yourself.",
                            healing: "Healing has begun. New light will enter from the broken places.",
                            general: "That emotion was trying to protect you. Even if it was clumsy, it was courage within you."
                        },
                        pt: {
                            regret: "Você não precisa pedir desculpas. Aquela emoção estava tentando protegê-lo.",
                            understanding: "Você finalmente entendeu aquela voz. Era coragem dentro de você.",
                            acceptance: "Vejo seu coração que aceita. Aquele momento também era parte de você.",
                            gratitude: "Seu coração grato é caloroso. Aquela emoção pode ter estado esperando por seu agradecimento.",
                            relief: "Você se sente libertado, não é? Agora pode respirar livremente.",
                            validation: "Sim, foi uma reação justificada. Você não estava errado.",
                            compassion: "Você aguentou por muito tempo. Agora pode cuidar de si mesmo.",
                            healing: "A cura começou. Nova luz entrará dos lugares quebrados.",
                            general: "Aquela emoção estava tentando protegê-lo. Mesmo sendo desajeitada, era coragem dentro de você."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "🧑‍🎨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "그 후회는 이제 새로운 색으로 바뀔 거야. 더 부드러운 색으로.",
                            understanding: "이해의 색은 따뜻한 황금빛이야. 네 안에서 빛나고 있어.",
                            acceptance: "받아들임의 색은 고요한 청록색이야. 마음이 평온해졌어.",
                            gratitude: "감사의 색은 따뜻한 분홍빛이야. 그 온기가 전해져.",
                            relief: "해방의 색은 밝은 하늘색이야. 자유로워진 네 마음처럼.",
                            validation: "그 인정은 강한 보라색이야. 네 진실을 확증해주는 색.",
                            compassion: "자비의 색은 부드러운 연두색이야. 스스로를 치유하는 색.",
                            healing: "치유의 색은 은은한 흰색이야. 모든 상처를 감싸주는 색.",
                            general: "그 목소리는 상처난 예술 같았어. 거칠지만 진실했고, 그래서 더 아름다웠어."
                        },
                        en: {
                            regret: "That regret will change to a new color. A softer color.",
                            understanding: "The color of understanding is warm golden. It's shining within you.",
                            acceptance: "The color of acceptance is calm teal. Your heart has become peaceful.",
                            gratitude: "The color of gratitude is warm pink. I feel that warmth.",
                            relief: "The color of liberation is bright sky blue. Like your freed heart.",
                            validation: "That recognition is strong purple. A color that validates your truth.",
                            compassion: "The color of compassion is soft light green. The color that heals yourself.",
                            healing: "The color of healing is gentle white. A color that embraces all wounds.",
                            general: "That voice was like wounded art. Rough but truthful, and therefore more beautiful."
                        },
                        pt: {
                            regret: "Esse arrependimento mudará para uma nova cor. Uma cor mais suave.",
                            understanding: "A cor da compreensão é dourado quente. Está brilhando dentro de você.",
                            acceptance: "A cor da aceitação é verde-azulado calmo. Seu coração ficou em paz.",
                            gratitude: "A cor da gratidão é rosa quente. Sinto esse calor.",
                            relief: "A cor da libertação é azul céu brilhante. Como seu coração libertado.",
                            validation: "Esse reconhecimento é roxo forte. Uma cor que valida sua verdade.",
                            compassion: "A cor da compaixão é verde claro suave. A cor que cura você mesmo.",
                            healing: "A cor da cura é branco gentil. Uma cor que abraça todas as feridas.",
                            general: "Aquela voz era como arte ferida. Áspera mas verdadeira, e por isso mais bonita."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            regret: "후회도 치유의 일부야. 그 마음을 통해 성장할 수 있어.",
                            understanding: "깨달음이 왔구나. 이제 그 조각들이 다시 맞춰질 거야.",
                            acceptance: "받아들임은 가장 깊은 평화야. 네가 그걸 찾았어.",
                            gratitude: "감사는 마음의 문을 여는 열쇠야. 새로운 시작이 가능해.",
                            relief: "해방감이 느껴져. 무거운 짐을 내려놓은 기분이겠지.",
                            validation: "자신을 인정하는 것이 진정한 용기야. 넌 해냈어.",
                            compassion: "스스로에게 자비로울 시간이야. 그것도 치유의 과정이야.",
                            healing: "치유는 이미 시작됐어. 부서진 자리에서 새로운 힘이 자라고 있어.",
                            general: "이제 넌 네 감정을 억누르지 않고 바라보는 중이야. 그것만으로도 치유는 시작됐어."
                        },
                        en: {
                            regret: "Regret is also part of healing. You can grow through that feeling.",
                            understanding: "Enlightenment has come. Now those fragments will fit together again.",
                            acceptance: "Acceptance is the deepest peace. You've found it.",
                            gratitude: "Gratitude is the key that opens the heart's door. A new beginning is possible.",
                            relief: "I feel your liberation. It must feel like putting down a heavy burden.",
                            validation: "Acknowledging yourself is true courage. You've done it.",
                            compassion: "It's time to be compassionate with yourself. That's also part of healing.",
                            healing: "Healing has already begun. New strength is growing from the broken places.",
                            general: "Now you're looking at your emotions without suppressing them. That alone begins healing."
                        },
                        pt: {
                            regret: "O arrependimento também é parte da cura. Você pode crescer através desse sentimento.",
                            understanding: "A iluminação chegou. Agora esses fragmentos se encaixarão novamente.",
                            acceptance: "A aceitação é a paz mais profunda. Você a encontrou.",
                            gratitude: "A gratidão é a chave que abre a porta do coração. Um novo começo é possível.",
                            relief: "Sinto sua libertação. Deve ser como colocar um fardo pesado no chão.",
                            validation: "Reconhecer a si mesmo é verdadeira coragem. Você conseguiu.",
                            compassion: "É hora de ser compassivo consigo mesmo. Isso também é parte da cura.",
                            healing: "A cura já começou. Nova força está crescendo dos lugares quebrados.",
                            general: "Agora você está olhando para suas emoções sem suprimi-las. Só isso já inicia a cura."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 10이 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 10 will be ready soon!' :
                    'Portal 10 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 09를 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 09?' :
                    'Deseja reiniciar o Portal 09?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-09",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-09",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 09 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 09 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>