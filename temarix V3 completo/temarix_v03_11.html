<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 11: Standing Before the Door of Frozen Time</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 11: Standing Before the Door of Frozen Time</div>
            <div class="portal-subtitle" id="portalSubtitle">When Time Stopped Moving</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">🕰 Portal 11 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 12</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you like to say to that version of yourself trapped in frozen time? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 11: 멈춰버린 시간의 문 앞에서",
                portalSubtitle: "시간이 멈춰버린 순간",
                portalIntro: "🕰 당신의 시간이 멈춰버린 듯했던 순간이 있었나요?\n\n그날 이후, 아무것도 변하지 않았어요.\n모든 게 그대로였고, 나도 거기 멈춘 채였죠.\n시간이 흘러도… 내 안은 멈춰 있었어요.\n\n그때, 무엇이 당신을 그 자리에 묶어두었나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "그 멈춘 시간 안에도 네가 있었어. 지금 여기까지 온 너, 이미 다시 흐르기 시작한 거야.",
                portalQuestion: "🕰 그 시간 속에 갇혀 있던 당신에게, 지금의 당신이 해주고 싶은 말은 무엇인가요?",
                finalTitle: "🕰 Portal 11 완료",
                finalMessage: "당신은 용기 있게 멈춰버린 시간의 무게를 마주했습니다.\n\n그 정지된 순간들이 나약함이 아니라\n생존을 위한 필요한 멈춤이었다는 것을\n이해하게 되었죠.\n\n이제 시간이 다시 흐르기 시작했습니다.\n당신은 더 이상 그 순간에 갇혀 있지 않고\n앞으로 나아갈 수 있게 되었어요.\n\n다음 Portal에서는 내 안에 남아 있는\n타인의 목소리를 탐험하는 여정이 이어집니다.",
                continueBtn: "Portal 12로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "멈춰진 시간 속에 갇혀 있던 당신에게 지금 어떤 말을 해주고 싶은지 말해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 11: Standing Before the Door of Frozen Time",
                portalSubtitle: "When Time Stopped Moving",
                portalIntro: "🕰 Was there a moment when your time seemed to have stopped?\n\nAfter that day, nothing changed.\nEverything remained the same, and I too remained stopped there.\nEven as time passed... my inside remained frozen.\n\nWhat was it that bound you to that place?",
                lightTitle: "✨ Word of Light",
                lightMessage: "You were there even in that stopped time. You who came this far, have already begun to flow again.",
                portalQuestion: "🕰 What would you like to say to that version of yourself trapped in frozen time?",
                finalTitle: "🕰 Portal 11 Complete",
                finalMessage: "You have courageously faced the weight\nof frozen time.\n\nYou came to understand that those moments of stillness\nwere not weakness but necessary pauses\nfor survival.\n\nNow time has begun to flow again.\nYou are no longer trapped in that moment\nand can move forward.\n\nIn the next Portal, a journey continues\nto explore the voices of others\nthat remain within you.",
                continueBtn: "Move to Portal 12",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you like to say to that version of yourself trapped in frozen time? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 11: Diante da Porta do Tempo Congelado",
                portalSubtitle: "Quando o Tempo Parou de Se Mover",
                portalIntro: "🕰 Houve um momento em que seu tempo pareceu ter parado?\n\nDepois daquele dia, nada mudou.\nTudo permaneceu igual, e eu também permaneci parado lá.\nMesmo com o tempo passando... meu interior permaneceu congelado.\n\nO que foi que te prendeu naquele lugar?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Você estava lá mesmo naquele tempo parado. Você que chegou até aqui, já começou a fluir novamente.",
                portalQuestion: "🕰 O que você gostaria de dizer para aquela versão de si mesmo presa no tempo congelado?",
                finalTitle: "🕰 Portal 11 Completo",
                finalMessage: "Você corajosamente enfrentou o peso\ndo tempo congelado.\n\nVocê passou a entender que aqueles momentos de quietude\nnão eram fraqueza, mas pausas necessárias\npara a sobrevivência.\n\nAgora o tempo começou a fluir novamente.\nVocê não está mais preso naquele momento\ne pode seguir em frente.\n\nNo próximo Portal, uma jornada continua\npara explorar as vozes dos outros\nque permanecem dentro de você.",
                continueBtn: "Ir para Portal 12",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "O que você gostaria de dizer para aquela versão de si mesmo presa no tempo congelado? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "네 시간은 멈춘 게 아니라, 너무 아파서 멈춘 척 한 거였어.",
                en: "Your time didn't stop, it just pretended to stop because it hurt too much.",
                pt: "Seu tempo não parou, apenas fingiu parar porque doía demais."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "세상은 흐르지만, 마음은 멈출 수 있어. 그건 도망이 아니라, 생존이야.",
                en: "The world flows, but the heart can stop. That's not escape, it's survival.",
                pt: "O mundo flui, mas o coração pode parar. Isso não é fuga, é sobrevivência."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "누구도 널 다그치지 않아야 했는데… 넌 그 조용한 멈춤 속에서 스스로를 책망했겠지.",
                en: "No one should have pressured you... You must have blamed yourself in that quiet stillness.",
                pt: "Ninguém deveria ter te pressionado... Você deve ter se culpado naquela quietude silenciosa."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "시간은 외부의 흐름이고, 감정은 내부의 강물이야. 그 둘이 어긋날 땐… 고요함이 온다.",
                en: "Time is the external flow, and emotion is the internal river. When those two are out of sync... stillness comes.",
                pt: "O tempo é o fluxo externo, e a emoção é o rio interno. Quando esses dois estão fora de sincronia... vem a quietude."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 멈춤은 캔버스 위의 정지된 붓질 같았어. 다음 선을 그릴 용기가, 그땐 없었던 거야.",
                en: "That pause was like a frozen brushstroke on canvas. You didn't have the courage to draw the next line then.",
                pt: "Essa pausa foi como uma pincelada congelada na tela. Você não tinha coragem para desenhar a próxima linha então."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "멈췄다고 해서 약한 건 아니야. 나도 멈춰본 적 있어. 그건 다시 움직이기 위한 숨 고르기였어.",
                en: "Stopping doesn't mean you're weak. I've stopped too. It was catching your breath to move again.",
                pt: "Parar não significa que você é fraco. Eu também parei. Era recuperar o fôlego para se mover novamente."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "너는 움직이지 않은 게 아니라, 그냥… 기다리고 있었던 거야. 누군가 와서, 네 시간을 깨워주길.",
                en: "You weren't not moving, you were just... waiting. For someone to come and wake up your time.",
                pt: "Você não estava sem se mover, você estava apenas... esperando. Por alguém vir e despertar seu tempo."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "그 멈춘 시간 안에도 네가 있었어. 지금 여기까지 온 너, 이미 다시 흐르기 시작한 거야.",
                en: "You were there even in that stopped time. You who came this far, have already begun to flow again.",
                pt: "Você estava lá mesmo naquele tempo parado. Você que chegou até aqui, já começou a fluir novamente."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                compassion: ['okay', 'enough', 'did well', 'survived', '괜찮', '충분', '잘했', '버텼', 'está bem', 'suficiente', 'sobreviveu'],
                encouragement: ['move', 'start', 'continue', 'forward', '움직', '시작', '계속', '앞으로', 'mover', 'começar', 'continuar'],
                understanding: ['understand', 'know', 'felt', 'pain', '이해', '알아', '느꼈', '아픔', 'entender', 'sei', 'dor'],
                forgiveness: ['sorry', 'forgive', 'not fault', 'blame', '미안', '용서', '잘못', '탓', 'desculpa', 'perdoar', 'culpa'],
                healing: ['heal', 'better', 'recover', 'grow', '치유', '나아', '회복', '성장', 'curar', 'melhor', 'recuperar'],
                gratitude: ['thank', 'grateful', 'appreciate', '고마', '감사', 'obrigado', 'grato'],
                acceptance: ['accept', 'normal', 'natural', 'human', '받아들', '당연', '자연', '인간', 'aceitar', 'normal', 'natural'],
                hope: ['hope', 'future', 'possible', 'can', '희망', '미래', '가능', '할 수', 'esperança', 'futuro', 'possível']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            compassion: "그 말, 정말 필요했어. 그때 꼭 들었어야 했을 말이야. 지금이라도 해줘서 다행이야.",
                            encouragement: "이제 움직일 때가 왔구나. 그 멈춤은 준비였고, 지금은 시작의 순간이야.",
                            understanding: "누군가 그때의 너를 이해해준다는 게 얼마나 중요한지... 네가 해낸 거야.",
                            forgiveness: "용서는 치유의 시작이야. 그때의 너도, 지금의 너도 모두 소중해.",
                            healing: "치유의 마음이 느껴져. 그 상처도 이제 천천히 아물어갈 거야.",
                            gratitude: "고마움을 표현할 수 있다는 건, 마음이 다시 열렸다는 증거야.",
                            acceptance: "받아들이는 마음이 보여. 그게 진짜 용기야.",
                            hope: "희망의 빛이 보이기 시작했어. 그 시간은 끝났어.",
                            general: "그 한마디가 멈춰있던 시간을 다시 흐르게 만들었어."
                        },
                        en: {
                            compassion: "Those words were really needed. You should have heard them back then. I'm glad you said them now.",
                            encouragement: "Now it's time to move. That pause was preparation, and now is the moment to begin.",
                            understanding: "How important it is for someone to understand you from that time... You did it.",
                            forgiveness: "Forgiveness is the beginning of healing. Both you from then and you now are precious.",
                            healing: "I feel the heart of healing. Those wounds will slowly heal now too.",
                            gratitude: "Being able to express gratitude is proof that your heart has opened again.",
                            acceptance: "I see your accepting heart. That's real courage.",
                            hope: "The light of hope is beginning to show. That time is over.",
                            general: "Those words made the stopped time flow again."
                        },
                        pt: {
                            compassion: "Essas palavras eram realmente necessárias. Você deveria ter ouvido isso naquela época. Fico feliz que você disse agora.",
                            encouragement: "Agora é hora de se mover. Essa pausa foi preparação, e agora é o momento de começar.",
                            understanding: "Como é importante alguém entender você daquela época... Você conseguiu.",
                            forgiveness: "O perdão é o início da cura. Tanto você de então quanto você agora são preciosos.",
                            healing: "Sinto o coração da cura. Essas feridas também vão sarar lentamente agora.",
                            gratitude: "Ser capaz de expressar gratidão é prova de que seu coração se abriu novamente.",
                            acceptance: "Vejo seu coração que aceita. Essa é a verdadeira coragem.",
                            hope: "A luz da esperança está começando a aparecer. Aquele tempo acabou.",
                            general: "Essas palavras fizeram o tempo parado fluir novamente."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            compassion: "그 말 한마디에, 네 안의 자책이 천천히 녹아들기 시작했어.",
                            encouragement: "움직임은 선택이야. 네가 그 선택을 할 준비가 되었구나.",
                            understanding: "이해받는다는 것, 그 따뜻함이 얼어붙은 시간을 녹이고 있어.",
                            forgiveness: "용서는 가장 깊은 치유야. 네가 그 문을 열었어.",
                            healing: "치유의 에너지가 흐르고 있어. 멈춰있던 것들이 다시 움직이기 시작했어.",
                            gratitude: "감사는 시간을 다시 흐르게 하는 마법이야.",
                            acceptance: "받아들임은 가장 깊은 평화야. 이제 시간이 너와 함께 흘러.",
                            hope: "희망은 멈춘 시간에 다시 숨을 불어넣어. 네가 그걸 해냈어.",
                            general: "네가 네 자신과 대화한 순간, 시간은 다시 흐르기 시작했어."
                        },
                        en: {
                            compassion: "With those words, the self-blame inside you began to slowly melt away.",
                            encouragement: "Movement is a choice. You're ready to make that choice.",
                            understanding: "Being understood, that warmth is melting the frozen time.",
                            forgiveness: "Forgiveness is the deepest healing. You opened that door.",
                            healing: "Healing energy is flowing. Things that were stopped have begun to move again.",
                            gratitude: "Gratitude is magic that makes time flow again.",
                            acceptance: "Acceptance is the deepest peace. Now time flows with you.",
                            hope: "Hope breathes life back into stopped time. You did that.",
                            general: "The moment you talked to yourself, time began to flow again."
                        },
                        pt: {
                            compassion: "Com essas palavras, a auto-culpa dentro de você começou a derreter lentamente.",
                            encouragement: "Movimento é uma escolha. Você está pronto para fazer essa escolha.",
                            understanding: "Ser compreendido, esse calor está derretendo o tempo congelado.",
                            forgiveness: "O perdão é a cura mais profunda. Você abriu essa porta.",
                            healing: "A energia de cura está fluindo. Coisas que estavam paradas começaram a se mover novamente.",
                            gratitude: "A gratidão é mágica que faz o tempo fluir novamente.",
                            acceptance: "A aceitação é a paz mais profunda. Agora o tempo flui com você.",
                            hope: "A esperança respira vida de volta ao tempo parado. Você fez isso.",
                            general: "No momento em que você conversou consigo mesmo, o tempo começou a fluir novamente."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "🧑‍🎨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            compassion: "그 말은 네 안의 색을 다시 물들였어. 멈춰 있던 그림이, 이제 다시 그려지기 시작했어.",
                            encouragement: "움직임의 색은 밝은 황금빛이야. 네 캔버스에 새로운 선이 그어지고 있어.",
                            understanding: "이해의 색은 따뜻한 오렌지야. 그 색이 얼어붙은 부분을 녹이고 있어.",
                            forgiveness: "용서의 색은 부드러운 연분홍이야. 상처를 덮어주는 치유의 색.",
                            healing: "치유의 색은 연한 초록이야. 생명력이 다시 스며들고 있어.",
                            gratitude: "감사의 색은 따뜻한 노랑이야. 마음에 햇살이 들어온 거야.",
                            acceptance: "받아들임의 색은 고요한 청록색이야. 평온함이 번지고 있어.",
                            hope: "희망의 색은 밝은 하늘색이야. 무한한 가능성의 색.",
                            general: "그 말로 네 안의 멈춰있던 색들이 다시 흐르기 시작했어."
                        },
                        en: {
                            compassion: "Those words colored your inside again. The stopped painting has begun to be drawn again.",
                            encouragement: "The color of movement is bright golden. New lines are being drawn on your canvas.",
                            understanding: "The color of understanding is warm orange. That color is melting the frozen parts.",
                            forgiveness: "The color of forgiveness is soft light pink. The healing color that covers wounds.",
                            healing: "The color of healing is light green. Life force is seeping in again.",
                            gratitude: "The color of gratitude is warm yellow. Sunlight has entered your heart.",
                            acceptance: "The color of acceptance is calm teal. Tranquility is spreading.",
                            hope: "The color of hope is bright sky blue. The color of infinite possibilities.",
                            general: "With those words, the stopped colors inside you began to flow again."
                        },
                        pt: {
                            compassion: "Essas palavras coloriram seu interior novamente. A pintura parada começou a ser desenhada novamente.",
                            encouragement: "A cor do movimento é dourado brilhante. Novas linhas estão sendo desenhadas na sua tela.",
                            understanding: "A cor da compreensão é laranja quente. Essa cor está derretendo as partes congeladas.",
                            forgiveness: "A cor do perdão é rosa claro suave. A cor de cura que cobre feridas.",
                            healing: "A cor da cura é verde claro. A força vital está penetrando novamente.",
                            gratitude: "A cor da gratidão é amarelo quente. A luz do sol entrou no seu coração.",
                            acceptance: "A cor da aceitação é azul-petróleo calmo. A tranquilidade está se espalhando.",
                            hope: "A cor da esperança é azul céu brilhante. A cor de possibilidades infinitas.",
                            general: "Com essas palavras, as cores paradas dentro de você começaram a fluir novamente."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 12가 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 12 will be ready soon!' :
                    'Portal 12 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 11을 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 11?' :
                    'Deseja reiniciar o Portal 11?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-11",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-11",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 11 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 11 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>