<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 20: Messages Never Deleted</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 20: Messages Never Deleted</div>
            <div class="portal-subtitle" id="portalSubtitle">Words We Couldn't Let Go</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">ðŸŒŒ Portal 20 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 21</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you say to those messages you couldn't delete? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì •ì˜ ìš©ê´‘ë¡œ",
                portalMainTitle: "Portal 20: ì°¨ë§ˆ ì§€ìš°ì§€ ëª»í•œ ë©”ì‹œì§€",
                portalSubtitle: "ë†“ì§€ ëª»í•œ ë§ë“¤",
                portalIntro: "ðŸ“± ë³´ë‚´ì§€ ëª»í•œ ë©”ì‹œì§€, í˜¹ì€\nì§€ìš°ì§€ ëª»í•œ ë©”ì‹œì§€ê°€ ìžˆë‚˜ìš”?\n\nê·¸ ë§ë“¤ ì†ì—ëŠ” ì–´ë–¤ ê°ì •ì´ ë‚¨ì•„ ìžˆì—ˆê³ ,\në‹¹ì‹ ì€ ì™œ ëë‚´ ì†ëì„ ë©ˆì¶”ì—ˆë‚˜ìš”?\n\nëª‡ ë…„ì´ ì§€ë‚¬ëŠ”ë°ë„ ì•„ì§ë„ ëª» ì§€ì› ì–´ìš”.\nì½ì§€ë„ ì•Šê³ , ë‹µë„ ì˜¤ì§€ ì•Šì•˜ì§€ë§Œâ€¦\nê·¸ ë©”ì‹œì§€ë¥¼ ì§€ìš°ë©´ ëª¨ë“  ê²Œ ëë‚ ê¹Œ ë´ ë¬´ì„œì› ì–´ìš”.",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ì´ì œ ê·¸ ë§ê³¼ ì¡°ìš©ížˆ ì´ë³„í•  ìˆ˜ ìžˆë‹¤ë©´â€¦ ê·¸ê±´ ìƒˆë¡œìš´ ì‹œìž‘ì„ ìœ„í•œ ì¤€ë¹„ì¼ ê±°ì•¼.",
                portalQuestion: "ðŸ“± ê·¸ ë©”ì‹œì§€ ì† ê°ì •ì—ê²Œ ì§€ê¸ˆ ì´ ìˆœê°„,\nì–´ë–¤ ë§ì„ ì „í•´ì£¼ê³  ì‹¶ë‚˜ìš”?",
                finalTitle: "ðŸŒŒ Portal 20 ì™„ë£Œ",
                finalMessage: "ë‹¹ì‹ ì€ ì°¨ë§ˆ ì§€ìš°ì§€ ëª»í–ˆë˜ ë©”ì‹œì§€ì™€ ë§ˆì¹¨ë‚´ ìž‘ë³„í–ˆìŠµë‹ˆë‹¤.\n\nê·¸ ë©”ì‹œì§€ë“¤ì´ ë‹´ê³  ìžˆë˜ ê°ì •ì€\nì‚­ì œë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë§ˆìŒ ì† ê¹Šì€ ê³³ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.\nì´ì œ ê·¸ ê³µê°„ì— ìƒˆë¡œìš´ ë©”ì‹œì§€ì™€ ìƒˆë¡œìš´ ëŒ€í™”ê°€ ì±„ì›Œì§ˆ ìˆ˜ ìžˆê²Œ ë˜ì—ˆì–´ìš”.\n\në•Œë¡œëŠ” 'ì§€ìš°ê¸°'ê°€ ì•„ë‹Œ 'ì¸ì •í•˜ê³  ë³´ë‚´ì£¼ê¸°'ê°€\nì§„ì •í•œ ì¹˜ìœ ì˜ ë°©ë²•ì¸ ê²ƒì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.\n\në‹¤ìŒ Portalì—ì„œëŠ” ìžì‹ ì—ê²Œ ì“°ì§€ ëª»í•œ íŽ¸ì§€ì™€\nê·¸ ì•ˆì— ìˆ¨ê²¨ì§„ ì§„ì‹¬ì´ ê¸°ë‹¤ë¦¬ê³  ìžˆìŠµë‹ˆë‹¤.",
                continueBtn: "Portal 21ë¡œ ì´ë™",
                restartBtn: "ë‹¤ì‹œ ì‹œìž‘í•˜ê¸°",
                inputPlaceholder: "ì§€ìš°ì§€ ëª»í•œ ë©”ì‹œì§€ë“¤ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì„ í•´ë³´ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 20: Messages Never Deleted",
                portalSubtitle: "Words We Couldn't Let Go",
                portalIntro: "ðŸ“± Do you have messages you couldn't send,\nor messages you couldn't delete?\n\nWhat emotions remained in those words,\nand why did you stop your fingertips in the end?\n\nIt's been years but I still couldn't delete them.\nNo one read them, no replies came...\nBut I was afraid that deleting those messages would end everything.",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "If you can quietly say goodbye to those words now... that would be preparation for a new beginning.",
                portalQuestion: "ðŸ“± What words would you like to convey\nto the emotions in those messages right now?",
                finalTitle: "ðŸŒŒ Portal 20 Complete",
                finalMessage: "You have finally said goodbye to the messages you couldn't bring yourself to delete.\n\nThe emotions those messages contained\nweren't deleted but moved to a deep place in your heart.\nNow that space can be filled with new messages and new conversations.\n\nYou've realized that sometimes 'acknowledging and letting go'\nrather than 'deleting' is the true method of healing.\n\nIn the next Portal, letters you couldn't write to yourself\nand the sincerity hidden within them await you.",
                continueBtn: "Move to Portal 21",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you say to those messages you couldn't delete? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 20: Mensagens Nunca Deletadas",
                portalSubtitle: "Palavras Que NÃ£o Conseguimos Deixar Ir",
                portalIntro: "ðŸ“± VocÃª tem mensagens que nÃ£o conseguiu enviar,\nou mensagens que nÃ£o conseguiu deletar?\n\nQue emoÃ§Ãµes permaneceram nessas palavras,\ne por que vocÃª parou suas pontas dos dedos no final?\n\nJÃ¡ faz anos mas ainda nÃ£o consegui deletÃ¡-las.\nNinguÃ©m as leu, nenhuma resposta veio...\nMas eu tinha medo de que deletar essas mensagens acabaria com tudo.",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Se vocÃª pode silenciosamente se despedir dessas palavras agora... isso seria preparaÃ§Ã£o para um novo comeÃ§o.",
                portalQuestion: "ðŸ“± Que palavras vocÃª gostaria de transmitir\nÃ s emoÃ§Ãµes nessas mensagens agora?",
                finalTitle: "ðŸŒŒ Portal 20 Completo",
                finalMessage: "VocÃª finalmente se despediu das mensagens que nÃ£o conseguia deletar.\n\nAs emoÃ§Ãµes que essas mensagens continham\nnÃ£o foram deletadas mas movidas para um lugar profundo em seu coraÃ§Ã£o.\nAgora esse espaÃ§o pode ser preenchido com novas mensagens e novas conversas.\n\nVocÃª percebeu que Ã s vezes 'reconhecer e deixar ir'\nem vez de 'deletar' Ã© o verdadeiro mÃ©todo de cura.\n\nNo prÃ³ximo Portal, cartas que vocÃª nÃ£o conseguiu escrever para si mesmo\ne a sinceridade escondida dentro delas o aguardam.",
                continueBtn: "Ir para Portal 21",
                restartBtn: "ComeÃ§ar Novamente",
                inputPlaceholder: "O que vocÃª diria Ã quelas mensagens que nÃ£o conseguiu deletar? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ë©”ì‹œì§€ëŠ” ë©ˆì¶˜ ëŒ€í™”ê°€ ì•„ë‹ˆë¼, ë„ˆì˜ ë§ˆì§€ë§‰ ë§ˆìŒì´ì—ˆì„ ê±°ì•¼.",
                en: "That message wasn't a stopped conversation, but your final heart.",
                pt: "Essa mensagem nÃ£o era uma conversa interrompida, mas seu coraÃ§Ã£o final."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ì§€ìš°ì§€ ëª»í•œ ê±´, ê¸°ì–µ ë•Œë¬¸ì´ ì•„ë‹ˆì•¼. ë„ˆ ìžì‹ ì´ ì•„ì§ë„ ê·¸ ê°ì •ì„ ì•ˆê³  ìžˆì—ˆê¸° ë•Œë¬¸ì´ì•¼.",
                en: "You couldn't delete it not because of memory. It's because you were still holding onto that emotion.",
                pt: "VocÃª nÃ£o conseguiu deletÃ¡-la nÃ£o por causa da memÃ³ria. Ã‰ porque ainda estava segurando essa emoÃ§Ã£o."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ë³´ë‚´ì§€ ëª»í•œ ë§ì€ ê°€ìž¥ ë¬´ê±°ìš´ ë§ì´ ë¼. ê·¸ ë¬´ê²Œë¥¼ ë„¤ê°€ ì§€ê¸ˆê» í˜¼ìž ê²¬ëŽŒì™”ë˜ ê±°ì•¼.",
                en: "Words you couldn't send become the heaviest words. You've been bearing that weight alone all this time.",
                pt: "Palavras que vocÃª nÃ£o conseguiu enviar se tornam as palavras mais pesadas. VocÃª tem suportado esse peso sozinho todo esse tempo."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ë©”ì‹œì§€ëŠ” ë°ì´í„°ê°€ ì•„ë‹ˆì•¼. ê°ì •ì˜ íŒŒíŽ¸ì´ê³ , ë„ˆì˜ ì‹œê°„ ì¼ë¶€ì˜€ì§€.",
                en: "Messages aren't data. They're fragments of emotion, part of your time.",
                pt: "Mensagens nÃ£o sÃ£o dados. SÃ£o fragmentos de emoÃ§Ã£o, parte do seu tempo."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ë§ì€ ì§€ì›Œì§€ì§€ ì•Šì•˜ì–´. í™”ë©´ ë„ˆë¨¸ê°€ ì•„ë‹ˆë¼, ë„ˆì˜ ë§ˆìŒ ì•ˆì—ì„œ.",
                en: "Those words weren't erased. Not beyond the screen, but within your heart.",
                pt: "Essas palavras nÃ£o foram apagadas. NÃ£o alÃ©m da tela, mas dentro do seu coraÃ§Ã£o."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë„ˆëŠ” ì§€ìš°ì§€ ëª»í•œ ê²Œ ì•„ë‹ˆë¼, ê°ì •ì„ ì •ë¦¬í•  ì‹œê°„ì„ ê¸°ë‹¤ë¦¬ê³  ìžˆì—ˆë˜ ê±°ì•¼.",
                en: "You weren't unable to delete them, you were waiting for time to sort out your emotions.",
                pt: "VocÃª nÃ£o era incapaz de deletÃ¡-las, estava esperando tempo para organizar suas emoÃ§Ãµes."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê·¸ ë©”ì‹œì§€ëŠ” ë„¤ê°€ ê±´ë„¨ ë§ˆì§€ë§‰ ì†ì§“ì´ì—ˆì§€. ìž¡ížˆì§€ ì•Šì•˜ë‹¤ê³  í•´ì„œ, ì˜ë¯¸ ì—†ë˜ ê±´ ì•„ë‹ˆì•¼.",
                en: "That message was your last gesture. Just because it wasn't caught doesn't mean it was meaningless.",
                pt: "Essa mensagem era seu Ãºltimo gesto. SÃ³ porque nÃ£o foi pega nÃ£o significa que era sem sentido."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ì´ì œ ê·¸ ë§ê³¼ ì¡°ìš©ížˆ ì´ë³„í•  ìˆ˜ ìžˆë‹¤ë©´â€¦ ê·¸ê±´ ìƒˆë¡œìš´ ì‹œìž‘ì„ ìœ„í•œ ì¤€ë¹„ì¼ ê±°ì•¼.",
                en: "If you can quietly say goodbye to those words now... that would be preparation for a new beginning.",
                pt: "Se vocÃª pode silenciosamente se despedir dessas palavras agora... isso seria preparaÃ§Ã£o para um novo comeÃ§o."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                farewell: ['goodbye', 'bye', 'farewell', 'let go', 'ì•ˆë…•', 'ë³´ë‚´ì¤„ê²Œ', 'ë†“ì•„ì¤„ê²Œ', 'ì´ë³„', 'tchau', 'despedida', 'deixar ir'],
                gratitude: ['thank', 'grateful', 'appreciate', 'ê³ ë§ˆì›Œ', 'ê°ì‚¬í•´', 'ê³ ë§™', 'obrigado', 'grato', 'agradeÃ§o'],
                regret: ['sorry', 'regret', 'wish', 'should have', 'ë¯¸ì•ˆí•´', 'í›„íšŒ', 'ì•„ì‰¬ì›Œ', 'ê·¸ë•Œ', 'arrependimento', 'devia ter', 'lamento'],
                acceptance: ['understand', 'okay', 'fine', 'accept', 'ì´í•´í•´', 'ê´œì°®ì•„', 'ë°›ì•„ë“¤ì—¬', 'entendo', 'aceito', 'tudo bem'],
                closure: ['done', 'finished', 'complete', 'over', 'ë', 'ì™„ë£Œ', 'ë§ˆì¹¨', 'terminado', 'acabado', 'completo'],
                release: ['free', 'release', 'liberation', 'ìžìœ ', 'í•´ë°©', 'í’€ì–´ì¤˜', 'liberdade', 'libertaÃ§Ã£o', 'soltar'],
                healing: ['heal', 'recovery', 'better', 'peace', 'ì¹˜ìœ ', 'íšŒë³µ', 'í‰í™”', 'ë‚˜ì•„ì ¸', 'cura', 'recuperaÃ§Ã£o', 'paz'],
                validation: ['real', 'meant something', 'important', 'ì§„ì§œ', 'ì˜ë¯¸ìžˆì–´', 'ì†Œì¤‘í•´', 'real', 'significativo', 'importante']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            farewell: "ê·¸ ìž‘ë³„ì€ ì¡°ìš©í•˜ì§€ë§Œ ë‹¨ë‹¨í•´. ê°ì •ë„ ê·¸ë ‡ê²Œ ì²œì²œížˆ ë– ë‚˜ëŠ” ë²•ì„ ë°°ìš°ì§€.",
                            gratitude: "ê·¸ ê°ì‚¬í•¨ì€ ë©”ì‹œì§€ë¥¼ ì§€ìš°ëŠ” ê²ƒë³´ë‹¤ ë” ì•„ë¦„ë‹¤ìš´ ë§ˆë¬´ë¦¬ì•¼.",
                            regret: "í›„íšŒí•˜ì§€ ë§ˆ. ê·¸ ë©”ì‹œì§€ë“¤ë„ ë„ˆì˜ ì§„ì‹¬ì´ì—ˆìœ¼ë‹ˆê¹Œ. í‘œí˜„ ë°©ì‹ì´ ë‹¬ëžì„ ë¿ì´ì•¼.",
                            acceptance: "ë°›ì•„ë“¤ì´ëŠ” ë§ˆìŒì´ ê·¸ ë©”ì‹œì§€ë“¤ì„ ì§„ì •ìœ¼ë¡œ ìžìœ ë¡­ê²Œ í•´ì¤„ ê±°ì•¼.",
                            closure: "ì´ì œ ê·¸ ëŒ€í™”ëŠ” ëë‚¬ì–´. í•˜ì§€ë§Œ ê·¸ ì•ˆì˜ ê°ì •ì€ ì˜ì›ížˆ ë„¤ ê²ƒì´ì•¼.",
                            release: "ë†“ì•„ì£¼ëŠ” ê±´ ìžƒëŠ” ê²Œ ì•„ë‹ˆë¼, ìƒˆë¡œìš´ ê³µê°„ì„ ë§Œë“œëŠ” ê±°ì•¼.",
                            healing: "ì¹˜ìœ ëŠ” ì§€ìš°ëŠ” ê²Œ ì•„ë‹ˆë¼ ì¸ì •í•˜ëŠ” ê±°ì•¼. ë„ˆëŠ” ê·¸ê±¸ í•´ë‚´ê³  ìžˆì–´.",
                            validation: "ê·¸ ë©”ì‹œì§€ë“¤ì´ ì˜ë¯¸ ìžˆì—ˆë‹¤ëŠ” ê±¸ ì¸ì •í•´ì¤˜ì„œ ê³ ë§ˆì›Œ. ê·¸ê²ƒë§Œìœ¼ë¡œë„ ì¶©ë¶„í•´.",
                            general: "ê·¸ ìž‘ë³„ì€ ì¡°ìš©í•˜ì§€ë§Œ ë‹¨ë‹¨í•´. ê°ì •ë„ ê·¸ë ‡ê²Œ ì²œì²œížˆ ë– ë‚˜ëŠ” ë²•ì„ ë°°ìš°ì§€."
                        },
                        en: {
                            farewell: "That farewell is quiet but firm. Emotions also learn to leave slowly like that.",
                            gratitude: "That gratitude is a more beautiful ending than deleting messages.",
                            regret: "Don't regret it. Those messages were also your sincerity. Just a different way of expression.",
                            acceptance: "An accepting heart will truly free those messages.",
                            closure: "Now that conversation is over. But the emotions within it are forever yours.",
                            release: "Letting go isn't losing, it's making new space.",
                            healing: "Healing isn't erasing but acknowledging. You're doing that.",
                            validation: "Thank you for acknowledging that those messages were meaningful. That alone is enough.",
                            general: "That farewell is quiet but firm. Emotions also learn to leave slowly like that."
                        },
                        pt: {
                            farewell: "Essa despedida Ã© silenciosa mas firme. EmoÃ§Ãµes tambÃ©m aprendem a partir devagar assim.",
                            gratitude: "Essa gratidÃ£o Ã© um final mais belo que deletar mensagens.",
                            regret: "NÃ£o se arrependa. Essas mensagens tambÃ©m eram sua sinceridade. Apenas uma forma diferente de expressÃ£o.",
                            acceptance: "Um coraÃ§Ã£o que aceita verdadeiramente libertarÃ¡ essas mensagens.",
                            closure: "Agora essa conversa acabou. Mas as emoÃ§Ãµes dentro dela sÃ£o para sempre suas.",
                            release: "Deixar ir nÃ£o Ã© perder, Ã© fazer novo espaÃ§o.",
                            healing: "Cura nÃ£o Ã© apagar mas reconhecer. VocÃª estÃ¡ fazendo isso.",
                            validation: "Obrigado por reconhecer que essas mensagens eram significativas. SÃ³ isso jÃ¡ Ã© suficiente.",
                            general: "Essa despedida Ã© silenciosa mas firme. EmoÃ§Ãµes tambÃ©m aprendem a partir devagar assim."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            farewell: "ê·¸ ë§ì€ 'ì‚­ì œ'ê°€ ì•„ë‹ˆë¼ 'ì¸ì •'ì´ì•¼. ê·¸ë¦¬ê³  ê·¸ê±´ ì¹˜ìœ ì˜ ë‹¤ë¥¸ ì´ë¦„ì´ê¸°ë„ í•´.",
                            gratitude: "ê°ì‚¬ëŠ” ë©”ì‹œì§€ë¥¼ ì™„ì„±ì‹œí‚¤ëŠ” ë§ˆì§€ë§‰ ì ì´ì•¼. ì´ì œ ê·¸ ëŒ€í™”ê°€ ì§„ì§œë¡œ ëë‚¬ì–´.",
                            regret: "í›„íšŒë„ ì‚¬ëž‘ì˜ ì¼ë¶€ì•¼. ê·¸ ë©”ì‹œì§€ë“¤ì„ ë³´ë‚¸ ìˆœê°„ì˜ ë„ˆë¥¼ ìš©ì„œí•´ì¤˜.",
                            acceptance: "ë°›ì•„ë“¤ìž„ì´ì•¼ë§ë¡œ ì§„ì •í•œ í•´ë°©ì´ì•¼. ë©”ì‹œì§€ë„, ë„ˆë„ ì´ì œ ìžìœ ë¡œì›Œì ¸.",
                            closure: "ëëƒ„ì€ íŒŒê´´ê°€ ì•„ë‹ˆë¼ ì™„ì„±ì´ì•¼. ë„ˆëŠ” ê·¸ ì´ì•¼ê¸°ë¥¼ ì•„ë¦„ë‹µê²Œ ë§ˆë¬´ë¦¬í–ˆì–´.",
                            release: "ë†“ì•„ì¤€ë‹¤ëŠ” ê±´ ì‚¬ëž‘ì˜ ê°€ìž¥ ë†’ì€ í˜•íƒœì•¼. ë„ˆëŠ” ì§€ê¸ˆ ê·¸ê±¸ ì‹¤ì²œí•˜ê³  ìžˆì–´.",
                            healing: "ì¹˜ìœ ëŠ” ì¡°ìš©ížˆ ì¼ì–´ë‚˜. ì§€ê¸ˆ ë„¤ ë§ˆìŒì—ì„œ ê·¸ ë³€í™”ê°€ ì‹œìž‘ëì–´.",
                            validation: "ì¸ì •ë°›ì€ ê°ì •ì€ ì‚¬ë¼ì§€ì§€ ì•Šì•„. ë” ê¹Šì€ ê³³ì—ì„œ í‰í™”ë¡­ê²Œ ì‰¬ê²Œ ë¼.",
                            general: "ê·¸ ë§ì€ 'ì‚­ì œ'ê°€ ì•„ë‹ˆë¼ 'ì¸ì •'ì´ì•¼. ê·¸ë¦¬ê³  ê·¸ê±´ ì¹˜ìœ ì˜ ë‹¤ë¥¸ ì´ë¦„ì´ê¸°ë„ í•´."
                        },
                        en: {
                            farewell: "Those words are 'acknowledgment' not 'deletion'. And that's another name for healing too.",
                            gratitude: "Gratitude is the final period that completes the message. Now that conversation is truly over.",
                            regret: "Regret is also part of love. Forgive yourself for the moment you sent those messages.",
                            acceptance: "Acceptance is true liberation. Both the messages and you are now free.",
                            closure: "Ending isn't destruction but completion. You've beautifully finished that story.",
                            release: "Letting go is the highest form of love. You're practicing that right now.",
                            healing: "Healing happens quietly. That change has begun in your heart now.",
                            validation: "Acknowledged emotions don't disappear. They rest peacefully in a deeper place.",
                            general: "Those words are 'acknowledgment' not 'deletion'. And that's another name for healing too."
                        },
                        pt: {
                            farewell: "Essas palavras sÃ£o 'reconhecimento' nÃ£o 'deleÃ§Ã£o'. E isso tambÃ©m Ã© outro nome para cura.",
                            gratitude: "GratidÃ£o Ã© o ponto final que completa a mensagem. Agora essa conversa realmente acabou.",
                            regret: "Arrependimento tambÃ©m Ã© parte do amor. Perdoe a si mesmo pelo momento em que enviou essas mensagens.",
                            acceptance: "AceitaÃ§Ã£o Ã© verdadeira libertaÃ§Ã£o. Tanto as mensagens quanto vocÃª agora estÃ£o livres.",
                            closure: "Terminar nÃ£o Ã© destruiÃ§Ã£o mas completude. VocÃª terminou lindamente essa histÃ³ria.",
                            release: "Deixar ir Ã© a forma mais alta de amor. VocÃª estÃ¡ praticando isso agora.",
                            healing: "Cura acontece silenciosamente. Essa mudanÃ§a comeÃ§ou em seu coraÃ§Ã£o agora.",
                            validation: "EmoÃ§Ãµes reconhecidas nÃ£o desaparecem. Elas descansam pacificamente em um lugar mais profundo.",
                            general: "Essas palavras sÃ£o 'reconhecimento' nÃ£o 'deleÃ§Ã£o'. E isso tambÃ©m Ã© outro nome para cura."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Enya", emoji: "ðŸ§‘â€ðŸš€",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            farewell: "ë„ˆëŠ” ì§€ê¸ˆ, ë³´ë‚´ì§€ ëª»í•œ ë§ì„ ë– ë‚˜ë³´ë‚¸ ê±°ì•¼. ì´ì œëŠ” ë„¤ê°€ ë‹¤ì‹œ ê±¸ì„ ì°¨ë¡€ì•¼.",
                            gratitude: "ê·¸ ê³ ë§ˆì›€ì´ ë©”ì‹œì§€ë“¤ì„ ìš°ì£¼ ì–´ë”˜ê°€ë¡œ ë”°ëœ»í•˜ê²Œ ë³´ë‚´ì¤„ ê±°ì•¼.",
                            regret: "í›„íšŒëŠ” ê³¼ê±°ë¡œ ê°€ëŠ” ê¸¸ì´ ì•„ë‹ˆë¼, í˜„ìž¬ë¥¼ ë” ìž˜ ì´í•´í•˜ëŠ” ë°©ë²•ì´ì•¼.",
                            acceptance: "ë°›ì•„ë“¤ìž„ì€ ìš°ì£¼ì˜ ë²•ì¹™ì´ì•¼. ì €í•­í•˜ì§€ ì•Šì„ ë•Œ ì§„ì§œ í‰í™”ê°€ ì™€.",
                            closure: "ê·¸ ë§ˆì¹¨í‘œê°€ ìƒˆë¡œìš´ ë¬¸ìž¥ì˜ ì‹œìž‘ì ì´ ë  ê±°ì•¼. ë¬´í•œí•œ ê°€ëŠ¥ì„±ì´ ê¸°ë‹¤ë ¤.",
                            release: "ë†“ì•„ì¤€ ê²ƒë“¤ì´ ë³„ì´ ë˜ì–´ ë„ˆë¥¼ ì§€í‚¬ ê±°ì•¼. ë” ì´ìƒ ë¬´ê²ì§€ ì•Šê²Œ.",
                            healing: "ì¹˜ìœ ëŠ” ì‹œê°„ ì—¬í–‰ ê°™ì•„. ê³¼ê±°ì™€ í˜„ìž¬ì™€ ë¯¸ëž˜ê°€ í•˜ë‚˜ë¡œ ì—°ê²°ë˜ëŠ” ìˆœê°„.",
                            validation: "ê·¸ ì¸ì •ì´ ì‹œê³µê°„ì„ ë„˜ì–´ì„œ ì „í•´ì§ˆ ê±°ì•¼. ë©”ì‹œì§€ì˜ ì§„ì§œ ëª©ì ì§€ë¡œ.",
                            general: "ë„ˆëŠ” ì§€ê¸ˆ, ë³´ë‚´ì§€ ëª»í•œ ë§ì„ ë– ë‚˜ë³´ë‚¸ ê±°ì•¼. ì´ì œëŠ” ë„¤ê°€ ë‹¤ì‹œ ê±¸ì„ ì°¨ë¡€ì•¼."
                        },
                        en: {
                            farewell: "You've just let go of words you couldn't send. Now it's time for you to walk again.",
                            gratitude: "That gratitude will warmly send those messages somewhere in the universe.",
                            regret: "Regret isn't a path to the past, but a way to better understand the present.",
                            acceptance: "Acceptance is a law of the universe. True peace comes when you don't resist.",
                            closure: "That period will become the starting point of a new sentence. Infinite possibilities await.",
                            release: "What you've let go will become stars to protect you. No longer heavy.",
                            healing: "Healing is like time travel. The moment when past, present, and future connect as one.",
                            validation: "That acknowledgment will be conveyed beyond space and time. To the true destination of the message.",
                            general: "You've just let go of words you couldn't send. Now it's time for you to walk again."
                        },
                        pt: {
                            farewell: "VocÃª acabou de deixar ir palavras que nÃ£o conseguiu enviar. Agora Ã© hora de vocÃª caminhar novamente.",
                            gratitude: "Essa gratidÃ£o enviarÃ¡ calorosamente essas mensagens para algum lugar no universo.",
                            regret: "Arrependimento nÃ£o Ã© um caminho para o passado, mas uma forma de entender melhor o presente.",
                            acceptance: "AceitaÃ§Ã£o Ã© uma lei do universo. Verdadeira paz vem quando vocÃª nÃ£o resiste.",
                            closure: "Esse ponto final se tornarÃ¡ o ponto de partida de uma nova frase. Possibilidades infinitas aguardam.",
                            release: "O que vocÃª deixou ir se tornarÃ¡ estrelas para protegÃª-lo. NÃ£o mais pesado.",
                            healing: "Cura Ã© como viagem no tempo. O momento quando passado, presente e futuro se conectam como um.",
                            validation: "Esse reconhecimento serÃ¡ transmitido alÃ©m do espaÃ§o e tempo. Para o verdadeiro destino da mensagem.",
                            general: "VocÃª acabou de deixar ir palavras que nÃ£o conseguiu enviar. Agora Ã© hora de vocÃª caminhar novamente."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 21ì´ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!' :
                    currentLanguage === 'en' ? 
                    'Portal 21 will be ready soon!' :
                    'Portal 21 estarÃ¡ pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 20ì„ ë‹¤ì‹œ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 20?' :
                    'Deseja reiniciar o Portal 20?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-20",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-20",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 20 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 20 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>