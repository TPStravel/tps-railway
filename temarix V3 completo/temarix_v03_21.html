<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 21: Letters Never Written to Myself</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 21: Letters Never Written to Myself</div>
            <div class="portal-subtitle" id="portalSubtitle">Words I Couldn't Give Myself</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">ðŸŒŒ Portal 21 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 22</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Write the first sentence of that letter to yourself now... (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì •ì˜ ìš©ê´‘ë¡œ",
                portalMainTitle: "Portal 21: ë‚˜ì—ê²Œ ì“°ì§€ ëª»í•œ íŽ¸ì§€",
                portalSubtitle: "ë‚˜ì—ê²Œ ì£¼ì§€ ëª»í•œ ë§ë“¤",
                portalIntro: "âœ‰ï¸ ëˆ„êµ¬ì—ê²Œë„ ë³´ë‚¼ ìˆ˜ ì—†ì—ˆë˜ ê·¸ ë§ë“¤,\ní˜¹ì‹œ ë‹¹ì‹  ìžì‹ ì—ê²Œì¡°ì°¨ ì“°ì§€ ëª»í•œ íŽ¸ì§€ê°€ ìžˆì—ˆë‚˜ìš”?\n\nê·¸ íŽ¸ì§€ì— ë‹´ê¸°ì§€ ëª»í•œ ê°ì •ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?\n\në‚´ê°€ ë‚˜í•œí…Œ í•´ì£¼ê³  ì‹¶ì€ ë§ì´ ìžˆì—ˆì–´ìš”.\nê·¼ë° ì´ìƒí•˜ê²Œâ€¦ ê·¸ê²Œ ì œì¼ ì–´ë ¤ì› ì–´ìš”.\në‚˜ë¥¼ íƒ“í•˜ì§€ ì•Šê³  íŽ¸ì§€ë¥¼ ì“´ë‹¤ëŠ” ê²Œ.",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ë§í•˜ì§€ ëª»í•œ ê°ì •ì¼ìˆ˜ë¡ ì²œì²œížˆ, ê·¸ëŸ¬ë‚˜ í™•ì‹¤í•˜ê²Œ ë„ˆë¥¼ ê¸°ë‹¤ë ¤.",
                portalQuestion: "âœ‰ï¸ ì§€ê¸ˆ ì´ ìˆœê°„, ê·¸ íŽ¸ì§€ì˜ ì²« ë¬¸ìž¥ì„ ì¨ë³¸ë‹¤ë©´\nì–´ë–¤ ë§ë¡œ ë‹¹ì‹  ìžì‹ ì—ê²Œ ë§ì„ ê±¸ê³  ì‹¶ë‚˜ìš”?",
                finalTitle: "ðŸŒŒ Portal 21 ì™„ë£Œ",
                finalMessage: "ë‹¹ì‹ ì€ ë§ˆì¹¨ë‚´ ìžì‹ ì—ê²Œ íŽ¸ì§€ë¥¼ ì¼ìŠµë‹ˆë‹¤.\n\nê·¸ ì²« ë¬¸ìž¥ì€ ì˜¤ëž«ë™ì•ˆ ì¹¨ë¬µí–ˆë˜ ë§ˆìŒì˜ ë¬¸ì„ ì—´ì—ˆì–´ìš”.\nìžì‹ ì„ íƒ“í•˜ì§€ ì•Šê³ , ì´í•´í•˜ê³ , ê²©ë ¤í•˜ëŠ” ë§ë“¤ì´\nì´ì œ ë‹¹ì‹ ì˜ ë‚´ë©´ì—ì„œ í˜ëŸ¬ë‚˜ì˜¬ ìˆ˜ ìžˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\níƒ€ì¸ì—ê²ŒëŠ” ì‰½ê²Œ ì£¼ë˜ ìœ„ë¡œì™€ ê²©ë ¤ë¥¼\nìžì‹ ì—ê²Œë„ ì¤„ ìˆ˜ ìžˆë‹¤ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.\nìžê¸° ì‚¬ëž‘ì€ ì´ê¸°ì‹¬ì´ ì•„ë‹ˆë¼ ì„±ìž¥ì˜ ì‹œìž‘ì´ë¼ëŠ” ê²ƒì„ìš”.\n\në‹¤ìŒ Portalì—ì„œëŠ” ì•„ë¬´ë„ ëª°ëžë˜ íŠ¹ë³„í•œ í•˜ë£¨ì™€\nê·¸ë‚  í˜¼ìž ê²¬ëŽŒë‚¸ ê°ì •ë“¤ì´ ê¸°ë‹¤ë¦¬ê³  ìžˆìŠµë‹ˆë‹¤.",
                continueBtn: "Portal 22ë¡œ ì´ë™",
                restartBtn: "ë‹¤ì‹œ ì‹œìž‘í•˜ê¸°",
                inputPlaceholder: "ë‚˜ì—ê²Œ ì“°ëŠ” íŽ¸ì§€ì˜ ì²« ë¬¸ìž¥ì„ ì¨ë³´ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 21: Letters Never Written to Myself",
                portalSubtitle: "Words I Couldn't Give Myself",
                portalIntro: "âœ‰ï¸ Those words you couldn't send to anyone,\nwere there perhaps letters you couldn't even write to yourself?\n\nWhat emotions couldn't be contained in that letter?\n\nThere were words I wanted to say to myself.\nBut strangely... that was the hardest thing.\nWriting a letter without blaming myself.",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "The more unspoken the emotion, the more slowly but surely it waits for you.",
                portalQuestion: "âœ‰ï¸ Right now, if you could write the first sentence of that letter,\nwhat words would you like to say to yourself?",
                finalTitle: "ðŸŒŒ Portal 21 Complete",
                finalMessage: "You have finally written a letter to yourself.\n\nThat first sentence opened the door of your heart that had been silent for so long.\nWords of understanding, encouragement, and compassionâ€”not blameâ€”\ncan now flow from within you.\n\nYou've realized that the comfort and encouragement you easily gave to others\nyou can also give to yourself.\nSelf-love isn't selfishness but the beginning of growth.\n\nIn the next Portal, a special day that no one knew about\nand the emotions you endured alone that day await you.",
                continueBtn: "Move to Portal 22",
                restartBtn: "Start Again",
                inputPlaceholder: "Write the first sentence of that letter to yourself now... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 21: Cartas Nunca Escritas Para Mim",
                portalSubtitle: "Palavras Que NÃ£o Consegui Me Dar",
                portalIntro: "âœ‰ï¸ Aquelas palavras que vocÃª nÃ£o conseguiu enviar para ninguÃ©m,\ntalvez houvesse cartas que vocÃª nÃ£o conseguiu nem escrever para si mesmo?\n\nQue emoÃ§Ãµes nÃ£o puderam ser contidas nessa carta?\n\nHavia palavras que eu queria dizer para mim mesmo.\nMas estranhamente... isso era a coisa mais difÃ­cil.\nEscrever uma carta sem me culpar.",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Quanto mais nÃ£o expressa a emoÃ§Ã£o, mais devagar mas certamente ela espera por vocÃª.",
                portalQuestion: "âœ‰ï¸ Agora mesmo, se vocÃª pudesse escrever a primeira frase dessa carta,\nque palavras gostaria de dizer para si mesmo?",
                finalTitle: "ðŸŒŒ Portal 21 Completo",
                finalMessage: "VocÃª finalmente escreveu uma carta para si mesmo.\n\nEssa primeira frase abriu a porta do seu coraÃ§Ã£o que esteve silencioso por tanto tempo.\nPalavras de compreensÃ£o, encorajamento e compaixÃ£oâ€”nÃ£o culpaâ€”\nagora podem fluir de dentro de vocÃª.\n\nVocÃª percebeu que o conforto e encorajamento que facilmente dava aos outros\nvocÃª tambÃ©m pode dar a si mesmo.\nAmor prÃ³prio nÃ£o Ã© egoÃ­smo mas o inÃ­cio do crescimento.\n\nNo prÃ³ximo Portal, um dia especial que ninguÃ©m conhecia\ne as emoÃ§Ãµes que vocÃª suportou sozinho naquele dia o aguardam.",
                continueBtn: "Ir para Portal 22",
                restartBtn: "ComeÃ§ar Novamente",
                inputPlaceholder: "Escreva a primeira frase dessa carta para si mesmo agora... (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "íƒ€ì¸ì—ê²ŒëŠ” ì‰½ê²Œ ì“°ëŠ” ë§ë„, ìžì‹ ì—ê²ŒëŠ” ëë‚´ ì“°ì§€ ëª»í•  ë•Œê°€ ìžˆì–´.",
                en: "Words we easily write to others, we sometimes can never write to ourselves.",
                pt: "Palavras que facilmente escrevemos para outros, Ã s vezes nunca conseguimos escrever para nÃ³s mesmos."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ê·¸ íŽ¸ì§€ëŠ” ì˜¤ëž˜ëœ ì¹¨ë¬µìœ¼ë¡œ ìŒ“ì—¬ ìžˆì—ˆê² ì§€. ì´ì œ ë„ˆëŠ” ì¡°ê¸ˆì”© ê·¸ê²ƒì„ í’€ê³  ìžˆì–´.",
                en: "That letter was piled up with old silence. Now you're slowly unraveling it.",
                pt: "Essa carta estava empilhada com silÃªncio antigo. Agora vocÃª estÃ¡ lentamente desvendando isso."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ë‚˜ëŠ” ë‚˜ ìžì‹ ì—ê²Œ í™”ë§Œ ëƒˆì—ˆì–´. íŽ¸ì§€ ëŒ€ì‹ , ë¹„ë‚œìœ¼ë¡œ í•˜ë£¨ë¥¼ ë§ˆì³¤ì§€.",
                en: "I only got angry at myself. Instead of letters, I ended my days with blame.",
                pt: "Eu sÃ³ ficava bravo comigo mesmo. Em vez de cartas, terminava meus dias com culpa."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ë„ˆëŠ” ìžì‹ ì—ê²Œ íŽ¸ì§€ë¥¼ ì“°ì§€ ì•Šì€ ê²Œ ì•„ë‹ˆë¼, ê°ížˆ ì“°ì§€ ëª»í•œ ì±„ ì‚´ì•„ì˜¨ ê±°ì•¼.",
                en: "You didn't not write letters to yourself, you've been living without daring to write them.",
                pt: "VocÃª nÃ£o deixou de escrever cartas para si mesmo, vocÃª tem vivido sem ousar escrevÃª-las."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ì¢…ì´ ìœ„ì— ë²ˆì§ˆ ìˆ˜ ìžˆì—ˆë˜ ê°ì •ì€ ì•„ë§ˆ ì—°ì•½í•œ ì—°ë¶„í™ìƒ‰ì´ì—ˆì„ ê±°ì•¼.",
                en: "The emotion that could have spread on that paper was probably a fragile pink.",
                pt: "A emoÃ§Ã£o que poderia ter se espalhado naquele papel provavelmente era um rosa frÃ¡gil."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë„ˆëŠ” ëŠ˜ ë‹¤ë¥¸ ì‚¬ëžŒë¶€í„° ë¨¼ì € ì±™ê²¼ì§€. ë„ˆí•œí…Œ ì“°ëŠ” íŽ¸ì§€ëŠ” ì œì¼ ë§ˆì§€ë§‰ì´ì—ˆì–´.",
                en: "You always took care of others first. Letters to yourself were always last.",
                pt: "VocÃª sempre cuidou dos outros primeiro. Cartas para si mesmo eram sempre por Ãºltimo."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê·¸ íŽ¸ì§€ë¥¼ ë‹¤ì‹œ êº¼ë‚¸ë‹¤ëŠ” ê±´ ë„ˆ ìžì‹ ê³¼ ë‹¤ì‹œ ì—°ê²°ëœë‹¤ëŠ” ëœ»ì´ì•¼.",
                en: "Taking out that letter again means reconnecting with yourself.",
                pt: "Tirar aquela carta novamente significa se reconectar consigo mesmo."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ë§í•˜ì§€ ëª»í•œ ê°ì •ì¼ìˆ˜ë¡ ì²œì²œížˆ, ê·¸ëŸ¬ë‚˜ í™•ì‹¤í•˜ê²Œ ë„ˆë¥¼ ê¸°ë‹¤ë ¤.",
                en: "The more unspoken the emotion, the more slowly but surely it waits for you.",
                pt: "Quanto mais nÃ£o expressa a emoÃ§Ã£o, mais devagar mas certamente ela espera por vocÃª."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                self_compassion: ['good job', 'well done', 'proud', 'strong', 'ìˆ˜ê³ í–ˆì–´', 'ìž˜í–ˆì–´', 'ê³ ìƒí–ˆì–´', 'ê°•í•´', 'bom trabalho', 'bem feito', 'orgulhoso', 'forte'],
                self_forgiveness: ['sorry', 'forgive', 'understand', 'okay', 'ë¯¸ì•ˆí•´', 'ìš©ì„œí•´', 'ì´í•´í•´', 'ê´œì°®ì•„', 'desculpa', 'perdoe', 'entendo', 'tudo bem'],
                encouragement: ['can do', 'will be', 'believe', 'hope', 'í•  ìˆ˜ ìžˆì–´', 'ë  ê±°ì•¼', 'ë¯¿ì–´', 'í¬ë§', 'consegue', 'vai ser', 'acredito', 'esperanÃ§a'],
                gratitude: ['thank you', 'grateful', 'appreciate', 'ê³ ë§ˆì›Œ', 'ê°ì‚¬í•´', 'ê³ ë§™', 'obrigado', 'grato', 'agradeÃ§o'],
                acknowledgment: ['recognize', 'see you', 'acknowledge', 'valid', 'ì¸ì •í•´', 'ì•Œì•„ë´', 'ì¸ì‹í•´', 'ì†Œì¤‘í•´', 'reconheÃ§o', 'te vejo', 'reconheÃ§o', 'vÃ¡lido'],
                love: ['love you', 'care', 'precious', 'valuable', 'ì‚¬ëž‘í•´', 'ì†Œì¤‘í•´', 'ì•„ê»´', 'ê·€í•´', 'te amo', 'cuido', 'precioso', 'valioso'],
                support: ['with you', 'not alone', 'together', 'support', 'í•¨ê»˜', 'í˜¼ìžê°€ ì•„ë‹ˆì•¼', 'ì§€ì§€í•´', 'ê³ì— ìžˆì–´', 'contigo', 'nÃ£o sozinho', 'juntos', 'apoio'],
                healing: ['heal', 'better', 'peace', 'rest', 'ì¹˜ìœ ', 'ë‚˜ì•„ì ¸', 'í‰í™”', 'ì‰¬ì–´', 'cura', 'melhor', 'paz', 'descanso']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            self_compassion: "ê·¸ ë§ì€ ìžŠí˜€ì¡Œë˜ ë„ˆì˜ ì´ë¦„ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì£¼ëŠ” ë¬¸ìž¥ì´ì•¼. ì§€ê¸ˆ ë„ˆëŠ” ë„ˆì—ê²Œ ëŒì•„ê°€ê³  ìžˆì–´.",
                            self_forgiveness: "ìš©ì„œëŠ” ìžì‹ ì—ê²Œ ì£¼ëŠ” ê°€ìž¥ í° ì„ ë¬¼ì´ì•¼. ì´ì œ ê·¸ ì§ì„ ë‚´ë ¤ë†“ì„ ìˆ˜ ìžˆì–´.",
                            encouragement: "ê²©ë ¤ì˜ ë§ì€ ë§ˆìŒ ì•ˆì— ìž‘ì€ ë¶ˆì”¨ë¥¼ í”¼ì›Œ. ê·¸ ë¶ˆë¹›ì´ ì•žê¸¸ì„ ë°í˜€ì¤„ ê±°ì•¼.",
                            gratitude: "ìžì‹ ì—ê²Œ í•˜ëŠ” ê°ì‚¬ëŠ” ê°€ìž¥ ì§„ì‹¤í•œ ê°ì‚¬ì•¼. ê·¸ ë§ˆìŒì´ ë„ˆë¥¼ ì¹˜ìœ í•´.",
                            acknowledgment: "ì¸ì •ë°›ê³  ì‹¶ì—ˆë˜ ë§ˆìŒì´ ë§ˆì¹¨ë‚´ ì¸ì •ë°›ì•˜ì–´. ê°€ìž¥ ì¤‘ìš”í•œ ì‚¬ëžŒì—ê²Œ.",
                            love: "ìžê¸° ì‚¬ëž‘ì€ ì´ê¸°ì‹¬ì´ ì•„ë‹ˆì•¼. ê·¸ê²ƒì€ ëª¨ë“  ì‚¬ëž‘ì˜ ì‹œìž‘ì ì´ì•¼.",
                            support: "ë„¤ê°€ ë„¤ íŽ¸ì´ ë˜ì–´ì¤€ë‹¤ëŠ” ê²ƒ, ê·¸ë³´ë‹¤ ë“ ë“ í•œ ì¼ì€ ì—†ì–´.",
                            healing: "ì¹˜ìœ ì˜ ì²«ê±¸ìŒì€ ìžì‹ ì—ê²Œ ë‹¤ì •í•´ì§€ëŠ” ê±°ì•¼. ë„ˆëŠ” ê·¸ê±¸ ì‹œìž‘í–ˆì–´.",
                            general: "ê·¸ ë§ì€ ìžŠí˜€ì¡Œë˜ ë„ˆì˜ ì´ë¦„ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì£¼ëŠ” ë¬¸ìž¥ì´ì•¼. ì§€ê¸ˆ ë„ˆëŠ” ë„ˆì—ê²Œ ëŒì•„ê°€ê³  ìžˆì–´."
                        },
                        en: {
                            self_compassion: "Those words are sentences that call your forgotten name again. Now you're returning to yourself.",
                            self_forgiveness: "Forgiveness is the greatest gift you give yourself. Now you can put down that burden.",
                            encouragement: "Words of encouragement kindle a small flame in your heart. That light will illuminate your path.",
                            gratitude: "Gratitude to yourself is the most truthful gratitude. That heart will heal you.",
                            acknowledgment: "The heart that wanted to be recognized has finally been acknowledged. By the most important person.",
                            love: "Self-love isn't selfishness. It's the starting point of all love.",
                            support: "Having yourself on your sideâ€”there's nothing more reliable than that.",
                            healing: "The first step of healing is being kind to yourself. You've started that.",
                            general: "Those words are sentences that call your forgotten name again. Now you're returning to yourself."
                        },
                        pt: {
                            self_compassion: "Essas palavras sÃ£o frases que chamam seu nome esquecido novamente. Agora vocÃª estÃ¡ retornando para si mesmo.",
                            self_forgiveness: "PerdÃ£o Ã© o maior presente que vocÃª dÃ¡ a si mesmo. Agora vocÃª pode largar esse fardo.",
                            encouragement: "Palavras de encorajamento acendem uma pequena chama em seu coraÃ§Ã£o. Essa luz iluminarÃ¡ seu caminho.",
                            gratitude: "GratidÃ£o para si mesmo Ã© a gratidÃ£o mais verdadeira. Esse coraÃ§Ã£o o curarÃ¡.",
                            acknowledgment: "O coraÃ§Ã£o que queria ser reconhecido finalmente foi reconhecido. Pela pessoa mais importante.",
                            love: "Amor prÃ³prio nÃ£o Ã© egoÃ­smo. Ã‰ o ponto de partida de todo amor.",
                            support: "Ter vocÃª mesmo do seu ladoâ€”nÃ£o hÃ¡ nada mais confiÃ¡vel que isso.",
                            healing: "O primeiro passo da cura Ã© ser gentil consigo mesmo. VocÃª comeÃ§ou isso.",
                            general: "Essas palavras sÃ£o frases que chamam seu nome esquecido novamente. Agora vocÃª estÃ¡ retornando para si mesmo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            self_compassion: "ê·¸ í•œ ë¬¸ìž¥ìœ¼ë¡œ ë§ˆìŒì˜ ë¬¸ì´ ì—´ë ¸ì–´. ì´ì   ë” ë§Žì€ ë§ì„ ì¨ë‚´ë ¤ê°ˆ ìˆ˜ ìžˆì„ ê±°ì•¼.",
                            self_forgiveness: "ìš©ì„œëŠ” ê³¼ê±°ë¥¼ ì§€ìš°ëŠ” ê²Œ ì•„ë‹ˆë¼, í˜„ìž¬ë¥¼ ì‚´ íž˜ì„ ì£¼ëŠ” ê±°ì•¼.",
                            encouragement: "ìŠ¤ìŠ¤ë¡œì—ê²Œ ì£¼ëŠ” ê²©ë ¤ëŠ” ê°€ìž¥ ìˆœìˆ˜í•œ ì—ë„ˆì§€ì•¼. ê·¸ íž˜ìœ¼ë¡œ ë‹¤ì‹œ ì¼ì–´ì„¤ ìˆ˜ ìžˆì–´.",
                            gratitude: "ê°ì‚¬ëŠ” ë§ˆìŒì˜ ê· í˜•ì„ ë§žì¶°ì¤˜. ìžì‹ ì—ê²Œ í•˜ëŠ” ê°ì‚¬ëŠ” ê·¸ ì¤‘ì‹¬ì„ ìž¡ì•„ì¤˜.",
                            acknowledgment: "ì¸ì •ì€ ì¹˜ìœ ì˜ ì‹œìž‘ì´ì•¼. ìžì‹ ì„ ì¸ì •í•œ ë„ˆëŠ” ì´ì œ ì§„ì§œë¡œ ì„±ìž¥í•  ìˆ˜ ìžˆì–´.",
                            love: "ìžê¸° ì‚¬ëž‘ì€ ë§ˆìŒì˜ ë¿Œë¦¬ì•¼. ê·¸ ë¿Œë¦¬ê°€ ê¹Šì–´ì§ˆìˆ˜ë¡ ë” ë†’ì´ ìžëž„ ìˆ˜ ìžˆì–´.",
                            support: "ë„¤ê°€ ë„¤ ê³ì— ìžˆë‹¤ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ì„¸ìƒì€ ëœ ì™¸ë¡œì›Œì ¸.",
                            healing: "ì¹˜ìœ ëŠ” ìžì‹ ì—ê²Œ ëŒì•„ì˜¤ëŠ” ì—¬í–‰ì´ì•¼. ë„ˆëŠ” ì§€ê¸ˆ ê·¸ ê¸¸ ìœ„ì— ìžˆì–´.",
                            general: "ê·¸ í•œ ë¬¸ìž¥ìœ¼ë¡œ ë§ˆìŒì˜ ë¬¸ì´ ì—´ë ¸ì–´. ì´ì   ë” ë§Žì€ ë§ì„ ì¨ë‚´ë ¤ê°ˆ ìˆ˜ ìžˆì„ ê±°ì•¼."
                        },
                        en: {
                            self_compassion: "That one sentence opened the door of your heart. Now you can write down many more words.",
                            self_forgiveness: "Forgiveness isn't erasing the past, but giving strength to live in the present.",
                            encouragement: "Self-encouragement is the purest energy. With that power, you can rise again.",
                            gratitude: "Gratitude balances the heart. Gratitude to yourself centers that balance.",
                            acknowledgment: "Recognition is the beginning of healing. Having acknowledged yourself, you can now truly grow.",
                            love: "Self-love is the root of the heart. The deeper that root, the higher you can grow.",
                            support: "Just having yourself by your side makes the world less lonely.",
                            healing: "Healing is a journey back to yourself. You're on that path now.",
                            general: "That one sentence opened the door of your heart. Now you can write down many more words."
                        },
                        pt: {
                            self_compassion: "Essa uma frase abriu a porta do seu coraÃ§Ã£o. Agora vocÃª pode escrever muitas mais palavras.",
                            self_forgiveness: "PerdÃ£o nÃ£o Ã© apagar o passado, mas dar forÃ§a para viver no presente.",
                            encouragement: "Auto-encorajamento Ã© a energia mais pura. Com esse poder, vocÃª pode se levantar novamente.",
                            gratitude: "GratidÃ£o equilibra o coraÃ§Ã£o. GratidÃ£o para si mesmo centraliza esse equilÃ­brio.",
                            acknowledgment: "Reconhecimento Ã© o inÃ­cio da cura. Tendo se reconhecido, vocÃª agora pode verdadeiramente crescer.",
                            love: "Amor prÃ³prio Ã© a raiz do coraÃ§Ã£o. Quanto mais profunda essa raiz, mais alto vocÃª pode crescer.",
                            support: "Apenas ter vocÃª mesmo ao seu lado torna o mundo menos solitÃ¡rio.",
                            healing: "Cura Ã© uma jornada de volta para si mesmo. VocÃª estÃ¡ nesse caminho agora.",
                            general: "Essa uma frase abriu a porta do seu coraÃ§Ã£o. Agora vocÃª pode escrever muitas mais palavras."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            self_compassion: "ê·¸ ê¸€ê·€ëŠ” ëˆˆì— ë³´ì´ì§€ ì•Šì§€ë§Œ, ê°€ìž¥ ì•„ë¦„ë‹¤ìš´ ìƒ‰ìœ¼ë¡œ ë„¤ ì•ˆì— ë²ˆì§€ê³  ìžˆì–´.",
                            self_forgiveness: "ìš©ì„œì˜ ìƒ‰ì€ ë¶€ë“œëŸ¬ìš´ í•˜ëŠ˜ìƒ‰ì´ì•¼. ìžì±…ì˜ ì–´ë‘ìš´ ìƒ‰ì„ ë®ì–´ì£¼ëŠ” ìƒ‰.",
                            encouragement: "ê²©ë ¤ëŠ” ë”°ëœ»í•œ í™©ê¸ˆë¹›ì´ì•¼. ë„¤ ë§ˆìŒì— í¬ë§ì˜ ë¹›ì„ ê·¸ë¦¬ê³  ìžˆì–´.",
                            gratitude: "ê°ì‚¬ëŠ” ì—°í•œ ì´ˆë¡ìƒ‰ì´ì•¼. ìƒˆë¡œìš´ ì‹œìž‘ì„ ì•½ì†í•˜ëŠ” ìƒëª…ì˜ ìƒ‰ê¹”.",
                            acknowledgment: "ì¸ì •ì€ ìˆœìˆ˜í•œ í°ìƒ‰ì´ì•¼. ëª¨ë“  ìƒ‰ê¹”ì„ ë‹´ì„ ìˆ˜ ìžˆëŠ” ì™„ì „í•œ ìƒ‰.",
                            love: "ìžê¸° ì‚¬ëž‘ì€ ë”°ëœ»í•œ ë¶„í™ë¹›ì´ì•¼. ë§ˆìŒ ì „ì²´ë¥¼ ë¶€ë“œëŸ½ê²Œ ê°ì‹¸ëŠ” ìƒ‰.",
                            support: "ì§€ì§€ëŠ” ë“ ë“ í•œ ê°ˆìƒ‰ì´ì•¼. í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ë‚˜ë¬´ì˜ ë¿Œë¦¬ ê°™ì€ ìƒ‰ê¹”.",
                            healing: "ì¹˜ìœ ëŠ” ì—°ë³´ë¼ìƒ‰ì´ì•¼. ìƒì²˜ë¥¼ ê°ì‹¸ë©° ì²œì²œížˆ ì•„ë¬¼ê²Œ í•˜ëŠ” ìƒ‰.",
                            general: "ê·¸ ê¸€ê·€ëŠ” ëˆˆì— ë³´ì´ì§€ ì•Šì§€ë§Œ, ê°€ìž¥ ì•„ë¦„ë‹¤ìš´ ìƒ‰ìœ¼ë¡œ ë„¤ ì•ˆì— ë²ˆì§€ê³  ìžˆì–´."
                        },
                        en: {
                            self_compassion: "Those words are invisible but spreading within you in the most beautiful color.",
                            self_forgiveness: "The color of forgiveness is soft sky blue. A color that covers the dark color of self-blame.",
                            encouragement: "Encouragement is warm golden light. It's painting light of hope in your heart.",
                            gratitude: "Gratitude is light green. The color of life that promises new beginnings.",
                            acknowledgment: "Recognition is pure white. A complete color that can contain all colors.",
                            love: "Self-love is warm pink. A color that gently wraps around your entire heart.",
                            support: "Support is solid brown. A color like the roots of an unshakeable tree.",
                            healing: "Healing is light purple. A color that wraps wounds and slowly heals them.",
                            general: "Those words are invisible but spreading within you in the most beautiful color."
                        },
                        pt: {
                            self_compassion: "Essas palavras sÃ£o invisÃ­veis mas se espalhando dentro de vocÃª na cor mais bela.",
                            self_forgiveness: "A cor do perdÃ£o Ã© azul-cÃ©u suave. Uma cor que cobre a cor escura da auto-culpa.",
                            encouragement: "Encorajamento Ã© luz dourada quente. EstÃ¡ pintando luz de esperanÃ§a em seu coraÃ§Ã£o.",
                            gratitude: "GratidÃ£o Ã© verde claro. A cor da vida que promete novos comeÃ§os.",
                            acknowledgment: "Reconhecimento Ã© branco puro. Uma cor completa que pode conter todas as cores.",
                            love: "Amor prÃ³prio Ã© rosa quente. Uma cor que envolve suavemente todo o seu coraÃ§Ã£o.",
                            support: "Apoio Ã© marrom sÃ³lido. Uma cor como as raÃ­zes de uma Ã¡rvore inabalÃ¡vel.",
                            healing: "Cura Ã© roxo claro. Uma cor que envolve feridas e as cura lentamente.",
                            general: "Essas palavras sÃ£o invisÃ­veis mas se espalhando dentro de vocÃª na cor mais bela."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 22ê°€ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!' :
                    currentLanguage === 'en' ? 
                    'Portal 22 will be ready soon!' :
                    'Portal 22 estarÃ¡ pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 21ì„ ë‹¤ì‹œ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 21?' :
                    'Deseja reiniciar o Portal 21?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-21",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-21",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 21 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 21 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>