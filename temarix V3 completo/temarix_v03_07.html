<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 07: The Self Buried in Others' Gaze</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 07: The Self Buried in Others' Gaze</div>
            <div class="portal-subtitle" id="portalSubtitle">Living Within the Eyes of Others</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">👁‍🗨 Portal 07 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 08</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="If you could step out of that gaze and stand as your authentic self, what would you look like now? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 07: 타인의 시선 속에 묻힌 나",
                portalSubtitle: "타인의 눈길 속에서 살아가는 나",
                portalIntro: "👁‍🗨 당신은 언제부터, 타인의 시선 안에 살고 있었나요?\n\n누군가가 어떻게 볼지 먼저 생각하게 되고,\n그 눈길을 의식해서 표정을 만들고, 말투를 바꾸고,\n행동을 조심하며 살아온 시간들.\n\n언제부턴가 거울을 보는 것처럼 자연스럽게\n다른 사람의 눈을 통해 나를 바라보게 되었죠.\n\n\"저 사람이 날 어떻게 생각할까?\"\n\"이렇게 말하면 이상하게 보이지 않을까?\"\n\"실망시키면 어떻게 하지?\"\n\n그 시선들 사이에서 진짜 당신은 어디로 숨었나요?\n그 눈길 속에서 당신은 어떤 얼굴을 하고 있었나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "타인의 시선은 거울이 아닙니다. 당신이 스스로를 바라보는 눈이 가장 진실에 가깝습니다.",
                portalQuestion: "👁‍🗨 타인의 시선을 벗고, 오롯한 나로 서게 된다면 지금의 나는 어떤 모습일까요?",
                finalTitle: "👁‍🗨 Portal 07 완료",
                finalMessage: "당신은 용기 있게 타인의 시선에서 한 발짝 나왔습니다.\n\n그동안 다른 사람의 눈을 통해 자신을 바라보며\n진짜 모습을 숨기고 살았던 시간들이\n얼마나 힘들었는지 인정하셨죠.\n\n이제 당신만의 시선으로\n자신을 바라볼 수 있게 되었습니다.\n\n다음 Portal에서는 깊숙이 감춰둔\n기억의 상자를 열어보는 여정이 이어집니다.",
                continueBtn: "Portal 08로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "타인의 시선을 벗고 진짜 나로 선다면, 지금 어떤 모습일지 말해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 07: The Self Buried in Others' Gaze",
                portalSubtitle: "Living Within the Eyes of Others",
                portalIntro: "👁‍🗨 Since when have you been living within the gaze of others?\n\nThinking first about how someone might see you,\ncrafting expressions with their eyes in mind, changing your tone,\nbeing careful with your actions through all those times.\n\nAt some point, as naturally as looking in a mirror,\nyou began to see yourself through other people's eyes.\n\n\"What will they think of me?\"\n\"Won't I look strange if I say this?\"\n\"What if I disappoint them?\"\n\nAmidst all those gazes, where did the real you hide?\nWhat kind of face were you wearing in their sight?",
                lightTitle: "✨ Word of Light",
                lightMessage: "Others' gazes are not mirrors. The eyes with which you see yourself are closest to the truth.",
                portalQuestion: "👁‍🗨 If you could step out of that gaze and stand as your authentic self, what would you look like now?",
                finalTitle: "👁‍🗨 Portal 07 Complete",
                finalMessage: "You have courageously stepped out of others' gazes.\n\nYou acknowledged how difficult it was\nto live while hiding your true self,\nseeing yourself through other people's eyes\nall this time.\n\nNow you can look at yourself\nthrough your own eyes.\n\nIn the next Portal, a journey continues\nto open the box of deeply hidden memories.",
                continueBtn: "Move to Portal 08",
                restartBtn: "Start Again",
                inputPlaceholder: "If you could step out of that gaze and stand as your authentic self, what would you look like now? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 07: O Eu Enterrado no Olhar dos Outros",
                portalSubtitle: "Vivendo Dentro dos Olhos dos Outros",
                portalIntro: "👁‍🗨 Desde quando você tem vivido dentro do olhar dos outros?\n\nPensando primeiro em como alguém pode te ver,\ncriando expressões com seus olhos em mente, mudando seu tom,\nsendo cuidadoso com suas ações durante todos esses momentos.\n\nEm algum ponto, tão naturalmente quanto olhar no espelho,\nvocê começou a se ver através dos olhos de outras pessoas.\n\n\"O que eles vão pensar de mim?\"\n\"Não vou parecer estranho se disser isso?\"\n\"E se eu os decepcionar?\"\n\nNo meio de todos esses olhares, onde o verdadeiro você se escondeu?\nQue tipo de rosto você estava usando na vista deles?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Os olhares dos outros não são espelhos. Os olhos com os quais você se vê estão mais próximos da verdade.",
                portalQuestion: "👁‍🗨 Se você pudesse sair desse olhar e se colocar como seu eu autêntico, como você seria agora?",
                finalTitle: "👁‍🗨 Portal 07 Completo",
                finalMessage: "Você corajosamente saiu dos olhares dos outros.\n\nVocê reconheceu o quão difícil foi\nviver escondendo seu verdadeiro eu,\nvendo-se através dos olhos de outras pessoas\ntodo esse tempo.\n\nAgora você pode olhar para si mesmo\natravés de seus próprios olhos.\n\nNo próximo Portal, uma jornada continua\npara abrir a caixa de memórias profundamente escondidas.",
                continueBtn: "Ir para Portal 08",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "Se você pudesse sair desse olhar e se colocar como seu eu autêntico, como você seria agora? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "너는 너무 오래 거울이 되어 있었지. 타인의 표정만을 반사하며, 스스로를 잊은 채.",
                en: "You've been a mirror for too long. Reflecting only others' expressions while forgetting yourself.",
                pt: "Você foi um espelho por muito tempo. Refletindo apenas as expressões dos outros enquanto se esquecia de si mesmo."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "그 시선 속의 너는 조용했고, 조심스러웠지. 나는 그 침묵 속 외침을 들었어.",
                en: "You in that gaze were quiet and cautious. I heard the cry within that silence.",
                pt: "Você naquele olhar era quieto e cauteloso. Eu ouvi o grito dentro daquele silêncio."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "보이는 대로 살아야 한다는 말… 얼마나 많은 너를 가두게 만들었을까.",
                en: "The expectation to live as you appear... how much of you did that imprison?",
                pt: "A expectativa de viver como você aparenta... quanto de você isso aprisionou?"
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "시선은 무게가 있어. 네가 느꼈던 압박은 허상이 아니야. 진짜 너는 그 밑에서 숨 쉬고 있었던 거야.",
                en: "Gazes have weight. The pressure you felt wasn't an illusion. The real you was breathing beneath all that.",
                pt: "Os olhares têm peso. A pressão que você sentiu não era uma ilusão. O verdadeiro você estava respirando debaixo de tudo isso."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "네 얼굴에 붙은 표정들… 진짜 너의 색은 그 아래에서 얼마나 흔들렸을까?",
                en: "The expressions pasted on your face... how much did your true colors tremble underneath?",
                pt: "As expressões coladas no seu rosto... quanto suas verdadeiras cores tremeram por baixo?"
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "남들이 널 판단하기 전에, 너 스스로를 단죄했겠지. 나도 그 싸움을 했었어.",
                en: "Before others could judge you, you condemned yourself. I've fought that battle too.",
                pt: "Antes que outros pudessem te julgar, você se condenou. Eu também lutei essa batalha."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "넌 늘 연기했지만, 그건 거짓이 아니라 살아남기 위한 방식이었을지도 몰라.",
                en: "You always performed, but that wasn't falsehood—it might have been your way of surviving.",
                pt: "Você sempre atuou, mas isso não era falsidade—pode ter sido sua maneira de sobreviver."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "진짜 널 꺼내는 데엔 시간도, 용기도 필요해. 오늘 그 문을 조금 열었구나.",
                en: "Bringing out the real you takes time and courage. Today you've opened that door a little.",
                pt: "Trazer o verdadeiro você para fora leva tempo e coragem. Hoje você abriu essa porta um pouco."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                authentic: ['authentic', 'real', 'true', 'genuine', 'honest'],
                free: ['free', 'liberated', 'independent', 'unbound'],
                confident: ['confident', 'strong', 'brave', 'bold'],
                peaceful: ['peaceful', 'calm', 'quiet', 'serene'],
                creative: ['creative', 'artistic', 'expressive', 'colorful'],
                vulnerable: ['vulnerable', 'open', 'exposed', 'fragile'],
                happy: ['happy', 'joyful', 'bright', 'cheerful'],
                uncertain: ['uncertain', 'confused', 'lost', 'unsure'],
                angry: ['angry', 'mad', 'fierce', 'rebellious'],
                sad: ['sad', 'melancholy', 'quiet', 'withdrawn']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            authentic: "흔들리는 너, 그 자체로 아름다워. 누군가를 따라 만들지 않아도 돼.",
                            free: "자유로운 네 모습이 얼마나 빛나는지 알아? 그 날개를 펼칠 시간이야.",
                            confident: "그 당당함이 진짜 너구나. 이제 아무도 네 빛을 가릴 수 없어.",
                            peaceful: "고요한 너의 힘을 느껴. 평온함 속에서 진정한 강함이 나와.",
                            general: "흔들리는 너, 그 자체로 아름다워. 누군가를 따라 만들지 않아도 돼."
                        },
                        en: {
                            authentic: "You, trembling as you are, are beautiful just like that. You don't need to be molded after someone else.",
                            free: "Do you know how radiant your free self is? It's time to spread those wings.",
                            confident: "That confidence is the real you. Now no one can dim your light.",
                            peaceful: "I feel the power in your quietness. True strength emerges from tranquility.",
                            general: "You, trembling as you are, are beautiful just like that. You don't need to be molded after someone else."
                        },
                        pt: {
                            authentic: "Você, tremendo como está, é lindo assim mesmo. Você não precisa ser moldado segundo outra pessoa.",
                            free: "Você sabe quão radiante é seu eu livre? É hora de abrir essas asas.",
                            confident: "Essa confiança é o verdadeiro você. Agora ninguém pode diminuir sua luz.",
                            peaceful: "Eu sinto o poder na sua quietude. A verdadeira força emerge da tranquilidade.",
                            general: "Você, tremendo como está, é lindo assim mesmo. Você não precisa ser moldado segundo outra pessoa."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            authentic: "'그냥 나'라는 선언이 얼마나 강한지 알아? 그건 세상에 처음으로 너를 보여주는 일이야.",
                            vulnerable: "약해 보이는 것도 용기야. 진짜 강함은 약함을 숨기지 않는 데서 나와.",
                            uncertain: "확신이 없어도 괜찮아. 길을 찾아가는 과정 자체가 너의 진짜 모습이니까.",
                            creative: "네 안의 창조성이 깨어나고 있어. 이제 세상은 네 색으로 칠해질 거야.",
                            general: "'그냥 나'라는 선언이 얼마나 강한지 알아? 그건 세상에 처음으로 너를 보여주는 일이야."
                        },
                        en: {
                            authentic: "Do you know how powerful the declaration 'just me' is? It's showing yourself to the world for the first time.",
                            vulnerable: "Appearing vulnerable is also courage. True strength comes from not hiding weakness.",
                            uncertain: "It's okay to be uncertain. The process of finding your way is your true self.",
                            creative: "The creativity within you is awakening. Now the world will be painted in your colors.",
                            general: "Do you know how powerful the declaration 'just me' is? It's showing yourself to the world for the first time."
                        },
                        pt: {
                            authentic: "Você sabe quão poderosa é a declaração 'apenas eu'? É mostrar-se ao mundo pela primeira vez.",
                            vulnerable: "Parecer vulnerável também é coragem. A verdadeira força vem de não esconder a fraqueza.",
                            uncertain: "Está tudo bem ser incerto. O processo de encontrar seu caminho é seu verdadeiro eu.",
                            creative: "A criatividade dentro de você está despertando. Agora o mundo será pintado com suas cores.",
                            general: "Você sabe quão poderosa é a declaração 'apenas eu'? É mostrar-se ao mundo pela primeira vez."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "🧑‍🎨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            creative: "그 솔직함이야말로 가장 빛나는 색이야. 이제 캔버스는 네 것이야.",
                            happy: "네 기쁨의 색깔이 얼마나 따뜻한지! 그 밝음으로 세상을 물들여.",
                            sad: "슬픔도 아름다운 색이야. 그 깊이가 네 그림을 더욱 풍부하게 만들어.",
                            angry: "그 분노의 빨간색, 숨기지 마. 그것도 네 팔레트의 일부야.",
                            general: "그 솔직함이야말로 가장 빛나는 색이야. 이제 캔버스는 네 것이야."
                        },
                        en: {
                            creative: "That honesty is the most radiant color. Now the canvas is yours.",
                            happy: "How warm the color of your joy is! Paint the world with that brightness.",
                            sad: "Sadness is also a beautiful color. That depth makes your painting richer.",
                            angry: "That red of your anger, don't hide it. It's also part of your palette.",
                            general: "That honesty is the most radiant color. Now the canvas is yours."
                        },
                        pt: {
                            creative: "Essa honestidade é a cor mais radiante. Agora a tela é sua.",
                            happy: "Quão quente é a cor da sua alegria! Pinte o mundo com esse brilho.",
                            sad: "A tristeza também é uma cor linda. Essa profundidade torna sua pintura mais rica.",
                            angry: "Esse vermelho da sua raiva, não esconda. Também faz parte da sua paleta.",
                            general: "Essa honestidade é a cor mais radiante. Agora a tela é sua."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 08이 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 08 will be ready soon!' :
                    'Portal 08 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 07을 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 07?' :
                    'Deseja reiniciar o Portal 07?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-07",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-07",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 07 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 07 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>