<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 05: Clothed in Silence</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 05: Clothed in Silence</div>
            <div class="portal-subtitle" id="portalSubtitle">When You Believed Not Speaking Could Protect You</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">🧥 Portal 05 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 06</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me what you most wanted to shout out in that silence... (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 05: 침묵의 옷을 입은 채",
                portalSubtitle: "말하지 않는 것이 지켜줄 수 있다고 믿었던 순간",
                portalIntro: "🧥 당신은 침묵이라는 옷을 입고 있었던 적이 있나요?\n\n말하지 않는 것이 당신을 지켜줄 수 있다고 믿었던 순간들.\n말하면 실망시킬까 봐, 상처를 줄까 봐, 관계가 무너질까 봐...\n\n그래서 당신은 조용한 미소를 지었고, 괜찮다고 말했고,\n아무것도 아니라고 손을 흔들었을지도 모릅니다.\n\n침묵은 때로는 방패가 되어주었지만,\n때로는 가장 무거운 갑옷이 되기도 했죠.\n\n그 침묵 속에 숨겨둔 진짜 목소리는 지금도 당신 안에서\n조용히 말하고 있을지도 모릅니다.",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "침묵도 하나의 언어입니다. 하지만 가장 중요한 대화는 당신 자신과 나누는 것이니까요.",
                portalQuestion: "🧥 그 침묵 속에서 가장 크게 외치고 싶었던 말은 무엇이었나요?",
                finalTitle: "🧥 Portal 05 완료",
                finalMessage: "당신은 침묵의 옷을 벗고 진정한 목소리를 찾았습니다.\n\n그 무거운 갑옷을 내려놓는 것은 용기가 필요했지만,\n이제 당신의 진심이 세상에 닿을 수 있게 되었습니다.\n\n다음 Portal에서는 과거의 그림자와 마주하며\n또 다른 감정의 여정이 기다리고 있습니다.\n\n당신의 목소리가 계속해서\n세상에 울려퍼지기를 바랍니다.",
                continueBtn: "Portal 06으로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "그 침묵 속에서 가장 크게 외치고 싶었던 말은 무엇이었는지 말해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 05: Clothed in Silence",
                portalSubtitle: "When You Believed Not Speaking Could Protect You",
                portalIntro: "🧥 Have you ever worn the clothing of silence?\n\nThose moments when you believed not speaking could protect you.\nAfraid of disappointing, afraid of hurting, afraid of breaking relationships...\n\nSo you smiled quietly, said you were fine,\nand waved your hand saying it was nothing.\n\nSilence sometimes became a shield for you,\nbut sometimes it became the heaviest armor.\n\nThe real voice hidden in that silence may still be\nquietly speaking within you even now.",
                lightTitle: "✨ Word of Light",
                lightMessage: "Silence is also a language. But the most important conversation is the one you have with yourself.",
                portalQuestion: "🧥 What was the message you most wanted to shout out in that silence?",
                finalTitle: "🧥 Portal 05 Complete",
                finalMessage: "You have shed the clothing of silence and found your true voice.\n\nIt took courage to put down that heavy armor,\nbut now your sincerity can reach the world.\n\nIn the next Portal, facing the shadows of the past,\nanother emotional journey awaits.\n\nMay your voice continue to\nresonate throughout the world.",
                continueBtn: "Move to Portal 06",
                restartBtn: "Start Again",
                inputPlaceholder: "Tell me what you most wanted to shout out in that silence... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 05: Vestido de Silêncio",
                portalSubtitle: "Quando Acreditou que Não Falar Poderia Te Proteger",
                portalIntro: "🧥 Você já usou as roupas do silêncio?\n\nAqueles momentos quando acreditou que não falar poderia te proteger.\nCom medo de decepcionar, com medo de machucar, com medo de quebrar relacionamentos...\n\nEntão você sorriu silenciosamente, disse que estava bem,\ne acenou dizendo que não era nada.\n\nO silêncio às vezes se tornou um escudo para você,\nmas às vezes se tornou a armadura mais pesada.\n\nA voz real escondida naquele silêncio ainda pode estar\nfalando silenciosamente dentro de você agora.",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "O silêncio também é uma linguagem. Mas a conversa mais importante é aquela que você tem consigo mesmo.",
                portalQuestion: "🧥 Qual foi a mensagem que mais quis gritar naquele silêncio?",
                finalTitle: "🧥 Portal 05 Completo",
                finalMessage: "Você tirou as roupas do silêncio e encontrou sua verdadeira voz.\n\nFoi preciso coragem para baixar essa armadura pesada,\nmas agora sua sinceridade pode alcançar o mundo.\n\nNo próximo Portal, enfrentando as sombras do passado,\noutra jornada emocional espera.\n\nQue sua voz continue a\necoar pelo mundo.",
                continueBtn: "Ir para Portal 06",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "Me diga o que mais quis gritar naquele silêncio... (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "네 침묵은 방패였어. 조용한 무기였고, 조용한 상처였지.",
                en: "Your silence was a shield. A quiet weapon, and a quiet wound.",
                pt: "Seu silêncio era um escudo. Uma arma silenciosa, e uma ferida silenciosa."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "말하지 않음은 비겁함이 아니야. 때로는 너무 많이 느끼는 사람들이 택하는 방식이야.",
                en: "Not speaking isn't cowardice. Sometimes it's the way chosen by those who feel too much.",
                pt: "Não falar não é covardia. Às vezes é o caminho escolhido por aqueles que sentem demais."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "나는 그 침묵 속의 눈빛을 알아. 그건 충분히 말하고 있었어.",
                en: "I know the look in your eyes during that silence. It was speaking enough.",
                pt: "Eu conheço o olhar em seus olhos durante aquele silêncio. Estava falando o suficiente."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "침묵은 생각보다 많은 이야기를 담고 있지. 그것을 들을 줄 아는 사람만이 진심을 보지.",
                en: "Silence contains more stories than you think. Only those who know how to listen can see the sincerity.",
                pt: "O silêncio contém mais histórias do que você imagina. Apenas aqueles que sabem escutar podem ver a sinceridade."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "그 침묵은 어떤 색이었을까? 투명했을까, 회색이었을까, 아니면 검은 빛이었을까?",
                en: "What color was that silence? Was it transparent, gray, or perhaps black light?",
                pt: "Que cor tinha aquele silêncio? Era transparente, cinza, ou talvez luz negra?"
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "넌 늘 참았지. 말할 타이밍도, 말할 권리도 빼앗긴 채.",
                en: "You always endured. Deprived of timing to speak, deprived of the right to speak.",
                pt: "Você sempre aguentou. Privado do momento de falar, privado do direito de falar."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "침묵은 우주야. 외로움과 넓음이 공존하는 공간. 넌 그 안에 있었던 거야.",
                en: "Silence is the universe. A space where loneliness and vastness coexist. You were inside it.",
                pt: "O silêncio é o universo. Um espaço onde a solidão e a vastidão coexistem. Você estava dentro dele."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "말하지 않아도 괜찮아. 다만, 그 침묵이 너를 무겁게 만들고 있다면… 이제 내려놔도 좋아.",
                en: "It's okay not to speak. But if that silence is weighing you down... it's okay to let it go now.",
                pt: "Está tudo bem não falar. Mas se esse silêncio está te pesando... está tudo bem deixar ir agora."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                pain: ['hurt', 'pain', 'suffering', 'ache'],
                fear: ['afraid', 'scared', 'fear', 'terrified'],
                silence: ['silent', 'quiet', 'mute', 'wordless'],
                loneliness: ['lonely', 'alone', 'isolated', 'abandoned'],
                love: ['love', 'care', 'affection', 'warmth'],
                anger: ['angry', 'mad', 'furious', 'rage'],
                helpless: ['helpless', 'powerless', 'weak', 'unable'],
                sorry: ['sorry', 'apologize', 'regret', 'guilt'],
                hope: ['hope', 'wish', 'dream', 'better'],
                truth: ['truth', 'honest', 'real', 'genuine']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            pain: "네가 말하지 않았던 그 순간들, 나는 그 울림을 지금 느껴. 늦었지만, 난 듣고 있어.",
                            fear: "두려움 속에서도 당신은 누군가를 지키려 했죠. 그 마음을 이제 알 것 같아요.",
                            silence: "그 침묵은 가장 깊은 외침이었어. 나는 그 소리를 들었어.",
                            general: "네가 말하지 않았던 그 순간들, 나는 그 울림을 지금 느껴. 늦었지만, 난 듣고 있어."
                        },
                        en: {
                            pain: "Those moments when you didn't speak, I feel that resonance now. Though late, I'm listening.",
                            fear: "Even in fear, you tried to protect someone. I think I understand that heart now.",
                            silence: "That silence was the deepest cry. I heard that sound.",
                            general: "Those moments when you didn't speak, I feel that resonance now. Though late, I'm listening."
                        },
                        pt: {
                            pain: "Aqueles momentos quando você não falou, eu sinto essa ressonância agora. Embora tarde, estou ouvindo.",
                            fear: "Mesmo no medo, você tentou proteger alguém. Acho que entendo esse coração agora.",
                            silence: "Esse silêncio foi o grito mais profundo. Eu ouvi esse som.",
                            general: "Aqueles momentos quando você não falou, eu sinto essa ressonância agora. Embora tarde, estou ouvindo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Kael", emoji: "🧙",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            pain: "'괜찮지 않다'는 고백은 가장 용감한 선언 중 하나야. 그건 무너짐이 아니라 진실의 시작이야.",
                            truth: "진실을 말하는 것은 가장 어려운 마법이지. 하지만 당신은 이제 그걸 해냈어.",
                            helpless: "무력감도 하나의 감정이야. 그것을 인정하는 것부터 힘이 시작되지.",
                            general: "'괜찮지 않다'는 고백은 가장 용감한 선언 중 하나야. 그건 무너짐이 아니라 진실의 시작이야."
                        },
                        en: {
                            pain: "Confessing 'I'm not okay' is one of the bravest declarations. It's not collapse, but the beginning of truth.",
                            truth: "Speaking the truth is the most difficult magic. But you've done it now.",
                            helpless: "Helplessness is also an emotion. Acknowledging it is where strength begins.",
                            general: "Confessing 'I'm not okay' is one of the bravest declarations. It's not collapse, but the beginning of truth."
                        },
                        pt: {
                            pain: "Confessar 'não estou bem' é uma das declarações mais corajosas. Não é colapso, mas o início da verdade.",
                            truth: "Falar a verdade é a magia mais difícil. Mas você conseguiu agora.",
                            helpless: "O desamparo também é uma emoção. Reconhecê-lo é onde a força começa.",
                            general: "Confessar 'não estou bem' é uma das declarações mais corajosas. Não é colapso, mas o início da verdade."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Enya", emoji: "🧑‍🚀",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "말이 없었다고 해서, 네 존재가 작아진 건 아니야. 오히려 그 침묵은 네 가장 큰 외침이었을지도 몰라.",
                            love: "사랑한다는 말을 못했더라도, 그 마음은 우주 어딘가에 남아있어. 지금도 누군가에게 닿고 있을 거야.",
                            hope: "침묵 속에서도 희망은 자라고 있었어. 작은 씨앗처럼, 조용히.",
                            general: "말이 없었다고 해서, 네 존재가 작아진 건 아니야. 오히려 그 침묵은 네 가장 큰 외침이었을지도 몰라."
                        },
                        en: {
                            loneliness: "Just because you were silent doesn't mean your existence became smaller. That silence might have been your greatest cry.",
                            love: "Even if you couldn't say you loved, that heart remains somewhere in the universe. It's probably reaching someone even now.",
                            hope: "Even in silence, hope was growing. Like a small seed, quietly.",
                            general: "Just because you were silent doesn't mean your existence became smaller. That silence might have been your greatest cry."
                        },
                        pt: {
                            loneliness: "Só porque você ficou em silêncio não significa que sua existência se tornou menor. Esse silêncio pode ter sido seu maior grito.",
                            love: "Mesmo que você não conseguisse dizer que amava, esse coração permanece em algum lugar do universo. Provavelmente está alcançando alguém agora.",
                            hope: "Mesmo no silêncio, a esperança estava crescendo. Como uma pequena semente, silenciosamente.",
                            general: "Só porque você ficou em silêncio não significa que sua existência se tornou menor. Esse silêncio pode ter sido seu maior grito."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 06이 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 06 will be ready soon!' :
                    'Portal 06 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 05를 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 05?' :
                    'Deseja reiniciar o Portal 05?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-05",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-05",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 05 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 05 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>