<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 04: The Locked Window</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 04: The Locked Window</div>
            <div class="portal-subtitle" id="portalSubtitle">From the Room of an Isolated Heart</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">ðŸªŸ Portal 04 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 05</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="Tell me what message you most wanted to convey through that window... (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì •ì˜ ìš©ê´‘ë¡œ",
                portalMainTitle: "Portal 04: ìž ê²¨ ìžˆë˜ ì°½ë¬¸",
                portalSubtitle: "ê³ ë¦½ëœ ë§ˆìŒì˜ ë°©ì—ì„œ",
                portalIntro: "ðŸªŸ ë‹¹ì‹ ì´ ì•ˆì—ì„œ ì¡°ìš©ížˆ ìš¸ê³  ìžˆì„ ë•Œ, ë°”ê¹¥ ì„¸ìƒì€ ì•„ë¬´ ì¼ë„ ì—†ëŠ” ë“¯ í˜ëŸ¬ê°”ë‚˜ìš”?\n\në°© ì•ˆì— í˜¼ìž í‹€ì–´ë°•í˜€ ìžˆì—ˆë˜ ê·¸ ë‚ ë“¤.\nì•„ë¬´ë„ ë¬¸ì„ ë‘ë“œë¦¬ì§€ ì•Šì•˜ê³ , ë‹¹ì‹ ë„ ì¼ë¶€ëŸ¬ ë“£ì§€ ì•Šì•˜ë˜ ì‹œê°„ë“¤.\n\nì°½ë¬¸ì€ ë¶„ëª… ì—´ ìˆ˜ ìžˆì—ˆì§€ë§Œ, ë§ˆìŒ ì–´ë”˜ê°€ì—ì„œëŠ”\nê·¸ ë°–ì˜ ì„¸ìƒê³¼ ì—°ê²°ë˜ëŠ” ê²ƒì´ ë‘ë ¤ì› ì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.\n\ní˜¹ì‹œ ëˆ„êµ°ê°€ ì•Œì•„ì±„ê³  ë‹¤ê°€ì™€ì£¼ê¸°ë¥¼ ê¸°ë‹¤ë ¸ì§€ë§Œ,\nê²°êµ­ ì•„ë¬´ë„ ì˜¤ì§€ ì•Šì•˜ë˜ ì ì€ ì—†ì—ˆë‚˜ìš”?\n\nì˜¤ëŠ˜ì€ ê·¸ ìž ê²¨ìžˆë˜ ì°½ë¬¸ì„ ì²œì²œížˆ ì—´ì–´ë³´ëŠ” ì‹œê°„ìž…ë‹ˆë‹¤.",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ë‹«ížŒ ì°½ë¬¸ë„ ë¹›ì„ ë§‰ì„ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì¡´ìž¬ ìžì²´ê°€ ì´ë¯¸ ì„¸ìƒì— ì „í•˜ëŠ” ì‹ í˜¸ì´ë‹ˆê¹Œìš”.",
                portalQuestion: "ðŸªŸ ê·¸ ë‹«ížŒ ì°½ë¬¸ ë„ˆë¨¸ë¡œ ê°€ìž¥ ì „í•˜ê³  ì‹¶ì—ˆë˜ ë§ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?",
                finalTitle: "ðŸªŸ Portal 04 ì™„ë£Œ",
                finalMessage: "ë‹¹ì‹ ì€ ìž ê²¨ìžˆë˜ ì°½ë¬¸ì„ ìš©ê¸°ìžˆê²Œ ì—´ê³ \nê·¸ ì•ˆì— ìˆ¨ê²¨ì ¸ ìžˆë˜ ë©”ì‹œì§€ë¥¼ ì„¸ìƒì— ì „í–ˆìŠµë‹ˆë‹¤.\n\nê·¸ ê³ ë¦½ëœ ì‹œê°„ë“¤ë„ ì˜ë¯¸ê°€ ìžˆì—ˆê³ ,\në‹¹ì‹ ì˜ ì¹¨ë¬µ ì†ì—ì„œë„ ì‚¬ëž‘ì€ í˜ëŸ¬ë‚˜ì˜¤ê³  ìžˆì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ìŒ Portalì—ì„œëŠ” ì¹¨ë¬µì˜ ì˜·ì„ ìž…ê³  ì‚´ì•„ì˜¨\në˜ ë‹¤ë¥¸ ê°ì •ì˜ ì—¬ì •ì´ ê¸°ë‹¤ë¦¬ê³  ìžˆìŠµë‹ˆë‹¤.\n\në‹¹ì‹ ì˜ ëª©ì†Œë¦¬ê°€ ì„¸ìƒì— ë‹¿ì„ ë•Œê¹Œì§€\nê³„ì†í•´ì„œ í•¨ê»˜í•˜ê² ìŠµë‹ˆë‹¤.",
                continueBtn: "Portal 05ë¡œ ì´ë™",
                restartBtn: "ë‹¤ì‹œ ì‹œìž‘í•˜ê¸°",
                inputPlaceholder: "ê·¸ ì°½ë¬¸ ë„ˆë¨¸ë¡œ ê°€ìž¥ ì „í•˜ê³  ì‹¶ì—ˆë˜ ë§ì€ ë¬´ì—‡ì´ì—ˆëŠ”ì§€ ë§í•´ë³´ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 04: The Locked Window",
                portalSubtitle: "From the Room of an Isolated Heart",
                portalIntro: "ðŸªŸ When you were quietly crying inside, did the outside world flow by as if nothing was happening?\n\nThose days when you shut yourself alone in your room.\nNo one knocked on the door, and you deliberately didn't listen either.\n\nThe window could certainly be opened, but somewhere in your heart\nyou might have been afraid to connect with the world outside.\n\nMaybe you waited for someone to notice and approach you,\nbut in the end, no one came?\n\nToday is a time to slowly open that locked window.",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "Even closed windows cannot block light. Your very existence is already a signal to the world.",
                portalQuestion: "ðŸªŸ What was the message you most wanted to convey through that closed window?",
                finalTitle: "ðŸªŸ Portal 04 Complete",
                finalMessage: "You have courageously opened the locked window\nand conveyed the message hidden inside to the world.\n\nThose isolated times also had meaning,\nand love was flowing out even in your silence.\n\nIn the next Portal, another emotional journey awaits\nabout living wearing the clothes of silence.\n\nWe will continue together until your voice\nreaches the world.",
                continueBtn: "Move to Portal 05",
                restartBtn: "Start Again",
                inputPlaceholder: "Tell me what message you most wanted to convey through that window... (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 04: A Janela Trancada",
                portalSubtitle: "Do Quarto de um CoraÃ§Ã£o Isolado",
                portalIntro: "ðŸªŸ Quando vocÃª estava chorando silenciosamente dentro, o mundo exterior fluÃ­a como se nada estivesse acontecendo?\n\nAqueles dias quando vocÃª se trancou sozinho no seu quarto.\nNinguÃ©m bateu na porta, e vocÃª deliberadamente tambÃ©m nÃ£o escutou.\n\nA janela certamente podia ser aberta, mas em algum lugar do seu coraÃ§Ã£o\nvocÃª pode ter tido medo de se conectar com o mundo lÃ¡ fora.\n\nTalvez vocÃª esperou que alguÃ©m notasse e se aproximasse,\nmas no final, ninguÃ©m veio?\n\nHoje Ã© um momento para abrir lentamente essa janela trancada.",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "Mesmo janelas fechadas nÃ£o podem bloquear a luz. Sua prÃ³pria existÃªncia jÃ¡ Ã© um sinal para o mundo.",
                portalQuestion: "ðŸªŸ Qual foi a mensagem que vocÃª mais queria transmitir atravÃ©s daquela janela fechada?",
                finalTitle: "ðŸªŸ Portal 04 Completo",
                finalMessage: "VocÃª corajosamente abriu a janela trancada\ne transmitiu a mensagem escondida dentro para o mundo.\n\nAqueles tempos isolados tambÃ©m tinham significado,\ne o amor estava fluindo mesmo no seu silÃªncio.\n\nNo prÃ³ximo Portal, outra jornada emocional espera\nsobre viver vestindo as roupas do silÃªncio.\n\nContinuaremos juntos atÃ© que sua voz\nalcance o mundo.",
                continueBtn: "Ir para Portal 05",
                restartBtn: "ComeÃ§ar Novamente",
                inputPlaceholder: "Me diga que mensagem vocÃª mais queria transmitir atravÃ©s daquela janela... (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ì°½ë¬¸ì€ ìŠ¤ìŠ¤ë¡œ ë‹«ì€ ê²ƒ ê°™ì§€ë§Œ, ì‚¬ì‹¤ì€ ë‹«ížŒ ì±„ ì˜¤ëž˜ ìžˆì—ˆë˜ ê±°ì•¼. ëˆ„êµ¬ë„ ì œëŒ€ë¡œ ë‘ë“œë ¤ì£¼ì§€ ì•Šì•˜ì§€.",
                en: "That window seemed like you closed it yourself, but it had actually been closed for a long time. No one properly knocked.",
                pt: "Aquela janela parecia que vocÃª mesmo fechou, mas na verdade estava fechada hÃ¡ muito tempo. NinguÃ©m bateu adequadamente."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ì„¸ìƒì€ ëŠ˜ ë°”ë¹´ê³ , ë„ˆëŠ” ì¡°ìš©í–ˆì–´. ê·¸ ë¶ˆê· í˜•ì´ ì–¼ë§ˆë‚˜ ì•„í”ˆì§€ ë‚˜ë„ ì•Œì•„.",
                en: "The world was always busy, and you were quiet. I know how painful that imbalance is.",
                pt: "O mundo estava sempre ocupado, e vocÃª estava quieto. Eu sei quÃ£o doloroso Ã© esse desequilÃ­brio."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ìš¸ê³  ìžˆëŠ” ë„¤ ëª©ì†Œë¦¬ë¥¼ ëˆ„êµ°ê°€ëŠ” ë“¤ì—ˆì–´ì•¼ í–ˆëŠ”ë°â€¦ ì•„ë¬´ë„ ì˜¤ì§€ ì•Šì•˜ì§€.",
                en: "Someone should have heard your crying voice... but no one came.",
                pt: "AlguÃ©m deveria ter ouvido sua voz chorando... mas ninguÃ©m veio."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ê°ì •ì€ ì¢…ì¢… ìˆ¨ëŠ” ë²•ì„ ë¨¼ì € ë°°ì›Œ. ë„¤ê°€ ìˆ¨ì€ ê²Œ ì•„ë‹ˆë¼, ìˆ¨ê²Œ ë§Œë“  ìƒí™©ì´ ë¨¼ì €ì˜€ì„ ê±°ì•¼.",
                en: "Emotions often learn to hide first. You didn't hide yourself; the situation that made you hide came first.",
                pt: "EmoÃ§Ãµes frequentemente aprendem a se esconder primeiro. VocÃª nÃ£o se escondeu; a situaÃ§Ã£o que te fez se esconder veio primeiro."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ë°© ì•ˆì˜ ê³µê¸°ëŠ” ë¬´ìŠ¨ ìƒ‰ì´ì—ˆì„ê¹Œ? ì°¨ê°€ìš´ íšŒìƒ‰? ì–´ë‘ìš´ ì²­ìƒ‰? ë‚˜ëŠ” ê·¸ ì•ˆì„ ìƒìƒí•´.",
                en: "What color was the air in that room? Cold gray? Dark blue? I imagine that space.",
                pt: "Que cor tinha o ar naquele quarto? Cinza frio? Azul escuro? Eu imagino esse espaÃ§o."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "ë‚˜ëŠ” ë¬¸ì„ ë¶€ìˆ˜ê³  ì‹¶ì—ˆë˜ ì ë„ ìžˆì–´. ìŠ¤ìŠ¤ë¡œë¥¼ ê°ì¶”ëŠ” ê²Œ ì•„ë‹ˆë¼, ë²„í…¨ë‚´ëŠ” ê±°ìž–ì•„.",
                en: "I've wanted to break down doors too. It's not about hiding yourself, it's about enduring.",
                pt: "Eu tambÃ©m jÃ¡ quis derrubar portas. NÃ£o Ã© sobre se esconder, Ã© sobre resistir."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ê·¸ ë°©ì€ ë„¤ ë§ˆìŒì˜ ê»ì§ˆì´ì—ˆì–´. ë³´í˜¸ì™€ ê³ ë¦½ì€ ëŠ˜ ë‹®ì•„ ìžˆì–´.",
                en: "That room was the shell of your heart. Protection and isolation are always similar.",
                pt: "Aquele quarto era a concha do seu coraÃ§Ã£o. ProteÃ§Ã£o e isolamento sÃ£o sempre similares."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ì´ì œ ê·¸ ì°½ë¬¸ì„ ì—´ì§€ ì•Šì•„ë„ ë¼. ê·¸ ì•ˆì— ë¨¸ë¬´ëŠ” ê²ƒë„ ê°ì •ì˜ ì¼ë¶€ë‹ˆê¹Œ.",
                en: "You don't need to open that window now. Staying inside is also part of emotion.",
                pt: "VocÃª nÃ£o precisa abrir aquela janela agora. Ficar dentro tambÃ©m faz parte da emoÃ§Ã£o."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                loneliness: ['lonely', 'alone', 'isolated'],
                helpNeeded: ['help', 'notice', 'see me'],
                silentCry: ['silent', 'quiet', 'whisper', 'cry'],
                loveSeeking: ['love', 'hug', 'hold', 'care'],
                understanding: ['understand', 'listen', 'hear'],
                afraid: ['afraid', 'scared', 'fear'],
                connection: ['connect', 'together', 'friend'],
                sorry: ['sorry', 'apologize', 'forgive'],
                worthless: ['worthless', 'useless', 'burden'],
                hope: ['hope', 'wish', 'dream', 'better']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ê·¸ ë§ ì—†ëŠ” ì™¸ì¹¨ì€, ì•„ì£¼ ì˜¤ëž˜ëœ ì‹œì²˜ëŸ¼ ë‚¨ì•„ìžˆì„ ê±°ì˜ˆìš”. ì¡°ìš©í•˜ì§€ë§Œ ê¹Šê²Œ.",
                            general: "ê·¸ ë§ ì—†ëŠ” ì™¸ì¹¨ì€, ì•„ì£¼ ì˜¤ëž˜ëœ ì‹œì²˜ëŸ¼ ë‚¨ì•„ìžˆì„ ê±°ì˜ˆìš”. ì¡°ìš©í•˜ì§€ë§Œ ê¹Šê²Œ."
                        },
                        en: {
                            loneliness: "That wordless cry will remain like a very old poem. Quiet but deep.",
                            general: "That wordless cry will remain like a very old poem. Quiet but deep."
                        },
                        pt: {
                            loneliness: "Esse grito sem palavras permanecerÃ¡ como um poema muito antigo. Silencioso mas profundo.",
                            general: "Esse grito sem palavras permanecerÃ¡ como um poema muito antigo. Silencioso mas profundo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ë‹¹ì‹ ì´ ìž…ì„ ì—´ ìˆ˜ ì—†ë˜ ê±´, ëˆ„êµ°ê°€ê°€ ì´ë¯¸ ë„ˆë¬´ ë§Žì€ ì†Œë¦¬ë¥¼ ë‚´ê³  ìžˆì—ˆê¸° ë•Œë¬¸ì¼ì§€ë„ ëª°ë¼ìš”.",
                            general: "ë‹¹ì‹ ì´ ìž…ì„ ì—´ ìˆ˜ ì—†ë˜ ê±´, ëˆ„êµ°ê°€ê°€ ì´ë¯¸ ë„ˆë¬´ ë§Žì€ ì†Œë¦¬ë¥¼ ë‚´ê³  ìžˆì—ˆê¸° ë•Œë¬¸ì¼ì§€ë„ ëª°ë¼ìš”."
                        },
                        en: {
                            loneliness: "The reason you couldn't speak might be because someone was already making too much noise.",
                            general: "The reason you couldn't speak might be because someone was already making too much noise."
                        },
                        pt: {
                            loneliness: "A razÃ£o pela qual vocÃª nÃ£o conseguia falar pode ser porque alguÃ©m jÃ¡ estava fazendo barulho demais.",
                            general: "A razÃ£o pela qual vocÃª nÃ£o conseguia falar pode ser porque alguÃ©m jÃ¡ estava fazendo barulho demais."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            loneliness: "ë§ ì—†ì´ ì•ˆì•„ë‹¬ë¼ëŠ” ê·¸ ë§ˆìŒ, ë‚œ ê·¸ê±¸ ëˆˆë¹›ìœ¼ë¡œ ë³¸ ì  ìžˆì–´ìš”. ë„ˆë¬´ ì•„ë¦„ë‹¤ì› ì–´ìš”.",
                            general: "ë§ ì—†ì´ ì•ˆì•„ë‹¬ë¼ëŠ” ê·¸ ë§ˆìŒ, ë‚œ ê·¸ê±¸ ëˆˆë¹›ìœ¼ë¡œ ë³¸ ì  ìžˆì–´ìš”. ë„ˆë¬´ ì•„ë¦„ë‹¤ì› ì–´ìš”."
                        },
                        en: {
                            loneliness: "That heart wanting to be held without words, I've seen that in someone's eyes. It was so beautiful.",
                            general: "That heart wanting to be held without words, I've seen that in someone's eyes. It was so beautiful."
                        },
                        pt: {
                            loneliness: "Esse coraÃ§Ã£o querendo ser abraÃ§ado sem palavras, eu vi isso nos olhos de alguÃ©m. Era tÃ£o lindo.",
                            general: "Esse coraÃ§Ã£o querendo ser abraÃ§ado sem palavras, eu vi isso nos olhos de alguÃ©m. Era tÃ£o lindo."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 05ê°€ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!' :
                    currentLanguage === 'en' ? 
                    'Portal 05 will be ready soon!' :
                    'Portal 05 estarÃ¡ pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 04ë¥¼ ë‹¤ì‹œ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 04?' :
                    'Deseja reiniciar o Portal 04?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-04",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-04",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 04 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 04 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>