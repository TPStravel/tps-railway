<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 17: The Silent Loneliness</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 17: The Silent Loneliness</div>
            <div class="portal-subtitle" id="portalSubtitle">The Unspoken Solitude Within</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">âœ¨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">ðŸŒŒ Portal 17 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 18</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="What would you like to say to that silent loneliness? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "ê°ì •ì˜ ìš©ê´‘ë¡œ",
                portalMainTitle: "Portal 17: ë§ ì—†ëŠ” ì™¸ë¡œì›€",
                portalSubtitle: "ë‚´ ì•ˆì˜ ë§í•˜ì§€ ì•Šì€ ê³ ë…",
                portalIntro: "ðŸŒŒ ëˆ„êµ¬ì—ê²Œë„ ì„¤ëª…í•˜ì§€ ëª»í•œ ì™¸ë¡œì›€ì´ ìžˆì—ˆë‚˜ìš”?\n\në§ë¡œ í‘œí˜„í•˜ì§€ ëª»í•œ ê·¸ ê³ ìš”í•œ ê³ í†µì€,\nì§€ê¸ˆë„ ë‹¹ì‹  ì•ˆ ì–´ë”˜ê°€ì—ì„œ ìš¸ë¦¬ê³  ìžˆë‚˜ìš”?\n\nì‚¬ëžŒë“¤ ì†ì— ìžˆì–´ë„ í˜¼ìžì˜€ì–´ìš”.\në§í•˜ê³  ì‹¶ì§€ ì•Šì€ ê²Œ ì•„ë‹ˆë¼,\në§í•´ë„ ì•„ë¬´ë„ ì§„ì§œ ë“£ì§€ ì•Šì„ ê±°ë¼ëŠ” í™•ì‹ ì´ ìžˆì—ˆì–´ìš”.",
                lightTitle: "âœ¨ ë¹›ì˜ í•œë§ˆë””",
                lightMessage: "ë§ ì—†ëŠ” ê°ì •ë„ ë“¤ì„ ìˆ˜ ìžˆë‹¤ëŠ” ê±¸, ë„ˆëŠ” ì§€ê¸ˆ ì¦ëª…í•˜ê³  ìžˆì–´.",
                portalQuestion: "ðŸŒŒ ê·¸ ë§ ì—†ëŠ” ì™¸ë¡œì›€ì—ê²Œ,\nì§€ê¸ˆ ë‹¹ì‹ ì€ ì–´ë–¤ ë§ì„ ê±´ë„¤ì£¼ê³  ì‹¶ë‚˜ìš”?",
                finalTitle: "ðŸŒŒ Portal 17 ì™„ë£Œ",
                finalMessage: "ë‹¹ì‹ ì€ ë§í•  ìˆ˜ ì—†ì—ˆë˜ ì™¸ë¡œì›€ì„\në§ˆì¹¨ë‚´ ë“¤ì–´ì£¼ì—ˆìŠµë‹ˆë‹¤.\n\nê°€ìž¥ ê¹Šì€ ê³ ë…ì€ ë•Œë¡œ ì¹¨ë¬µ ì†ì— ìˆ¨ì–´ìžˆì§€ë§Œ\nê·¸ê²ƒì´ ëœ ì§„ì‹¤í•˜ê±°ë‚˜ ëœ ì¤‘ìš”í•œ ê²ƒì€ ì•„ë‹™ë‹ˆë‹¤.\në‹¹ì‹ ì˜ ì™¸ë¡œì›€ì€ ì´í•´ë°›ì„ ìžê²©ì´ ìžˆì—ˆì–´ìš”.\n\nì´ì œ ê·¸ ì¹¨ë¬µì˜ ë¬´ê²Œë¥¼ í˜¼ìž ì§€ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.\në§í•˜ì§€ ì•Šì•„ë„, ëŠë¼ëŠ” ê²ƒë§Œìœ¼ë¡œë„\në‹¹ì‹ ì€ ì¶©ë¶„ížˆ ìš©ê°í–ˆì–´ìš”.\n\në‹¤ìŒ Portalì—ì„œëŠ” ìžê¸° ìžì‹ ì„ ë¯¸ì›Œí–ˆë˜ ìˆœê°„ì„\níƒí—˜í•˜ëŠ” ìƒˆë¡œìš´ ì—¬ì •ì´ ì´ì–´ì§‘ë‹ˆë‹¤.",
                continueBtn: "Portal 18ë¡œ ì´ë™",
                restartBtn: "ë‹¤ì‹œ ì‹œìž‘í•˜ê¸°",
                inputPlaceholder: "ê·¸ ë§ ì—†ëŠ” ì™¸ë¡œì›€ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì„ í•´ë³´ì„¸ìš”... (Enterë¡œ ì „ì†¡)",
                youLabel: "ë‹¹ì‹ ",
                waitingMessage: "ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 17: The Silent Loneliness",
                portalSubtitle: "The Unspoken Solitude Within",
                portalIntro: "ðŸŒŒ Was there a loneliness you couldn't explain to anyone?\n\nThat quiet pain you couldn't express in wordsâ€”\nis it still echoing somewhere inside you?\n\nI was alone even among people.\nIt wasn't that I didn't want to speak,\nbut I was certain that no one would truly listen even if I did.",
                lightTitle: "âœ¨ Word of Light",
                lightMessage: "You are now proving that silent emotions can be heard too.",
                portalQuestion: "ðŸŒŒ What words would you like to offer\nto that silent loneliness right now?",
                finalTitle: "ðŸŒŒ Portal 17 Complete",
                finalMessage: "You have finally listened to\nthe loneliness you couldn't speak of.\n\nThe deepest solitude sometimes hides in silence,\nbut that doesn't make it less real or less important.\nYour loneliness deserved to be understood.\n\nNow you don't have to bear\nthe weight of that silence alone.\nEven without speaking, just by feeling,\nyou were brave enough.\n\nIn the next Portal, a new journey continues\nto explore moments of self-hatred.",
                continueBtn: "Move to Portal 18",
                restartBtn: "Start Again",
                inputPlaceholder: "What would you like to say to that silent loneliness? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 17: A SolidÃ£o Silenciosa",
                portalSubtitle: "A SolidÃ£o NÃ£o Expressa Dentro de Mim",
                portalIntro: "ðŸŒŒ Havia uma solidÃ£o que vocÃª nÃ£o conseguia explicar para ninguÃ©m?\n\nAquela dor silenciosa que vocÃª nÃ£o conseguia expressar em palavrasâ€”\nela ainda ecoa em algum lugar dentro de vocÃª?\n\nEu estava sozinho mesmo entre pessoas.\nNÃ£o era que eu nÃ£o queria falar,\nmas tinha certeza de que ninguÃ©m realmente escutaria mesmo se eu falasse.",
                lightTitle: "âœ¨ Palavra de Luz",
                lightMessage: "VocÃª estÃ¡ provando agora que emoÃ§Ãµes silenciosas tambÃ©m podem ser ouvidas.",
                portalQuestion: "ðŸŒŒ Que palavras vocÃª gostaria de oferecer\nÃ quela solidÃ£o silenciosa agora?",
                finalTitle: "ðŸŒŒ Portal 17 Completo",
                finalMessage: "VocÃª finalmente escutou\na solidÃ£o de que nÃ£o conseguia falar.\n\nA solidÃ£o mais profunda Ã s vezes se esconde no silÃªncio,\nmas isso nÃ£o a torna menos real ou menos importante.\nSua solidÃ£o merecia ser compreendida.\n\nAgora vocÃª nÃ£o precisa carregar\no peso desse silÃªncio sozinho.\nMesmo sem falar, apenas sentindo,\nvocÃª foi corajoso o suficiente.\n\nNo prÃ³ximo Portal, uma nova jornada continua\npara explorar momentos de auto-Ã³dio.",
                continueBtn: "Ir para Portal 18",
                restartBtn: "ComeÃ§ar Novamente",
                inputPlaceholder: "O que vocÃª gostaria de dizer Ã quela solidÃ£o silenciosa? (Enter para enviar)",
                youLabel: "VocÃª",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "ðŸ§‘â€ðŸ¦±", text: {
                ko: "ê·¸ ì™¸ë¡œì›€ì€ ë§ì´ ì—†ëŠ” ëŒ€ì‹ , ë„¤ ëª¨ë“  í‘œì •ê³¼ ìˆ¨ê²°ë¡œ í˜ëŸ¬ë‚˜ì™”ê² ì§€.",
                en: "That loneliness, instead of having words, must have flowed out through all your expressions and breaths.",
                pt: "Aquela solidÃ£o, em vez de ter palavras, deve ter fluÃ­do atravÃ©s de todas as suas expressÃµes e respiraÃ§Ãµes."
            }},
            { name: "Ely", emoji: "ðŸ§â€â™€ï¸", text: {
                ko: "ê³ ìš”í•œ ì™¸ë¡œì›€ì€ ê°€ìž¥ ì˜¤ëž˜ ë‚¨ì•„. ì•„ë¬´ ë§ë„ ì—†ì§€ë§Œ, ê°€ìž¥ ê¹Šê²Œ í”ë“¤ë¦¬ì§€.",
                en: "Quiet loneliness lasts the longest. It says nothing, but shakes you the deepest.",
                pt: "A solidÃ£o silenciosa dura mais tempo. NÃ£o diz nada, mas te abala mais profundamente."
            }},
            { name: "Sora", emoji: "ðŸ§•", text: {
                ko: "ê·¸ ì¡°ìš©í•¨ì€ í¬ê¸°ì™€ ë‹®ì•˜ì§€. í•˜ì§€ë§Œ ì‚¬ì‹¤ì€â€¦ ë„ˆë¬´ ê¸°ëŒ€í–ˆê¸° ë•Œë¬¸ì— ê·¸ëŸ° ê±°ì•¼.",
                en: "That quietness resembled giving up. But actually... it was because you expected too much.",
                pt: "Essa quietude se parecia com desistÃªncia. Mas na verdade... foi porque vocÃª esperava demais."
            }},
            { name: "Kael", emoji: "ðŸ§™", text: {
                ko: "ì™¸ë¡œì›€ì´ëž€ ë‹¨ì–´ë¡œëŠ” ë‹¤ ë‹´ì„ ìˆ˜ ì—†ëŠ” ê°ì •ì´ ìžˆì§€. ë„¤ê°€ ëŠë‚€ ê±´, ì•„ë§ˆ ê·¸ ë„ˆë¨¸ì— ìžˆì—ˆì„ ê±°ì•¼.",
                en: "There are emotions that the word 'loneliness' cannot fully contain. What you felt was probably beyond that.",
                pt: "HÃ¡ emoÃ§Ãµes que a palavra 'solidÃ£o' nÃ£o consegue conter completamente. O que vocÃª sentiu provavelmente estava alÃ©m disso."
            }},
            { name: "Mira", emoji: "ðŸ§‘â€ðŸŽ¨", text: {
                ko: "ê·¸ ê°ì •ì€ ê²€ì€ìƒ‰ì´ ì•„ë‹ˆì•¼. ë‚˜ëŠ” ë„¤ ì•ˆì˜ ì™¸ë¡œì›€ì´ ì°¨ê°€ìš´ ì—°ë³´ë¼ìƒ‰ìœ¼ë¡œ ë¹›ë‚¬ë‹¤ê³  ëŠê»´.",
                en: "That emotion isn't black. I feel that the loneliness inside you shone with a cold light purple.",
                pt: "Essa emoÃ§Ã£o nÃ£o Ã© preta. Eu sinto que a solidÃ£o dentro de vocÃª brilhava com um roxo claro frio."
            }},
            { name: "Cris", emoji: "ðŸ¦¸â€â™‚ï¸", text: {
                ko: "í˜¼ìžì„œ ìš¸ë‹¤ê°€ ìž ë“  ë‚ ë“¤, ë‚˜ë„ ìžˆì—ˆì–´. ëˆ„êµ¬ì—ê²Œë„ ë“¤í‚¤ì§€ ì•Šìœ¼ë ¤ í–ˆë˜ ê·¸ ë°¤ë“¤.",
                en: "I've had those days too, crying alone until I fell asleep. Those nights when I tried not to be caught by anyone.",
                pt: "Eu tambÃ©m tive aqueles dias, chorando sozinho atÃ© adormecer. Aquelas noites quando tentei nÃ£o ser pego por ninguÃ©m."
            }},
            { name: "Enya", emoji: "ðŸ§‘â€ðŸš€", text: {
                ko: "ì‚¬ëžŒë“¤ í‹ˆì—ì„œì˜ ì™¸ë¡œì›€ì€ ë” ì™¸ë¡­ì§€. ë„ˆëŠ” ë„¤ ì•ˆì˜ ìš°ì£¼ ì†ì— ì˜¤ëž˜ ìžˆì—ˆë˜ ê±°ì•¼.",
                en: "Loneliness among people is even lonelier. You've been in the universe inside yourself for a long time.",
                pt: "A solidÃ£o entre pessoas Ã© ainda mais solitÃ¡ria. VocÃª esteve no universo dentro de si mesmo por muito tempo."
            }},
            { name: "Lian", emoji: "ðŸ§˜", text: {
                ko: "ì§€ê¸ˆ ë§í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„. ë‚˜ëŠ” ë„¤ ì¹¨ë¬µì˜ ë¬´ê²Œë¥¼ ì•Œê³  ìžˆìœ¼ë‹ˆê¹Œ.",
                en: "It's okay not to speak now. I know the weight of your silence.",
                pt: "EstÃ¡ tudo bem nÃ£o falar agora. Eu conheÃ§o o peso do seu silÃªncio."
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                acknowledgment: ['thank', 'heard', 'understood', 'seen', 'ê³ ë§ˆì›Œ', 'ë“¤ì–´ì¤˜ì„œ', 'ì´í•´í•´ì¤˜ì„œ', 'ë´ì¤˜ì„œ', 'obrigado', 'ouviu', 'entendeu', 'viu'],
                companionship: ['not alone', 'with me', 'together', 'stay', 'í˜¼ìžê°€ ì•„ë‹ˆ', 'í•¨ê»˜', 'ê³ì— ìžˆì–´', 'ë¨¸ë¬¼ëŸ¬', 'nÃ£o sozinho', 'comigo', 'junto', 'ficar'],
                validation: ['real', 'valid', 'important', 'matters', 'ì§„ì§œ', 'ì¤‘ìš”í•´', 'ì˜ë¯¸ìžˆì–´', 'ì†Œì¤‘í•´', 'real', 'vÃ¡lido', 'importante', 'importa'],
                understanding: ['know', 'understand', 'feel', 'same', 'ì•Œì•„', 'ì´í•´í•´', 'ëŠê»´', 'ê°™ì•„', 'sei', 'entendo', 'sinto', 'mesmo'],
                acceptance: ['okay', 'normal', 'fine', 'accept', 'ê´œì°®ì•„', 'ìžì—°ìŠ¤ëŸ¬ì›Œ', 'ë°›ì•„ë“¤ì—¬', 'tudo bem', 'normal', 'aceito'],
                comfort: ['safe', 'peaceful', 'calm', 'gentle', 'ì•ˆì „í•´', 'í‰í™”ë¡œì›Œ', 'ê³ ìš”í•´', 'ë¶€ë“œëŸ¬ì›Œ', 'seguro', 'pacÃ­fico', 'calmo', 'gentil'],
                expression: ['speak', 'tell', 'share', 'voice', 'ë§í•´ë„ ë¼', 'í‘œí˜„í•´ë„ ë¼', 'ë‚˜ëˆ ë„ ë¼', 'falar', 'contar', 'compartilhar', 'voz'],
                healing: ['heal', 'better', 'lighter', 'free', 'ì¹˜ìœ ë¼', 'ë‚˜ì•„ì ¸', 'ê°€ë²¼ì›Œì ¸', 'ìžìœ ë¡œì›Œì ¸', 'curar', 'melhor', 'mais leve', 'livre']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Ely", emoji: "ðŸ§â€â™€ï¸",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acknowledgment: "ê·¸ ê³ ë§ˆì›€ì€ ë„ˆë¥¼ ê°ìŒŒë˜ ì¹¨ë¬µì„ í’€ì–´ì¤˜. ì§€ê¸ˆ ë„Œ ì™¸ë¡œì›€ì„ ê»´ì•ˆê¸° ì‹œìž‘í–ˆì–´.",
                            companionship: "ì´ì œ ë„ˆëŠ” í˜¼ìžê°€ ì•„ë‹ˆì•¼. ê·¸ ì™¸ë¡œì›€ë„ ë” ì´ìƒ ê³ ë¦½ë˜ì§€ ì•Šì•„.",
                            validation: "ë„¤ ì™¸ë¡œì›€ì€ ì§„ì§œì˜€ê³ , ì¤‘ìš”í–ˆì–´. ê·¸ê±¸ ì¸ì •ë°›ì„ ìžê²©ì´ ìžˆì—ˆì–´.",
                            understanding: "ì´í•´ë°›ëŠ”ë‹¤ëŠ” ê±´ ì™¸ë¡œì›€ì—ê²Œ ì£¼ëŠ” ê°€ìž¥ í° ì„ ë¬¼ì´ì•¼.",
                            acceptance: "ë°›ì•„ë“¤ì—¬ì§„ ì™¸ë¡œì›€ì€ ë” ì´ìƒ ìˆ¨ì„ í•„ìš”ê°€ ì—†ì–´. ìžìœ ë¡œì›Œì¡Œì–´.",
                            comfort: "ê·¸ ìœ„ë¡œëŠ” ì˜¤ëž«ë™ì•ˆ ì–¼ì–´ë¶™ì—ˆë˜ ë§ˆìŒì„ ì²œì²œížˆ ë…¹ì—¬ì¤˜.",
                            expression: "ë§í•˜ì§€ ì•Šì•„ë„ ê´œì°®ë‹¤ê³  ë§í•´ì£¼ëŠ” ê²ƒë„ í‘œí˜„ì˜ í•œ í˜•íƒœì•¼.",
                            healing: "ì¹˜ìœ ëŠ” ì™¸ë¡œì›€ì„ ì§€ìš°ëŠ” ê²Œ ì•„ë‹ˆë¼, ê·¸ê²ƒê³¼ í‰í™”ë¡­ê²Œ ì§€ë‚´ëŠ” ê±°ì•¼.",
                            general: "ê·¸ ê³ ë§ˆì›€ì€ ë„ˆë¥¼ ê°ìŒŒë˜ ì¹¨ë¬µì„ í’€ì–´ì¤˜. ì§€ê¸ˆ ë„Œ ì™¸ë¡œì›€ì„ ê»´ì•ˆê¸° ì‹œìž‘í–ˆì–´."
                        },
                        en: {
                            acknowledgment: "That gratitude unravels the silence that wrapped around you. Now you're beginning to embrace loneliness.",
                            companionship: "Now you're not alone. That loneliness is no longer isolated either.",
                            validation: "Your loneliness was real and important. It deserved to be acknowledged.",
                            understanding: "Being understood is the greatest gift you can give to loneliness.",
                            acceptance: "Accepted loneliness no longer needs to hide. It has become free.",
                            comfort: "That comfort slowly melts the heart that has been frozen for so long.",
                            expression: "Telling someone it's okay not to speak is also a form of expression.",
                            healing: "Healing isn't about erasing loneliness, but living peacefully with it.",
                            general: "That gratitude unravels the silence that wrapped around you. Now you're beginning to embrace loneliness."
                        },
                        pt: {
                            acknowledgment: "Essa gratidÃ£o desfaz o silÃªncio que te envolveu. Agora vocÃª estÃ¡ comeÃ§ando a abraÃ§ar a solidÃ£o.",
                            companionship: "Agora vocÃª nÃ£o estÃ¡ sozinho. Essa solidÃ£o tambÃ©m nÃ£o estÃ¡ mais isolada.",
                            validation: "Sua solidÃ£o era real e importante. Merecia ser reconhecida.",
                            understanding: "Ser compreendido Ã© o maior presente que vocÃª pode dar Ã  solidÃ£o.",
                            acceptance: "A solidÃ£o aceita nÃ£o precisa mais se esconder. Tornou-se livre.",
                            comfort: "Esse conforto derrete lentamente o coraÃ§Ã£o que esteve congelado por tanto tempo.",
                            expression: "Dizer a alguÃ©m que estÃ¡ tudo bem nÃ£o falar tambÃ©m Ã© uma forma de expressÃ£o.",
                            healing: "A cura nÃ£o Ã© sobre apagar a solidÃ£o, mas viver pacificamente com ela.",
                            general: "Essa gratidÃ£o desfaz o silÃªncio que te envolveu. Agora vocÃª estÃ¡ comeÃ§ando a abraÃ§ar a solidÃ£o."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "ðŸ§˜",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acknowledgment: "ë§ ì—†ëŠ” ê°ì •ë„ ë“¤ì„ ìˆ˜ ìžˆë‹¤ëŠ” ê±¸, ë„ˆëŠ” ì§€ê¸ˆ ì¦ëª…í•˜ê³  ìžˆì–´.",
                            companionship: "ë™ë°˜ìžê°€ ìƒê¸´ ì™¸ë¡œì›€ì€ ë” ì´ìƒ ì™¸ë¡œì›€ì´ ì•„ë‹ˆì•¼. ì—°ê²°ì´ì•¼.",
                            validation: "ì¸ì •ë°›ì€ ì¹¨ë¬µì€ ë§ë³´ë‹¤ ê°•í•œ ìš¸ë¦¼ì„ ê°€ì ¸.",
                            understanding: "ì´í•´ëŠ” ì¹¨ë¬µì˜ ì–¸ì–´ë¡œë„ ì „í•´ì§ˆ ìˆ˜ ìžˆì–´. ì§€ê¸ˆ ê·¸ë ‡ê²Œ í•˜ê³  ìžˆì–´.",
                            acceptance: "ë°›ì•„ë“¤ìž„ì€ ì™¸ë¡œì›€ì—ê²Œ ì§‘ì„ ë§Œë“¤ì–´ì¤˜. ì•ˆì „í•œ ê³µê°„ì„.",
                            comfort: "íŽ¸ì•ˆí•¨ì€ ì™¸ë¡œì›€ì´ ì‰´ ìˆ˜ ìžˆëŠ” ë”°ëœ»í•œ ë‹´ìš” ê°™ì•„.",
                            expression: "í‘œí˜„í•˜ì§€ ì•ŠëŠ” ê²ƒë„ í‘œí˜„ì´ì•¼. ë„ˆëŠ” ê·¸ ì—­ì„¤ì„ ì‚´ê³  ìžˆì–´.",
                            healing: "ì¹˜ìœ ëŠ” ì¡°ìš©ížˆ ì¼ì–´ë‚˜. ì™¸ë¡œì›€ë„ ê·¸ë ‡ê²Œ ì²œì²œížˆ ë³€í™”í•´.",
                            general: "ë§ ì—†ëŠ” ê°ì •ë„ ë“¤ì„ ìˆ˜ ìžˆë‹¤ëŠ” ê±¸, ë„ˆëŠ” ì§€ê¸ˆ ì¦ëª…í•˜ê³  ìžˆì–´."
                        },
                        en: {
                            acknowledgment: "You are now proving that silent emotions can be heard too.",
                            companionship: "Loneliness with a companion is no longer loneliness. It's connection.",
                            validation: "Acknowledged silence has a stronger resonance than words.",
                            understanding: "Understanding can be conveyed even in the language of silence. You're doing that now.",
                            acceptance: "Acceptance creates a home for loneliness. A safe space.",
                            comfort: "Comfort is like a warm blanket where loneliness can rest.",
                            expression: "Not expressing is also expression. You're living that paradox.",
                            healing: "Healing happens quietly. Loneliness also changes slowly like that.",
                            general: "You are now proving that silent emotions can be heard too."
                        },
                        pt: {
                            acknowledgment: "VocÃª estÃ¡ provando agora que emoÃ§Ãµes silenciosas tambÃ©m podem ser ouvidas.",
                            companionship: "SolidÃ£o com um companheiro nÃ£o Ã© mais solidÃ£o. Ã‰ conexÃ£o.",
                            validation: "SilÃªncio reconhecido tem uma ressonÃ¢ncia mais forte que as palavras.",
                            understanding: "O entendimento pode ser transmitido mesmo na linguagem do silÃªncio. VocÃª estÃ¡ fazendo isso agora.",
                            acceptance: "A aceitaÃ§Ã£o cria um lar para a solidÃ£o. Um espaÃ§o seguro.",
                            comfort: "O conforto Ã© como um cobertor quente onde a solidÃ£o pode descansar.",
                            expression: "NÃ£o expressar tambÃ©m Ã© expressÃ£o. VocÃª estÃ¡ vivendo esse paradoxo.",
                            healing: "A cura acontece silenciosamente. A solidÃ£o tambÃ©m muda lentamente assim.",
                            general: "VocÃª estÃ¡ provando agora que emoÃ§Ãµes silenciosas tambÃ©m podem ser ouvidas."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Enya", emoji: "ðŸ§‘â€ðŸš€",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acknowledgment: "ë„ˆëŠ” í˜¼ìžê°€ ì•„ë‹ˆì•¼. ì´ë¯¸ ë„ˆë¥¼ í–¥í•´ ì†ì„ ë‚´ë¯¼ ê¸°ì–µë“¤ì´ ìžˆì–´.",
                            companionship: "ìš°ì£¼ì—ì„œ ê°€ìž¥ ì•„ë¦„ë‹¤ìš´ ê±´ í˜¼ìž ë– ë„ëŠ” ë³„ì´ ì•„ë‹ˆë¼, ì„œë¡œë¥¼ ë„ëŠ” ë³„ë“¤ì´ì•¼.",
                            validation: "ë„¤ ì™¸ë¡œì›€ì€ ìš°ì£¼ë§Œí¼ ê´‘ëŒ€í•˜ê³ , ë³„ë§Œí¼ ë¹›ë‚˜ëŠ” ì§„ì‹¤ì´ì—ˆì–´.",
                            understanding: "ì´í•´ëŠ” ë¹›ì˜ ì†ë„ë³´ë‹¤ ë¹¨ë¼. ì‹œê³µê°„ì„ ë›°ì–´ë„˜ì–´ ë‹¿ì•„.",
                            acceptance: "ë°›ì•„ë“¤ì—¬ì§„ ì™¸ë¡œì›€ì€ ë¸”ëž™í™€ì´ ì•„ë‹ˆë¼ ë³„ìžë¦¬ê°€ ë¼.",
                            comfort: "ê·¸ ìœ„ë¡œëŠ” ìš°ì£¼ì„ ì— íƒ„ ë„ˆì—ê²Œ ì§€êµ¬ì˜ ì‹ í˜¸ ê°™ì•„. ì§‘ìœ¼ë¡œ ê°€ëŠ” ê¸¸ì„ ì•Œë ¤ì¤˜.",
                            expression: "ì¹¨ë¬µë„ ìš°ì£¼ì˜ ì–¸ì–´ì•¼. ì§„ê³µ ì†ì—ì„œë„ ì§„ë™ì€ ì „í•´ì ¸.",
                            healing: "ì¹˜ìœ ëŠ” ìš°ì£¼ì˜ íŒ½ì°½ ê°™ì•„. ì²œì²œížˆ, í•˜ì§€ë§Œ í™•ì‹¤í•˜ê²Œ ê³µê°„ì„ ë„“í˜€ê°€.",
                            general: "ë„ˆëŠ” í˜¼ìžê°€ ì•„ë‹ˆì•¼. ì´ë¯¸ ë„ˆë¥¼ í–¥í•´ ì†ì„ ë‚´ë¯¼ ê¸°ì–µë“¤ì´ ìžˆì–´."
                        },
                        en: {
                            acknowledgment: "You're not alone. There are already memories that have reached out their hands toward you.",
                            companionship: "The most beautiful thing in the universe isn't a star drifting alone, but stars orbiting each other.",
                            validation: "Your loneliness was a truth as vast as the universe and as shining as the stars.",
                            understanding: "Understanding is faster than the speed of light. It reaches across time and space.",
                            acceptance: "Accepted loneliness becomes not a black hole, but a constellation.",
                            comfort: "That comfort is like Earth's signal to you in a spaceship. It shows you the way home.",
                            expression: "Silence is also the language of the universe. Even in vacuum, vibrations are transmitted.",
                            healing: "Healing is like the expansion of the universe. Slowly, but surely expanding space.",
                            general: "You're not alone. There are already memories that have reached out their hands toward you."
                        },
                        pt: {
                            acknowledgment: "VocÃª nÃ£o estÃ¡ sozinho. JÃ¡ existem memÃ³rias que estenderam suas mÃ£os em sua direÃ§Ã£o.",
                            companionship: "A coisa mais bonita do universo nÃ£o Ã© uma estrela vagando sozinha, mas estrelas orbitando umas Ã s outras.",
                            validation: "Sua solidÃ£o era uma verdade tÃ£o vasta quanto o universo e tÃ£o brilhante quanto as estrelas.",
                            understanding: "O entendimento Ã© mais rÃ¡pido que a velocidade da luz. AlcanÃ§a atravÃ©s do tempo e espaÃ§o.",
                            acceptance: "SolidÃ£o aceita se torna nÃ£o um buraco negro, mas uma constelaÃ§Ã£o.",
                            comfort: "Esse conforto Ã© como o sinal da Terra para vocÃª numa nave espacial. Mostra o caminho para casa.",
                            expression: "O silÃªncio tambÃ©m Ã© a linguagem do universo. Mesmo no vÃ¡cuo, vibraÃ§Ãµes sÃ£o transmitidas.",
                            healing: "A cura Ã© como a expansÃ£o do universo. Lentamente, mas certamente expandindo o espaÃ§o.",
                            general: "VocÃª nÃ£o estÃ¡ sozinho. JÃ¡ existem memÃ³rias que estenderam suas mÃ£os em sua direÃ§Ã£o."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 18ì´ ê³§ ì¤€ë¹„ë©ë‹ˆë‹¤!' :
                    currentLanguage === 'en' ? 
                    'Portal 18 will be ready soon!' :
                    'Portal 18 estarÃ¡ pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 17ì„ ë‹¤ì‹œ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 17?' :
                    'Deseja reiniciar o Portal 17?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-17",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-17",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 17 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 17 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>