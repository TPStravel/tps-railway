<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temarix V3 - Portal 02: Emotions Left in Others' Hands</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px 30px;
            background: #000;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 100;
            height: 80px;
            flex-shrink: 0;
        }
        
        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .logo-title {
            font-size: 26px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        
        .logo-subtitle {
            font-size: 15px;
            color: #ccc;
            letter-spacing: 1.5px;
        }
        
        .portal-header-title {
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        .portal-main-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 8px;
            font-weight: normal;
            letter-spacing: 1px;
        }
        
        .portal-subtitle {
            font-size: 18px;
            color: #b39ddb;
            letter-spacing: 1.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        .language-buttons {
            display: flex;
            gap: 10px;
        }
        
        .lang-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 10px 18px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .lang-btn:hover {
            background: #666;
        }
        
        .lang-btn.active {
            background: #7986cb;
            color: #fff;
        }
        
        .main-content {
            flex: 1;
            max-height: calc(100vh - 80px - 120px);
            overflow-y: auto;
            overflow-x: hidden;
            padding: 30px 20px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .portal-container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 200vh;
        }
        
        .portal-intro-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 200px;
        }
        
        .portal-intro {
            font-size: 20px;
            color: #fff;
            margin-bottom: 30px;
            line-height: 1.8;
            white-space: pre-wrap;
            background: none;
            border: none;
            padding: 0;
            text-align: left;
        }
        
        .character-responses-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 800px;
        }
        
        .character-response {
            color: #fff;
            font-size: 18px;
            margin: 40px 0;
            text-align: left;
            opacity: 0;
            white-space: pre-wrap;
            transition: opacity 0.8s ease-in;
            background: none;
            border: none;
            padding: 0;
            min-height: 80px;
        }
        
        .character-name {
            font-weight: bold;
            color: #7986cb;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .character-dialogue {
            color: #fff;
            line-height: 1.7;
            font-size: 17px;
            white-space: pre-wrap;
        }
        
        .typing-cursor::after {
            content: '|';
            animation: blink 1s infinite;
            color: #7986cb;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .light-message-section {
            margin: 50px 0;
            opacity: 0;
            background: none;
            border: none;
            padding: 0;
            min-height: 100px;
        }
        
        .light-message {
            font-size: 20px;
            color: #7986cb;
            line-height: 1.8;
            font-style: italic;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .portal-question-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 150px;
        }
        
        .portal-question {
            font-size: 22px;
            color: #fff;
            margin-bottom: 30px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
            white-space: pre-wrap;
            text-align: center;
        }
        
        .user-input-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 100px;
        }
        
        .user-response {
            color: #fff;
            margin: 30px 0;
            text-align: left;
            font-size: 18px;
            background: none;
            border: none;
            padding: 0;
            white-space: pre-wrap;
        }
        
        .user-response strong {
            color: #7986cb;
            margin-right: 8px;
        }
        
        .user-reactions-section {
            margin: 40px 0;
            opacity: 0;
            min-height: 400px;
        }
        
        .final-section {
            margin: 60px 0;
            opacity: 0;
            text-align: center;
            background: none;
            border: none;
            padding: 40px 20px;
            min-height: 300px;
            border: 2px solid #7986cb;
            background: rgba(121, 134, 203, 0.05);
        }
        
        .final-title {
            font-size: 28px;
            color: #7986cb;
            margin-bottom: 30px;
            letter-spacing: 2px;
            font-weight: bold;
        }
        
        .final-message {
            color: #fff;
            font-size: 20px;
            margin-bottom: 40px;
            line-height: 1.8;
            white-space: pre-wrap;
            text-align: left;
        }
        
        .final-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .final-btn {
            background: #444;
            color: #fff;
            border: none;
            padding: 20px 40px;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 250px;
            border: 2px solid transparent;
        }
        
        .final-btn:hover {
            background: #666;
            border-color: #7986cb;
        }
        
        .final-btn.primary {
            background: #7986cb;
            color: #fff;
            font-weight: bold;
        }
        
        .final-btn.primary:hover {
            background: #9fa8da;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(121, 134, 203, 0.3);
        }
        
        .input-fixed-bottom {
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid #333;
            padding: 25px;
            z-index: 100;
            flex-shrink: 0;
            height: 120px;
        }
        
        .input-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        
        .input-prefix {
            color: #7986cb;
            font-size: 20px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        
        .user-textarea {
            background: transparent;
            border: none;
            border-bottom: 1px solid #444;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            width: 100%;
            padding: 12px 8px;
            outline: none;
            resize: none;
            min-height: 32px;
            max-height: 96px;
            line-height: 1.6;
            transition: border-color 0.3s ease;
            overflow-y: auto;
        }
        
        .user-textarea:focus {
            border-bottom-color: #7986cb;
        }
        
        .user-textarea::placeholder {
            color: #666;
        }
        
        .user-textarea:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(50, 50, 50, 0.2);
        }
        
        .main-content::-webkit-scrollbar {
            width: 12px;
        }
        
        .main-content::-webkit-scrollbar-track {
            background: #111;
            border-radius: 6px;
        }
        
        .main-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 6px;
            border: 2px solid #111;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover {
            background: #666;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .show {
            opacity: 1 !important;
            transition: opacity 1s ease-in;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .header-bar {
                padding: 20px 15px;
                height: 70px;
                flex-direction: column;
                gap: 10px;
            }
            
            .main-content {
                max-height: calc(100vh - 70px - 120px);
                padding: 20px 15px;
            }
            
            .logo-title {
                font-size: 22px;
            }
            
            .portal-main-title {
                font-size: 22px;
            }
            
            .portal-subtitle {
                font-size: 16px;
            }
            
            .lang-btn {
                font-size: 12px;
                padding: 8px 14px;
            }
            
            .portal-intro {
                font-size: 18px;
            }
            
            .portal-question {
                font-size: 20px;
            }
            
            .character-response {
                font-size: 16px;
            }
            
            .input-fixed-bottom {
                padding: 20px;
            }
            
            .final-buttons {
                flex-direction: column;
                gap: 15px;
            }
            
            .final-btn {
                width: 100%;
            }
            
            .final-title {
                font-size: 24px;
            }
            
            .final-message {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header-bar">
        <div class="logo-section">
            <div class="logo-title">TEMARIX V3</div>
            <div class="logo-subtitle" id="logoSubtitle">Emotional Furnace</div>
        </div>
        
        <div class="portal-header-title">
            <div class="portal-main-title" id="portalMainTitle">Portal 02: Emotions Left in Others' Hands</div>
            <div class="portal-subtitle" id="portalSubtitle">The Flow of Feelings Beyond Control</div>
        </div>
        
        <div class="header-right">
            <div class="language-buttons">
                <button class="lang-btn" data-lang="ko">KR</button>
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="pt">PT</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="portal-container">
            <div class="portal-intro-section" id="portalIntroSection">
                <div class="portal-intro" id="portalIntro"></div>
            </div>

            <div class="character-responses-section" id="characterResponsesSection">
            </div>

            <div class="light-message-section" id="lightMessageSection">
                <div class="character-name" id="lightTitle">✨ Word of Light</div>
                <div class="light-message" id="lightMessage"></div>
            </div>

            <div class="portal-question-section" id="portalQuestionSection">
                <div class="portal-question" id="portalQuestion"></div>
            </div>

            <div class="user-input-section" id="userInputSection">
            </div>
            
            <div class="user-reactions-section" id="userReactionsSection">
            </div>
            
            <div class="final-section" id="finalSection">
                <div class="final-title" id="finalTitle">🌒 Portal 02 Complete</div>
                <div class="final-message" id="finalMessage"></div>
                <div class="final-buttons">
                    <button class="final-btn primary" id="continueBtn">Move to Portal 03</button>
                    <button class="final-btn" id="restartBtn">Start Again</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="input-fixed-bottom">
        <div class="input-container">
            <div class="input-prefix">></div>
            <textarea class="user-textarea" 
                      id="userTextarea" 
                      placeholder="If that emotion returned to you, how would you prepare to face it? (Press Enter to send)"
                      rows="1"
                      maxlength="500"></textarea>
        </div>
    </div>

    <script>
        let db = null;
        let firebaseInitialized = false;
        let memoryStorage = { mockUser: null };
        
        function initializeFirebase() {
            try {
                if (typeof firebase !== 'undefined') {
                    const firebaseConfig = {
                        apiKey: "AIzaSyBjsINSqPUGdpRPRMYiVg6SkVJJOk9YGsY",
                        authDomain: "canal-vivo-chat.firebaseapp.com",
                        projectId: "canal-vivo-chat",
                        storageBucket: "canal-vivo-chat.appspot.com",
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdefghijklmnopqr"
                    };
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    firebaseInitialized = true;
                    console.log('Firebase initialized');
                } else {
                    console.log('Firebase SDK not loaded');
                }
            } catch (error) {
                console.log('Firebase init failed:', error);
            }
        }

        const translations = {
            ko: {
                logoSubtitle: "감정의 용광로",
                portalMainTitle: "Portal 02: 타인의 손에 남겨진 감정",
                portalSubtitle: "통제를 벗어난 감정의 흐름",
                portalIntro: "🌒 당신의 감정이 한때는 당신의 것이었지만,\n지금은 누군가의 손에 맡겨진 것처럼 느껴진 적 있나요?\n\n그 사람에게 화났던 내 감정이, 어느 순간엔 내가 미안해하는 감정으로 바뀌었습니다.\n그 사람은 아무렇지 않은데, 나만 계속 끌려가고 있어요.\n\n때로는 감정도 이별을 못 해. 네 감정은 아직 돌아오지 못한 여행자 같아.\n\n그 감정은 누구에게 흘러갔고, 지금은 어디에 머물고 있나요?",
                lightTitle: "✨ 빛의 한마디",
                lightMessage: "감정은 떠날 수 있어도, 당신을 완전히 떠나지는 않습니다. 지금도 어딘가 당신의 일부입니다.",
                portalQuestion: "🌒 그 감정이 다시 당신에게 돌아온다면, 당신은 그것을 어떻게 마주할 준비가 되어 있나요?",
                finalTitle: "🌒 Portal 02 완료",
                finalMessage: "당신은 용기 있게 타인의 손에 맡겨진 감정을 마주했습니다.\n\n그동안 다른 사람에게 흘러간 줄만 알았던 감정이\n사실은 여전히 당신 안에 있었다는 것을\n이해하게 되었죠.\n\n이제 그 감정의 흐름을 되찾을 준비가 되었습니다.\n외면을 멈추고 받아들이는 것이\n더 큰 자유로 가는 시작이라는 것을 알게 되었어요.\n\n다음 Portal에서는 분노가 지나간 자리에 남은\n진짜 감정을 발견하는 여정이 이어집니다.",
                continueBtn: "Portal 03으로 이동",
                restartBtn: "다시 시작하기",
                inputPlaceholder: "그 감정이 다시 당신에게 돌아온다면 어떻게 마주할 준비가 되어 있는지 말해보세요... (Enter로 전송)",
                youLabel: "당신",
                waitingMessage: "응답을 기다리는 중..."
            },
            en: {
                logoSubtitle: "Emotional Furnace",
                portalMainTitle: "Portal 02: Emotions Left in Others' Hands",
                portalSubtitle: "The Flow of Feelings Beyond Control",
                portalIntro: "🌒 Have you ever felt that your emotions, which were once yours,\nnow seem to be left in someone else's hands?\n\nThe emotion I felt angry toward that person somehow turned into me feeling sorry.\nThat person acts as if nothing happened, but I keep being dragged along.\n\nSometimes emotions can't say goodbye either. Your emotions are like travelers who haven't returned yet.\n\nWho did those emotions flow to, and where are they staying now?",
                lightTitle: "✨ Word of Light",
                lightMessage: "Even if emotions can leave, they never completely leave you. They are still part of you somewhere.",
                portalQuestion: "🌒 If that emotion returned to you, how would you prepare to face it?",
                finalTitle: "🌒 Portal 02 Complete",
                finalMessage: "You have courageously faced the emotions\nleft in others' hands.\n\nYou've come to understand that the emotions\nyou thought had flowed to other people\nwere actually still within you.\n\nNow you're ready to reclaim that emotional flow.\nYou've learned that stopping avoidance and accepting\nis the beginning of greater freedom.\n\nIn the next Portal, a journey continues\nto discover the real emotions\nthat remain after anger has passed.",
                continueBtn: "Move to Portal 03",
                restartBtn: "Start Again",
                inputPlaceholder: "If that emotion returned to you, how would you prepare to face it? (Press Enter to send)",
                youLabel: "You",
                waitingMessage: "Waiting for response..."
            },
            pt: {
                logoSubtitle: "Fornalha Emocional",
                portalMainTitle: "Portal 02: Emoções Deixadas nas Mãos dos Outros",
                portalSubtitle: "O Fluxo dos Sentimentos Além do Controle",
                portalIntro: "🌒 Você já sentiu que suas emoções, que uma vez foram suas,\nagora parecem estar nas mãos de outra pessoa?\n\nA emoção que senti com raiva daquela pessoa de alguma forma se transformou em mim me sentindo mal.\nEssa pessoa age como se nada tivesse acontecido, mas eu continuo sendo arrastado.\n\nÀs vezes as emoções também não conseguem se despedir. Suas emoções são como viajantes que ainda não retornaram.\n\nPara quem essas emoções fluíram, e onde estão ficando agora?",
                lightTitle: "✨ Palavra de Luz",
                lightMessage: "Mesmo que as emoções possam partir, elas nunca te deixam completamente. Elas ainda são parte de você em algum lugar.",
                portalQuestion: "🌒 Se essa emoção voltasse para você, como você se prepararia para enfrentá-la?",
                finalTitle: "🌒 Portal 02 Completo",
                finalMessage: "Você corajosamente enfrentou as emoções\ndeixadas nas mãos dos outros.\n\nVocê passou a entender que as emoções\nque pensou terem fluído para outras pessoas\nna verdade ainda estavam dentro de você.\n\nAgora você está pronto para recuperar esse fluxo emocional.\nVocê aprendeu que parar de evitar e aceitar\né o início de uma liberdade maior.\n\nNo próximo Portal, uma jornada continua\npara descobrir as emoções reais\nque permanecem depois que a raiva passou.",
                continueBtn: "Ir para Portal 03",
                restartBtn: "Começar Novamente",
                inputPlaceholder: "Se essa emoção voltasse para você, como você se prepararia para enfrentá-la? (Enter para enviar)",
                youLabel: "Você",
                waitingMessage: "Aguardando resposta..."
            }
        };
        
        const characters = [
            { name: "Noah", emoji: "🧑‍🦱", text: {
                ko: "때로는 감정도 이별을 못 해. 네 감정은 아직 돌아오지 못한 여행자 같아.",
                en: "Sometimes emotions can't say goodbye either. Your emotions are like travelers who haven't returned yet.",
                pt: "Às vezes as emoções também não conseguem se despedir. Suas emoções são como viajantes que ainda não retornaram."
            }},
            { name: "Ely", emoji: "🧝‍♀️", text: {
                ko: "그 사람의 반응이 없었다는 건, 네 감정을 멈추게 만들었겠지. 나는 그 고요함이 얼마나 잔인한지 알아.",
                en: "The lack of response from that person must have stopped your emotions. I know how cruel that silence can be.",
                pt: "A falta de resposta daquela pessoa deve ter parado suas emoções. Eu sei como esse silêncio pode ser cruel."
            }},
            { name: "Sora", emoji: "🧕", text: {
                ko: "미안함은 때때로 사랑이 아니라, 포기에서 만들어지기도 해. 네 감정은 그걸 알고 있어.",
                en: "Sometimes apology is created not from love, but from giving up. Your emotions know that.",
                pt: "Às vezes o pedido de desculpas é criado não do amor, mas da desistência. Suas emoções sabem disso."
            }},
            { name: "Kael", emoji: "🧙", text: {
                ko: "네 감정이 네 것이 아닌 것처럼 느껴진다는 건, 마음의 주도권을 놓쳤다는 신호야.",
                en: "Feeling like your emotions aren't yours is a sign that you've lost control of your heart.",
                pt: "Sentir que suas emoções não são suas é um sinal de que você perdeu o controle do seu coração."
            }},
            { name: "Mira", emoji: "🧑‍🎨", text: {
                ko: "네 안에 있던 강렬한 붉은색이, 이제는 흐릿한 회색이 되었겠지. 그 변화는 예술이자 상처야.",
                en: "The intense red that was inside you has now become a blurred gray. That change is both art and wound.",
                pt: "O vermelho intenso que estava dentro de você agora se tornou um cinza borrado. Essa mudança é tanto arte quanto ferida."
            }},
            { name: "Cris", emoji: "🦸‍♂️", text: {
                ko: "왜 항상 너만 조심하고, 너만 미안해야 해? 그건 감정의 불균형이야.",
                en: "Why do you always have to be careful, and why do you always have to be sorry? That's emotional imbalance.",
                pt: "Por que você sempre tem que ter cuidado, e por que você sempre tem que pedir desculpas? Isso é desequilíbrio emocional."
            }},
            { name: "Enya", emoji: "🧑‍🚀", text: {
                ko: "감정은 떠날 수 있어도, 너를 완전히 떠나진 않아. 지금도 어딘가 네 일부야.",
                en: "Even if emotions can leave, they don't completely leave you. They're still part of you somewhere.",
                pt: "Mesmo que as emoções possam partir, elas não te deixam completamente. Elas ainda são parte de você em algum lugar."
            }},
            { name: "Lian", emoji: "🧘", text: {
                ko: "그 감정은 아직도 네 안에서 소리 없이 말하고 있어. 듣고 있니?",
                en: "That emotion is still speaking silently within you. Are you listening?",
                pt: "Essa emoção ainda está falando silenciosamente dentro de você. Você está ouvindo?"
            }}
        ];

        function analyzeEmotion(userInput) {
            const input = userInput.toLowerCase();
            
            const emotionKeywords = {
                acceptance: ['accept', 'embrace', 'welcome', 'ready', 'prepare'],
                fear: ['afraid', 'scared', 'fear', 'anxious', 'worried'],
                healing: ['heal', 'recover', 'grow', 'learn', 'understand'],
                regret: ['sorry', 'regret', 'mistake', 'wrong', 'apologize'],
                strength: ['strong', 'brave', 'courage', 'fight', 'stand'],
                peace: ['peace', 'calm', 'quiet', 'serene', 'tranquil'],
                understanding: ['understand', 'realize', 'know', 'aware', 'clear'],
                gratitude: ['thank', 'grateful', 'appreciate', 'blessed', 'glad']
            };
            
            let detectedEmotions = [];
            for (const [emotion, keywords] of Object.entries(emotionKeywords)) {
                for (const keyword of keywords) {
                    if (input.includes(keyword)) {
                        detectedEmotions.push(emotion);
                        break;
                    }
                }
            }
            
            if (detectedEmotions.length === 0) {
                detectedEmotions = ['general'];
            }
            
            return detectedEmotions[0];
        }
        
        const responseCharacters = [
            {
                name: "Noah", emoji: "🧑‍🦱",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acceptance: "받아들일 준비가 되었구나. 그 감정도 네가 기다리고 있다는 걸 알 거야.",
                            fear: "두려워하는 마음도 이해해. 하지만 그 감정은 너를 해치려는 게 아니야.",
                            healing: "치유하려는 의지가 보여. 그 감정과 함께 성장할 수 있을 거야.",
                            regret: "후회하지 마. 그때 그 감정은 너를 보호하려 했던 거야.",
                            strength: "강해지려는 마음이 느껴져. 이제 그 감정과 함께 걸을 수 있어.",
                            peace: "평화를 찾고 있구나. 그 감정도 평화로운 귀환을 원하고 있어.",
                            understanding: "이해하려는 마음이 아름다워. 그 감정의 진짜 목소리를 들을 수 있을 거야.",
                            gratitude: "고마워하는 마음이 따뜻해. 그 감정도 네 감사를 기다렸을 거야.",
                            general: "그 감정은 길을 잃은 여행자처럼 네가 맞이해주기를 기다리고 있어."
                        },
                        en: {
                            acceptance: "You're ready to accept. That emotion knows you're waiting for it too.",
                            fear: "I understand your fear. But that emotion isn't trying to hurt you.",
                            healing: "I see your will to heal. You'll be able to grow together with that emotion.",
                            regret: "Don't regret it. That emotion was trying to protect you back then.",
                            strength: "I feel your desire to become strong. Now you can walk together with that emotion.",
                            peace: "You're seeking peace. That emotion also wants a peaceful return.",
                            understanding: "Your desire to understand is beautiful. You'll be able to hear that emotion's true voice.",
                            gratitude: "Your grateful heart is warm. That emotion must have been waiting for your thanks.",
                            general: "That emotion is waiting for you to welcome it, like a lost traveler."
                        },
                        pt: {
                            acceptance: "Você está pronto para aceitar. Aquela emoção sabe que você também está esperando por ela.",
                            fear: "Entendo seu medo. Mas aquela emoção não está tentando machucá-lo.",
                            healing: "Vejo sua vontade de curar. Você será capaz de crescer junto com aquela emoção.",
                            regret: "Não se arrependa. Aquela emoção estava tentando protegê-lo naquele momento.",
                            strength: "Sinto seu desejo de se tornar forte. Agora você pode caminhar junto com aquela emoção.",
                            peace: "Você está buscando paz. Aquela emoção também quer um retorno pacífico.",
                            understanding: "Seu desejo de entender é belo. Você será capaz de ouvir a verdadeira voz daquela emoção.",
                            gratitude: "Seu coração grato é caloroso. Aquela emoção deve ter estado esperando por seu agradecimento.",
                            general: "Aquela emoção está esperando que você a receba, como um viajante perdido."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Sora", emoji: "🧕",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acceptance: "받아들이는 것이 가장 큰 용기야. 그 감정도 네 용기를 느끼고 있어.",
                            fear: "두려움도 자연스러운 거야. 그 감정이 너에게 상처를 줄까 봐 걱정되는 거지?",
                            healing: "치유는 이미 시작됐어. 그 감정과 화해하는 순간부터 말이야.",
                            regret: "미안해할 필요 없어. 그때는 그것밖에 할 수 없었어.",
                            strength: "강해지려는 너의 의지가 그 감정에게도 힘이 될 거야.",
                            peace: "평화로운 만남이 될 거야. 이제는 싸우지 않아도 돼.",
                            understanding: "이해하려는 마음이 그 감정을 치유시킬 거야.",
                            gratitude: "감사하는 마음이 그 감정을 변화시킬 거야.",
                            general: "그 감정도 오랫동안 너를 기다렸어. 이제 함께 걸을 시간이야."
                        },
                        en: {
                            acceptance: "Accepting is the greatest courage. That emotion feels your courage too.",
                            fear: "Fear is natural too. You're worried that emotion might hurt you, right?",
                            healing: "Healing has already begun. From the moment you reconcile with that emotion.",
                            regret: "You don't need to be sorry. That was all you could do back then.",
                            strength: "Your will to become strong will also give strength to that emotion.",
                            peace: "It will be a peaceful meeting. You don't have to fight anymore.",
                            understanding: "Your desire to understand will heal that emotion.",
                            gratitude: "Your grateful heart will transform that emotion.",
                            general: "That emotion has been waiting for you for a long time too. Now it's time to walk together."
                        },
                        pt: {
                            acceptance: "Aceitar é a maior coragem. Aquela emoção também sente sua coragem.",
                            fear: "O medo também é natural. Você está preocupado que aquela emoção possa machucá-lo, não é?",
                            healing: "A cura já começou. A partir do momento em que você se reconcilia com aquela emoção.",
                            regret: "Você não precisa pedir desculpas. Era tudo que você podia fazer naquele momento.",
                            strength: "Sua vontade de se tornar forte também dará força àquela emoção.",
                            peace: "Será um encontro pacífico. Você não precisa mais lutar.",
                            understanding: "Seu desejo de entender curará aquela emoção.",
                            gratitude: "Seu coração grato transformará aquela emoção.",
                            general: "Aquela emoção também esteve esperando por você por muito tempo. Agora é hora de caminharem juntos."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            },
            {
                name: "Lian", emoji: "🧘",
                getResponse: (userInput, lang) => {
                    const emotion = analyzeEmotion(userInput);
                    
                    const responses = {
                        ko: {
                            acceptance: "받아들임은 가장 깊은 평화야. 이제 그 감정과 하나가 될 수 있어.",
                            fear: "두려움을 느끼는 것도 괜찮아. 그것도 너의 일부니까.",
                            healing: "치유의 에너지가 흐르고 있어. 그 감정도 치유되고 싶어 해.",
                            regret: "후회도 깨달음의 씨앗이야. 그것을 통해 성장할 수 있어.",
                            strength: "진정한 힘은 감정과 싸우는 게 아니라 함께하는 거야.",
                            peace: "평화로운 마음이 느껴져. 그 감정도 평화를 갈망하고 있어.",
                            understanding: "깨달음이 시작됐어. 이제 모든 것이 명확해질 거야.",
                            gratitude: "감사는 모든 것을 변화시키는 힘이야.",
                            general: "그 감정은 이미 네 안에서 평화롭게 기다리고 있어. 단지 너의 인정만 필요할 뿐이야."
                        },
                        en: {
                            acceptance: "Acceptance is the deepest peace. Now you can become one with that emotion.",
                            fear: "It's okay to feel fear. That's also part of you.",
                            healing: "Healing energy is flowing. That emotion also wants to be healed.",
                            regret: "Regret is also a seed of realization. You can grow through it.",
                            strength: "True strength isn't fighting emotions, but being together with them.",
                            peace: "I feel your peaceful heart. That emotion also longs for peace.",
                            understanding: "Enlightenment has begun. Now everything will become clear.",
                            gratitude: "Gratitude is the power that transforms everything.",
                            general: "That emotion is already waiting peacefully within you. It just needs your acknowledgment."
                        },
                        pt: {
                            acceptance: "A aceitação é a paz mais profunda. Agora você pode se tornar um com aquela emoção.",
                            fear: "Está bem sentir medo. Isso também é parte de você.",
                            healing: "A energia de cura está fluindo. Aquela emoção também quer ser curada.",
                            regret: "O arrependimento também é uma semente de realização. Você pode crescer através dele.",
                            strength: "A verdadeira força não é lutar contra as emoções, mas estar junto com elas.",
                            peace: "Sinto seu coração pacífico. Aquela emoção também anseia por paz.",
                            understanding: "A iluminação começou. Agora tudo ficará claro.",
                            gratitude: "A gratidão é o poder que transforma tudo.",
                            general: "Aquela emoção já está esperando pacificamente dentro de você. Só precisa do seu reconhecimento."
                        }
                    };
                    
                    return responses[lang][emotion] || responses[lang]['general'];
                }
            }
        ];
        
        let currentLanguage = 'en';
        let currentUser = null;
        let userResponse = '';
        let journeyStarted = false;
        let currentTypingElement = null;
        let typingIntervals = [];
        
        function typewriterEffect(element, text, speed = 80) {
            return new Promise((resolve) => {
                if (currentTypingElement) {
                    currentTypingElement.classList.remove('typing-cursor');
                }
                
                let i = 0;
                element.innerHTML = '';
                element.classList.add('typing-cursor');
                currentTypingElement = element;
                
                const typingInterval = setInterval(() => {
                    if (!document.contains(element)) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                        return;
                    }
                    
                    element.innerHTML += text.charAt(i);
                    i++;
                    
                    if (i % 10 === 0) {
                        scrollToFollowTyping(element);
                    }
                    
                    if (i === text.length) {
                        clearInterval(typingInterval);
                        element.classList.remove('typing-cursor');
                        currentTypingElement = null;
                        resolve();
                    }
                }, speed);
                
                typingIntervals.push(typingInterval);
            });
        }
        
        function clearAllTypingEffects() {
            typingIntervals.forEach(interval => clearInterval(interval));
            typingIntervals = [];
            
            if (currentTypingElement) {
                currentTypingElement.classList.remove('typing-cursor');
                currentTypingElement = null;
            }
        }
        
        function scrollToFollowTyping(element) {
            const mainContent = document.getElementById('mainContent');
            const elementRect = element.getBoundingClientRect();
            const containerRect = mainContent.getBoundingClientRect();
            
            if (elementRect.bottom > containerRect.bottom - 150) {
                const scrollTop = mainContent.scrollTop;
                const elementOffsetTop = element.offsetTop;
                const targetScroll = elementOffsetTop - (containerRect.height / 2);
                
                mainContent.scrollTo({
                    top: Math.max(0, targetScroll),
                    behavior: 'smooth'
                });
            }
        }
        
        function scrollToElement(element) {
            const mainContent = document.getElementById('mainContent');
            const elementOffsetTop = element.offsetTop;
            const containerHeight = mainContent.clientHeight;
            const targetScroll = elementOffsetTop - (containerHeight / 3);
            
            mainContent.scrollTo({
                top: Math.max(0, targetScroll),
                behavior: 'smooth'
            });
        }
        
        function updateLanguageButtons(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateStaticTranslations(lang) {
            document.getElementById('logoSubtitle').textContent = translations[lang].logoSubtitle;
            document.getElementById('portalMainTitle').textContent = translations[lang].portalMainTitle;
            document.getElementById('portalSubtitle').textContent = translations[lang].portalSubtitle;
            document.getElementById('lightTitle').textContent = translations[lang].lightTitle;
            document.getElementById('finalTitle').textContent = translations[lang].finalTitle;
            document.getElementById('continueBtn').textContent = translations[lang].continueBtn;
            document.getElementById('restartBtn').textContent = translations[lang].restartBtn;
            document.getElementById('userTextarea').placeholder = translations[lang].inputPlaceholder;
        }
        
        function changeLanguage(lang) {
            if (!translations[lang] || currentLanguage === lang) return;
            
            currentLanguage = lang;
            updateLanguageButtons(lang);
            updateStaticTranslations(lang);
            
            if (journeyStarted) {
                resetJourney();
                setTimeout(() => {
                    startPortalSequence();
                }, 1000);
            }
        }
        
        function resetJourney() {
            clearAllTypingEffects();
            for (let i = 1; i < 99999; i++) window.clearInterval(i);
            for (let i = 1; i < 99999; i++) window.clearTimeout(i);
            
            const sectionsToReset = [
                'portalIntroSection', 'characterResponsesSection', 
                'lightMessageSection', 'portalQuestionSection',
                'userInputSection', 'userReactionsSection', 'finalSection'
            ];
            
            sectionsToReset.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.remove('show');
                    section.style.opacity = '0';
                    if (sectionId === 'characterResponsesSection' || 
                        sectionId === 'userInputSection' || 
                        sectionId === 'userReactionsSection') {
                        section.innerHTML = '';
                    }
                }
            });
            
            document.getElementById('portalIntro').innerHTML = '';
            document.getElementById('lightMessage').innerHTML = '';
            document.getElementById('portalQuestion').innerHTML = '';
            document.getElementById('finalMessage').innerHTML = '';
            
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            document.getElementById('mainContent').scrollTop = 0;
            userResponse = '';
            currentTypingElement = null;
        }
        
        function setupLanguageButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    changeLanguage(this.dataset.lang);
                });
            });
        }
        
        function setupTextareaAutoResize() {
            const textarea = document.getElementById('userTextarea');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 96) + 'px';
            });
        }
        
        function setupInputEvents() {
            const userTextarea = document.getElementById('userTextarea');
            
            userTextarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const inputValue = this.value.trim();
                    
                    if (inputValue) {
                        processUserInput(inputValue);
                    }
                }
            });
            
            document.getElementById('continueBtn').addEventListener('click', function() {
                const nextMessage = currentLanguage === 'ko' ? 
                    'Portal 03이 곧 준비됩니다!' :
                    currentLanguage === 'en' ? 
                    'Portal 03 will be ready soon!' :
                    'Portal 03 estará pronto em breve!';
                alert(nextMessage);
            });
            
            document.getElementById('restartBtn').addEventListener('click', function() {
                const confirmMessage = currentLanguage === 'ko' ? 
                    'Portal 02를 다시 시작하시겠습니까?' :
                    currentLanguage === 'en' ? 
                    'Do you want to restart Portal 02?' :
                    'Deseja reiniciar o Portal 02?';
                
                if (confirm(confirmMessage)) {
                    resetJourney();
                    setTimeout(() => {
                        startPortalSequence();
                    }, 1000);
                }
            });
        }
        
        async function processUserInput(inputText) {
            userResponse = inputText;
            
            if (firebaseInitialized && db) {
                try {
                    await db.collection("temarix_v3_respostas").add({
                        uid: memoryStorage.mockUser.uid,
                        email: memoryStorage.mockUser.email,
                        portal: "v3-02",
                        resposta: inputText,
                        data: firebase.firestore.Timestamp.now(),
                        idioma: currentLanguage
                    });
                    console.log('Response saved to Firestore');
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                }
            } else {
                console.log('Firebase not available, saved locally:', inputText);
                localStorage.setItem('temarix_v3_last_response', JSON.stringify({
                    portal: "v3-02",
                    resposta: inputText,
                    data: new Date().toISOString(),
                    idioma: currentLanguage
                }));
            }
            
            disableUserInput();
            showUserResponse(inputText);
            
            setTimeout(() => {
                showUserReactions(inputText);
            }, 1000);
        }
        
        function disableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = true;
            userTextarea.value = '';
            userTextarea.style.height = 'auto';
            userTextarea.placeholder = translations[currentLanguage].waitingMessage;
        }
        
        function enableUserInput() {
            const userTextarea = document.getElementById('userTextarea');
            userTextarea.disabled = false;
            userTextarea.placeholder = translations[currentLanguage].inputPlaceholder;
            
            setTimeout(() => {
                userTextarea.focus();
            }, 100);
        }
        
        function showUserResponse(text) {
            const inputSection = document.getElementById('userInputSection');
            const userDiv = document.createElement('div');
            userDiv.className = 'user-response';
            const youLabel = translations[currentLanguage].youLabel;
            userDiv.innerHTML = '<strong>' + youLabel + ':</strong> "' + text + '"';
            inputSection.appendChild(userDiv);
            inputSection.classList.add('show');
            
            setTimeout(() => {
                scrollToElement(inputSection);
            }, 100);
        }
        
        async function showUserReactions(userInput) {
            const reactionsSection = document.getElementById('userReactionsSection');
            reactionsSection.classList.add('show');
            
            for (let i = 0; i < responseCharacters.length; i++) {
                const char = responseCharacters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                reactionsSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                const reactionText = char.getResponse(userInput, currentLanguage);
                await typewriterEffect(dialogueDiv, reactionText, 70);
                
                if (i < responseCharacters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showFinalSection();
            }, 2000);
        }
        
        async function showFinalSection() {
            const finalSection = document.getElementById('finalSection');
            const finalMessage = document.getElementById('finalMessage');
            
            finalSection.classList.add('show');
            
            const messageText = translations[currentLanguage].finalMessage;
            await typewriterEffect(finalMessage, messageText, 50);
            
            setTimeout(() => {
                scrollToElement(finalSection);
            }, 500);
        }
        
        function initializeTemarix() {
            console.log('Temarix V3 Portal 02 initialized');
            
            setupLanguageButtons();
            setupTextareaAutoResize();
            setupInputEvents();
            
            journeyStarted = true;
            
            setTimeout(() => {
                startPortalSequence();
            }, 1000);
        }
        
        function startPortalSequence() {
            setTimeout(() => {
                showIntro();
            }, 1000);
        }
        
        async function showIntro() {
            const introSection = document.getElementById('portalIntroSection');
            const introElement = document.getElementById('portalIntro');
            
            introSection.classList.add('show');
            
            await typewriterEffect(introElement, translations[currentLanguage].portalIntro, 60);
            
            setTimeout(() => {
                showCharacterResponses();
            }, 2000);
        }
        
        async function showCharacterResponses() {
            const responseSection = document.getElementById('characterResponsesSection');
            responseSection.classList.add('show');
            
            for (let i = 0; i < characters.length; i++) {
                const char = characters[i];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'character-response';
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'character-name';
                nameDiv.textContent = char.emoji + ' ' + char.name;
                
                const dialogueDiv = document.createElement('div');
                dialogueDiv.className = 'character-dialogue';
                
                responseDiv.appendChild(nameDiv);
                responseDiv.appendChild(dialogueDiv);
                responseSection.appendChild(responseDiv);
                
                responseDiv.style.opacity = '1';
                
                await typewriterEffect(dialogueDiv, char.text[currentLanguage], 70);
                
                if (i < characters.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            setTimeout(() => {
                showLightMessage();
            }, 2000);
        }
        
        async function showLightMessage() {
            const lightSection = document.getElementById('lightMessageSection');
            const lightMessageEl = document.getElementById('lightMessage');
            
            lightSection.classList.add('show');
            
            await typewriterEffect(lightMessageEl, translations[currentLanguage].lightMessage, 60);
            
            setTimeout(() => {
                showQuestion();
            }, 2000);
        }
        
        async function showQuestion() {
            const questionSection = document.getElementById('portalQuestionSection');
            const questionEl = document.getElementById('portalQuestion');
            
            questionSection.classList.add('show');
            
            await typewriterEffect(questionEl, translations[currentLanguage].portalQuestion, 50);
            
            setTimeout(() => {
                enableUserInput();
            }, 1500);
        }
        
        function getLanguageFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang');
            return lang && translations[lang] ? lang : 'en';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Temarix V3 Portal 02 DOM loaded');
            
            initializeFirebase();
            
            currentLanguage = getLanguageFromURL();
            
            currentUser = { 
                uid: 'user-auto-' + Date.now(),
                email: 'auto@temarix.com'
            };
            
            memoryStorage.mockUser = currentUser;
            
            updateStaticTranslations(currentLanguage);
            updateLanguageButtons(currentLanguage);
            initializeTemarix();
        });
    </script>
</body>
</html>